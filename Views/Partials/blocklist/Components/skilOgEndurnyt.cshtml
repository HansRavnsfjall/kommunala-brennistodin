@* Views/Partials/BlockList/Components/skil-og-endurnyt.cshtml *@
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockListItem>
@using System.Globalization
@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Extensions

@{
    var culture = CultureInfo.CurrentUICulture?.Name;
    var el = Model?.Content;

    // --- LEFT (already done) ---
    var heading = el?.Value<string>("yvirskrift_skiljing", culture: culture, fallback: Fallback.ToLanguage)
                 ?? "Soleiðis skilur tú <br/> títt burturkast";

    IHtmlEncodedString? bodyHtml = el?.Value<IHtmlEncodedString>("tekstur_skiljing", culture: culture, fallback: Fallback.ToLanguage);
    var bodyText = el?.Value<string>("tekstur_skiljing", culture: culture, fallback: Fallback.ToLanguage);
    var hasRte = bodyHtml != null;

    var link = el?.Value<Link>("leinki_skiljing", culture: culture, fallback: Fallback.ToLanguage);
    string SafeHeading(string h) => string.IsNullOrWhiteSpace(h) ? "Soleiðis skilur tú <br/> títt burturkast" : h;
    var btnText = link?.Name.NullOrWhiteSpaceAsNull() ?? "Royn skiljiskjáttuna";
    var btnUrl  = link?.Url;
    var btnTarget = link?.Target.NullOrWhiteSpaceAsNull() ?? "_self";

    // --- RIGHT: top hours card ---
    var hoursHeading = el?.Value<string>("yvirskrift", culture: culture, fallback: Fallback.ToLanguage)
                     ?? "Endurnýtslan á Hjalla";

    var times = el?.Value<BlockListModel>("upplatingartidir", culture: culture, fallback: Fallback.ToLanguage)
            ?? new BlockListModel(new List<BlockListItem>());

    var moreLink = el?.Value<Link>("leinki", culture: culture, fallback: Fallback.ToLanguage);
    var moreText = moreLink?.Name.NullOrWhiteSpaceAsNull();
    var moreUrl  = moreLink?.Url;
    var moreTarget = moreLink?.Target.NullOrWhiteSpaceAsNull() ?? "_self";

    // --- Accordion data ---
    // endurnytslurListi : BlockList of alias "endurnytsla"
    var stations = el?.Value<BlockListModel>("endurnytslurListi", culture: culture, fallback: Fallback.ToLanguage)
                ?? new BlockListModel(new List<BlockListItem>());

    // unique accordion root id per block instance
    var accId = $"distAcc_{(Model?.Content?.Key.ToString("N").Substring(0,8) ?? "x")}";
}

<!-- ===== Intro / Hours / Accordion ===== -->
<section class="py-4 py-lg-5 front-skilji-upplating">
  <div class="container">
    <div class="row gx-lg-5 g-4 align-items-start">
      <div class="col-lg-6">
        <div class="intro-card">
          <h2>@Html.Raw(SafeHeading(heading))</h2>

          @if (hasRte)
          {
              <div class="fw-700 text-muted-600 mb-3">
                @bodyHtml
              </div>
          }
          else
          {
              <p class="fw-700 text-muted-600 mb-3">@bodyText</p>
          }

          @if (!string.IsNullOrWhiteSpace(btnUrl))
          {
              <a class="btn btn-cta" href="@btnUrl" target="@btnTarget" rel="@(btnTarget == "_blank" ? "noopener" : null)">@btnText</a>
          }
          else
          {
              <button class="btn btn-cta" disabled>@btnText</button>
          }
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-lg-6">
        <div class="hours-card">
          <h5>@hoursHeading</h5>

          @if (times.Any())
          {
              foreach (var item in times)
              {
                  var c = item.Content;
                  var rowLabel = c?.Value<string>("tekstur", culture: culture, fallback: Fallback.ToLanguage);
                  var rowTime  = c?.Value<string>("tid",     culture: culture, fallback: Fallback.ToLanguage);

                  if (!string.IsNullOrWhiteSpace(rowLabel) || !string.IsNullOrWhiteSpace(rowTime))
                  {
                      <div class="hours-row">
                          @rowLabel
                          @if (!string.IsNullOrWhiteSpace(rowTime))
                          {
                              <span class="time">@rowTime</span>
                          }
                      </div>
                  }
              }
          }
          else
          {
              <!-- optional fallback when no rows configured -->
              <div class="hours-row">Mánadag – Hósdag <span class="time">08:00 – 17:00</span></div>
              <div class="hours-row">Fríggjadag – Leygardag <span class="time">10:00 – 17:00</span></div>
              <div class="hours-row">Sunnudag <span class="time">Stongt</span></div>
          }
        </div>

        @if (!string.IsNullOrWhiteSpace(moreUrl))
        {
            <a href="@moreUrl" target="@moreTarget" rel="@(moreTarget == "_blank" ? "noopener" : null)" class="link-more">
              @(moreText ?? "Meira um endurnýtsluna")
       <svg class="arr" viewBox="0 0 24 24"><path d="M5 12h14M13 5l7 7-7 7"/></svg>
            </a>
        }

        <div class="accordion district-acc" id="@accId">
          @if (stations.Any())
          {
              var i = 0;
              foreach (var st in stations)
              {
                  var sc = st.Content;

                  // station heading
                  var stHeading = sc?.Value<string>("yvirskrift", culture: culture, fallback: Fallback.ToLanguage)
                                ?? $"Endurnýtsla {i+1}";

                  // station nested hours: support either property alias
                  BlockListModel stTimes =
                      sc?.Value<BlockListModel>("upplatingartidir", culture: culture, fallback: Fallback.ToLanguage)
                   ?? sc?.Value<BlockListModel>("upplatingartid",  culture: culture, fallback: Fallback.ToLanguage)
                   ?? new BlockListModel(new List<BlockListItem>());

                  // station link
                  var stLink = sc?.Value<Link>("leinki", culture: culture, fallback: Fallback.ToLanguage);
                  var stLinkText = stLink?.Name.NullOrWhiteSpaceAsNull() ?? "Meira um endurnýtsluna";
                  var stLinkUrl  = stLink?.Url;
                  var stLinkTarget = stLink?.Target.NullOrWhiteSpaceAsNull() ?? "_self";

                  // unique ids per item
                  var hId = $"{accId}_h{i}";
                  var cId = $"{accId}_c{i}";
                  i++;

                  <div class="accordion-item">
                    <h2 class="accordion-header" id="@hId">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@cId" aria-expanded="false" aria-controls="@cId">
                        @stHeading
                      </button>
                    </h2>
                    <div id="@cId" class="accordion-collapse collapse" data-bs-parent="#@accId" aria-labelledby="@hId">
                      <div class="accordion-body pt-0">
                        @if (stTimes.Any())
                        {
                            foreach (var t in stTimes)
                            {
                                var tc = t.Content;
                                var lbl = tc?.Value<string>("tekstur", culture: culture, fallback: Fallback.ToLanguage);
                                var tm  = tc?.Value<string>("tid",     culture: culture, fallback: Fallback.ToLanguage);

                                if (!string.IsNullOrWhiteSpace(lbl) || !string.IsNullOrWhiteSpace(tm))
                                {
                                    <div class="hours-row">
                                      @lbl
                                      @if (!string.IsNullOrWhiteSpace(tm))
                                      {
                                          <span class="time">@tm</span>
                                      }
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <!-- optional fallback -->
                            <div class="hours-row">Mánadag – Hósdag <span class="time">08:00 – 17:00</span></div>
                        }

                        @* station "leinki" under the hours, svg preserved *@
                        @if (!string.IsNullOrWhiteSpace(stLinkUrl))
                        {
                            <a href="@stLinkUrl" target="@stLinkTarget" rel="@(stLinkTarget == "_blank" ? "noopener" : null)" class="link-more">
                              @stLinkText
                              <svg class="arr" viewBox="0 0 24 24"><path d="M5 12h14M13 5l7 7-7 7"/></svg>
                            </a>
                        }
                      </div>
                    </div>
                  </div>
              }
          }
        </div> <!-- /accordion -->
      </div> <!-- /col-lg-6 -->
    </div>
  </div>
</section>
