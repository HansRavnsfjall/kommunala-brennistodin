{"version":3,"file":"form-copy-workflows-options-modal.element.js","sources":["../../../../src/section/forms/entity-actions/copy-workflows/modal/form-copy-workflows-options-modal.element.ts"],"sourcesContent":["import { FormsFormDetailRepository } from \"../../../repository/index.js\";\nimport { FORMS_FORM_TREE_ALIAS } from \"../../../tree/manifests.js\";\nimport type { FormsFormCopyWorkflowsOptionsModalData } from \"./index.js\";\nimport {\n  html,\n  customElement,\n  when,\n  state,\n  css,\n  unsafeHTML,\n} from \"@umbraco-cms/backoffice/external/lit\";\nimport { UmbModalBaseElement } from \"@umbraco-cms/backoffice/modal\";\nimport type {\n  FormDesign,\n  FormWorkflowWithTypeSettings,\n} from \"@umbraco-forms/generated\";\nimport type {\n  UmbTreeElement,\n  UmbTreeItemModelBase,\n} from \"@umbraco-cms/backoffice/tree\";\nimport { UMB_NOTIFICATION_CONTEXT } from \"@umbraco-cms/backoffice/notification\";\n\n@customElement(\"forms-form-copy-workflows-options-modal\")\nexport class FormsFormCopyWorkflowsOptionsModalElement extends UmbModalBaseElement<FormsFormCopyWorkflowsOptionsModalData> {\n  #sourceForm?: FormDesign | null;\n\n  @state()\n  private _selectedWorkflows: Array<string> = [];\n\n  @state()\n  private _destinationForm?: FormDesign | null;\n\n  #formDetailRepository = new FormsFormDetailRepository(this);\n\n  #notificationContext?: typeof UMB_NOTIFICATION_CONTEXT.TYPE;\n\n  constructor() {\n    super();\n\n    this.consumeContext(UMB_NOTIFICATION_CONTEXT, (instance) => {\n      this.#notificationContext = instance;\n    });\n  }\n\n  async connectedCallback() {\n    super.connectedCallback();\n\n    if (!this.data?.unique) return;\n    const { data } = await this.#formDetailRepository.requestByUnique(\n      this.data.unique,\n    );\n    if (!data) {\n      return;\n    }\n    this.#sourceForm = data;\n    this._selectedWorkflows = this.#allWorkflows(data).map((w) => w.id);\n    this.requestUpdate();\n  }\n\n  #allWorkflows(form: FormDesign) {\n    return form.formWorkflows.onSubmit\n      .concat(form.formWorkflows.onApprove)\n      .concat(form.formWorkflows.onReject);\n  }\n\n  #formHasWorkflows(form: FormDesign) {\n    return this.#allWorkflows(form).length > 0;\n  }\n\n  #isWorkflowSelected(workflowId: string) {\n    return this._selectedWorkflows.includes(workflowId);\n  }\n\n  #onWorkflowSelectedChanged(workflowId: string) {\n    const pos = this._selectedWorkflows.indexOf(workflowId);\n    if (pos >= 0) {\n      this._selectedWorkflows.splice(pos, 1);\n    } else {\n      this._selectedWorkflows.push(workflowId);\n    }\n    this.requestUpdate();\n  }\n\n  async #onTreeSelectionChange(event: CustomEvent) {\n    const target = event.target as UmbTreeElement;\n    const selection = target.getSelection();\n    if (selection.length > 0 && selection[0] != this.#sourceForm!.id) {\n      const destinationFormId = selection[0];\n      const { data } =\n        await this.#formDetailRepository.requestByUnique(destinationFormId);\n      if (data) {\n        this._destinationForm = data;\n      } else {\n        this._destinationForm = null;\n      }\n    } else {\n      this._destinationForm = null;\n    }\n\n    this.dispatchEvent(new CustomEvent(\"property-value-change\"));\n  }\n\n  #onSelectAnotherFormClick() {\n    this._destinationForm = null;\n  }\n\n  async #copyWorkflows() {\n    if (!this.#formDetailRepository)\n      throw new Error(\"Repository is not available\");\n    if (!this.#sourceForm) throw new Error(\"Source form is not available\");\n    if (!this._destinationForm)\n      throw new Error(\"Destination form is not available\");\n\n    const { error } = await this.#formDetailRepository.copyFormWorkflows(\n      this.#sourceForm.unique,\n      this._destinationForm.unique,\n      this._selectedWorkflows,\n    );\n\n    if (!error) {\n      this.#notificationContext?.peek(\"positive\", {\n        data: {\n          message: this.localize.term(\n            \"formCopyWorkflows_copiedWorkflowsSuccess\",\n          ),\n        },\n      });\n      this._submitModal();\n    } else {\n      this.#notificationContext?.peek(\"danger\", {\n        data: {\n          message: this.localize.term(\"formCopyWorkflows_copiedWorkflowsError\"),\n        },\n      });\n      this._rejectModal();\n    }\n  }\n\n  #renderWorkflowForStage(\n    workflows: FormWorkflowWithTypeSettings[],\n    stage: string,\n  ) {\n    return html` ${workflows.map(\n      (workflow) =>\n        html`<uui-table-row>\n          <uui-table-cell\n            >${this.localize.term(\"formWorkflows_\" + stage)}</uui-table-cell\n          >\n          <uui-table-cell>${workflow.name}</uui-table-cell>\n          <uui-table-cell>${workflow.workflowTypeName}</uui-table-cell>\n          <uui-table-cell>\n            <uui-toggle\n              ?checked=${this.#isWorkflowSelected(workflow.id)}\n              @change=${() => this.#onWorkflowSelectedChanged(workflow.id)}\n            ></uui-toggle>\n          </uui-table-cell>\n        </uui-table-row>`,\n    )}`;\n  }\n\n  render() {\n    return html` ${when(\n      this.#sourceForm,\n      () => html`\n        <umb-body-layout\n          headline=${this.localize.term(\"formCopyWorkflows_title\")}\n        >\n          <uui-box>\n            <p>\n              <b\n                >${this.localize.term(\n                  \"formCopyWorkflows_subtitle\",\n                  this.#sourceForm!.name,\n                )}</b\n              >\n            </p>\n            ${when(\n              !this.#formHasWorkflows(this.#sourceForm!),\n              () =>\n                html`<p>\n                  ${this.localize.term(\"formCopyWorkflows_noWorkflows\")}\n                </p>`,\n            )}\n            ${when(\n              this.#formHasWorkflows(this.#sourceForm!),\n              () => html`\n                <p>\n                  ${this.localize.term(\"formCopyWorkflows_selectedWorkflows\")}\n                </p>\n\n                <uui-table>\n                  <uui-table-head>\n                    <uui-table-head-cell\n                      >${this.localize.term(\n                        \"formCopyWorkflows_stage\",\n                      )}</uui-table-head-cell\n                    >\n                    <uui-table-head-cell\n                      >${this.localize.term(\n                        \"formEntries_workflowAuditName\",\n                      )}</uui-table-head-cell\n                    >\n                    <uui-table-head-cell\n                      >${this.localize.term(\n                        \"formEntries_workflowAuditType\",\n                      )}</uui-table-head-cell\n                    >\n                    <uui-table-head-cell\n                      >${this.localize.term(\n                        \"formCopyWorkflows_selected\",\n                      )}?</uui-table-head-cell\n                    >\n                  </uui-table-head>\n\n                  ${this.#renderWorkflowForStage(\n                    this.#sourceForm!.formWorkflows.onSubmit,\n                    \"onSubmit\",\n                  )}\n                  ${this.#renderWorkflowForStage(\n                    this.#sourceForm!.formWorkflows.onApprove,\n                    \"onApprove\",\n                  )}\n                  ${this.#renderWorkflowForStage(\n                    this.#sourceForm!.formWorkflows.onReject,\n                    \"onReject\",\n                  )}\n                </uui-table>\n\n                ${when(\n                  this._destinationForm,\n                  () =>\n                    html` <p>\n                      ${unsafeHTML(\n                        this.localize.term(\n                          \"formCopyWorkflows_selectedDestinationForm\",\n                          this._destinationForm!.name,\n                        ),\n                      )}\n                      <small\n                        >(<button\n                          type=\"button\"\n                          @click=${this.#onSelectAnotherFormClick}\n                        >\n                          ${this.localize.term(\n                            \"formCopyWorkflows_selectAnotherForm\",\n                          )}</button\n                        >)</small\n                      >\n                    </p>`,\n                )}\n                ${when(\n                  !this._destinationForm,\n                  () =>\n                    html` <p>\n                        ${this.localize.term(\n                          \"formCopyWorkflows_destinationForm\",\n                        )}\n                      </p>\n                      <umb-tree\n                        id=\"CopyToFolder\"\n                        alias=\"${FORMS_FORM_TREE_ALIAS}\"\n                        .props=${{\n                          hideTreeRoot: true,\n                          selectionConfiguration: {\n                            multiple: false,\n                          },\n                          selectableFilter: (item: UmbTreeItemModelBase) =>\n                            !item.isFolder &&\n                            item.unique !== this.#sourceForm!.unique,\n                        }}\n                        @selection-change=${this.#onTreeSelectionChange}\n                      ></umb-tree>`,\n                )}\n              `,\n            )}\n          </uui-box>\n          <uui-button\n            slot=\"actions\"\n            id=\"cancel\"\n            label=${this.localize.term(\"general_cancel\")}\n            @click=${this._rejectModal}\n            >${this.localize.term(\"general_cancel\")}</uui-button\n          >\n          <uui-button\n            form=\"CopyForm\"\n            slot=\"actions\"\n            type=\"submit\"\n            label=${this.localize.term(\"general_copy\")}\n            look=\"primary\"\n            color=\"positive\"\n            @click=${this.#copyWorkflows}\n            ?disabled=${!this.#sourceForm ||\n            !this._destinationForm ||\n            this._selectedWorkflows.length === 0}\n          ></uui-button>\n        </umb-body-layout>\n      `,\n    )}`;\n  }\n\n  static styles = [\n    css`\n      small a {\n        text-decoration: underline;\n        cursor: pointer;\n      }\n    `,\n  ];\n}\n\nexport default FormsFormCopyWorkflowsOptionsModalElement;\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"forms-form-copy-workflows-options-modal\": FormsFormCopyWorkflowsOptionsModalElement;\n  }\n}\n"],"names":["_sourceForm","_formDetailRepository","_notificationContext","_FormsFormCopyWorkflowsOptionsModalElement_instances","allWorkflows_fn","formHasWorkflows_fn","isWorkflowSelected_fn","onWorkflowSelectedChanged_fn","onTreeSelectionChange_fn","onSelectAnotherFormClick_fn","copyWorkflows_fn","renderWorkflowForStage_fn","FormsFormCopyWorkflowsOptionsModalElement","UmbModalBaseElement","__privateAdd","FormsFormDetailRepository","UMB_NOTIFICATION_CONTEXT","instance","__privateSet","_a","data","__privateGet","__privateMethod","w","html","when","unsafeHTML","FORMS_FORM_TREE_ALIAS","item","form","workflowId","pos","event","selection","destinationFormId","error","_b","workflows","stage","workflow","css","__decorateClass","state","customElement","FormsFormCopyWorkflowsOptionsModalElement$1"],"mappings":"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"}