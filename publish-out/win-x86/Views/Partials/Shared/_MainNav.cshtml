@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using System
@using System.Linq
@using System.Collections.Generic
@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Core.Routing
@using Umbraco.Extensions

@{
    // ---------------- Config / Aliases ----------------
    var inPreview = UmbracoContext?.InPreviewMode == true;
    const string AliasMegaRoot  = "megamenuFolder";
    string[] HeadingAliases     = { "megamenuHeading", "megamenuYvirskrift", "megamenuHeader" };
    const string PropHideInMenu = "hideInMenu";
    const string PropShortcut   = "shortcut"; // single or multi URL picker

    // ---------------- Fast helpers ----------------
    bool Hidden(IPublishedContent c)
        => c.HasProperty(PropHideInMenu) && (c.Value<bool?>(PropHideInMenu) ?? false);

    bool ShouldShow(IPublishedContent c)
        => c != null && (inPreview || c.IsPublished()) && c.IsVisible() && !Hidden(c);

    bool IsAlias(IPublishedContent c, params string[] aliases)
        => aliases.Any(a => a.Equals(c.ContentType?.Alias, StringComparison.OrdinalIgnoreCase));

    bool IsMegaRoot(IPublishedContent c) => IsAlias(c, AliasMegaRoot);
    bool IsHeading(IPublishedContent c)  => IsAlias(c, HeadingAliases);

    // Resolve each UDI only once per request (use string key to avoid GuidUdi)
    var udiUrlCache = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

    string ResolveShortcutUrl(Link l)
    {
        if (l?.Udi != null)
        {
            var key = l.Udi.ToString() ?? string.Empty;
            if (udiUrlCache.TryGetValue(key, out var cached)) return cached;

            var target = Umbraco.Content(l.Udi);
            var url = target?.Url(mode: UrlMode.Auto);
            url = string.IsNullOrWhiteSpace(url) ? "#" : url!;
            udiUrlCache[key] = url;
            return url;
        }
        return string.IsNullOrWhiteSpace(l?.Url) ? "#" : l!.Url!;
    }

    // Prefer single URL picker; fall back to multi URL picker
    Link? ReadShortcut(IPublishedContent c)
    {
        if (!c.HasProperty(PropShortcut)) return null;

        // Single
        var one = c.Value<Link>(PropShortcut);
        if (one != null) return one;

        // Multi
        var many = c.Value<IEnumerable<Link>>(PropShortcut);
        return many?.FirstOrDefault();
    }

    string NodeUrlOrFallback(IPublishedContent c)
    {
        var u = c.Url(mode: UrlMode.Auto);
        if (!string.IsNullOrWhiteSpace(u) && u != "/") return u!;

        // Rare fallback: build from segments
        var parts = c.Ancestors().Where(a => a.Level > 1).OrderBy(a => a.Level)
                     .Select(a => a.UrlSegment()).Where(s => !string.IsNullOrWhiteSpace(s)).ToList();
        var me = c.UrlSegment();
        if (!string.IsNullOrWhiteSpace(me)) parts.Add(me);
        var built = "/" + string.Join("/", parts);
        return string.IsNullOrWhiteSpace(built) || built == "/" ? "#" : built;
    }

    string GetHref(IPublishedContent c)
    {
        var sc = ReadShortcut(c);
        if (sc != null)
        {
            var scUrl = ResolveShortcutUrl(sc);
            if (!string.IsNullOrWhiteSpace(scUrl) && scUrl != "#") return scUrl;
        }
        return NodeUrlOrFallback(c);
    }

    bool HasUsableLink(IPublishedContent c)
    {
        var sc = ReadShortcut(c);
        if (sc != null && ResolveShortcutUrl(sc) is string s1 && !string.IsNullOrWhiteSpace(s1) && s1 != "#") return true;

        var u = NodeUrlOrFallback(c);
        return !string.IsNullOrWhiteSpace(u) && u != "#";
    }

    // ---------------- Data (build once) ----------------
    var root = Model?.AncestorOrSelf(1) ?? Model?.Root();
    var top  = (root?.Children ?? Enumerable.Empty<IPublishedContent>()).Where(ShouldShow).ToList();

    // ---------------- Renderers ----------------
    void RenderMega(IPublishedContent megaRoot)
    {
        var kids = (megaRoot.Children ?? Enumerable.Empty<IPublishedContent>()).Where(ShouldShow).ToList();
        var headings    = kids.Where(IsHeading).ToList();
        var directLinks = kids.Where(c => !IsHeading(c) && HasUsableLink(c)).ToList();

        var groups = new List<(string Title, List<IPublishedContent> Links)>();

        foreach (var h in headings)
        {
            var hKids  = (h.Children ?? Enumerable.Empty<IPublishedContent>()).Where(ShouldShow).ToList();
            var level1 = hKids.Where(HasUsableLink).ToList();
            var level2 = !level1.Any()
                ? hKids.SelectMany(ch => (ch.Children ?? Enumerable.Empty<IPublishedContent>()))
                       .Where(ShouldShow).Where(HasUsableLink).ToList()
                : new List<IPublishedContent>();

            var links = level1.Any() ? level1 : level2;
            if (links.Any()) groups.Add((h.Name, links));
        }

        if (directLinks.Any()) groups.Add((megaRoot.Name, directLinks));
        if (!groups.Any()) return;

        <div class="mega">
          <div class="container">
            <div class="row g-4">
              @foreach (var group in groups)
              {
                  var links = group.Links;
                  var lots  = links.Count > 6;
                  var col   = lots ? "col-12 col-lg-6" : "col-6 col-lg-3";
                  <div class="@col">
                    <h6>@group.Title</h6>
                    @if (links.Any())
                    {
                        if (lots)
                        {
                            var half = (int)Math.Ceiling(links.Count / 2.0);
                            var left = links.Take(half).ToList();
                            var right= links.Skip(half).ToList();
                            <div class="row">
                              <div class="col-12 col-md-6">
                                @foreach (var l in left)  { <a href="@GetHref(l)">@l.Name</a> }
                              </div>
                              <div class="col-12 col-md-6">
                                @foreach (var l in right) { <a href="@GetHref(l)">@l.Name</a> }
                              </div>
                            </div>
                        }
                        else
                        {
                            foreach (var l in links) { <a href="@GetHref(l)">@l.Name</a> }
                        }
                    }
                  </div>
              }
            </div>
          </div>
        </div>
    }

    void RenderTopItem(IPublishedContent node)
    {
        if (IsMegaRoot(node))
        {
            <li class="nav-item dropdown mega-parent position-static">
              <a class="nav-link is-mega" href="#" role="button" data-title="@node.Name" aria-expanded="false">
                @node.Name
              </a>
              @{ RenderMega(node); }
            </li>
            return;
        }

        var href = GetHref(node);
        if (string.IsNullOrWhiteSpace(href) || href == "#") return;

        <li class="nav-item">
          <a class="nav-link" href="@href">@node.Name</a>
        </li>
    }
}

<nav class="navbar navbar-expand-lg navbar-main sticky-top">
  <div class="container-fluid ps-container align-left">
    <a class="navbar-brand d-flex align-items-center gap-2 fw-700 text-white" href="/">
      <img src="~/images/logo-main.png" alt="kob" class="me-2 toplogo">
    </a>

   <button class="navbar-toggler" type="button"
        data-bs-toggle="collapse"
        data-bs-target="#mainNav"
        aria-controls="mainNav"
        aria-expanded="false"
        aria-label="Toggle navigation">
    <span class="toggler-icon top-bar"></span>
    <span class="toggler-icon middle-bar"></span>
    <span class="toggler-icon bottom-bar"></span>
</button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        @foreach (var node in top) { RenderTopItem(node); }
        <li class="en-mobile-link nav-item "><a class="nav-link" href="/english">English<a></li>
      </ul>
      <ul class="after-nav">
        <li class="searchcontainer-desktop">
          <div class="search-trigger">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="11" cy="11" r="7" stroke="white" stroke-width="2"/>
              <line x1="16.5" y1="16.5" x2="21" y2="21" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
        </li>
        <li class="en-link"><a class="nav-link" href="/english">EN</a></li>
      </ul>
    </div>
    <div class="searchcontainer-mobile">
  
</div>
  </div>
</nav>

<!-- Site Search Overlay -->
<section id="siteSearchOverlay" class="site-search-overlay" aria-hidden="true" hidden>
  <div class="container position-relative">
    <button class="site-search-close btn p-0" type="button" aria-label="Lat aftur">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 6l12 12M18 6L6 18" stroke="#6B8E23" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="row g-4 gx-5 mainsearchrow align-items-start">
      <!-- left: label + input -->
      <div class="col-12 col-lg-6">
        <div class="site-search-label text-uppercase fw-700">Skriva leitiord</div>
        <div class="site-search-input d-flex align-items-center">
          <input id="siteSearchField" class="form-control border-0 shadow-none" type="text" placeholder="Skriva..." autocomplete="off" />
          <button class="clear-btn btn p-0 ms-2" type="button" aria-label="Strika">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="#808080" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- right: grouped results -->
      <div class="col-12 col-lg-6">
        <div class="site-search-groups">

         <!-- ===== Group: AÐRAR SÍÐUR (topics) ===== -->
          <div class="group" data-group="topics">
            <a class="group-title group-title-link" data-group-link="topics" href="/leiting?q=&group=others">
              Síður <span class="count">(0)</span>
            </a>
            <ul class="group-list" id="topicsList"></ul>
          </div>


          <!-- ===== Group: Tíðindi ===== -->
          <div class="group" data-group="news">
            <a class="group-title group-title-link" data-group-link="news" href="/leiting?q=&group=news">
              Tíðindi <span class="count">(0)</span>
            </a>
            <ul class="group-list" id="newsList"></ul>
          </div>

          <!-- ===== Group: Skiljiskjáttan ===== -->
          <div class="group" data-group="guides">
            <a class="group-title group-title-link" data-group-link="guides" href="/leiting?q=&group=guides">
              Skiljivegleiðing <span class="count">(0)</span>
            </a>
            <ul class="group-list" id="guidesList"></ul>
          </div>

         
          <!-- No results -->
          <div class="site-search-noresults" hidden>Onki úrslit</div>

        </div>
      </div>
    </div>
  </div>
</section>
