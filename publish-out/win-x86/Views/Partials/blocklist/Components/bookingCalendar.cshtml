@* Views/Partials/BlockList/Components/bookingCalendar.cshtml *@
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockListItem>
@using System
@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Core.Strings
@using Umbraco.Extensions

@{
    var el = Model?.Content;
    var headline = el?.Value<string>("headline", fallback: Fallback.ToLanguage);
    IHtmlEncodedString? intro = el?.Value<IHtmlEncodedString>("intro", fallback: Fallback.ToLanguage);

    // OPTIONAL: media picker for the modal image. Change "visitImage" to your own alias.
    IPublishedContent? visitImage = el?.Value<IPublishedContent>("visitImage");
    var visMyndUrl = visitImage?.Url() ?? "/media/fs3p4kmb/inngongd.jpg"; // fallback image
}

<section class="booking-calendar py-5">
  <div class="container">
    <div class="row editor">
      <div class="col-md-6">
        @if (!string.IsNullOrWhiteSpace(headline))
        {
            <h1>@headline</h1>
        }
        @if (intro != null)
        {
            <div class="text-muted mb-4">@intro</div>
        }
      </div>

      <div class="col-md-6">
        <div class="gethere_box">
          <h2>Soleiðis finnur tú okkum</h2>
          <div class="links-holder">
            <a target="_blank" href="https://maps.app.goo.gl/fSNNnDKKBLaJ5yuy8">
              <svg class="pin" xmlns="http://www.w3.org/2000/svg" width="74" height="74" viewBox="0 0 74 74" fill="none" aria-hidden="true" focusable="false">
                <path d="M64.75 30.8333C64.75 52.4166 37 70.9166 37 70.9166C37 70.9166 9.25 52.4166 9.25 30.8333C9.25 23.4736 12.1737 16.4152 17.3778 11.2111C22.5819 6.00696 29.6402 3.08331 37 3.08331C44.3598 3.08331 51.4181 6.00696 56.6222 11.2111C61.8263 16.4152 64.75 23.4736 64.75 30.8333Z" stroke="#1E1E1E" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M37 40.0833C42.1086 40.0833 46.25 35.9419 46.25 30.8333C46.25 25.7247 42.1086 21.5833 37 21.5833C31.8914 21.5833 27.75 25.7247 27.75 30.8333C27.75 35.9419 31.8914 40.0833 37 40.0833Z" stroke="#1E1E1E" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>VÍS Á KORTI</span>
            </a>

            <a target="_blank" href="https://www.torshavn.fo/byur-og-ferdsla/vegir-og-ferdsla/bussleidin#pid=5">
              <svg class="buss" xmlns="http://www.w3.org/2000/svg" width="89" height="89" viewBox="0 0 89 89" fill="none">
                <path d="M21.75 55.6247C21.75 57.7979 22.5297 59.671 24.0752 61.2165C25.6205 62.7618 27.493 63.5416 29.666 63.5417H59.333C61.5063 63.5417 63.3794 62.7619 64.9248 61.2165C66.4701 59.6711 67.25 57.7979 67.25 55.6247V43.9997H21.75V55.6247ZM31.5205 48.7087C32.9346 48.7087 34.1207 49.1975 35.1074 50.1843C36.0941 51.171 36.583 52.3572 36.583 53.7712C36.5829 55.1849 36.0939 56.3705 35.1074 57.3571C34.1207 58.3439 32.9346 58.8337 31.5205 58.8337C30.1065 58.8337 28.9204 58.3439 27.9336 57.3571C26.9471 56.3705 26.4581 55.1849 26.458 53.7712C26.458 52.3572 26.9469 51.171 27.9336 50.1843C28.9204 49.1975 30.1065 48.7087 31.5205 48.7087ZM57.4785 48.7087C58.8926 48.7087 60.0787 49.1975 61.0654 50.1843C62.0522 51.171 62.541 52.3571 62.541 53.7712C62.5409 55.185 62.052 56.3705 61.0654 57.3571C60.0787 58.3439 58.8926 58.8337 57.4785 58.8337C56.0646 58.8336 54.8793 58.3438 53.8926 57.3571C52.9059 56.3704 52.4161 55.1851 52.416 53.7712C52.416 52.3571 52.9058 51.171 53.8926 50.1843C54.8792 49.1977 56.0647 48.7088 57.4785 48.7087ZM21.75 37.5837H67.25V25.4587H21.75V37.5837ZM44.6855 14.3337C38.0658 14.3337 33.1767 14.7189 30.0537 15.5075C26.9879 16.2817 24.8046 17.1529 23.5986 18.1579L22.5371 19.0417H66.5596L65.8271 18.2106C65.2967 17.6094 64.4936 17.0904 63.4639 16.6354C62.4291 16.1782 61.1331 15.7724 59.585 15.4128C56.4661 14.6882 51.4884 14.3337 44.6855 14.3337ZM19.041 66.3727L18.9131 66.2302C17.8352 65.0326 16.9672 63.7009 16.3086 62.2341C15.66 60.7893 15.333 59.2065 15.333 57.4792V22.2497C15.3331 19.7648 15.9085 17.6397 17.04 15.8542C18.1723 14.0676 19.8811 12.5904 22.1953 11.4333C26.8464 9.10776 34.2588 7.91669 44.5 7.91671C55.1188 7.91671 62.6195 9.06255 67.082 11.2936C69.2972 12.4012 70.9351 13.8633 72.0225 15.6706C73.1105 17.479 73.666 19.6649 73.666 22.2497V57.4792C73.666 59.2066 73.3391 60.7893 72.6904 62.2341C72.0319 63.7009 71.1638 65.0326 70.0859 66.2302L69.958 66.3727V74.1667C69.958 75.0915 69.6505 75.8434 69.0381 76.4557C68.4258 77.0678 67.6745 77.3746 66.75 77.3747H63.041C62.1166 77.3746 61.3652 77.0678 60.7529 76.4557C60.1406 75.8434 59.833 75.0915 59.833 74.1667V69.9587H29.166V74.1667C29.166 75.0915 28.8594 75.8434 28.2471 76.4557C27.6347 77.0681 26.8828 77.3747 25.958 77.3747H22.25C21.3253 77.3747 20.5733 77.068 19.9609 76.4557C19.3486 75.8434 19.041 75.0915 19.041 74.1667V66.3727Z" fill="#1D1B20" stroke="#FAF2E9"/>
              </svg>
              <span>BUSSLEIÐIN</span>
            </a>

            <a class="visMynd" data-image-url="@visMyndUrl">
              <svg class="image" xmlns="http://www.w3.org/2000/svg" width="91" height="91" viewBox="0 0 91 91" fill="none" aria-hidden="true" focusable="false">
                <path d="M18.9583 79.625C16.8729 79.625 15.0719 78.8983 13.5552 77.4448C12.1017 75.9281 11.375 74.1271 11.375 72.0417V18.9583C11.375 16.8729 12.1017 15.1035 13.5552 13.65C15.0719 12.1333 16.8729 11.375 18.9583 11.375H72.0417C74.1271 11.375 75.8965 12.1333 77.35 13.65C78.8667 15.1035 79.625 16.8729 79.625 18.9583V72.0417C79.625 74.1271 78.8667 75.9281 77.35 77.4448C75.8965 78.8983 74.1271 79.625 72.0417 79.625H18.9583ZM18.9583 72.0417H72.0417V18.9583H18.9583V72.0417ZM22.75 64.4583H68.25L54.0313 45.5L42.6563 60.6667L34.125 49.2917L22.75 64.4583ZM18.9583 72.0417V18.9583V72.0417Z" fill="#1D1B20" stroke="#FAF2E9" stroke-width="1.5"/>
              </svg>
              <span>VÍS MYND</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left: Calendar + Date/Time Selection -->
      <div class="col-lg-6">
        <div class="card border-0">
          <div class="card-body p-3">
            <!-- Month Navigation -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <button type="button" class="btn btn-link text-dark p-0 border-0" id="prevMonth" style="font-size: 1.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="19" viewBox="0 0 13 19" fill="none">
                  <path d="M0.994363 1.12295L10.4498 9.49622L0.994363 17.8695" stroke="#4B7019" stroke-width="3"/>
                </svg>
              </button>
              <h4 class="mb-0 text-uppercase fw-bold" id="monthTitle" style="color: #5a8a4a; letter-spacing: 2px; font-size: 1.1rem;">JANUAR 2026</h4>
              <button type="button" class="btn btn-link text-dark p-0 border-0" id="nextMonth" style="font-size: 1.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="19" viewBox="0 0 13 19" fill="none">
                  <path d="M0.994363 1.12295L10.4498 9.49622L0.994363 17.8695" stroke="#4B7019" stroke-width="3"/>
                </svg>
              </button>
            </div>

            <!-- Calendar Grid -->
            <div id="calendarGrid"></div>

            <!-- Date and Time Selection (below calendar) -->
            <div class="mt-3">
              <div class="mb-2">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Dagur</label>
                <input type="text" class="form-control form-control-sm bg-light" id="selectedDateDisplay" readonly placeholder="Vel ein dag í kalendara">
              </div>

              <div class="mb-0">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Vel tíð</label>
                <select class="form-select form-select-sm" id="timeSlot" name="timeSlot" required disabled>
                  <option value="">Vel dag fyrst</option>
                  <option value="08:30">KL. 08:30</option>
                  <option value="09:00">KL. 09:00</option>
                  <option value="09:30">KL. 09:30</option>
                  <option value="10:00">KL. 10:00</option>
                  <option value="10:30">KL. 10:30</option>
                  <option value="13:00">KL. 13:00</option>
                  <option value="13:30">KL. 13:30</option>
                  <option value="14:00">KL. 14:00</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Booking Form -->
      <div class="col-lg-6">
        <div class="card border-0">
          <div class="card-body p-3">
            <form id="bookingForm">
              <input type="hidden" id="selectedDateIso" name="selectedDateIso">

              <div class="mb-2">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Skúli, stovnur ella virki</label>
                <input type="text" class="form-control form-control-sm" name="firmValue" required>
              </div>

              <div class="mb-2">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Kontaktpersónur</label>
                <input type="text" class="form-control form-control-sm" name="nameValue" required>
              </div>

              <div class="mb-2">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">T-postur</label>
                <input type="email" class="form-control form-control-sm" name="email" required>
              </div>

              <div class="mb-2">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Telefon</label>
                <input type="tel" class="form-control form-control-sm" name="phone">
              </div>

              <div class="mb-2">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Tal av vitjandi</label>
                <input type="text"
                       class="form-control form-control-sm"
                       name="attendees"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       required
                       oninput="this.value = this.value.replace(/[^0-9]/g, '');">
              </div>

              <div class="mb-3">
                <label class="form-label text-uppercase small fw-bold mb-1" style="font-size: 0.75rem;">Viðmerking</label>
                <textarea class="form-control form-control-sm" name="notes" rows="3"></textarea>
              </div>

              <div class="alert alert-light border mt-2 mb-3 small mb-0 py-2">
                <small style="font-size: 0.75rem;">Bílegging verður góðkend av starvsfólki, áðrenn hon er bindandi.</small>
              </div>
              <div class="text-right">
                <button type="submit" class="btn btn-lg w-100 text-white fw-bold text-uppercase"
                        style="background-color: #5a8a4a; letter-spacing: 1px; padding: 0.75rem; font-size: 0.9rem;"
                        id="submitBtn" disabled>
                  Bílegg vitjan
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  @* Image Modal (Bootstrap 5) *@
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-dark">
        <button type="button" class="btn-close btn-close-white ms-auto me-2 mt-2" data-bs-dismiss="modal" aria-label="Lat aftur"></button>
        <div class="modal-body p-0">
          <img id="imageModalImg" src="" alt="Mynd" class="img-fluid w-100" />
        </div>
        <div class="modal-footer justify-content-between">
          <a id="imageModalDownload" class="btn btn-sm btn-light" download>Tak niður</a>
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Lat aftur</button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .visMynd { cursor: pointer; }

  #prevMonth svg{
    transform:rotate(180deg);
  }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    row-gap: 10px;
    column-gap: 30px;
    padding-bottom:21px;
    position: relative; /* ensure ::after positions under headers */
  }
  .calendar-grid::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    width: calc(100% - 20px);
    margin-left: 10px;
    top:50px;
    border-bottom: 1px solid #C0C0C0;
    pointer-events: none;
  }

  .booking-calendar button{
    text-decoration:none !important;
  }

  .alert {
    border-radius:0px;
  }

  .calendar-header {
    padding: 0.75rem 0.25rem;
    text-align: center;
    font-weight: 700;
    font-size: 0.75rem;
    background-color: #fff;
    color: #212529;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom:20px;
  }

  .calendar-day {
    aspect-ratio: 1;
    background-color: #fff;
    padding: 5px 10px;
    width:100%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    max-height:32px;
    border-radius:20px;
  }

  .calendar-day.inactive {
    color: #ced4da;
    cursor: default;
  }

  .calendar-day.past {
    color: #adb5bd;
    cursor: not-allowed;
  }

  .calendar-day.available {
    background-color: #d4e9d0;
    color: #2d5a2a;
    font-weight: 700;
    cursor: pointer;
  }

  .calendar-day.available:hover {
    background-color: #c0debb;
  }

  .calendar-day.selected {
    background-color: #5a8a4a !important;
    color: white !important;
    font-weight: 700;
  }

  .calendar-day.half-booked-morning-free {
    background: linear-gradient(to right, #d4e9d0 0%, #d4e9d0 50%, #f4c7c8 50%, #f4c7c8 100%);
    color: #2d5a2a;
    font-weight: 700;
    cursor: pointer;
  }

  .calendar-day.half-booked-morning-free:hover {
    background: linear-gradient(to right, #c0debb 0%, #c0debb 50%, #ebb9ba 50%, #ebb9ba 100%);
  }

  .calendar-day.half-booked-morning-free.selected {
    background: linear-gradient(to right, #5a8a4a 0%, #5a8a4a 50%, #dc3545 50%, #dc3545 100%) !important;
    color: white !important;
  }

  .calendar-day.half-booked-afternoon-free {
    background: linear-gradient(to right, #f4c7c8 0%, #f4c7c8 50%, #d4e9d0 50%, #d4e9d0 100%);
    color: #2d5a2a;
    font-weight: 700;
    cursor: pointer;
  }

  .calendar-day.half-booked-afternoon-free:hover {
    background: linear-gradient(to right, #ebb9ba 0%, #ebb9ba 50%, #c0debb 50%, #c0debb 100%);
  }

  .calendar-day.half-booked-afternoon-free.selected {
    background: linear-gradient(to right, #dc3545 0%, #dc3545 50%, #5a8a4a 50%, #5a8a4a 100%) !important;
    color: white !important;
  }

  .calendar-day.fully-booked {
    background-color: #f4c7c8;
    color: #721c24;
    font-weight: 700;
    cursor: not-allowed;
  }

  .day-number {
    font-size: 16px;
    line-height: 1;
  }

  .form-control:focus, .form-select:focus {
    border-color: #5a8a4a;
    box-shadow: 0 0 0 0.2rem rgba(90, 138, 74, 0.25);
  }

  .btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(90, 138, 74, 0.25);
  }

  @@media (max-width: 991px) {
    .calendar-day {
      min-height: 60px;
      padding: 0.25rem;
    }
    .day-number {
      font-size: 1.25rem;
    }
  }

  @@media (max-width: 576px) {
    .calendar-header {
      font-size: 0.625rem;
      padding: 0.5rem 0.125rem;
    }
    .calendar-day {
      min-height: 50px;
    }
    .day-number {
      font-size: 1rem;
    }
  }
</style>

<script>
(function() {
  const today = new Date();
  today.setHours(0,0,0,0);

  let currentYear = today.getFullYear();
  let currentMonth = today.getMonth() + 1;
  let selectedDate = null;
  let slotsData = [];

  const API_BASE = '/umbraco/api/bookingapi';

  const monthNamesFo = ['januar', 'februar', 'mars', 'apríl', 'mai', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'desember'];

  // MONDAY-FIRST headers
  const dayNamesFo = ['MÁN', 'TÝS', 'MIK', 'HÓS', 'FRÍ', 'LEY', 'SUN'];

  function updateMonthTitle() {
    const title = `${monthNamesFo[currentMonth - 1]} ${currentYear}`.toUpperCase();
    document.getElementById('monthTitle').textContent = title;
  }

  function getDaysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
  }

  // Converts JS getDay() (0=Sun...6=Sat) to Monday-first index 0..6
  function getFirstDayOfMonth(year, month) {
    const day = new Date(year, month - 1, 1).getDay();
    return day === 0 ? 6 : day - 1; // Monday=0 ... Sunday=6
  }

  function isPast(date) {
    const checkDate = new Date(date);
    checkDate.setHours(0, 0, 0, 0);
    return checkDate < today;
  }

  // Only Tuesday (2), Wednesday (3), Thursday (4) are bookable
  function isBookableDay(dayOfWeek) {
    return dayOfWeek === 2 || dayOfWeek === 3 || dayOfWeek === 4;
  }

  function formatDateFo(dateStr) {
    const [y, m, d] = dateStr.split('-').map(n => parseInt(n, 10));
    const date = new Date(y, m - 1, d);
    const dayNum = date.getDate();
    const monthName = monthNamesFo[date.getMonth()];
    const year = date.getFullYear();
    // Map matches JS getDay(): 0=Sun .. 6=Sat
    const faroeseDays = ['sunnudagur','mánadagur','týsdagur','mikudagur','hósdagur','fríggjadagur','leygardagur'];
    const dayName = faroeseDays[date.getDay()];
    return `${dayName} ${dayNum}. ${monthName} ${year}`;
  }

  function getDayStatus(dateStr) {
    const daySlots = slotsData.filter(s => s.date === dateStr);
    if (daySlots.length === 0) return { status: 'inactive', canBook: false };

    const keyOf = s => (s.slotKey || s.slot || s.slotValue);

    const morning   = daySlots.find(s => keyOf(s) === 'Morning');
    const afternoon = daySlots.find(s => keyOf(s) === 'Afternoon');

    const isFree = s => s && s.status === 'free';

    const morningFree   = isFree(morning);
    const afternoonFree = isFree(afternoon);

    if (morningFree && afternoonFree) {
      return { status: 'available', canBook: true, morningAvailable: true,  afternoonAvailable: true  };
    }
    if (morningFree && !afternoonFree) {
      return { status: 'half-booked-morning-free',  canBook: true, morningAvailable: true,  afternoonAvailable: false };
    }
    if (!morningFree && afternoonFree) {
      return { status: 'half-booked-afternoon-free', canBook: true, morningAvailable: false, afternoonAvailable: true  };
    }
    return { status: 'fully-booked', canBook: false, morningAvailable: false, afternoonAvailable: false };
  }

  function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    grid.className = 'calendar-grid';

    // Headers (MONDAY-FIRST)
    dayNamesFo.forEach(day => {
      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.textContent = day;
      grid.appendChild(header);
    });

    const daysInMonth = getDaysInMonth(currentYear, currentMonth);
    const firstDay = getFirstDayOfMonth(currentYear, currentMonth);

    // Empty cells before month starts
    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'calendar-day inactive';
      grid.appendChild(empty);
    }

    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const date = new Date(currentYear, currentMonth - 1, day);
      const dayOfWeek = date.getDay(); // 0=Sun .. 6=Sat

      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      cell.dataset.date = dateStr;

      const dayNum = document.createElement('div');
      dayNum.className = 'day-number';
      dayNum.textContent = day;
      cell.appendChild(dayNum);

      if (isPast(date)) {
        cell.classList.add('past');
      } else if (!isBookableDay(dayOfWeek)) {
        cell.classList.add('inactive');
      } else {
        const dayInfo = getDayStatus(dateStr);
        cell.classList.add(dayInfo.status);
        cell.dataset.morningAvailable = dayInfo.morningAvailable || false;
        cell.dataset.afternoonAvailable = dayInfo.afternoonAvailable || false;

        if (dayInfo.canBook) {
          cell.addEventListener('click', () => selectDate(dateStr, dayInfo));
        }
      }

      if (selectedDate === dateStr) {
        cell.classList.add('selected');
      }

      grid.appendChild(cell);
    }
  }

  function selectDate(dateStr, dayInfo) {
    selectedDate = dateStr;
    document.getElementById('selectedDateIso').value = dateStr;
    document.getElementById('selectedDateDisplay').value = formatDateFo(dateStr);

    // Update UI
    document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
    const selectedCell = document.querySelector(`[data-date="${dateStr}"]`);
    if (selectedCell) {
      selectedCell.classList.add('selected');
    }

    // Enable and filter time slot dropdown
    const timeSlot = document.getElementById('timeSlot');
    timeSlot.disabled = false;
    timeSlot.value = '';

    const morningTimes = ['08:30', '09:00', '09:30', '10:00', '10:30'];
    const afternoonTimes = ['13:00', '13:30', '14:00'];

    timeSlot.querySelectorAll('option').forEach(opt => {
      const val = opt.value;
      if (!val) {
        opt.textContent = 'Vel tíð';
        opt.disabled = false;
        return;
      }

      const isMorningTime = morningTimes.includes(val);
      const isAfternoonTime = afternoonTimes.includes(val);

      if ((isMorningTime && !dayInfo.morningAvailable) || (isAfternoonTime && !dayInfo.afternoonAvailable)) {
        opt.disabled = true;
        opt.style.display = 'none';
      } else {
        opt.disabled = false;
        opt.style.display = '';
      }
    });

    checkFormValidity();
  }

  function checkFormValidity() {
    const submitBtn = document.getElementById('submitBtn');
    const date = document.getElementById('selectedDateIso').value;
    const timeSlot = document.getElementById('timeSlot').value;
    const firmValue = document.querySelector('[name="firmValue"]').value;
    const nameValue = document.querySelector('[name="nameValue"]').value;
    const email = document.querySelector('[name="email"]').value;

    submitBtn.disabled = !(date && timeSlot && firmValue && nameValue && email);
  }

  async function loadSlots() {
    const url = `${API_BASE}/slots?year=${currentYear}&month=${currentMonth}&months=1`;
    try {
      const res = await fetch(url, {
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json();
      slotsData = Array.isArray(json?.slots) ? json.slots : [];

      renderCalendar();
      updateMonthTitle();
    } catch (err) {
      console.error('Failed to load slots:', err);
      document.getElementById('calendarGrid').innerHTML =
        '<div class="col-span-7 alert alert-danger m-3">Kundi ikki heinta tøkar tíðir.</div>';
    }
  }

  // Month nav
  document.getElementById('prevMonth').addEventListener('click', () => {
    const prev = new Date(currentYear, currentMonth - 2, 1);
    const startOfPrev = new Date(prev.getFullYear(), prev.getMonth(), 1);
    const startOfTodayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    if (startOfPrev < startOfTodayMonth) return;
    currentYear = prev.getFullYear();
    currentMonth = prev.getMonth() + 1;
    selectedDate = null;
    document.getElementById('selectedDateDisplay').value = '';
    document.getElementById('timeSlot').disabled = true;
    document.getElementById('timeSlot').value = '';
    loadSlots();
  });

  document.getElementById('nextMonth').addEventListener('click', () => {
    const next = new Date(currentYear, currentMonth, 1);
    currentYear = next.getFullYear();
    currentMonth = next.getMonth() + 1;
    selectedDate = null;
    document.getElementById('selectedDateDisplay').value = '';
    document.getElementById('timeSlot').disabled = true;
    document.getElementById('timeSlot').value = '';
    loadSlots();
  });

  // Form inputs affecting validity
  document.getElementById('timeSlot').addEventListener('change', checkFormValidity);
  document.querySelector('[name="firmValue"]').addEventListener('input', checkFormValidity);
  document.querySelector('[name="nameValue"]').addEventListener('input', checkFormValidity);
  document.querySelector('[name="email"]').addEventListener('input', checkFormValidity);

  document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target;
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;

    submitBtn.disabled = true;
    submitBtn.textContent = 'SENDIR...';

    const payload = {
      date: document.getElementById('selectedDateIso').value,
      timeSlot: document.getElementById('timeSlot').value,
      firmValue: form.firmValue.value,
      nameValue: form.nameValue.value,
      email: form.email.value,
      phone: form.phone.value,
      attendees: parseInt(form.attendees.value || '1', 10),
      notes: form.notes.value
    };

    try {
      const res = await fetch(`${API_BASE}/request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });

      const ct = res.headers.get('content-type') || '';
      let data = null;
      if (ct.includes('application/json')) data = await res.json();

      if (res.ok) {
        alert('Takk! Bílegging er móttikin og bíðar eftir góðkenning.');
        form.reset();
        selectedDate = null;
        document.getElementById('selectedDateDisplay').value = '';
        document.getElementById('timeSlot').disabled = true;
        submitBtn.disabled = true;
        loadSlots();
      } else {
        const msg = data?.error || `HTTP ${res.status}`;
        const details = data?.details ? `\n\n${data.details}` : '';
        alert(`Feilur: ${msg}${details}`);
      }
    } catch (err) {
      alert('Óvæntað villa: ' + String(err));
    } finally {
      submitBtn.textContent = originalText;
      checkFormValidity();
    }
  });

  // --- Show image modal (Bootstrap 5) ---
  const modalEl = document.getElementById('imageModal');
  const modalImg = document.getElementById('imageModalImg');
  const modalDl  = document.getElementById('imageModalDownload');

  document.querySelectorAll('.visMynd').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const url = link.getAttribute('data-image-url');
      if (!url) return;
      modalImg.src = url;
      modalDl.href = url;
      if (window.bootstrap && bootstrap.Modal) {
        const bsModal = new bootstrap.Modal(modalEl, { focus: true });
        bsModal.show();
      } else {
        // Fallback: open in a new tab if bootstrap JS is missing
        window.open(url, '_blank');
      }
    });
  });

  // Initialize calendar
  loadSlots();
})();
</script>
