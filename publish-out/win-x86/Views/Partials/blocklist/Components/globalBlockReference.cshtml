@* Global Block Reference (no custom DI) â€” fixed namespace collisions *@
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockListItem>

@using System.Globalization
@using Microsoft.AspNetCore.Mvc.ViewEngines
@using Microsoft.Extensions.Logging
@using Umbraco.Cms.Core
@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Extensions

@inject ICompositeViewEngine ViewEngine
@inject ILoggerFactory LoggerFactory

@functions {
    static readonly Guid GLOBAL_BLOCKS_CONTAINER_KEY = Guid.Parse("409f2e13-404d-4040-a120-341581f55942");
    const string GLOBAL_BLOCKS_PROPERTY_ALIAS = "modul";

    bool TryGetTargetKey(IPublishedElement el, string alias, string? culture, out Guid key, ILogger log)
    {
        key = Guid.Empty;

        var raw = el.Value<object?>(alias, culture: culture, fallback: Fallback.ToLanguage);
        if (raw is null) return false;

        switch (raw)
        {
            case Guid g when g != Guid.Empty:
                key = g; return true;

            case string s:
            {
                if (Guid.TryParse(s, out var g2)) { key = g2; return true; }

                // Use fully-qualified namespaces so Razor doesn't treat "Umbraco" as the helper
                if (global::Umbraco.Cms.Core.UdiParser.TryParse(s, out var parsedUdi))
                {
                    if (parsedUdi is global::Umbraco.Cms.Core.GuidUdi gudi && gudi.Guid != Guid.Empty)
                    { key = gudi.Guid; return true; }
                }
                return false;
            }

            case global::Umbraco.Cms.Core.GuidUdi gudi2 when gudi2.Guid != Guid.Empty:
                key = gudi2.Guid; return true;

            case global::Umbraco.Cms.Core.Udi udi2:
                if (udi2 is global::Umbraco.Cms.Core.GuidUdi g3 && g3.Guid != Guid.Empty)
                { key = g3.Guid; return true; }
                return false;

            default:
                log.LogWarning("GlobalBlockReference: alias '{Alias}' returned unsupported type {Type}.", alias, raw.GetType().FullName);
                return false;
        }
    }

    bool ViewExists(ICompositeViewEngine ve, string path) => ve.GetView(null, path, isMainPage: false).Success;
}

@{
    var log = LoggerFactory.CreateLogger("GlobalBlockReference");

    try
    {
        var culture = CultureInfo.CurrentUICulture?.Name;

        var referenceElement = Model?.Content;
        if (referenceElement is null) { log.LogWarning("Model.Content was null."); return; }

        Guid targetKey;
        var gotKey =
            TryGetTargetKey(referenceElement, "targetKey", culture, out targetKey, log) ||
            TryGetTargetKey(referenceElement, "targetBlockKey", culture, out targetKey, log);

        if (!gotKey || targetKey == Guid.Empty)
        { log.LogWarning("No valid target key."); return; }

        // OK to use the helper here: Umbraco.Content(Guid) gets the node by key
        var globalContainer = Umbraco.Content(GLOBAL_BLOCKS_CONTAINER_KEY);
        if (globalContainer is null)
        { log.LogWarning("Global container {Key} not found.", GLOBAL_BLOCKS_CONTAINER_KEY); return; }

        var blocks = globalContainer.Value<BlockListModel?>(GLOBAL_BLOCKS_PROPERTY_ALIAS, culture: culture, fallback: Fallback.ToLanguage);
        if (blocks is null || blocks.Count == 0)
        { log.LogWarning("Property '{Prop}' empty on container {Key}.", GLOBAL_BLOCKS_PROPERTY_ALIAS, GLOBAL_BLOCKS_CONTAINER_KEY); return; }

        var resolvedItem = blocks.FirstOrDefault(b => b?.Content?.Key == targetKey);
        if (resolvedItem is null)
        { log.LogWarning("No block with key {Key} found.", targetKey); return; }

        var alias = resolvedItem.Content?.ContentType?.Alias;
        if (string.IsNullOrWhiteSpace(alias))
        { log.LogWarning("Resolved block has empty alias."); return; }

        string ComponentPath(string a) => $"~/Views/Partials/BlockList/Components/{a}.cshtml";
        const string FallbackPath = "~/Views/Partials/BlockList/Default.cshtml";
        var viewPath = ComponentPath(alias);

        if (ViewExists(ViewEngine, viewPath))
        {
            @await Html.PartialAsync(viewPath, resolvedItem)
        }
        else
        {
            @await Html.PartialAsync(FallbackPath, resolvedItem)
        }
    }
    catch (Exception ex)
    {
        log.LogError(ex, "GlobalBlockReference crashed.");
        <!-- GlobalBlockReference failed; see logs -->
    }
}
    