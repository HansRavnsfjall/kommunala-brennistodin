{"version":3,"file":"data-list.repository.js","sources":["../../../../Umbraco.Community.Contentment.Client/src/property-editor-ui/data-list/data-list.repository.ts"],"sourcesContent":["// SPDX-License-Identifier: MPL-2.0\r\n// Copyright Â© 2024 Lee Kelleher\r\n\r\nimport { createExtensionApi } from '@umbraco-cms/backoffice/extension-api';\r\nimport { tryExecute } from '@umbraco-cms/backoffice/resources';\r\nimport { umbExtensionsRegistry } from '@umbraco-cms/backoffice/extension-registry';\r\nimport { umbHttpClient } from '@umbraco-cms/backoffice/http-client';\r\nimport { DataListService } from '../../api/sdk.gen.js';\r\nimport { UmbPropertyEditorConfigCollection } from '@umbraco-cms/backoffice/property-editor';\r\nimport { UmbRepositoryBase } from '@umbraco-cms/backoffice/repository';\r\nimport type { ContentmentConfigurationEditorValue, ContentmentDataListEditor } from '../../property-editor-ui/types.js';\r\nimport type { ContentmentDataSourceExtentionManifestType } from '../../extensions/data-source/data-source.extension.js';\r\nimport type { UmbApi } from '@umbraco-cms/backoffice/extension-api';\r\nimport type { UmbControllerHost, UmbControllerAlias } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbPropertyEditorConfig } from '@umbraco-cms/backoffice/property-editor';\r\nimport type { ContentmentListItem } from '../types.js';\r\nimport type { ContentmentListEditorExtentionManifestType } from '../../extensions/list-editor/list-editor.extension.js';\r\n\r\nexport class ContentmentDataListRepository extends UmbRepositoryBase implements UmbApi {\r\n\t#dataSourceLookup: Record<string, ContentmentDataSourceExtentionManifestType> = {};\r\n\t#listEditorLookup: Record<string, ContentmentListEditorExtentionManifestType> = {};\r\n\r\n\tconstructor(host: UmbControllerHost, controllerAlias?: UmbControllerAlias) {\r\n\t\tsuper(host, controllerAlias);\r\n\r\n\t\tthis.observe(umbExtensionsRegistry.byType('contentmentDataSource'), (manifests) => {\r\n\t\t\tmanifests.forEach((manifest) => {\r\n\t\t\t\tif (manifest.api && manifest.meta?.key) {\r\n\t\t\t\t\tthis.#dataSourceLookup[manifest.meta.key] = manifest;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tthis.observe(umbExtensionsRegistry.byType('contentmentListEditor'), (manifests) => {\r\n\t\t\tmanifests.forEach((manifest) => {\r\n\t\t\t\tif (manifest.meta?.key) {\r\n\t\t\t\t\tthis.#listEditorLookup[manifest.meta.key] = manifest;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tpublic async getEditor(\r\n\t\tdataSource: ContentmentConfigurationEditorValue | null | undefined,\r\n\t\tlistEditor: ContentmentConfigurationEditorValue | null | undefined,\r\n\t\tentityUnique?: string | null,\r\n\t\tpropertyAlias?: string | null,\r\n\t\tvariantId?: string | null\r\n\t): Promise<ContentmentDataListEditor | undefined> {\r\n\t\tif (!dataSource || !listEditor) return;\r\n\r\n\t\tlet propertyEditorUiAlias = '';\r\n\t\tlet config: UmbPropertyEditorConfig = [];\r\n\r\n\t\tconst dataSourceKey = dataSource.key;\r\n\t\tconst manifest = dataSourceKey ? this.#dataSourceLookup[dataSourceKey] : null;\r\n\t\tif (manifest) {\r\n\t\t\tconst api = await createExtensionApi(this, manifest, [this, this.controllerAlias]);\r\n\t\t\tconst items = (await api?.getItems(dataSource.value)) ?? [];\r\n\t\t\tconfig.push({ alias: 'items', value: items });\r\n\r\n\t\t\t// NOTE: Sets `dataSource` to null, as we don't want the server to attempt to process it.\r\n\t\t\tdataSource = null;\r\n\t\t}\r\n\r\n\t\t// TODO: [LK] Implement the `listEditor` lookup (for client-side only registrations).\r\n\r\n\t\tconst body = {\r\n\t\t\talias: propertyAlias,\r\n\t\t\tdataSource,\r\n\t\t\tid: entityUnique,\r\n\t\t\tlistEditor,\r\n\t\t\tvariant: variantId,\r\n\t\t};\r\n\r\n\t\tconst { data } = await tryExecute(this, DataListService.postDataListEditor({ client: umbHttpClient, body }));\r\n\r\n\t\tif (data?.propertyEditorUiAlias) {\r\n\t\t\tpropertyEditorUiAlias = data.propertyEditorUiAlias;\r\n\t\t}\r\n\r\n\t\tif (data?.config) {\r\n\t\t\tconfig.push(...data.config);\r\n\t\t}\r\n\r\n\t\treturn { propertyEditorUiAlias, config: new UmbPropertyEditorConfigCollection(config) };\r\n\t}\r\n\r\n\tpublic async getItemsByUrl(url: string): Promise<ContentmentListItem[]> {\r\n\t\t// NOTE: The security needs to be set for the request, otherwise it returns a 401 unauthorized error! [LK]\r\n\t\tconst { data } = await tryExecute(this, umbHttpClient.get({ security: [{ scheme: 'bearer', type: 'http' }], url }));\r\n\r\n\t\treturn data as Array<ContentmentListItem>;\r\n\t}\r\n}\r\n\r\nexport { ContentmentDataListRepository as api };\r\n"],"names":["ContentmentDataListRepository","UmbRepositoryBase","host","controllerAlias","__privateAdd","_dataSourceLookup","_listEditorLookup","umbExtensionsRegistry","manifests","manifest","_a","__privateGet","dataSource","listEditor","entityUnique","propertyAlias","variantId","propertyEditorUiAlias","config","dataSourceKey","api","createExtensionApi","items","body","data","tryExecute","DataListService","umbHttpClient","UmbPropertyEditorConfigCollection","url"],"mappings":";;;;;;;;;;;;;AAkBO,MAAMA,UAAsCC,EAAoC;AAAA,EAItF,YAAYC,GAAyBC,GAAsC;AAC1E,UAAMD,GAAMC,CAAe;AAJ5B,IAAAC,EAAA,MAAAC,GAAgF,CAAC;AACjF,IAAAD,EAAA,MAAAE,GAAgF,CAAC;AAKhF,SAAK,QAAQC,EAAsB,OAAO,uBAAuB,GAAG,CAACC,MAAc;AACxE,MAAAA,EAAA,QAAQ,CAACC,MAAa;;AAC/B,QAAIA,EAAS,SAAOC,IAAAD,EAAS,SAAT,QAAAC,EAAe,SAClCC,EAAA,MAAKN,GAAkBI,EAAS,KAAK,GAAG,IAAIA;AAAA,MAC7C,CACA;AAAA,IAAA,CACD,GAED,KAAK,QAAQF,EAAsB,OAAO,uBAAuB,GAAG,CAACC,MAAc;AACxE,MAAAA,EAAA,QAAQ,CAACC,MAAa;;AAC3B,SAAAC,IAAAD,EAAS,SAAT,QAAAC,EAAe,QAClBC,EAAA,MAAKL,GAAkBG,EAAS,KAAK,GAAG,IAAIA;AAAA,MAC7C,CACA;AAAA,IAAA,CACD;AAAA,EAAA;AAAA,EAGF,MAAa,UACZG,GACAC,GACAC,GACAC,GACAC,GACiD;AAC7C,QAAA,CAACJ,KAAc,CAACC,EAAY;AAEhC,QAAII,IAAwB,IACxBC,IAAkC,CAAC;AAEvC,UAAMC,IAAgBP,EAAW,KAC3BH,IAAWU,IAAgBR,EAAA,MAAKN,GAAkBc,CAAa,IAAI;AACzE,QAAIV,GAAU;AACP,YAAAW,IAAM,MAAMC,EAAmB,MAAMZ,GAAU,CAAC,MAAM,KAAK,eAAe,CAAC,GAC3Ea,IAAS,OAAMF,KAAA,gBAAAA,EAAK,SAASR,EAAW,WAAW,CAAC;AAC1D,MAAAM,EAAO,KAAK,EAAE,OAAO,SAAS,OAAOI,GAAO,GAG/BV,IAAA;AAAA,IAAA;AAKd,UAAMW,IAAO;AAAA,MACZ,OAAOR;AAAA,MACP,YAAAH;AAAA,MACA,IAAIE;AAAA,MACJ,YAAAD;AAAA,MACA,SAASG;AAAA,IACV,GAEM,EAAE,MAAAQ,EAAA,IAAS,MAAMC,EAAW,MAAMC,EAAgB,mBAAmB,EAAE,QAAQC,GAAe,MAAAJ,EAAM,CAAA,CAAC;AAE3G,WAAIC,KAAA,QAAAA,EAAM,0BACTP,IAAwBO,EAAK,wBAG1BA,KAAA,QAAAA,EAAM,UACFN,EAAA,KAAK,GAAGM,EAAK,MAAM,GAGpB,EAAE,uBAAAP,GAAuB,QAAQ,IAAIW,EAAkCV,CAAM,EAAE;AAAA,EAAA;AAAA,EAGvF,MAAa,cAAcW,GAA6C;AAEjE,UAAA,EAAE,MAAAL,MAAS,MAAMC,EAAW,MAAME,EAAc,IAAI,EAAE,UAAU,CAAC,EAAE,QAAQ,UAAU,MAAM,OAAA,CAAQ,GAAG,KAAAE,EAAA,CAAK,CAAC;AAE3G,WAAAL;AAAA,EAAA;AAET;AA3ECnB,IAAA,eACAC,IAAA;"}