{"version":3,"file":"datasource-workspace.context.js","sources":["../src/section/datasources/workspace/datasource-workspace-editor.element.ts","../src/section/datasources/workspace/datasource-workspace.context.ts"],"sourcesContent":["import { FORMS_DATASOURCE_WORKSPACE_CONTEXT } from \"./datasource-workspace.context-token.js\";\nimport { UmbElementMixin } from \"@umbraco-cms/backoffice/element-api\";\nimport {\n  LitElement,\n  css,\n  customElement,\n  html,\n  property,\n  state,\n} from \"@umbraco-cms/backoffice/external/lit\";\nimport type { UUIInputEvent } from \"@umbraco-cms/backoffice/external/uui\";\n\nconst elementName = \"forms-datasource-workspace-editor\";\n\n@customElement(elementName)\nexport class FormsDataSourceWorkspaceEditorElement extends UmbElementMixin(\n  LitElement,\n) {\n  @state()\n  private _dataSourceName = \"\";\n\n  @property({ type: String, attribute: false })\n  workspaceAlias?: string;\n\n  #workspaceContext?: typeof FORMS_DATASOURCE_WORKSPACE_CONTEXT.TYPE;\n\n  constructor() {\n    super();\n\n    this.consumeContext(FORMS_DATASOURCE_WORKSPACE_CONTEXT, (context) => {\n      this.#workspaceContext = context;\n      this.#observeId();\n    });\n  }\n\n  #observeId() {\n    if (!this.#workspaceContext) return;\n    this.observe(\n      this.#workspaceContext.data,\n      (data) => (this._dataSourceName = data?.name ?? \"\"),\n    );\n  }\n\n  #onChangeName(e: UUIInputEvent) {\n    this.#workspaceContext?.setName(e.target.value.toString());\n  }\n\n  render() {\n    return html` <umb-workspace-editor alias=\"Forms.Workspace.DataSources\">\n      <uui-input\n        slot=\"header\"\n        id=\"nameInput\"\n        label=${this.localize.term(\"placeholders_entername\")}\n        placeholder=${this.localize.term(\"placeholders_entername\")}\n        required\n        .value=${this._dataSourceName}\n        @input=\"${this.#onChangeName}\"\n      ></uui-input>\n    </umb-workspace-editor>`;\n  }\n\n  static styles = [\n    css`\n      :host {\n        display: block;\n        width: 100%;\n        height: 100%;\n      }\n\n      #nameInput {\n        flex: 1 1 auto;\n      }\n    `,\n  ];\n}\n\nexport default FormsDataSourceWorkspaceEditorElement;\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [elementName]: FormsDataSourceWorkspaceEditorElement;\n  }\n}\n","import {\n  FORMS_DATASOURCE_ENTITY_TYPE,\n  FORMS_DATASOURCE_ROOT_ENTITY_TYPE,\n} from \"../entities.js\";\nimport { FormsDataSourceDetailRepository } from \"../repository/index.js\";\nimport { FormsDataSourceTypeDetailRepository } from \"../../provider-types/datasource-types/repository/detail/index.js\";\nimport { DATASOURCE_WORKSPACE_ALIAS } from \"./manifests.js\";\nimport FormsWorkspaceEditorElement from \"./datasource-workspace-editor.element.js\";\nimport type { UmbSaveableWorkspaceContext } from \"@umbraco-cms/backoffice/workspace\";\nimport { UmbSubmittableWorkspaceContextBase } from \"@umbraco-cms/backoffice/workspace\";\nimport type { UmbControllerHostElement } from \"@umbraco-cms/backoffice/controller-api\";\nimport { UmbObjectState } from \"@umbraco-cms/backoffice/observable-api\";\nimport type { FormDataSource } from \"@umbraco-forms/generated\";\nimport { UMB_ACTION_EVENT_CONTEXT } from \"@umbraco-cms/backoffice/action\";\nimport {\n  UmbRequestReloadChildrenOfEntityEvent,\n  UmbRequestReloadStructureForEntityEvent,\n} from \"@umbraco-cms/backoffice/entity-action\";\nimport { UMB_NOTIFICATION_CONTEXT } from \"@umbraco-cms/backoffice/notification\";\nimport { UmbLocalizationController } from \"@umbraco-cms/backoffice/localization-api\";\n\nexport class FormsDataSourceWorkspaceContext\n  extends UmbSubmittableWorkspaceContextBase<FormDataSource>\n  implements UmbSaveableWorkspaceContext\n{\n  public readonly dataSourceRepository = new FormsDataSourceDetailRepository(\n    this,\n  );\n  public readonly dataSourceTypeRepository =\n    new FormsDataSourceTypeDetailRepository(this);\n\n  #data = new UmbObjectState<FormDataSource | undefined>(undefined);\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  #getDataPromise?: Promise<any>;\n\n  readonly data = this.#data.asObservable();\n  readonly unique = this.#data.asObservablePart((data) => data?.unique);\n  readonly name = this.#data.asObservablePart((data) => data?.name);\n  readonly id = this.#data.asObservablePart((data) => data?.unique);\n\n  constructor(host: UmbControllerHostElement) {\n    super(host, DATASOURCE_WORKSPACE_ALIAS);\n\n    this.routes.setRoutes([\n      {\n        path: \"create/:type\",\n        component: FormsWorkspaceEditorElement,\n        setup: async (_component, info) => {\n          const dataSourceType = info.match.params.type;\n          await this.create(dataSourceType);\n        },\n      },\n      {\n        path: \"edit/:unique\",\n        component: FormsWorkspaceEditorElement,\n        setup: (_component, info) => {\n          const unique = info.match.params.unique;\n          this.load(unique);\n        },\n      },\n    ]);\n  }\n\n  async load(id: string) {\n    this.#getDataPromise = this.dataSourceRepository.requestByUnique(id);\n    const { data } = await this.#getDataPromise;\n\n    if (data) {\n      this.setIsNew(false);\n      this.#data.update(data);\n    }\n  }\n\n  async create(type: string) {\n    const scaffold =\n      await this.dataSourceRepository.requestDataSourceScaffold();\n\n    let data = scaffold.data!;\n    data.formDataSourceTypeId = type;\n\n    if (this.modalContext) {\n      data = { ...data, ...this.modalContext.data.preset };\n    }\n    this.setIsNew(true);\n    this.#data.setValue(data);\n    return { data };\n  }\n\n  async requestSave() {\n    await this.submit();\n  }\n\n  async submit(): Promise<void> {\n    if (!this.#data.value) return;\n    if (!this.#data.value.unique) return;\n\n    if (this.#data.value.name.trim().length === 0) {\n      const notificationContext = await this.getContext(\n        UMB_NOTIFICATION_CONTEXT,\n      );\n      const localize = new UmbLocalizationController(this);\n      notificationContext?.peek(\"danger\", {\n        data: {\n          message: localize.term(\"formEdit_noNameForForm\"),\n        },\n      });\n\n      return;\n    }\n\n    const eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\n\n    if (this.getIsNew()) {\n      await this.dataSourceRepository.create(this.#data.value, null);\n\n      const event = new UmbRequestReloadChildrenOfEntityEvent({\n        entityType: FORMS_DATASOURCE_ROOT_ENTITY_TYPE,\n        unique: null,\n      });\n      eventContext?.dispatchEvent(event);\n      this.setIsNew(false);\n    } else {\n      await this.dataSourceRepository.save(this.#data.value);\n\n      const event = new UmbRequestReloadStructureForEntityEvent({\n        unique: this.getUnique()!,\n        entityType: this.getEntityType(),\n      });\n      eventContext?.dispatchEvent(event);\n    }\n  }\n\n  async loadDataSourceType(id: string) {\n    const { data } = await this.dataSourceTypeRepository.requestByUnique(id);\n    return data;\n  }\n\n  getData() {\n    return this.#data.getValue();\n  }\n\n  getUnique() {\n    return this.getData()?.unique || \"\";\n  }\n\n  getDataSourceTypeId() {\n    return this.getData()?.formDataSourceTypeId || \"\";\n  }\n\n  getEntityType(): string {\n    return FORMS_DATASOURCE_ENTITY_TYPE;\n  }\n\n  getName() {\n    return this.#data.getValue()?.name;\n  }\n\n  setName(name: string) {\n    this.#data.update({ name });\n  }\n\n  setDataSourceProperty(alias: string, value: unknown) {\n    this.#data.update({ [alias]: value });\n  }\n\n  getDataSourceProperty(alias: string) {\n    return this.getData()?.[alias];\n  }\n\n  async getWizardScaffold() {\n    const { data } =\n      await this.dataSourceRepository.requestDataSourceWizardScaffold(\n        this.getUnique(),\n      );\n    return data;\n  }\n\n  destroy() {\n    this.#data.destroy();\n\n    super.destroy();\n  }\n}\n\nexport const api = FormsDataSourceWorkspaceContext;\n"],"names":["_workspaceContext","_FormsDataSourceWorkspaceEditorElement_instances","observeId_fn","onChangeName_fn","elementName","FormsDataSourceWorkspaceEditorElement","UmbElementMixin","LitElement","__privateAdd","FORMS_DATASOURCE_WORKSPACE_CONTEXT","context","__privateSet","__privateMethod","html","__privateGet","data","_a","css","__decorateClass","state","property","customElement","FormsDataSourceWorkspaceContext","UmbSubmittableWorkspaceContextBase","host","DATASOURCE_WORKSPACE_ALIAS","_data","_getDataPromise","FormsDataSourceDetailRepository","FormsDataSourceTypeDetailRepository","UmbObjectState","FormsWorkspaceEditorElement","_component","info","dataSourceType","unique","id","type","notificationContext","UMB_NOTIFICATION_CONTEXT","localize","UmbLocalizationController","eventContext","UMB_ACTION_EVENT_CONTEXT","event","UmbRequestReloadChildrenOfEntityEvent","FORMS_DATASOURCE_ROOT_ENTITY_TYPE","UmbRequestReloadStructureForEntityEvent","FORMS_DATASOURCE_ENTITY_TYPE","name","alias","value","api"],"mappings":"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"}