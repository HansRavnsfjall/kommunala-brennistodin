{"version":3,"file":"document-mapper-property-editor.element.js","sources":["../src/property-editor/document-mapper/document-mapper-property-editor.element.ts"],"sourcesContent":["import { FORMS_FORM_WORKSPACE_CONTEXT } from \"../../section/forms/workspace/form-workspace.context-token.js\";\nimport {\n  html,\n  customElement,\n  property,\n  css,\n  when,\n} from \"@umbraco-cms/backoffice/external/lit\";\nimport type { UmbPropertyEditorUiElement } from \"@umbraco-cms/backoffice/property-editor\";\nimport { UmbLitElement } from \"@umbraco-cms/backoffice/lit-element\";\nimport type { UUIInputEvent } from \"@umbraco-ui/uui-input\";\nimport type {\n  Field,\n  MappedDocumentTypeModel,\n  MappedDocumentTypePropertyModel,\n  PickerItem,\n} from \"@umbraco-forms/generated\";\nimport { PickerService } from \"@umbraco-forms/generated\";\nimport type { UUISelectEvent } from \"@umbraco-ui/uui\";\nimport { tryExecute } from \"@umbraco-cms/backoffice/resources\";\n\nconst elementName = \"forms-document-mapper-property-editor\";\n\nexport type DocumentMapping = {\n  doctype: string;\n  nameField?: string;\n  nameStaticValue?: string;\n  properties: Array<MappedDocumentTypePropertyModel>;\n};\n\n@customElement(elementName)\nexport class FormsDocumentMapperPropertyUiElement\n  extends UmbLitElement\n  implements UmbPropertyEditorUiElement\n{\n  #workspaceContext?: typeof FORMS_FORM_WORKSPACE_CONTEXT.TYPE;\n  #value: string = \"\";\n  #mapping: DocumentMapping = this.#createScaffold();\n  #docTypes: Array<PickerItem> = [];\n  #fieldSelectOptions: Array<Option> = [];\n\n  @property({ type: String })\n  get value() {\n    return this.#value;\n  }\n  set value(value: string) {\n    const oldVal = this.#value;\n    this.#value = value;\n    this.requestUpdate(\"value\", oldVal);\n\n    this.#initializeMapping(value);\n  }\n\n  constructor() {\n    super();\n\n    this.consumeContext(FORMS_FORM_WORKSPACE_CONTEXT, (instance) => {\n      this.#workspaceContext = instance;\n      this.#initializeDocTypes();\n      this.#initializeFieldSelectOptions();\n    });\n  }\n\n  #createScaffold() {\n    return {\n      doctype: \"\",\n      nameField: \"\",\n      nameStaticValue: \"\",\n      properties: [],\n    };\n  }\n\n  #initializeMapping(value?: string) {\n    if (value && value.length > 0) {\n      this.#mapping = JSON.parse(value);\n      this.#cleanMapping();\n    }\n  }\n\n  #cleanMapping() {\n    // Remove the tracking values added previously in angularjs.\n    for (let index = 0; index < this.#mapping.properties.length; index++) {\n      const property = this.#mapping.properties[index];\n      delete property[\"$$hashKey\"];\n    }\n  }\n\n  async #initializeDocTypes() {\n    const { data } = await tryExecute(\n      this,\n      PickerService.getPickerDocumentType(),\n    );\n    if (data) {\n      this.#docTypes = data;\n      await this.#refreshMapping();\n      this.requestUpdate();\n    }\n  }\n\n  async #refreshMapping() {\n    if (this.#mapping.doctype.length === 0) return;\n\n    // We need the fields on load in case of renames or new properties added or removed.\n    const body: MappedDocumentTypeModel = {\n      doctypeAlias: this.#mapping.doctype,\n      currentProperties: this.#mapping.properties,\n    };\n\n    const { data } = await tryExecute(\n      this,\n      PickerService.postPickerDocumentTypeMappingsRefresh({ body }),\n    );\n    if (data) {\n      this.#mapping.properties = data;\n      this.#refreshValue();\n    }\n  }\n\n  #initializeFieldSelectOptions() {\n    const allFields = this.#workspaceContext!.getAllFields();\n    const options = allFields.map((f: Field) => {\n      return { name: f.caption, value: f.id };\n    });\n    options.unshift({ name: \"Select form field\", value: \"\" }); // Can't use just the uui-select placeholder here, as we want to be able to deselect.\n    this.#fieldSelectOptions = options;\n  }\n\n  #getDocTypeOptionsWithSelectedValue() {\n    return this.#docTypes.map((pi: PickerItem) => {\n      return {\n        name: pi.value,\n        value: pi.id,\n        selected: pi.id === this.#mapping.doctype ? true : undefined,\n      };\n    });\n  }\n\n  async #onDocTypeChange(e: UUISelectEvent) {\n    const value = e.target.value.toString();\n    this.#mapping.doctype = value;\n    await this.#updateProperties(value);\n    this.#refreshValue();\n  }\n\n  async #updateProperties(doctype: string) {\n    this.#mapping.properties = [];\n    if (doctype.length === 0) return;\n\n    const { data } = await tryExecute(\n      this,\n      PickerService.getPickerDocumentTypeByAliasProperties({\n        path: { alias: doctype },\n      }),\n    );\n    if (data) {\n      this.#mapping.properties = data.map((pi: PickerItem) => {\n        return { id: pi.id, value: pi.value, staticValue: \"\", field: \"\" };\n      });\n\n      this.#refreshValue();\n    }\n  }\n\n  #getFieldSelectOptionsWithSelectedValue(value?: string) {\n    return this.#fieldSelectOptions.map((o: Option) => {\n      return {\n        ...o,\n        selected: value && o.value === value ? true : undefined,\n      };\n    });\n  }\n\n  #onNameFieldSelectChange(e: UUISelectEvent) {\n    const value = e.target.value.toString();\n    this.#mapping.nameField = value.length > 0 ? value : undefined;\n    this.#refreshValue();\n  }\n\n  #onNameStaticValueChange(e: UUIInputEvent) {\n    const value = e.target.value.toString();\n    this.#mapping.nameStaticValue = value.length > 0 ? value : undefined;\n    this.#refreshValue();\n  }\n\n  #onPropertyFieldSelectChange(e: UUISelectEvent, idx: number) {\n    const value = e.target.value.toString();\n    this.#mapping.properties[idx].field = value;\n    this.#refreshValue();\n  }\n\n  #onPropertyStaticValueChange(e: UUIInputEvent, idx: number) {\n    const value = e.target.value.toString();\n    this.#mapping.properties[idx].staticValue = value;\n    this.#refreshValue();\n  }\n\n  #refreshValue() {\n    this.value = JSON.stringify(this.#mapping);\n    this.dispatchEvent(new CustomEvent(\"property-value-change\"));\n  }\n\n  async connectedCallback() {\n    super.connectedCallback();\n  }\n\n  render() {\n    return html` <div>\n      <uui-select\n        .options=${this.#getDocTypeOptionsWithSelectedValue()}\n        placeholder=\"Choose type\"\n        @change=${this.#onDocTypeChange}\n      >\n      </uui-select>\n\n      ${when(\n        this.#mapping.doctype.length > 0,\n        () => html`\n          <div class=\"umb-forms__save-as-node\">\n            <div class=\"umb-forms__save-as-node__head\">\n              <div class=\"umb-forms__save-as-node-field\">\n                <strong><small>Property</small></strong>\n              </div>\n              <div class=\"umb-forms__save-as-node-field\">\n                <strong><small>Field value</small></strong>\n              </div>\n              <div class=\"umb-forms__save-as-node-field\">\n                <strong><small>Static value</small></strong>\n              </div>\n            </div>\n\n            <div class=\"umb-forms__save-as-node-group\">\n              <div class=\"umb-forms__save-as-node-field\">\n                <small>Node Name</small>\n              </div>\n\n              <div class=\"umb-forms__save-as-node-field\">\n                <uui-select\n                  .options=${this.#getFieldSelectOptionsWithSelectedValue(\n                    this.#mapping.nameField,\n                  )}\n                  placeholder=\"Select form field\"\n                  @change=${this.#onNameFieldSelectChange}\n                >\n                </uui-select>\n              </div>\n\n              <div class=\"umb-forms__save-as-node-field\">\n                <uui-input\n                  type=\"text\"\n                  label=\"Static value\"\n                  placeholder=\"Static value\"\n                  .value=${this.#mapping.nameStaticValue || \"\"}\n                  @change=${this.#onNameStaticValueChange}\n                ></uui-input>\n              </div>\n            </div>\n\n            ${this.#mapping.properties.map((property, idx) => {\n              return html` <div class=\"umb-forms__save-as-node-group\">\n                <div class=\"umb-forms__save-as-node-field\">\n                  <small>${property.value}</small>\n                </div>\n\n                <div class=\"umb-forms__save-as-node-field\">\n                  <uui-select\n                    .options=${this.#getFieldSelectOptionsWithSelectedValue(\n                      property.field,\n                    )}\n                    placeholder=\"Map a field\"\n                    @change=${(e: UUISelectEvent) =>\n                      this.#onPropertyFieldSelectChange(e, idx)}\n                  >\n                  </uui-select>\n                </div>\n\n                <div class=\"umb-forms__save-as-node-field\">\n                  <uui-input\n                    type=\"text\"\n                    label=\"Static value\"\n                    placeholder=\"Static value\"\n                    .value=${property.staticValue}\n                    @change=${(e: UUIInputEvent) =>\n                      this.#onPropertyStaticValueChange(e, idx)}\n                  >\n                    ></uui-input\n                  >\n                </div>\n              </div>`;\n            })}\n          </div>\n        `,\n      )}\n    </div>`;\n  }\n\n  static styles = [\n    css`\n      .umb-forms__save-as-node {\n        flex-wrap: wrap;\n        margin-top: 20px;\n      }\n\n      .umb-forms__save-as-node-group {\n        display: flex;\n        flex-wrap: wrap;\n        flex-direction: row;\n        padding: 5px 0;\n      }\n\n      .umb-forms__save-as-node__head {\n        display: flex;\n        flex-direction: row;\n        flex-wrap: wrap;\n        width: 100%;\n      }\n\n      .umb-forms__save-as-node-field {\n        display: flex;\n        align-items: center;\n        flex: 0 0 37%;\n        margin: 3px;\n      }\n\n      .umb-forms__save-as-node-field:first-of-type {\n        flex: 0 0 20%;\n      }\n\n      .umb-forms__save-as-node .-full-width {\n        width: 100%;\n      }\n    `,\n  ];\n}\n\nexport default FormsDocumentMapperPropertyUiElement;\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [elementName]: FormsDocumentMapperPropertyUiElement;\n  }\n}\n"],"names":["_workspaceContext","_value","_mapping","_docTypes","_fieldSelectOptions","_FormsDocumentMapperPropertyUiElement_instances","createScaffold_fn","initializeMapping_fn","cleanMapping_fn","initializeDocTypes_fn","refreshMapping_fn","initializeFieldSelectOptions_fn","getDocTypeOptionsWithSelectedValue_fn","onDocTypeChange_fn","updateProperties_fn","getFieldSelectOptionsWithSelectedValue_fn","onNameFieldSelectChange_fn","onNameStaticValueChange_fn","onPropertyFieldSelectChange_fn","onPropertyStaticValueChange_fn","refreshValue_fn","elementName","FormsDocumentMapperPropertyUiElement","UmbLitElement","__privateAdd","__privateMethod","FORMS_FORM_WORKSPACE_CONTEXT","instance","__privateSet","__privateGet","value","oldVal","html","when","property","idx","e","index","data","tryExecute","PickerService","body","options","f","pi","doctype","o","css","__decorateClass","customElement","FormsDocumentMapperPropertyUiElement$1"],"mappings":"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"}