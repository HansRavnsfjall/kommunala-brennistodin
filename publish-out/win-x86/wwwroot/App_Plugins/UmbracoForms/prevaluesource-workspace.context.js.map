{"version":3,"file":"prevaluesource-workspace.context.js","sources":["../src/section/prevaluesources/workspace/prevaluesource-workspace-editor.element.ts","../src/section/prevaluesources/workspace/prevaluesource-workspace.context.ts"],"sourcesContent":["import { FORMS_PREVALUESOURCE_WORKSPACE_CONTEXT } from \"./prevaluesource-workspace.context-token.js\";\nimport { UmbElementMixin } from \"@umbraco-cms/backoffice/element-api\";\nimport {\n  LitElement,\n  css,\n  customElement,\n  html,\n  property,\n  state,\n} from \"@umbraco-cms/backoffice/external/lit\";\nimport type { UUIInputEvent } from \"@umbraco-cms/backoffice/external/uui\";\n\nconst elementName = \"forms-prevaluesource-workspace-editor\";\n\n@customElement(elementName)\nexport class FormsPrevalueSourceWorkspaceEditorElement extends UmbElementMixin(\n  LitElement,\n) {\n  @state()\n  private _prevalueSourceName = \"\";\n\n  @property({ type: String, attribute: false })\n  workspaceAlias?: string;\n\n  #workspaceContext?: typeof FORMS_PREVALUESOURCE_WORKSPACE_CONTEXT.TYPE;\n\n  constructor() {\n    super();\n\n    this.consumeContext(FORMS_PREVALUESOURCE_WORKSPACE_CONTEXT, (context) => {\n      this.#workspaceContext = context;\n      this.#observeId();\n    });\n  }\n\n  #observeId() {\n    if (!this.#workspaceContext) return;\n    this.observe(\n      this.#workspaceContext.data,\n      (data) => (this._prevalueSourceName = data?.name ?? \"\"),\n    );\n  }\n\n  #onChangeName(e: UUIInputEvent) {\n    this.#workspaceContext?.setName(e.target.value.toString());\n  }\n\n  render() {\n    return html` <umb-workspace-editor alias=\"Forms.Workspace.PrevalueSources\">\n      <uui-input\n        slot=\"header\"\n        id=\"nameInput\"\n        label=${this.localize.term(\"placeholders_entername\")}\n        placeholder=${this.localize.term(\"placeholders_entername\")}\n        required\n        .value=${this._prevalueSourceName}\n        @input=\"${this.#onChangeName}\"\n      ></uui-input>\n    </umb-workspace-editor>`;\n  }\n\n  static styles = [\n    css`\n      :host {\n        display: block;\n        width: 100%;\n        height: 100%;\n      }\n\n      #nameInput {\n        flex: 1 1 auto;\n      }\n    `,\n  ];\n}\n\nexport default FormsPrevalueSourceWorkspaceEditorElement;\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [elementName]: FormsPrevalueSourceWorkspaceEditorElement;\n  }\n}\n","import {\n  FORMS_PREVALUESOURCE_ENTITY_TYPE,\n  FORMS_PREVALUESOURCE_ROOT_ENTITY_TYPE,\n} from \"../entities.js\";\nimport { FormsPrevalueSourceDetailRepository } from \"../repository/index.js\";\nimport { FormsPrevalueSourceTypeDetailRepository } from \"../../provider-types/prevaluesource-types/repository/detail/index.js\";\nimport { PREVALUESOURCE_WORKSPACE_ALIAS } from \"./manifests.js\";\nimport FormsWorkspaceEditorElement from \"./prevaluesource-workspace-editor.element.js\";\nimport type { UmbSaveableWorkspaceContext } from \"@umbraco-cms/backoffice/workspace\";\nimport { UmbSubmittableWorkspaceContextBase } from \"@umbraco-cms/backoffice/workspace\";\nimport type { UmbControllerHostElement } from \"@umbraco-cms/backoffice/controller-api\";\nimport { UmbObjectState } from \"@umbraco-cms/backoffice/observable-api\";\nimport type { FieldPreValueSource, PreValue } from \"@umbraco-forms/generated\";\nimport { UMB_ACTION_EVENT_CONTEXT } from \"@umbraco-cms/backoffice/action\";\nimport {\n  UmbRequestReloadChildrenOfEntityEvent,\n  UmbRequestReloadStructureForEntityEvent,\n} from \"@umbraco-cms/backoffice/entity-action\";\nimport { UMB_NOTIFICATION_CONTEXT } from \"@umbraco-cms/backoffice/notification\";\nimport { UmbLocalizationController } from \"@umbraco-cms/backoffice/localization-api\";\n\nexport class FormsPrevalueSourceWorkspaceContext\n  extends UmbSubmittableWorkspaceContextBase<FieldPreValueSource>\n  implements UmbSaveableWorkspaceContext\n{\n  public readonly prevalueSourceRepository =\n    new FormsPrevalueSourceDetailRepository(this);\n  public readonly prevalueSourceTypeRepository =\n    new FormsPrevalueSourceTypeDetailRepository(this);\n\n  #data = new UmbObjectState<FieldPreValueSource | undefined>(undefined);\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  #getDataPromise?: Promise<any>;\n\n  readonly data = this.#data.asObservable();\n  readonly unique = this.#data.asObservablePart((data) => data?.unique);\n  readonly name = this.#data.asObservablePart((data) => data?.name);\n  readonly id = this.#data.asObservablePart((data) => data?.unique);\n\n  #prevalues = new UmbObjectState<Array<PreValue>>([]);\n\n  readonly prevalues = this.#prevalues.asObservable();\n\n  constructor(host: UmbControllerHostElement) {\n    super(host, PREVALUESOURCE_WORKSPACE_ALIAS);\n\n    this.routes.setRoutes([\n      {\n        path: \"create/:type\",\n        component: FormsWorkspaceEditorElement,\n        setup: async (_component, info) => {\n          const prevalueSourceType = info.match.params.type;\n          await this.create(prevalueSourceType);\n        },\n      },\n      {\n        path: \"edit/:unique\",\n        component: FormsWorkspaceEditorElement,\n        setup: (_component, info) => {\n          const unique = info.match.params.unique;\n          this.load(unique);\n        },\n      },\n    ]);\n  }\n\n  async load(id: string) {\n    this.#getDataPromise = this.prevalueSourceRepository?.requestByUnique(id);\n    const { data } = await this.#getDataPromise;\n\n    if (data) {\n      this.setIsNew(false);\n      this.#data.update(data);\n      await this.#refreshPrevalues(data.unique);\n    }\n  }\n\n  async create(type: string) {\n    const scaffold =\n      await this.prevalueSourceRepository?.requestPrevalueSourceScaffold();\n\n    let data = scaffold.data!;\n    data.fieldPreValueSourceTypeId = type;\n\n    if (this.modalContext) {\n      data = { ...data, ...this.modalContext.data.preset };\n    }\n    this.setIsNew(true);\n    this.#data.setValue(data);\n    return { data };\n  }\n\n  async requestSave() {\n    await this.submit();\n  }\n\n  async submit(): Promise<void> {\n    if (!this.#data.value) return;\n    if (!this.#data.value.unique) return;\n\n    if (this.#data.value.name.trim().length === 0) {\n      const notificationContext = await this.getContext(\n        UMB_NOTIFICATION_CONTEXT,\n      );\n      const localize = new UmbLocalizationController(this);\n      notificationContext?.peek(\"danger\", {\n        data: {\n          message: localize.term(\"formEdit_noNameForForm\"),\n        },\n      });\n\n      return;\n    }\n\n    const eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\n\n    if (this.getIsNew()) {\n      const { error } = await this.prevalueSourceRepository.create(\n        this.#data.value,\n        null,\n      );\n      if (error) return;\n\n      const event = new UmbRequestReloadChildrenOfEntityEvent({\n        entityType: FORMS_PREVALUESOURCE_ROOT_ENTITY_TYPE,\n        unique: null,\n      });\n      eventContext?.dispatchEvent(event);\n\n      this.setIsNew(false);\n\n      return;\n    }\n\n    const { error } = await this.prevalueSourceRepository.save(\n      this.#data.value,\n    );\n    if (error) return;\n\n    await this.#refreshPrevalues(this.#data.value.unique);\n\n    const event = new UmbRequestReloadStructureForEntityEvent({\n      unique: this.getUnique(),\n      entityType: this.getEntityType(),\n    });\n    eventContext?.dispatchEvent(event);\n  }\n\n  async loadPrevalueSourceType(id: string) {\n    const { data } =\n      await this.prevalueSourceTypeRepository.requestByUnique(id);\n    return data;\n  }\n\n  async #refreshPrevalues(id: string) {\n    const { data } = await this.prevalueSourceRepository.requestPrevalues(id);\n    if (data) {\n      this.#prevalues.update(data);\n    }\n  }\n\n  getData() {\n    return this.#data.getValue();\n  }\n\n  getPrevalues() {\n    const value = this.#prevalues.getValue();\n    return Object.keys(value).map((key) => value[key]); // Transform into an array.\n  }\n\n  getUnique() {\n    return this.getData()?.unique || \"\";\n  }\n\n  getPrevalueSourceTypeId() {\n    return this.getData()?.fieldPreValueSourceTypeId || \"\";\n  }\n\n  getEntityType(): string {\n    return FORMS_PREVALUESOURCE_ENTITY_TYPE;\n  }\n\n  getName() {\n    return this.#data.getValue()?.name;\n  }\n\n  setName(name: string) {\n    this.#data.update({ name });\n  }\n\n  setPrevalueSourceProperty(alias: string, value: unknown) {\n    this.#data.update({ [alias]: value });\n  }\n\n  getPrevalueSourceProperty(alias: string) {\n    return this.getData()?.[alias];\n  }\n\n  destroy() {\n    this.#data.destroy();\n\n    super.destroy();\n  }\n}\n\nexport const api = FormsPrevalueSourceWorkspaceContext;\n"],"names":["_workspaceContext","_FormsPrevalueSourceWorkspaceEditorElement_instances","observeId_fn","onChangeName_fn","elementName","FormsPrevalueSourceWorkspaceEditorElement","UmbElementMixin","LitElement","__privateAdd","FORMS_PREVALUESOURCE_WORKSPACE_CONTEXT","context","__privateSet","__privateMethod","html","__privateGet","data","e","_a","css","__decorateClass","state","property","customElement","FormsPrevalueSourceWorkspaceContext","UmbSubmittableWorkspaceContextBase","host","PREVALUESOURCE_WORKSPACE_ALIAS","_FormsPrevalueSourceWorkspaceContext_instances","_data","_getDataPromise","_prevalues","FormsPrevalueSourceDetailRepository","FormsPrevalueSourceTypeDetailRepository","UmbObjectState","FormsWorkspaceEditorElement","_component","info","prevalueSourceType","unique","id","refreshPrevalues_fn","type","notificationContext","UMB_NOTIFICATION_CONTEXT","localize","UmbLocalizationController","eventContext","UMB_ACTION_EVENT_CONTEXT","error","event","UmbRequestReloadChildrenOfEntityEvent","FORMS_PREVALUESOURCE_ROOT_ENTITY_TYPE","UmbRequestReloadStructureForEntityEvent","value","key","FORMS_PREVALUESOURCE_ENTITY_TYPE","name","alias","api"],"mappings":";;;;;;;;;;;;;;;;;;;;;;wXAAAA,GAAAC,GAAAC,GAAAC;AAYA,MAAMC,IAAc;AAGb,IAAMC,IAAN,cAAwDC;AAAA,EAC7DC;AACF,EAAE;AAAA,EASA,cAAc;AACZ,UAAA,GAZGC,EAAA,MAAAP,CAAA,GAIL,KAAQ,sBAAsB,IAK9BO,EAAA,MAAAR,CAAA,GAKE,KAAK,eAAeS,GAAwC,CAACC,MAAY;AACvE,MAAAC,EAAA,MAAKX,GAAoBU,CAAA,GACzBE,EAAA,MAAKX,GAAAC,CAAA,EAAL,KAAA,IAAA;AAAA,IAAA,CACD;AAAA,EAAA;AAAA,EAeH,SAAS;AACP,WAAOW;AAAA;AAAA;AAAA;AAAA,gBAIK,KAAK,SAAS,KAAK,wBAAwB,CAAC;AAAA,sBACtC,KAAK,SAAS,KAAK,wBAAwB,CAAC;AAAA;AAAA,iBAEjD,KAAK,mBAAmB;AAAA,kBACvBD,QAAKX,GAAAE,CAAA,CAAa;AAAA;AAAA;AAAA,EAAA;AAkBpC;AAlDEH,IAAA,oBAAA,QAAA;AATKC,IAAA,oBAAA,QAAA;AAoBLC,IAAU,WAAG;AACX,EAAKY,QAAKd,CAAA,KACV,KAAK;AAAA,IACHc,QAAKd,CAAA,EAAkB;AAAA,IACvB,CAACe,MAAU,KAAK,uBAAsBA,KAAA,gBAAAA,EAAM,SAAQ;AAAA,EAAA;AAExD;AAEAZ,IAAa,SAACa,GAAkB;;AAC9B,GAAAC,IAAAH,EAAA,MAAKd,OAAL,QAAAiB,EAAwB,QAAQD,EAAE,OAAO,MAAM;AACjD;AA9BWX,EA8CJ,SAAS;AAAA,EACda;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWF;AAtDQC,EAAA;AAAA,EADPC,EAAA;AAAM,GAHIf,EAIH,WAAA,uBAAA,CAAA;AAGRc,EAAA;AAAA,EADCE,EAAS,EAAE,MAAM,QAAQ,WAAW,IAAO;AAAA,GANjChB,EAOX,WAAA,kBAAA,CAAA;AAPWA,IAANc,EAAA;AAAA,EADNG,EAAclB,CAAW;AAAA,GACbC,CAAA;;ACMN,MAAMkB,UACHC,EAEV;AAAA,EAoBE,YAAYC,GAAgC;AAC1C,UAAMA,GAAMC,CAA8B;AAxBvC,IAAAlB,EAAA,MAAAmB;AASL,IAAAnB,EAAA,MAAAoB;AAGA;AAAA,IAAApB,EAAA,MAAAqB;AAOA,IAAArB,EAAA,MAAAsB;AAfA,SAAgB,2BACd,IAAIC,EAAoC,IAAI,GAC9C,KAAgB,+BACd,IAAIC,EAAwC,IAAI,GAElDrB,EAAA,MAAAiB,GAAQ,IAAIK,EAAgD,MAAS,IAKrE,KAAS,OAAOnB,EAAA,MAAKc,GAAM,aAAA,GAC3B,KAAS,SAASd,EAAA,MAAKc,GAAM,iBAAiB,CAACb,MAASA,KAAA,gBAAAA,EAAM,MAAM,GACpE,KAAS,OAAOD,EAAA,MAAKc,GAAM,iBAAiB,CAACb,MAASA,KAAA,gBAAAA,EAAM,IAAI,GAChE,KAAS,KAAKD,EAAA,MAAKc,GAAM,iBAAiB,CAACb,MAASA,KAAA,gBAAAA,EAAM,MAAM,GAEhEJ,EAAA,MAAAmB,GAAa,IAAIG,EAAgC,EAAE,IAEnD,KAAS,YAAYnB,EAAA,MAAKgB,GAAW,aAAA,GAKnC,KAAK,OAAO,UAAU;AAAA,MACpB;AAAA,QACE,MAAM;AAAA,QACN,WAAWI;AAAAA,QACX,OAAO,OAAOC,GAAYC,MAAS;AACjC,gBAAMC,IAAqBD,EAAK,MAAM,OAAO;AAC7C,gBAAM,KAAK,OAAOC,CAAkB;AAAA,QAAA;AAAA,MACtC;AAAA,MAEF;AAAA,QACE,MAAM;AAAA,QACN,WAAWH;AAAAA,QACX,OAAO,CAACC,GAAYC,MAAS;AAC3B,gBAAME,IAASF,EAAK,MAAM,OAAO;AACjC,eAAK,KAAKE,CAAM;AAAA,QAAA;AAAA,MAClB;AAAA,IACF,CACD;AAAA,EAAA;AAAA,EAGH,MAAM,KAAKC,GAAY;;AACrB,IAAA5B,EAAA,MAAKkB,IAAkBZ,IAAA,KAAK,6BAAL,gBAAAA,EAA+B,gBAAgBsB;AACtE,UAAM,EAAE,MAAAxB,EAAA,IAAS,MAAMD,EAAA,MAAKe;AAE5B,IAAId,MACF,KAAK,SAAS,EAAK,GACnBD,EAAA,MAAKc,GAAM,OAAOb,CAAI,GACtB,MAAMH,EAAA,MAAKe,GAAAa,GAAL,WAAuBzB,EAAK;AAAA,EACpC;AAAA,EAGF,MAAM,OAAO0B,GAAc;;AAIzB,QAAI1B,KAFF,QAAME,IAAA,KAAK,6BAAL,gBAAAA,EAA+B,kCAEnB;AACpB,WAAAF,EAAK,4BAA4B0B,GAE7B,KAAK,iBACP1B,IAAO,EAAE,GAAGA,GAAM,GAAG,KAAK,aAAa,KAAK,OAAA,IAE9C,KAAK,SAAS,EAAI,GAClBD,EAAA,MAAKc,GAAM,SAASb,CAAI,GACjB,EAAE,MAAAA,EAAA;AAAA,EAAK;AAAA,EAGhB,MAAM,cAAc;AAClB,UAAM,KAAK,OAAA;AAAA,EAAO;AAAA,EAGpB,MAAM,SAAwB;AAE5B,QADI,CAACD,EAAA,MAAKc,GAAM,SACZ,CAACd,EAAA,MAAKc,GAAM,MAAM,OAAQ;AAE9B,QAAId,EAAA,MAAKc,GAAM,MAAM,KAAK,KAAA,EAAO,WAAW,GAAG;AAC7C,YAAMc,IAAsB,MAAM,KAAK;AAAA,QACrCC;AAAA,MAAA,GAEIC,IAAW,IAAIC,EAA0B,IAAI;AACnD,MAAAH,KAAA,QAAAA,EAAqB,KAAK,UAAU;AAAA,QAClC,MAAM;AAAA,UACJ,SAASE,EAAS,KAAK,wBAAwB;AAAA,QAAA;AAAA,MACjD;AAGF;AAAA,IAAA;AAGF,UAAME,IAAe,MAAM,KAAK,WAAWC,CAAwB;AAEnE,QAAI,KAAK,YAAY;AACnB,YAAM,EAAE,OAAAC,EAAAA,IAAU,MAAM,KAAK,yBAAyB;AAAA,QACpDlC,EAAA,MAAKc,GAAM;AAAA,QACX;AAAA,MAAA;AAEF,UAAIoB,EAAO;AAEX,YAAMC,IAAQ,IAAIC,EAAsC;AAAA,QACtD,YAAYC;AAAA,QACZ,QAAQ;AAAA,MAAA,CACT;AACD,MAAAL,KAAA,QAAAA,EAAc,cAAcG,IAE5B,KAAK,SAAS,EAAK;AAEnB;AAAA,IAAA;AAGF,UAAM,EAAE,OAAAD,EAAA,IAAU,MAAM,KAAK,yBAAyB;AAAA,MACpDlC,EAAA,MAAKc,GAAM;AAAA,IAAA;AAEb,QAAIoB,EAAO;AAEX,UAAMpC,EAAA,MAAKe,GAAAa,GAAL,WAAuB1B,EAAA,MAAKc,GAAM,MAAM;AAE9C,UAAMqB,IAAQ,IAAIG,EAAwC;AAAA,MACxD,QAAQ,KAAK,UAAA;AAAA,MACb,YAAY,KAAK,cAAA;AAAA,IAAc,CAChC;AACD,IAAAN,KAAA,QAAAA,EAAc,cAAcG;AAAA,EAAK;AAAA,EAGnC,MAAM,uBAAuBV,GAAY;AACvC,UAAM,EAAE,MAAAxB,EAAA,IACN,MAAM,KAAK,6BAA6B,gBAAgBwB,CAAE;AAC5D,WAAOxB;AAAA,EAAA;AAAA,EAUT,UAAU;AACR,WAAOD,EAAA,MAAKc,GAAM,SAAA;AAAA,EAAS;AAAA,EAG7B,eAAe;AACb,UAAMyB,IAAQvC,EAAA,MAAKgB,GAAW,SAAA;AAC9B,WAAO,OAAO,KAAKuB,CAAK,EAAE,IAAI,CAACC,MAAQD,EAAMC,CAAG,CAAC;AAAA,EAAA;AAAA,EAGnD,YAAY;;AACV,aAAOrC,IAAA,KAAK,cAAL,gBAAAA,EAAgB,WAAU;AAAA,EAAA;AAAA,EAGnC,0BAA0B;;AACxB,aAAOA,IAAA,KAAK,cAAL,gBAAAA,EAAgB,8BAA6B;AAAA,EAAA;AAAA,EAGtD,gBAAwB;AACtB,WAAOsC;AAAA,EAAA;AAAA,EAGT,UAAU;;AACR,YAAOtC,IAAAH,EAAA,MAAKc,GAAM,SAAA,MAAX,gBAAAX,EAAuB;AAAA,EAAA;AAAA,EAGhC,QAAQuC,GAAc;AACpB,IAAA1C,EAAA,MAAKc,GAAM,OAAO,EAAE,MAAA4B,EAAA,CAAM;AAAA,EAAA;AAAA,EAG5B,0BAA0BC,GAAeJ,GAAgB;AACvD,IAAAvC,EAAA,MAAKc,GAAM,OAAO,EAAE,CAAC6B,CAAK,GAAGJ,GAAO;AAAA,EAAA;AAAA,EAGtC,0BAA0BI,GAAe;;AACvC,YAAOxC,IAAA,KAAK,QAAA,MAAL,gBAAAA,EAAiBwC;AAAA,EAAK;AAAA,EAG/B,UAAU;AACR,IAAA3C,EAAA,MAAKc,GAAM,QAAA,GAEX,MAAM,QAAA;AAAA,EAAQ;AAElB;AA9KEA,IAAA,eAGAC,IAAA,eAOAC,IAAA,eAnBKH,IAAA,eAsICa,mBAAkBD,GAAY;AAClC,QAAM,EAAE,MAAAxB,EAAA,IAAS,MAAM,KAAK,yBAAyB,iBAAiBwB,CAAE;AACxE,EAAIxB,KACFD,EAAA,MAAKgB,GAAW,OAAOf,CAAI;AAC7B;AA+CG,MAAM2C,KAAMnC;"}