{"version":3,"file":"security-workspace-base.context.js","sources":["../src/section/security/workspace/security-workspace-base.context.ts"],"sourcesContent":["import type { PackagePermissionsSecurityBase } from \"../entities.js\";\nimport { UMB_ACTION_EVENT_CONTEXT } from \"@umbraco-cms/backoffice/action\";\nimport type {\n  UmbControllerHost,\n  UmbControllerHostElement,\n} from \"@umbraco-cms/backoffice/controller-api\";\nimport { UmbRequestReloadStructureForEntityEvent } from \"@umbraco-cms/backoffice/entity-action\";\nimport { UmbObjectState } from \"@umbraco-cms/backoffice/observable-api\";\nimport type { UmbDetailRepository } from \"@umbraco-cms/backoffice/repository\";\nimport type { Component } from \"@umbraco-cms/backoffice/router\";\nimport type { UmbSaveableWorkspaceContext } from \"@umbraco-cms/backoffice/workspace\";\nimport { UmbSubmittableWorkspaceContextBase } from \"@umbraco-cms/backoffice/workspace\";\nimport { FORMS_CONTEXT } from \"@umbraco-forms/context\";\nimport type {\n  FormSecurityForGroup,\n  FormSecurityForUser,\n} from \"@umbraco-forms/generated\";\n\nexport interface FormsSecurityRepositoryConstructor<ItemType> {\n  new (host: UmbControllerHost): UmbDetailRepository<ItemType>;\n}\n\nexport interface FormsSecurityWorkspaceContext {\n  setProperty(\n    alias: keyof PackagePermissionsSecurityBase | \"startFolderIds\",\n    value: unknown,\n  ): void;\n  toggleFormSecurityAccess(formId: string): void;\n  setFormSecurityAccess(formId: string, value: boolean): void;\n}\n\nexport class FormsSecurityWorkspaceBaseContext<\n    SecurityType extends FormSecurityForGroup | FormSecurityForUser,\n  >\n  extends UmbSubmittableWorkspaceContextBase<SecurityType>\n  implements UmbSaveableWorkspaceContext, FormsSecurityWorkspaceContext\n{\n  protected _data = new UmbObjectState<SecurityType | undefined>(undefined);\n\n  #repository: UmbDetailRepository<SecurityType>;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  #getDataPromise?: Promise<any>;\n\n  #entityType: string;\n\n  readonly data = this._data.asObservable();\n  readonly unique = this._data.asObservablePart((data) => data?.unique);\n  readonly name = this._data.asObservablePart((data) => data?.name);\n  readonly id = this._data.asObservablePart((data) => data?.unique);\n\n  constructor(\n    host: UmbControllerHostElement,\n    workspaceAlias: string,\n    entityType: string,\n    repository: FormsSecurityRepositoryConstructor<SecurityType>,\n    component: Component,\n  ) {\n    super(host, workspaceAlias);\n\n    this.#repository = new repository(this);\n    this.#entityType = entityType;\n\n    this.routes.setRoutes([\n      {\n        path: \"edit/:unique\",\n        component,\n        setup: (_component, info) => {\n          const unique = info.match.params.unique;\n          this.load(unique);\n        },\n      },\n    ]);\n  }\n\n  getData() {\n    return this._data.getValue();\n  }\n\n  getUnique() {\n    return this.getData()?.unique || \"\";\n  }\n\n  getEntityType(): string {\n    return this.#entityType;\n  }\n\n  setProperty(\n    alias: keyof PackagePermissionsSecurityBase | \"startFolderIds\",\n    value: unknown,\n  ) {\n    if (!this._data.value) return;\n    this._data.update({ [alias]: value } as Partial<SecurityType>);\n  }\n\n  async load(id: string) {\n    this.#getDataPromise = this.#repository?.requestByUnique(id);\n    const { data } = await this.#getDataPromise;\n\n    if (data) {\n      this.setIsNew(false);\n      this._data.update(data);\n    }\n  }\n\n  async requestSave() {\n    await this.submit();\n  }\n\n  async submit(): Promise<void> {\n    if (!this._data.value) return;\n    if (!this._data.value.unique) return;\n\n    await this.#repository?.save(this._data.value);\n\n    // after saving ensure the global forms context fetches the new value\n    // to avoid having to refresh to see updated values\n    const formsContext = await this.getContext(FORMS_CONTEXT);\n    await formsContext?.getUserSecurity();\n\n    const event = new UmbRequestReloadStructureForEntityEvent({\n      unique: this.getUnique()!,\n      entityType: this.getEntityType(),\n    });\n\n    const eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\n    eventContext?.dispatchEvent(event);\n  }\n\n  toggleFormSecurityAccess(formId: string) {\n    if (!this._data.value) return;\n\n    const formsSecurity = this._data.value.formsSecurity.map((r) => ({\n      ...r,\n      ...(r.form === formId && {\n        hasAccess: !r.hasAccess,\n      }),\n    }));\n\n    this._data.update({ formsSecurity } as Partial<SecurityType>);\n  }\n\n  setFormSecurityAccess(formId: string, value: boolean) {\n    if (!this._data.value) return;\n\n    const formsSecurity = this._data.value.formsSecurity.map((r) => ({\n      ...r,\n      ...(r.form === formId && {\n        hasAccess: value,\n      }),\n    }));\n\n    this._data.update({ formsSecurity } as Partial<SecurityType>);\n  }\n\n  destroy() {\n    this._data.destroy();\n\n    super.destroy();\n  }\n}\n"],"names":["FormsSecurityWorkspaceBaseContext","UmbSubmittableWorkspaceContextBase","host","workspaceAlias","entityType","repository","component","__privateAdd","_repository","_getDataPromise","_entityType","UmbObjectState","data","__privateSet","_component","info","unique","_a","__privateGet","alias","value","id","formsContext","FORMS_CONTEXT","event","UmbRequestReloadStructureForEntityEvent","eventContext","UMB_ACTION_EVENT_CONTEXT","formId","formsSecurity","r"],"mappings":"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"}