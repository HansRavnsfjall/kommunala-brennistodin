{"version":3,"file":"text-with-field-picker-property-editor.element.js","sources":["../src/property-editor/text-with-field-picker/text-with-field-picker-property-editor.element.ts"],"sourcesContent":["import { FORMS_FORM_WORKSPACE_CONTEXT } from \"../../section/forms/workspace/form-workspace.context-token.js\";\nimport {\n  html,\n  customElement,\n  property,\n  css,\n  state,\n} from \"@umbraco-cms/backoffice/external/lit\";\nimport type { UmbPropertyEditorUiElement } from \"@umbraco-cms/backoffice/property-editor\";\nimport { UmbLitElement } from \"@umbraco-cms/backoffice/lit-element\";\nimport type { UUIInputEvent } from \"@umbraco-ui/uui-input\";\nimport type { UUISelectEvent } from \"@umbraco-ui/uui\";\nimport type { Field } from \"@umbraco-forms/generated\";\n\nconst elementName = \"text-with-field-picker-property-editor\";\nconst FREE_TEXT: string = \"FREE_TEXT\";\nconst FIELD_PICKER: string = \"FIELD_PICKER\";\n\n@customElement(elementName)\nexport class FormsTextWithFieldPickerPropertyUiElement\n  extends UmbLitElement\n  implements UmbPropertyEditorUiElement\n{\n  #workspaceContext?: typeof FORMS_FORM_WORKSPACE_CONTEXT.TYPE;\n  #fieldSelectOptions: Array<Field> = [];\n\n  @state()\n  inputMode = \"\";\n\n  #value = \"\";\n  @property()\n  get value() {\n    this.inputMode = this.#isMagicString(this.#value)\n      ? FIELD_PICKER\n      : FREE_TEXT; //Check current input mode when dialog is opened.\n    return this.#value;\n  }\n  set value(value: string) {\n    const oldVal = this.#value;\n    this.#value = value;\n    this.requestUpdate(\"value\", oldVal);\n  }\n\n  constructor() {\n    super();\n\n    this.consumeContext(FORMS_FORM_WORKSPACE_CONTEXT, (instance) => {\n      this.#workspaceContext = instance;\n      this.#initializeFieldSelectOptions();\n    });\n  }\n\n  #initializeFieldSelectOptions() {\n    this.#fieldSelectOptions = this.#workspaceContext!.getAllFields();\n  }\n\n  #changeInputMode(value: string) {\n    this.inputMode = value;\n  }\n\n  #onTextBoxChange(e: UUIInputEvent) {\n    const textValue = e.target.value.toString();\n\n    if (this.#isFieldMagicString(textValue)) {\n      this.#value = this.#deMagic(textValue);\n    } else {\n      this.#value = textValue;\n    }\n\n    this.#refreshValue();\n  }\n\n  #onFieldSelectChange(e: UUISelectEvent) {\n    this.#value = this.#toMagicString(e.target.value.toString());\n    this.#refreshValue();\n  }\n\n  #refreshValue() {\n    this.dispatchEvent(new CustomEvent(\"property-value-change\"));\n  }\n\n  /**\n   * Convert any input string into a magic string by appending '{' and '}'.\n   * @param {string} input\n   * @returns {string} original input string if it's a magic string already. Returns '' if input is falsy.\n   */\n  #toMagicString(input) {\n    if (!input) {\n      return \"\";\n    }\n\n    if (this.#isMagicString(input)) {\n      return input;\n    }\n\n    return `{${input}}`;\n  }\n\n  /**\n   * Convert any magic string into a normal text.\n   * @param {string} input\n   * @returns {string} normal text which is not wrapped by {}. Returns original input string if it is NOT a magic string.\n   */\n  #deMagic(input) {\n    return this.#isMagicString(input)\n      ? input.substring(1, this.#value.length - 1)\n      : input;\n  }\n\n  #isMagicString(input) {\n    const regex = new RegExp(/^{\\w+}$/gi);\n    return !!input && regex.test(input);\n  }\n\n  /**\n   * Check if the input string actually a magic string of a field.\n   * @param {string} input\n   */\n  #isFieldMagicString(input) {\n    if (!this.#isMagicString(input)) {\n      return false;\n    }\n\n    const fieldAliases = this.#workspaceContext!.getAllFields().map(\n      (field) => field.alias,\n    );\n    return fieldAliases.includes(this.#deMagic(input));\n  }\n\n  #isFreeTextMode() {\n    return this.inputMode === FREE_TEXT;\n  }\n\n  render() {\n    return html`\n      <uui-button-group>\n        <uui-button\n          label=\"Free text\"\n          look=${this.#isFreeTextMode() ? \"primary\" : \"secondary\"}\n          color=\"default\"\n          @click=${() => this.#changeInputMode(FREE_TEXT)}\n        ></uui-button>\n        <uui-button\n          label=\"Select field\"\n          look=${!this.#isFreeTextMode() ? \"primary\" : \"secondary\"}\n          color=\"default\"\n          @click=${() => this.#changeInputMode(FIELD_PICKER)}\n        ></uui-button>\n      </uui-button-group>\n      ${this.#isFreeTextMode()\n        ? html`\n            <div class=\"text-with-field-picker-margin-div\">\n              <uui-input\n                type=\"text\"\n                .value=${this.#value}\n                @change=${(e: UUIInputEvent) => this.#onTextBoxChange(e)}\n              >\n              </uui-input>\n            </div>\n          `\n        : html`\n            <div class=\"text-with-field-picker-margin-div\">\n              <uui-select\n                .options=${this.#fieldSelectOptions.map((f: Field) => ({\n                  name: f.caption,\n                  value: f.alias,\n                  selected: f.alias === this.#deMagic(this.#value),\n                })) ?? []}\n                placeholder=\"Select a field\"\n                @change=${(e: UUISelectEvent) => this.#onFieldSelectChange(e)}\n              >\n              </uui-select>\n            </div>\n          `}\n    `;\n  }\n\n  static styles = [\n    css`\n      .text-with-field-picker-margin-div {\n        margin-top: var(--uui-size-3);\n      }\n    `,\n  ];\n}\n\nexport default FormsTextWithFieldPickerPropertyUiElement;\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [elementName]: FormsTextWithFieldPickerPropertyUiElement;\n  }\n}\n"],"names":["_workspaceContext","_fieldSelectOptions","_value","_FormsTextWithFieldPickerPropertyUiElement_instances","initializeFieldSelectOptions_fn","changeInputMode_fn","onTextBoxChange_fn","onFieldSelectChange_fn","refreshValue_fn","toMagicString_fn","deMagic_fn","isMagicString_fn","isFieldMagicString_fn","isFreeTextMode_fn","elementName","FREE_TEXT","FIELD_PICKER","FormsTextWithFieldPickerPropertyUiElement","UmbLitElement","__privateAdd","FORMS_FORM_WORKSPACE_CONTEXT","instance","__privateSet","__privateMethod","__privateGet","value","oldVal","html","e","f","textValue","input","regex","field","css","__decorateClass","state","property","customElement","FormsTextWithFieldPickerPropertyUiElement$1"],"mappings":"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"}