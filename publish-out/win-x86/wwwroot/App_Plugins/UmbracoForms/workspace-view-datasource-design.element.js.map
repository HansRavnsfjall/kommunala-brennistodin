{"version":3,"file":"workspace-view-datasource-design.element.js","sources":["../src/section/datasources/workspace/views/design/workspace-view-datasource-design.element.ts"],"sourcesContent":["import { FORMS_DATASOURCE_WORKSPACE_CONTEXT } from \"../../datasource-workspace.context-token.js\";\nimport { ProviderTypeSettingsHelper } from \"../../../../provider-types/provider-type-settings-helper.class.js\";\nimport { UmbTextStyles } from \"@umbraco-cms/backoffice/style\";\nimport {\n  css,\n  html,\n  customElement,\n  state,\n  LitElement,\n  when,\n} from \"@umbraco-cms/backoffice/external/lit\";\nimport { UmbElementMixin } from \"@umbraco-cms/backoffice/element-api\";\nimport type { UmbWorkspaceViewElement } from \"@umbraco-cms/backoffice/workspace\";\nimport type {\n  FormDataSource,\n  PreValueSourceTypeWithSettings,\n} from \"@umbraco-forms/generated\";\nimport type {\n  UmbPropertyDatasetElement,\n  UmbPropertyValueData,\n} from \"@umbraco-cms/backoffice/property\";\nimport type { UmbPropertyEditorConfig } from \"@umbraco-cms/backoffice/property-editor\";\n\nconst elementName = \"workspace-view-datasource-design\";\n\n@customElement(elementName)\nexport class UmbWorkspaceViewDataSourceDesignElement\n  extends UmbElementMixin(LitElement)\n  implements UmbWorkspaceViewElement\n{\n  @state()\n  _dataSource?: FormDataSource;\n\n  @state()\n  _dataSourceType?: PreValueSourceTypeWithSettings;\n\n  @state()\n  _settingValues: Array<UmbPropertyValueData> = [];\n\n  @state()\n  _settingsConfig: Array<{ alias: string; value: UmbPropertyEditorConfig }> =\n    [];\n\n  @state()\n  _settingsConfigLoaded: boolean = false;\n\n  #workspaceContext?: typeof FORMS_DATASOURCE_WORKSPACE_CONTEXT.TYPE;\n\n  #providerTypeSettingsHelper?: ProviderTypeSettingsHelper;\n\n  #init: Promise<unknown>;\n\n  constructor() {\n    super();\n\n    this.#init = Promise.all([\n      this.consumeContext(FORMS_DATASOURCE_WORKSPACE_CONTEXT, (instance) => {\n        this.#workspaceContext = instance;\n      }).asPromise(),\n    ]);\n  }\n\n  async connectedCallback() {\n    super.connectedCallback();\n\n    await this.#init;\n    if (!this.#workspaceContext) return;\n\n    this._dataSource = this.#workspaceContext.getData();\n\n    const dataSourceTypeId = this._dataSource?.formDataSourceTypeId;\n    if (!dataSourceTypeId) return;\n\n    this._dataSourceType =\n      await this.#workspaceContext?.loadDataSourceType(dataSourceTypeId);\n    if (!this._dataSourceType) return;\n\n    this.#providerTypeSettingsHelper = new ProviderTypeSettingsHelper(\n      this,\n      this._dataSourceType,\n      \"formProviderDataSources\",\n    );\n\n    await this.#providerTypeSettingsHelper.loadSettingValueConverterApis();\n    await this.#initialize();\n  }\n\n  async #initialize() {\n    if (!this.#workspaceContext || !this._dataSource) return;\n\n    this._settingValues =\n      await this.#providerTypeSettingsHelper!.getSettingValues(\n        this._dataSource.settings,\n      );\n\n    this._settingsConfig =\n      await this.#providerTypeSettingsHelper!.getSettingsConfig(\n        this._settingValues,\n        this._dataSourceType!.settings,\n      );\n    this._settingsConfigLoaded = true;\n\n    // Initialize settings based on configured default values.\n    if (this.#workspaceContext?.getIsNew() && this._dataSourceType) {\n      const settings = structuredClone(this._dataSourceType.settings);\n      for (let i = 0; i < this._dataSourceType!.settings.length; i++) {\n        const setting = this._dataSourceType!.settings[i];\n        if (setting.defaultValue) {\n          settings[setting.alias] = setting.defaultValue;\n        }\n      }\n\n      this._settingValues = settings;\n    }\n  }\n\n  async #onSettingsChange(e: CustomEvent) {\n    const value = (e.target as UmbPropertyDatasetElement).value;\n    this._settingValues = value;\n\n    const settings =\n      await this.#providerTypeSettingsHelper!.getUpdatedSettingsForPersistence(\n        value,\n      );\n\n    this.#setPropertyValue(\"settings\", settings);\n  }\n\n  #setPropertyValue(alias: string, value: unknown) {\n    this.#workspaceContext?.setDataSourceProperty(alias, value);\n    this.dispatchEvent(new CustomEvent(\"valueChange\"));\n  }\n\n  render() {\n    return html` <uui-box>\n      <umb-property-layout\n        alias=\"type\"\n        .label=${this.localize.term(\"general_type\")}\n      >\n        <div slot=\"editor\">${this._dataSourceType?.name}</div>\n      </umb-property-layout>\n\n      ${when(\n        this.#providerTypeSettingsHelper &&\n          this._dataSourceType &&\n          this._settingsConfigLoaded,\n        () =>\n          html`<umb-property-dataset\n            .value=${this._settingValues}\n            @change=${this.#onSettingsChange}\n          >\n            ${this._dataSourceType!.settings.map(\n              (setting) => html`\n                <umb-property\n                  ?inert=${setting.isReadOnly}\n                  .label=${this.#providerTypeSettingsHelper!.getLocalizedSettingDetail(\n                    setting,\n                    \"Label\",\n                    setting.name,\n                  )}\n                  .description=${this.#providerTypeSettingsHelper!.getLocalizedSettingDetail(\n                    setting,\n                    \"Description\",\n                    setting.description,\n                  )}\n                  alias=${setting.alias}\n                  .config=${this.#providerTypeSettingsHelper!.getPropertyConfigForSetting(\n                    this._settingsConfig,\n                    setting,\n                  )}\n                  .appearance=${this.#providerTypeSettingsHelper!.getPropertyAppearanceForSetting(\n                    setting.view,\n                  )}\n                  property-editor-ui-alias=${setting.view}\n                >\n                </umb-property>\n              `,\n            )}\n          </umb-property-dataset>`,\n      )}\n    </uui-box>`;\n  }\n\n  static styles = [\n    UmbTextStyles,\n    css`\n      :host {\n        display: flex;\n        flex-direction: column;\n        margin: var(--uui-size-layout-1);\n      }\n\n      [inert] {\n        opacity: 0.5;\n      }\n    `,\n  ];\n}\n\nexport default UmbWorkspaceViewDataSourceDesignElement;\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [elementName]: UmbWorkspaceViewDataSourceDesignElement;\n  }\n}\n"],"names":["_workspaceContext","_providerTypeSettingsHelper","_init","_UmbWorkspaceViewDataSourceDesignElement_instances","initialize_fn","onSettingsChange_fn","setPropertyValue_fn","elementName","UmbWorkspaceViewDataSourceDesignElement","UmbElementMixin","LitElement","__privateAdd","__privateSet","FORMS_DATASOURCE_WORKSPACE_CONTEXT","instance","__privateGet","dataSourceTypeId","_a","_b","ProviderTypeSettingsHelper","__privateMethod","html","when","setting","settings","i","value","alias","UmbTextStyles","css","__decorateClass","state","customElement","UmbWorkspaceViewDataSourceDesignElement$1"],"mappings":"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"}