{"version":3,"file":"config-step.element-BdwVM2kj.js","sources":["../../../usync-publisher-assets/src/strategies/common/config-step.element.ts"],"sourcesContent":["import {\r\n\tJUMOO_PROCESSING_CONTEXT,\r\n\tPipelineContext,\r\n\tProcessStepElement,\r\n\tProcessStepElementBase,\r\n} from '@jumoo/processing';\r\nimport { SyncPublisherStratey } from '../constants';\r\nimport {\r\n\tcss,\r\n\tcustomElement,\r\n\thtml,\r\n\tnothing,\r\n\tstate,\r\n} from '@umbraco-cms/backoffice/external/lit';\r\nimport {\r\n\tPublisherProcessingOptions,\r\n\tPublishMode,\r\n\tSyncPublisherOptions,\r\n\tSyncPublishServerView,\r\n\tSyncSendOptions,\r\n} from '../../api';\r\nimport PublisherStrategyContext, {\r\n\tUSYNC_PUBLISHER_STRATEGY_CONTEXT,\r\n} from '../strategy.context';\r\n\r\n/**\r\n * @name SyncPublishPushConfigStepElement\r\n * @description this is the first step in the process, selecting the server to push to.\r\n */\r\n@customElement(SyncPublisherStratey.elements.config)\r\nexport default class SyncPublishPushConfigStepElement\r\n\textends ProcessStepElementBase\r\n\timplements ProcessStepElement\r\n{\r\n\t#pipelineContext?: PipelineContext;\r\n\r\n\t#strategyContext?: PublisherStrategyContext;\r\n\r\n\t@state()\r\n\tmode: PublishMode = PublishMode.PUSH;\r\n\r\n\t@state()\r\n\tentityType: string = '';\r\n\r\n\t@state()\r\n\tprimaryItem: string = '';\r\n\r\n\t@state()\r\n\tsendOptions?: SyncSendOptions;\r\n\r\n\t@state()\r\n\tserver?: SyncPublishServerView;\r\n\r\n\t@state()\r\n\tpublisherOptions?: SyncPublisherOptions | null;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(USYNC_PUBLISHER_STRATEGY_CONTEXT, (context) => {\r\n\t\t\tthis.#strategyContext = context;\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(JUMOO_PROCESSING_CONTEXT, (context) => {\r\n\t\t\tif (!context) return;\r\n\r\n\t\t\tthis.#pipelineContext = context;\r\n\r\n\t\t\tthis.observe(this.#pipelineContext.options, (options) => {\r\n\t\t\t\tif (!options) return;\r\n\r\n\t\t\t\tconst publisherOptions = options as PublisherProcessingOptions;\r\n\r\n\t\t\t\t// @ts-expect-error (the udi is serialized as a string.)\r\n\t\t\t\tthis.primaryItem = publisherOptions.items[0].udi;\r\n\t\t\t\tthis.entityType = publisherOptions.items[0].entityType;\r\n\t\t\t\tthis.mode = publisherOptions.mode;\r\n\t\t\t});\r\n\r\n\t\t\tthis.observe(this.#pipelineContext.pending, (pending) => {\r\n\t\t\t\tif (!pending) return;\r\n\t\t\t\tthis.publisherOptions = pending.publisherOptions as SyncPublisherOptions | null;\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tconnectedCallback() {\r\n\t\tsuper.connectedCallback();\r\n\r\n\t\tconst options = this.options as PublisherProcessingOptions;\r\n\t\tif (!options.server) return;\r\n\r\n\t\t// set the server here.\r\n\t\tthis._getServer(options.server);\r\n\t}\r\n\r\n\tasync _getServer(alias: string) {\r\n\t\tconst server = await this.#strategyContext?.getServer(alias);\r\n\t\tif (!server) return;\r\n\t\tthis.server = server;\r\n\r\n\t\tawait this._setupServer(server);\r\n\t}\r\n\r\n\tasync _setupServer(serverView: SyncPublishServerView) {\r\n\t\tthis.sendOptions = await this.#strategyContext?.getSyncSendOptionsByMode(\r\n\t\t\tserverView.alias,\r\n\t\t\tthis.mode,\r\n\t\t\tthis.entityType,\r\n\t\t);\r\n\r\n\t\t// set the value in pending.\r\n\t\tthis.#pipelineContext?.setPending({ server: serverView.alias });\r\n\r\n\t\tif (this.sendOptions) {\r\n\t\t\tthis._updateSendOptions(this.sendOptions);\r\n\t\t}\r\n\r\n\t\t// once we have a server we are ready to go ?\r\n\t\tthis.#pipelineContext?.setValid(true);\r\n\t}\r\n\r\n\t_dispatchServerChange(serverView: SyncPublishServerView) {\r\n\t\tthis.dispatchEvent(\r\n\t\t\tnew CustomEvent<SyncPublishServerView>('usync-server-update', {\r\n\t\t\t\tbubbles: true,\r\n\t\t\t\tcomposed: true,\r\n\t\t\t\tdetail: serverView,\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\t#onUpdateRelease(e: CustomEvent<string>) {\r\n\t\tif (!e.detail) return;\r\n\r\n\t\tconst processOptions = structuredClone(this.options as PublisherProcessingOptions);\r\n\r\n\t\tif (!processOptions.custom) {\r\n\t\t\tprocessOptions.custom = {};\r\n\t\t}\r\n\t\tprocessOptions.custom.releaseDate = e.detail;\r\n\r\n\t\tthis.#pipelineContext?.setPending({ custom: processOptions.custom });\r\n\t}\r\n\r\n\t#onUpdateSettings(e: CustomEvent<SyncSendOptions>) {\r\n\t\tif (!e.detail) return;\r\n\t\tthis._updateSendOptions(e.detail);\r\n\t}\r\n\r\n\t_updateSendOptions(sendOptions: SyncSendOptions) {\r\n\t\tif (!this.#strategyContext) return;\r\n\r\n\t\tconst processOptions = structuredClone(this.options as PublisherProcessingOptions);\r\n\r\n\t\tconst publishedOptions = processOptions.publisherOptions\r\n\t\t\t? this.#strategyContext.mergeToPublisherOptions(\r\n\t\t\t\t\tprocessOptions.publisherOptions,\r\n\t\t\t\t\tsendOptions,\r\n\t\t\t\t)\r\n\t\t\t: sendOptions;\r\n\r\n\t\t// set the values in pending this wat the ui doesn't update\r\n\t\t// and the pending values are set to the options when the user clicks next.\r\n\t\tthis.#pipelineContext?.setPending({ publisherOptions: publishedOptions });\r\n\t}\r\n\r\n\trender() {\r\n\t\treturn html`<div class=\"config\">\r\n\t\t\t${this.renderOptionsBox()} ${this.renderDeleteWarning()}\r\n\t\t</div>`;\r\n\t}\r\n\r\n\trenderDeleteWarning() {\r\n\t\tif (!this.mode || !this.publisherOptions) return nothing;\r\n\r\n\t\tif (\r\n\t\t\tthis.publisherOptions?.removeOrphans === false ||\r\n\t\t\t(this.mode !== PublishMode.SETTINGS_PULL && this.mode !== PublishMode.SETTINGS_PUSH)\r\n\t\t)\r\n\t\t\treturn nothing;\r\n\r\n\t\treturn html`<div class=\"warning\">\r\n\t\t\t<umb-localize key=\"usyncpublish_deleteWarning\"></umb-localize>\r\n\t\t</div>`;\r\n\t}\r\n\r\n\trenderOptionsBox() {\r\n\t\treturn html`<usync-publisher-sync-options\r\n\t\t\t.settings=${this.sendOptions}\r\n\t\t\t.publisherSettings=${this.server?.publisherSettings}\r\n\t\t\t.showAdvanced=${false}\r\n\t\t\t.canBeScheduled=${this.entityType === 'document'}\r\n\t\t\t@update-settings=${this.#onUpdateSettings}\r\n\t\t\t@update-release-date=${this.#onUpdateRelease}></usync-publisher-sync-options>`;\r\n\t}\r\n\r\n\tstatic styles = css`\r\n\t\t.config {\r\n\t\t\tdisplay: flex;\r\n\t\t\tflex-direction: column;\r\n\t\t\tgap: 20px;\r\n\t\t}\r\n\r\n\t\t.warning {\r\n\t\t\tpadding: 10px;\r\n\t\t\tbackground-color: var(--uui-color-warning-emphasis);\r\n\t\t\tcolor: var(--uui-color-warning-text);\r\n\t\t\tborder: 1px solid var(--uui-color-warning-border);\r\n\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t}\r\n\t`;\r\n}\r\n"],"names":["_pipelineContext","_strategyContext","_SyncPublishPushConfigStepElement_instances","onUpdateRelease_fn","onUpdateSettings_fn","SyncPublishPushConfigStepElement","ProcessStepElementBase","__privateAdd","PublishMode","USYNC_PUBLISHER_STRATEGY_CONTEXT","context","__privateSet","JUMOO_PROCESSING_CONTEXT","__privateGet","options","publisherOptions","pending","alias","server","_a","serverView","_b","_c","sendOptions","processOptions","publishedOptions","html","nothing","__privateMethod","css","__decorateClass","state","customElement","SyncPublisherStratey"],"mappings":"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"}