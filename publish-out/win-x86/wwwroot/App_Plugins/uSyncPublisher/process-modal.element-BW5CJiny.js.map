{"version":3,"file":"process-modal.element-BW5CJiny.js","sources":["../../../usync-publisher-assets/src/strategies/modal/process-modal.element.ts"],"sourcesContent":["import { UmbModalBaseElement } from '@umbraco-cms/backoffice/modal';\r\nimport {\r\n\tSyncPublisherProcessData,\r\n\tSyncPublisherProcessResults,\r\n} from './process-modal.token';\r\nimport {\r\n\tJumooProcessingModalInfo,\r\n\tPipelineContext,\r\n\tPipelineStatus,\r\n\tProcessingOptions,\r\n} from '@jumoo/processing';\r\nimport {\r\n\tcss,\r\n\tcustomElement,\r\n\thtml,\r\n\tnothing,\r\n\tstate,\r\n} from '@umbraco-cms/backoffice/external/lit';\r\nimport { SyncPublisherStratey } from '../constants';\r\nimport {\r\n\tChangeType,\r\n\tDependencyFlags,\r\n\tPublisherProcessingOptions,\r\n\tPublishMode,\r\n\tSyncItem,\r\n\tSyncPublishServerView,\r\n\tUdiModel,\r\n} from '../../api';\r\nimport PublisherStrategyContext from '../strategy.context';\r\nimport { UUIButtonState } from '@umbraco-cms/backoffice/external/uui';\r\n\r\n@customElement('usync-publisher-process-modal')\r\nexport class SyncPublisherProcessModalElement extends UmbModalBaseElement<\r\n\tSyncPublisherProcessData,\r\n\tSyncPublisherProcessResults\r\n> {\r\n\t#pipelineContext: PipelineContext;\r\n\t#strategyContext: PublisherStrategyContext;\r\n\r\n\t@state()\r\n\tstrategy?: string;\r\n\r\n\t@state()\r\n\tstatus: PipelineStatus | undefined;\r\n\r\n\t@state()\r\n\tisLastAction: boolean = false;\r\n\r\n\t@state()\r\n\toptions: ProcessingOptions | undefined;\r\n\r\n\t@state()\r\n\ttitle: string;\r\n\r\n\t@state()\r\n\tvalid: boolean = true;\r\n\r\n\t@state()\r\n\tprimaryItem?: UdiModel;\r\n\r\n\t@state()\r\n\tentityType?: string | null;\r\n\r\n\t@state()\r\n\thideServers: boolean = false;\r\n\r\n\t@state()\r\n\tcloseLabel: string = 'Cancel';\r\n\r\n\t@state()\r\n\tprivate _buttonState?: UUIButtonState;\r\n\r\n\t/** setup **/\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.#pipelineContext = new PipelineContext(this);\r\n\t\tthis.#strategyContext = new PublisherStrategyContext(this);\r\n\r\n\t\tthis.title = '...';\r\n\r\n\t\tthis.observe(this.#pipelineContext.finalized, (finalized) => {\r\n\t\t\tif (finalized) {\r\n\t\t\t\tthis.modalContext?.reject();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tasync connectedCallback() {\r\n\t\tsuper.connectedCallback();\r\n\r\n\t\tif (!this.data || !this.data?.items) return;\r\n\r\n\t\tthis.title = `${this.localize.term(`usyncpublish_processModalTitle${this.data.mode}`)} ...`;\r\n\r\n\t\tthis.primaryItem = this.data.items[0];\r\n\t\tthis.entityType = this.data.entityType;\r\n\r\n\t\tif (!this.data.server) return;\r\n\t\tawait this._setup(this.data.server.alias, this.data.mode);\r\n\t\tthis.hideServers = true;\r\n\t}\r\n\r\n\tasync _setup(server?: string, mode?: PublishMode) {\r\n\t\tif (!server) return;\r\n\r\n\t\tthis.title = `${this.localize.term(`usyncpublish_processModalTitle${mode}`)} ${server}`;\r\n\r\n\t\tthis.strategy =\r\n\t\t\t(await this._getStrategy(server, mode)) ??\r\n\t\t\tSyncPublisherStratey.strategies.realtimePush;\r\n\r\n\t\tthis.options = this.initializeOptions(server) as unknown as ProcessingOptions;\r\n\t}\r\n\r\n\tasync _getStrategy(server?: string, mode?: PublishMode) {\r\n\t\tif (!server) return null;\r\n\r\n\t\treturn (\r\n\t\t\t(await this.#strategyContext.getStrategyByServer(\r\n\t\t\t\tserver,\r\n\t\t\t\tmode ?? PublishMode.PUSH,\r\n\t\t\t)) ?? SyncPublisherStratey.strategies.realtimePush\r\n\t\t);\r\n\t}\r\n\r\n\tinitializeOptions(server: string): PublisherProcessingOptions | undefined {\r\n\t\tif (!this.data?.items) return;\r\n\r\n\t\tconst syncItems = this.data.items\r\n\t\t\t.map((udi) => {\r\n\t\t\t\tconst syncItem: SyncItem = {\r\n\t\t\t\t\tudi: udi,\r\n\t\t\t\t\tchange: ChangeType.UPDATE,\r\n\t\t\t\t\tflags: DependencyFlags.INCLUDE_CHILDREN,\r\n\t\t\t\t\tname: 'single',\r\n\t\t\t\t\tentityType: this.data?.entityType ?? '',\r\n\t\t\t\t};\r\n\r\n\t\t\t\treturn syncItem;\r\n\t\t\t})\r\n\t\t\t.filter((item) => item !== undefined);\r\n\r\n\t\treturn {\r\n\t\t\t$type: 'PublisherProcessingOptions',\r\n\t\t\titems: syncItems,\r\n\t\t\tserver: server,\r\n\t\t\tmode: this.data.mode ?? PublishMode.PUSH,\r\n\t\t\tentityType: this.data.entityType ?? '',\r\n\t\t\tcreateRestorePoint: false,\r\n\t\t};\r\n\t}\r\n\r\n\t/** user input **/\r\n\t#onProcess() {\r\n\t\tthis.hideServers = true;\r\n\t\tthis.#pipelineContext.triggerNext();\r\n\t}\r\n\r\n\t#onCancel() {\r\n\t\tthis.#closeModal();\r\n\t}\r\n\r\n\tasync #onClose() {\r\n\t\tawait this.#closeModal();\r\n\t}\r\n\r\n\tasync #closeModal() {\r\n\t\tif (!this.options?.server) {\r\n\t\t\tthis.modalContext?.reject();\r\n\t\t} else {\r\n\t\t\tthis.#pipelineContext.setValid(false);\r\n\t\t\tthis._buttonState = 'waiting';\r\n\t\t\tawait this.#pipelineContext.triggerClose();\r\n\t\t}\r\n\t}\r\n\r\n\tasync #onSelectServer(e: CustomEvent<SyncPublishServerView>) {\r\n\t\tif (!e.detail) return;\r\n\r\n\t\tawait this._setup(e.detail.alias, this.data?.mode);\r\n\t\tawait this._setupServer(e.detail);\r\n\t}\r\n\r\n\tasync _setupServer(serverView: SyncPublishServerView) {\r\n\t\tif (!this.options) return;\r\n\r\n\t\tthis.options.server = serverView.alias;\r\n\r\n\t\t// once we have a server we are ready to go ?\r\n\t\tthis.#pipelineContext?.setValid(true);\r\n\t}\r\n\r\n\t/** process events **/\r\n\t#onStatusChange(e: CustomEvent) {\r\n\t\tthis.status = e.detail.status;\r\n\t\tthis.isLastAction = e.detail.isLastAction;\r\n\t}\r\n\r\n\t#onModalUpdate(modalUpdate: CustomEvent<JumooProcessingModalInfo>) {\r\n\t\tthis.closeLabel = modalUpdate.detail.closeLabel ?? 'Cancel';\r\n\t\tthis.title = modalUpdate.detail.headline;\r\n\t}\r\n\r\n\t#onComplete() {}\r\n\r\n\t#onSetValid(e: CustomEvent<boolean>) {\r\n\t\tthis.valid = e.detail;\r\n\t}\r\n\r\n\t/** render **/\r\n\trender() {\r\n\t\treturn html`<umb-body-layout headline=${this.title}>\r\n\t\t\t${this.renderServerPicker()} ${this.renderProcess()}\r\n\t\t\t<div slot=\"actions\">${this.renderActions()}</div>\r\n\t\t</umb-body-layout>`;\r\n\t}\r\n\r\n\trenderServerPicker() {\r\n\t\treturn this.hideServers\r\n\t\t\t? nothing\r\n\t\t\t: html`\r\n\t\t\t\t\t<div class=\"server-picker\">\r\n\t\t\t\t\t\t<usync-publisher-server-picker\r\n\t\t\t\t\t\t\t.mode=${this.data?.mode}\r\n\t\t\t\t\t\t\t.hideUrl=${true}\r\n\t\t\t\t\t\t\t.entityType=${this.data?.entityType}\r\n\t\t\t\t\t\t\t.primary=${this.primaryItem?.uriValue}\r\n\t\t\t\t\t\t\t.useGrid=${true}\r\n\t\t\t\t\t\t\t@server-selected=${this.#onSelectServer}></usync-publisher-server-picker>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t`;\r\n\t}\r\n\r\n\trenderProcess() {\r\n\t\treturn !this.options?.server\r\n\t\t\t? nothing\r\n\t\t\t: html`\r\n\t\t\t\t\t<jumoo-pipeline\r\n\t\t\t\t\t\t.processor=${SyncPublisherStratey.pipelines.publish}\r\n\t\t\t\t\t\t.strategy=${this.strategy}\r\n\t\t\t\t\t\t.setup=${this.options}\r\n\t\t\t\t\t\t.debug=${false}\r\n\t\t\t\t\t\t@set-valid=${this.#onSetValid}\r\n\t\t\t\t\t\t@pipeline-status=${this.#onStatusChange}\r\n\t\t\t\t\t\t@pipeline-complete=${this.#onComplete}\r\n\t\t\t\t\t\t@pipeline-modal-update=${this.#onModalUpdate}></jumoo-pipeline>\r\n\t\t\t\t`;\r\n\t}\r\n\r\n\trenderActions() {\r\n\t\tconst actions =\r\n\t\t\tthis.status == PipelineStatus.WAITING\r\n\t\t\t\t? html`<uui-button\r\n\t\t\t\t\t\t@click=\"${this.#onProcess}\"\r\n\t\t\t\t\t\tcolor=\"positive\"\r\n\t\t\t\t\t\tlook=\"primary\"\r\n\t\t\t\t\t\tlabel=${this.localize.term(\r\n\t\t\t\t\t\t\t'usyncpublish_processModal' + (this.data?.mode ?? PublishMode.PUSH),\r\n\t\t\t\t\t\t)}></uui-button>`\r\n\t\t\t\t: nothing;\r\n\r\n\t\treturn this.isLastAction || !this.valid\r\n\t\t\t? html`<uui-button\r\n\t\t\t\t\t@click=\"${this.#onClose}\"\r\n\t\t\t\t\t.label=${this.localize.term('usyncpublish_processModalClose')}></uui-button>`\r\n\t\t\t: html`<uui-button\r\n\t\t\t\t\t\t.label=${this.closeLabel}\r\n\t\t\t\t\t\t@click=\"${this.#onCancel}\"\r\n\t\t\t\t\t\t.state=${this._buttonState}></uui-button>\r\n\t\t\t\t\t${actions}`;\r\n\t}\r\n\r\n\tstatic styles = css`\r\n\t\t:host {\r\n\t\t\tdisplay: block;\r\n\t\t\theight: 100%;\r\n\t\t}\r\n\r\n\t\t.server-picker {\r\n\t\t\tmargin-bottom: 20px;\r\n\t\t}\r\n\t`;\r\n}\r\n\r\nexport default SyncPublisherProcessModalElement;\r\n"],"names":["_pipelineContext","_strategyContext","_SyncPublisherProcessModalElement_instances","onProcess_fn","onCancel_fn","onClose_fn","closeModal_fn","onSelectServer_fn","onStatusChange_fn","onModalUpdate_fn","onComplete_fn","onSetValid_fn","SyncPublisherProcessModalElement","UmbModalBaseElement","__privateAdd","__privateSet","PipelineContext","PublisherStrategyContext","__privateGet","finalized","_a","server","mode","SyncPublisherStratey","PublishMode","udi","ChangeType","DependencyFlags","item","serverView","html","nothing","_b","_c","__privateMethod","actions","PipelineStatus","e","modalUpdate","css","__decorateClass","state","customElement","SyncPublisherProcessModalElement$1"],"mappings":";;;;;;;;;;;wYAAAA,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC;AAgCa,IAAAC,IAAN,cAA+CC,EAGpD;AAAA;AAAA,EAuCD,cAAc;AACP,UAAA,GA3CDC,EAAA,MAAAZ,CAAA,GAINY,EAAA,MAAAd,CAAA,GACAc,EAAA,MAAAb,CAAA,GASwB,KAAA,eAAA,IASP,KAAA,QAAA,IASM,KAAA,cAAA,IAGF,KAAA,aAAA,UAUfc,EAAA,MAAAf,GAAmB,IAAIgB,EAAgB,IAAI,CAAA,GAC3CD,EAAA,MAAAd,GAAmB,IAAIgB,EAAyB,IAAI,CAAA,GAEzD,KAAK,QAAQ,OAEb,KAAK,QAAQC,EAAA,MAAKlB,CAAiB,EAAA,WAAW,CAACmB,MAAc;;AAC5D,MAAIA,OACHC,IAAA,KAAK,iBAAL,QAAAA,EAAmB;AAAA,IACpB,CACA;AAAA,EAAA;AAAA,EAGF,MAAM,oBAAoB;;AAGzB,IAFA,MAAM,kBAAkB,GAEpB,GAAC,KAAK,QAAQ,GAACA,IAAA,KAAK,SAAL,QAAAA,EAAW,YAEzB,KAAA,QAAQ,GAAG,KAAK,SAAS,KAAK,iCAAiC,KAAK,KAAK,IAAI,EAAE,CAAC,QAErF,KAAK,cAAc,KAAK,KAAK,MAAM,CAAC,GAC/B,KAAA,aAAa,KAAK,KAAK,YAEvB,KAAK,KAAK,WACT,MAAA,KAAK,OAAO,KAAK,KAAK,OAAO,OAAO,KAAK,KAAK,IAAI,GACxD,KAAK,cAAc;AAAA,EAAA;AAAA,EAGpB,MAAM,OAAOC,GAAiBC,GAAoB;AACjD,IAAKD,MAEA,KAAA,QAAQ,GAAG,KAAK,SAAS,KAAK,iCAAiCC,CAAI,EAAE,CAAC,IAAID,CAAM,IAEhF,KAAA,WACH,MAAM,KAAK,aAAaA,GAAQC,CAAI,KACrCC,EAAqB,WAAW,cAE5B,KAAA,UAAU,KAAK,kBAAkBF,CAAM;AAAA,EAAA;AAAA,EAG7C,MAAM,aAAaA,GAAiBC,GAAoB;AACnD,WAACD,IAGH,MAAMH,QAAKjB,CAAiB,EAAA;AAAA,MAC5BoB;AAAA,MACAC,KAAQE,EAAY;AAAA,IAAA,KACfD,EAAqB,WAAW,eANnB;AAAA,EAMmB;AAAA,EAIxC,kBAAkBF,GAAwD;;AACrE,YAACD,IAAA,KAAK,SAAL,QAAAA,EAAW,QAgBT;AAAA,MACN,OAAO;AAAA,MACP,OAhBiB,KAAK,KAAK,MAC1B,IAAI,CAACK,MAAQ;;AASN,eARoB;AAAA,UAC1B,KAAAA;AAAA,UACA,QAAQC,EAAW;AAAA,UACnB,OAAOC,EAAgB;AAAA,UACvB,MAAM;AAAA,UACN,cAAYP,IAAA,KAAK,SAAL,gBAAAA,EAAW,eAAc;AAAA,QACtC;AAAA,MAGA,CAAA,EACA,OAAO,CAACQ,MAASA,MAAS,MAAS;AAAA,MAKpC,QAAAP;AAAA,MACA,MAAM,KAAK,KAAK,QAAQG,EAAY;AAAA,MACpC,YAAY,KAAK,KAAK,cAAc;AAAA,MACpC,oBAAoB;AAAA,IACrB,IAvBuB;AAAA,EAuBvB;AAAA,EAkCD,MAAM,aAAaK,GAAmC;;AACjD,IAAC,KAAK,YAEL,KAAA,QAAQ,SAASA,EAAW,QAG5BT,IAAAF,EAAA,MAAAlB,CAAA,MAAA,QAAAoB,EAAkB,SAAS;AAAA,EAAI;AAAA;AAAA,EAqBrC,SAAS;AACD,WAAAU,8BAAiC,KAAK,KAAK;AAAA,KAC/C,KAAK,mBAAmB,CAAC,IAAI,KAAK,cAAe,CAAA;AAAA,yBAC7B,KAAK,eAAe;AAAA;AAAA,EAAA;AAAA,EAI5C,qBAAqB;;AACb,WAAA,KAAK,cACTC,IACAD;AAAA;AAAA;AAAA,gBAGUV,IAAA,KAAK,SAAL,gBAAAA,EAAW,IAAI;AAAA,kBACZ,EAAI;AAAA,sBACDY,IAAA,KAAK,SAAL,gBAAAA,EAAW,UAAU;AAAA,mBACxBC,IAAA,KAAK,gBAAL,gBAAAA,EAAkB,QAAQ;AAAA,kBAC1B,EAAI;AAAA,0BACIC,QAAKhC,GAAeK,CAAA,CAAA;AAAA;AAAA;AAAA,EAAA;AAAA,EAK7C,gBAAgB;;AACf,YAAQa,IAAA,KAAK,YAAL,QAAAA,EAAc,SAEnBU;AAAA;AAAA,mBAEcP,EAAqB,UAAU,OAAO;AAAA,kBACvC,KAAK,QAAQ;AAAA,eAChB,KAAK,OAAO;AAAA,eACZ,EAAK;AAAA,mBACDW,QAAKhC,GAAWS,CAAA,CAAA;AAAA,yBACVuB,QAAKhC,GAAeM,CAAA,CAAA;AAAA,2BAClB0B,QAAKhC,GAAWQ,CAAA,CAAA;AAAA,+BACZwB,QAAKhC,GAAcO,CAAA,CAAA;AAAA,QAV7CsB;AAAA,EAU6C;AAAA,EAIjD,gBAAgB;;AACf,UAAMI,IACL,KAAK,UAAUC,EAAe,UAC3BN;AAAA,gBACUI,QAAKhC,GAAUC,CAAA,CAAA;AAAA;AAAA;AAAA,cAGjB,KAAK,SAAS;AAAA,MACrB,iCAA+BiB,IAAA,KAAK,SAAL,gBAAAA,EAAW,SAAQI,EAAY;AAAA,IAAA,CAC9D,mBACDO;AAEJ,WAAO,KAAK,gBAAgB,CAAC,KAAK,QAC/BD;AAAA,eACUI,QAAKhC,GAAQG,CAAA,CAAA;AAAA,cACd,KAAK,SAAS,KAAK,gCAAgC,CAAC,mBAC7DyB;AAAA,eACU,KAAK,UAAU;AAAA,gBACdI,QAAKhC,GAASE,CAAA,CAAA;AAAA,eACf,KAAK,YAAY;AAAA,OACzB+B,CAAO;AAAA,EAAA;AAad;AAxPCnC,IAAA,oBAAA,QAAA;AACAC,IAAA,oBAAA,QAAA;AALMC,IAAA,oBAAA,QAAA;AA2HNC,IAAU,WAAG;AACZ,OAAK,cAAc,IACnBe,EAAA,MAAKlB,GAAiB,YAAY;AACnC;AAEAI,IAAS,WAAG;AACX,EAAA8B,EAAA,MAAKhC,GAALI,CAAA,EAAA,KAAA,IAAA;AACD;AAEMD,IAAQ,iBAAG;AAChB,QAAM6B,QAAKhC,GAALI,CAAA,EAAA,KAAA,IAAA;AACP;AAEMA,IAAW,iBAAG;;AACf,GAACc,IAAA,KAAK,YAAL,QAAAA,EAAc,UAGbF,EAAA,MAAAlB,CAAA,EAAiB,SAAS,EAAK,GACpC,KAAK,eAAe,WACd,MAAAkB,EAAA,MAAKlB,GAAiB,aAAa,MAJzCgC,IAAA,KAAK,iBAAL,QAAAA,EAAmB;AAMrB;AAEMzB,IAAe,eAAC8B,GAAuC;;AACxD,EAACA,EAAE,WAEP,MAAM,KAAK,OAAOA,EAAE,OAAO,QAAOjB,IAAA,KAAK,SAAL,gBAAAA,EAAW,IAAI,GAC3C,MAAA,KAAK,aAAaiB,EAAE,MAAM;AACjC;AAYA7B,IAAe,SAAC6B,GAAgB;AAC1B,OAAA,SAASA,EAAE,OAAO,QAClB,KAAA,eAAeA,EAAE,OAAO;AAC9B;AAEA5B,IAAc,SAAC6B,GAAoD;AAC7D,OAAA,aAAaA,EAAY,OAAO,cAAc,UAC9C,KAAA,QAAQA,EAAY,OAAO;AACjC;AAEA5B,IAAW,WAAG;AAAC;AAEfC,IAAW,SAAC0B,GAAyB;AACpC,OAAK,QAAQA,EAAE;AAChB;AAjLYzB,EAkPL,SAAS2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA1OhBC,EAAA;AAAA,EADCC,EAAM;AAAA,GAPK7B,EAQZ,WAAA,YAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAVK7B,EAWZ,WAAA,UAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAbK7B,EAcZ,WAAA,gBAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAhBK7B,EAiBZ,WAAA,WAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAnBK7B,EAoBZ,WAAA,SAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAtBK7B,EAuBZ,WAAA,SAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAzBK7B,EA0BZ,WAAA,eAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GA5BK7B,EA6BZ,WAAA,cAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GA/BK7B,EAgCZ,WAAA,eAAA,CAAA;AAGA4B,EAAA;AAAA,EADCC,EAAM;AAAA,GAlCK7B,EAmCZ,WAAA,cAAA,CAAA;AAGQ4B,EAAA;AAAA,EADPC,EAAM;AAAA,GArCK7B,EAsCJ,WAAA,gBAAA,CAAA;AAtCIA,IAAN4B,EAAA;AAAA,EADNE,EAAc,+BAA+B;AAAA,GACjC9B,CAAA;AA8Pb,MAAA+B,IAAe/B;"}