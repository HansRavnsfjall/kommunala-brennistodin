{"version":3,"file":"report-step.element-DsjaNEpm.js","sources":["../../../usync-publisher-assets/src/strategies/common/report-step.element.ts"],"sourcesContent":["import {\r\n\tJUMOO_PROCESSING_CONTEXT,\r\n\tPipelineContext,\r\n\tProcessStepElement,\r\n\tProcessStepElementBase,\r\n} from '@jumoo/processing';\r\nimport {\r\n\tcustomElement,\r\n\thtml,\r\n\tnothing,\r\n\tstate,\r\n\twhen,\r\n} from '@umbraco-cms/backoffice/external/lit';\r\nimport { SyncPublisherStratey } from '../constants';\r\nimport {\r\n\tChangeDetailType,\r\n\tChangeType,\r\n\tPublisherProcessingOptions,\r\n\tUSyncActionView,\r\n\tUSyncChange,\r\n} from '../../api';\r\nimport PublisherStrategyContext, {\r\n\tUSYNC_PUBLISHER_STRATEGY_CONTEXT,\r\n} from '../strategy.context';\r\n\r\n@customElement(SyncPublisherStratey.elements.report)\r\nexport class SyncPublishReportStepElement\r\n\textends ProcessStepElementBase\r\n\timplements ProcessStepElement\r\n{\r\n\t#pipelineContext?: PipelineContext;\r\n\t#strateyContext?: PublisherStrategyContext;\r\n\r\n\t@state()\r\n\tdetectRestorePoint: boolean = false;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(JUMOO_PROCESSING_CONTEXT, (context) => {\r\n\t\t\tthis.#pipelineContext = context;\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(USYNC_PUBLISHER_STRATEGY_CONTEXT, (context) => {\r\n\t\t\tthis.#strateyContext = context;\r\n\t\t});\r\n\t}\r\n\r\n\tasync connectedCallback() {\r\n\t\tsuper.connectedCallback();\r\n\r\n\t\t// work out if we need to continue.\r\n\t\tconst changes = this.setValid();\r\n\r\n\t\tif (changes) {\r\n\t\t\t// get the restore option from the server settings.\r\n\t\t\tawait this.getRestoreOption();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate setValid() {\r\n\t\tconst changes = (this.results?.results['changes'] as number) ?? 0;\r\n\t\tthis.dispatchEvent(\r\n\t\t\tnew CustomEvent<boolean>('set-valid', {\r\n\t\t\t\tbubbles: true,\r\n\t\t\t\tcomposed: true,\r\n\t\t\t\tdetail: changes != 0,\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\treturn changes != 0;\r\n\t}\r\n\r\n\tprivate async getRestoreOption() {\r\n\t\tconst options = this.options as PublisherProcessingOptions;\r\n\t\tif (!options.server) return;\r\n\r\n\t\tconst entityType = options.entityType;\r\n\t\tif (!entityType) return;\r\n\r\n\t\tconst server = await this.#strateyContext?.getServer(options.server);\r\n\t\tif (!server) return;\r\n\r\n\t\tconst sendOptions = await this.#strateyContext?.getSyncSendOptions(\r\n\t\t\tserver.alias,\r\n\t\t\tentityType,\r\n\t\t);\r\n\r\n\t\tthis.detectRestorePoint = sendOptions?.detectRestorePoint ?? false;\r\n\t}\r\n\r\n\tprivate containsSettingsChange(actions: USyncActionView[]): boolean {\r\n\t\treturn actions.some((action) => {\r\n\t\t\treturn (\r\n\t\t\t\taction.change != ChangeType.NO_CHANGE && this.containsDeleteChange(action.details)\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\tprivate containsDeleteChange(details: USyncChange[]): boolean {\r\n\t\treturn details.some((detail) => {\r\n\t\t\treturn detail.change == ChangeDetailType.DELETE;\r\n\t\t});\r\n\t}\r\n\r\n\t#onRestorePointChange(e: Event) {\r\n\t\tif (!this.options) return;\r\n\r\n\t\tconst element = e.target as HTMLInputElement;\r\n\t\tif (!element) return;\r\n\r\n\t\tconst processOptions = structuredClone(this.options as PublisherProcessingOptions);\r\n\t\tif (!processOptions.publisherOptions) return;\r\n\r\n\t\tprocessOptions.publisherOptions.createRestorePoint = element.checked;\r\n\r\n\t\tthis.#pipelineContext?.setPending({\r\n\t\t\tpublisherOptions: processOptions.publisherOptions,\r\n\t\t});\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst actions = this.results?.results['actions'] as USyncActionView[];\r\n\t\tconst publisherOptions = this.options as PublisherProcessingOptions;\r\n\t\tconst changes = this.results?.results['changes'] as number;\r\n\r\n\t\tconst settingsChanges = changes && this.containsSettingsChange(actions);\r\n\r\n\t\treturn html`\r\n\t\t\t<usync-publisher-report-view\r\n\t\t\t\t.server=${publisherOptions.server ?? ''}\r\n\t\t\t\t.results=${actions}></usync-publisher-report-view>\r\n\t\t\t${when(settingsChanges, () => this.renderRestorePointOption())}\r\n\t\t`;\r\n\t}\r\n\r\n\trenderRestorePointOption() {\r\n\t\treturn !this.detectRestorePoint\r\n\t\t\t? nothing\r\n\t\t\t: html`<uui-box .headline=${this.localize.term('usyncpublish_restorePrompt')}>\r\n\t\t\t\t\t<div>\r\n\t\t\t\t\t\t<umb-localize key=\"usyncpublish_restorePromptDesc\"></umb-localize>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<uui-checkbox\r\n\t\t\t\t\t\tlabel=\"${this.localize.term('usyncpublish_createRestorePoint')}\"\r\n\t\t\t\t\t\t@change=${this.#onRestorePointChange}></uui-checkbox>\r\n\t\t\t\t</uui-box>`;\r\n\t}\r\n}\r\n\r\nexport default SyncPublishReportStepElement;\r\n"],"names":["_pipelineContext","_strateyContext","_SyncPublishReportStepElement_instances","onRestorePointChange_fn","SyncPublishReportStepElement","ProcessStepElementBase","__privateAdd","JUMOO_PROCESSING_CONTEXT","context","__privateSet","USYNC_PUBLISHER_STRATEGY_CONTEXT","changes","_a","options","entityType","server","__privateGet","sendOptions","_b","actions","action","ChangeType","details","detail","ChangeDetailType","publisherOptions","settingsChanges","html","when","__privateMethod","nothing","element","processOptions","__decorateClass","state","customElement","SyncPublisherStratey","SyncPublishReportStepElement$1"],"mappings":"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"}