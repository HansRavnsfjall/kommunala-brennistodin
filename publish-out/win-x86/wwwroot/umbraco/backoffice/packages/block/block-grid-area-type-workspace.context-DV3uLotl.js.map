{"version":3,"file":"block-grid-area-type-workspace.context-DV3uLotl.js","sources":["../../../src/packages/block/block-grid/components/block-grid-area-config-entry/workspace/block-grid-area-type-workspace.context.ts"],"sourcesContent":["import type { UmbBlockGridTypeAreaType } from '../../../types.js';\r\nimport type { UmbPropertyDatasetContext, UmbPropertyValueData } from '@umbraco-cms/backoffice/property';\r\nimport { UMB_PROPERTY_CONTEXT } from '@umbraco-cms/backoffice/property';\r\nimport type {\r\n\tUmbInvariantDatasetWorkspaceContext,\r\n\tUmbRoutableWorkspaceContext,\r\n\tUmbWorkspaceContext,\r\n\tManifestWorkspace,\r\n} from '@umbraco-cms/backoffice/workspace';\r\nimport {\r\n\tUmbSubmittableWorkspaceContextBase,\r\n\tUmbInvariantWorkspacePropertyDatasetContext,\r\n\tumbObjectToPropertyValueArray,\r\n} from '@umbraco-cms/backoffice/workspace';\r\nimport { UmbArrayState, UmbObjectState, appendToFrozenArray } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport type { PropertyEditorSettingsProperty } from '@umbraco-cms/backoffice/property-editor';\r\nimport { UmbId } from '@umbraco-cms/backoffice/id';\r\nimport { firstValueFrom } from '@umbraco-cms/backoffice/external/rxjs';\r\n\r\nexport class UmbBlockGridAreaTypeWorkspaceContext\r\n\textends UmbSubmittableWorkspaceContextBase<UmbBlockGridTypeAreaType>\r\n\timplements UmbInvariantDatasetWorkspaceContext, UmbRoutableWorkspaceContext\r\n{\r\n\t// Just for context token safety:\r\n\tpublic readonly IS_BLOCK_GRID_AREA_TYPE_WORKSPACE_CONTEXT = true;\r\n\r\n\t#entityType: string;\r\n\t#data = new UmbObjectState<UmbBlockGridTypeAreaType | undefined>(undefined);\r\n\treadonly data = this.#data.asObservable();\r\n\r\n\treadonly values = this.#data.asObservablePart((data) => {\r\n\t\treturn umbObjectToPropertyValueArray(data);\r\n\t});\r\n\tasync getValues(): Promise<Array<UmbPropertyValueData> | undefined> {\r\n\t\treturn umbObjectToPropertyValueArray(await firstValueFrom(this.data));\r\n\t}\r\n\r\n\t// TODO: Get the name of the contentElementType..\r\n\treadonly name = this.#data.asObservablePart((data) => data?.alias);\r\n\treadonly unique = this.#data.asObservablePart((data) => data?.key);\r\n\r\n\t#properties = new UmbArrayState<PropertyEditorSettingsProperty>([], (x) => x.alias);\r\n\treadonly properties = this.#properties.asObservable();\r\n\r\n\tconstructor(host: UmbControllerHost, workspaceArgs: { manifest: ManifestWorkspace }) {\r\n\t\tsuper(host, workspaceArgs.manifest.alias);\r\n\t\tthis.#entityType = workspaceArgs.manifest.meta?.entityType;\r\n\t}\r\n\r\n\tset manifest(manifest: ManifestWorkspace) {\r\n\t\tthis.routes.setRoutes([\r\n\t\t\t{\r\n\t\t\t\tpath: 'edit/:id',\r\n\t\t\t\tcomponent: () => import('./block-grid-area-type-workspace-editor.element.js'),\r\n\t\t\t\tsetup: (component, info) => {\r\n\t\t\t\t\tconst id = info.match.params.id;\r\n\t\t\t\t\tthis.load(id);\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tpath: 'create',\r\n\t\t\t\tcomponent: () => import('./block-grid-area-type-workspace-editor.element.js'),\r\n\t\t\t\tsetup: () => {\r\n\t\t\t\t\tthis.create();\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t]);\r\n\t}\r\n\r\n\tprotected override resetState(): void {\r\n\t\tsuper.resetState();\r\n\t\tthis.#data.setValue(undefined);\r\n\t}\r\n\r\n\tcreatePropertyDatasetContext(host: UmbControllerHost): UmbPropertyDatasetContext {\r\n\t\treturn new UmbInvariantWorkspacePropertyDatasetContext(host, this);\r\n\t}\r\n\r\n\tasync load(unique: string) {\r\n\t\tthis.resetState();\r\n\t\tthis.consumeContext(UMB_PROPERTY_CONTEXT, (context) => {\r\n\t\t\tthis.observe(\r\n\t\t\t\tcontext?.value,\r\n\t\t\t\t(value) => {\r\n\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\tconst blockTypeData = value.find((x: UmbBlockGridTypeAreaType) => x.key === unique);\r\n\t\t\t\t\t\tif (blockTypeData) {\r\n\t\t\t\t\t\t\tthis.#data.setValue(blockTypeData);\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Fallback to undefined:\r\n\t\t\t\t\tthis.#data.setValue(undefined);\r\n\t\t\t\t},\r\n\t\t\t\t'observePropertyValue',\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\tasync create() {\r\n\t\tthis.resetState();\r\n\t\tlet data: UmbBlockGridTypeAreaType = {\r\n\t\t\tkey: UmbId.new(),\r\n\t\t\talias: '',\r\n\t\t\tcolumnSpan: 12,\r\n\t\t\trowSpan: 1,\r\n\t\t\tminAllowed: 0,\r\n\t\t\tmaxAllowed: undefined,\r\n\t\t\tspecifiedAllowance: [],\r\n\t\t};\r\n\r\n\t\t// If we have a modal context, we blend in the modal preset data: [NL]\r\n\t\tif (this.modalContext) {\r\n\t\t\tdata = { ...data, ...this.modalContext.data.preset };\r\n\t\t}\r\n\r\n\t\tthis.setIsNew(true);\r\n\t\tthis.#data.setValue(data);\r\n\t}\r\n\r\n\tgetData() {\r\n\t\treturn this.#data.getValue();\r\n\t}\r\n\r\n\tgetUnique() {\r\n\t\treturn this.getData()!.key;\r\n\t}\r\n\r\n\tgetEntityType() {\r\n\t\treturn this.#entityType;\r\n\t}\r\n\r\n\tgetName() {\r\n\t\treturn this.#data.getValue()?.alias;\r\n\t}\r\n\r\n\t// TODO: [v15] ignoring unused name parameter to avoid breaking changes\r\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\tsetName(name: string | undefined) {\r\n\t\tthrow new Error('You cannot set a name of a area-type.');\r\n\t}\r\n\r\n\t/**\r\n\t * @function propertyValueByAlias\r\n\t * @param {string} propertyAlias\r\n\t * @returns {Promise<Observable<ReturnType | undefined> | undefined>}\r\n\t * @description Get an Observable for the value of this property.\r\n\t */\r\n\tasync propertyValueByAlias<ReturnType = unknown>(propertyAlias: keyof UmbBlockGridTypeAreaType) {\r\n\t\treturn this.#data.asObservablePart((data) => data?.[propertyAlias as keyof UmbBlockGridTypeAreaType] as ReturnType);\r\n\t}\r\n\r\n\tgetPropertyValue<ReturnType = unknown>(propertyAlias: keyof UmbBlockGridTypeAreaType) {\r\n\t\treturn this.#data.getValue()?.[propertyAlias as keyof UmbBlockGridTypeAreaType] as ReturnType;\r\n\t}\r\n\r\n\t/**\r\n\t * @function setPropertyValue\r\n\t * @param {string} alias\r\n\t * @param {unknown} value - value can be a promise resolving into the actual value or the raw value it self.\r\n\t * @returns {Promise<void>}\r\n\t * @description Set the value of this property.\r\n\t */\r\n\tasync setPropertyValue(alias: string, value: unknown) {\r\n\t\tconst currentData = this.#data.value;\r\n\t\tif (currentData) {\r\n\t\t\tthis.#data.update({ ...currentData, [alias]: value });\r\n\t\t}\r\n\t}\r\n\r\n\tasync submit() {\r\n\t\tif (!this.#data.value) {\r\n\t\t\tthrow new Error('No data to submit.');\r\n\t\t}\r\n\r\n\t\tconst context = await this.getContext(UMB_PROPERTY_CONTEXT);\r\n\t\tif (!context) {\r\n\t\t\tthrow new Error('Property context not found.');\r\n\t\t}\r\n\r\n\t\t// TODO: We should most likely consume already, in this way I avoid having the reset this consumption.\r\n\t\tcontext.setValue(appendToFrozenArray(context.getValue() ?? [], this.#data.getValue(), (x) => x?.key));\r\n\r\n\t\tthis.setIsNew(false);\r\n\t}\r\n\r\n\tpublic override destroy(): void {\r\n\t\tthis.#data.destroy();\r\n\t\tsuper.destroy();\r\n\t}\r\n}\r\n\r\nexport default UmbBlockGridAreaTypeWorkspaceContext;\r\n\r\nexport const UMB_BLOCK_GRID_AREA_TYPE_WORKSPACE_CONTEXT = new UmbContextToken<\r\n\tUmbWorkspaceContext,\r\n\tUmbBlockGridAreaTypeWorkspaceContext\r\n>(\r\n\t'UmbWorkspaceContext',\r\n\tundefined,\r\n\t(context): context is UmbBlockGridAreaTypeWorkspaceContext =>\r\n\t\t(context as any).IS_BLOCK_GRID_AREA_TYPE_WORKSPACE_CONTEXT,\r\n);\r\n"],"names":["UmbBlockGridAreaTypeWorkspaceContext","UmbSubmittableWorkspaceContextBase","host","workspaceArgs","#data","UmbObjectState","data","umbObjectToPropertyValueArray","#properties","UmbArrayState","x","#entityType","firstValueFrom","manifest","component","info","id","UmbInvariantWorkspacePropertyDatasetContext","unique","UMB_PROPERTY_CONTEXT","context","value","blockTypeData","UmbId","name","propertyAlias","alias","currentData","appendToFrozenArray","UMB_BLOCK_GRID_AREA_TYPE_WORKSPACE_CONTEXT","UmbContextToken"],"mappings":"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"}