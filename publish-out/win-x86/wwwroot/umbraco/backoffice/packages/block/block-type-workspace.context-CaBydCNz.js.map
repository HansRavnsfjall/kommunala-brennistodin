{"version":3,"file":"block-type-workspace.context-CaBydCNz.js","sources":["../../../src/packages/block/block-type/workspace/block-type-workspace-editor.element.ts","../../../src/packages/block/block-type/workspace/block-type-workspace.context.ts"],"sourcesContent":["import { UMB_BLOCK_TYPE_WORKSPACE_CONTEXT } from './block-type-workspace.context-token.js';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\nimport { customElement, css, html, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { UmbRepositoryItemsManager } from '@umbraco-cms/backoffice/repository';\r\nimport type { UmbDocumentTypeItemModel } from '@umbraco-cms/backoffice/document-type';\r\nimport { UMB_DOCUMENT_TYPE_ITEM_REPOSITORY_ALIAS } from '@umbraco-cms/backoffice/document-type';\r\n\r\n@customElement('umb-block-type-workspace-editor')\r\nexport class UmbBlockTypeWorkspaceEditorElement extends UmbLitElement {\r\n\t#itemManager = new UmbRepositoryItemsManager<UmbDocumentTypeItemModel>(this, UMB_DOCUMENT_TYPE_ITEM_REPOSITORY_ALIAS);\r\n\r\n\t#workspaceContext?: typeof UMB_BLOCK_TYPE_WORKSPACE_CONTEXT.TYPE;\r\n\r\n\t@state()\r\n\tprivate _name?: string;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(UMB_BLOCK_TYPE_WORKSPACE_CONTEXT, (instance) => {\r\n\t\t\tthis.#workspaceContext = instance;\r\n\t\t\tthis.#workspaceContext?.createPropertyDatasetContext(this);\r\n\t\t\tthis.observe(this.#workspaceContext?.unique, (unique) => {\r\n\t\t\t\tif (unique) {\r\n\t\t\t\t\tthis.#itemManager.setUniques([unique]);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tthis.observe(this.#itemManager.items, (items) => {\r\n\t\t\tconst item = items[0];\r\n\t\t\tif (item) {\r\n\t\t\t\tthis._name = item.name;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn html`\r\n\t\t\t<umb-workspace-editor headline=${this.localize.term('blockEditor_blockConfigurationOverlayTitle', [this._name])}>\r\n\t\t\t</umb-workspace-editor>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\theight: 100%;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UmbBlockTypeWorkspaceEditorElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-block-type-workspace-editor': UmbBlockTypeWorkspaceEditorElement;\r\n\t}\r\n}\r\n","import type { UmbBlockTypeBaseModel, UmbBlockTypeWithGroupKey } from '../types.js';\r\nimport { UmbBlockTypeWorkspaceEditorElement } from './block-type-workspace-editor.element.js';\r\nimport type { UmbPropertyDatasetContext, UmbPropertyValueData } from '@umbraco-cms/backoffice/property';\r\nimport { UMB_PROPERTY_CONTEXT } from '@umbraco-cms/backoffice/property';\r\nimport type {\r\n\tUmbInvariantDatasetWorkspaceContext,\r\n\tUmbRoutableWorkspaceContext,\r\n\tManifestWorkspace,\r\n} from '@umbraco-cms/backoffice/workspace';\r\nimport {\r\n\tUmbSubmittableWorkspaceContextBase,\r\n\tUmbInvariantWorkspacePropertyDatasetContext,\r\n\tUmbWorkspaceIsNewRedirectController,\r\n\tUmbWorkspaceIsNewRedirectControllerAlias,\r\n\tumbObjectToPropertyValueArray,\r\n} from '@umbraco-cms/backoffice/workspace';\r\nimport { UmbObjectState, appendToFrozenArray } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { firstValueFrom } from '@umbraco-cms/backoffice/external/rxjs';\r\n\r\nexport class UmbBlockTypeWorkspaceContext<BlockTypeData extends UmbBlockTypeWithGroupKey = UmbBlockTypeWithGroupKey>\r\n\textends UmbSubmittableWorkspaceContextBase<BlockTypeData>\r\n\timplements UmbInvariantDatasetWorkspaceContext, UmbRoutableWorkspaceContext\r\n{\r\n\t// Just for context token safety:\r\n\tpublic readonly IS_BLOCK_TYPE_WORKSPACE_CONTEXT = true;\r\n\r\n\t#gotPropertyContext: Promise<unknown>;\r\n\t#propertyContext?: typeof UMB_PROPERTY_CONTEXT.TYPE;\r\n\r\n\t#entityType: string;\r\n\t#data = new UmbObjectState<BlockTypeData | undefined>(undefined);\r\n\treadonly data = this.#data.asObservable();\r\n\r\n\treadonly name = this.#data.asObservablePart(() => 'block type');\r\n\treadonly unique = this.#data.asObservablePart((data) => data?.contentElementTypeKey);\r\n\r\n\treadonly values = this.#data.asObservablePart((data) => {\r\n\t\treturn umbObjectToPropertyValueArray(data);\r\n\t});\r\n\tasync getValues(): Promise<Array<UmbPropertyValueData> | undefined> {\r\n\t\treturn umbObjectToPropertyValueArray(await firstValueFrom(this.data));\r\n\t}\r\n\r\n\tconstructor(host: UmbControllerHost, args: { manifest: ManifestWorkspace }) {\r\n\t\tsuper(host, args.manifest.alias);\r\n\t\tconst manifest = args.manifest;\r\n\t\tthis.#entityType = manifest.meta?.entityType;\r\n\r\n\t\tthis.#gotPropertyContext = this.consumeContext(UMB_PROPERTY_CONTEXT, (context) => {\r\n\t\t\tthis.#propertyContext = context;\r\n\t\t}).asPromise({ preventTimeout: true });\r\n\r\n\t\tthis.routes.setRoutes([\r\n\t\t\t{\r\n\t\t\t\t// Would it make more sense to have groupKey before elementTypeKey?\r\n\t\t\t\tpath: 'create/:elementTypeKey/:groupKey',\r\n\t\t\t\tcomponent: UmbBlockTypeWorkspaceEditorElement,\r\n\t\t\t\tsetup: async (component, info) => {\r\n\t\t\t\t\tconst elementTypeKey = info.match.params.elementTypeKey;\r\n\t\t\t\t\tconst groupKey = info.match.params.groupKey === 'null' ? null : info.match.params.groupKey;\r\n\t\t\t\t\tawait this.create(elementTypeKey, groupKey);\r\n\r\n\t\t\t\t\tnew UmbWorkspaceIsNewRedirectController(\r\n\t\t\t\t\t\tthis,\r\n\t\t\t\t\t\tthis,\r\n\t\t\t\t\t\tthis.getHostElement().shadowRoot!.querySelector('umb-router-slot')!,\r\n\t\t\t\t\t);\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tpath: 'edit/:id',\r\n\t\t\t\tcomponent: UmbBlockTypeWorkspaceEditorElement,\r\n\t\t\t\tsetup: (component, info) => {\r\n\t\t\t\t\tconst id = info.match.params.id;\r\n\t\t\t\t\tthis.load(id);\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t]);\r\n\t}\r\n\r\n\tprotected override resetState() {\r\n\t\tsuper.resetState();\r\n\t\tthis.#data.setValue(undefined);\r\n\t\tthis.removeUmbControllerByAlias(UmbWorkspaceIsNewRedirectControllerAlias);\r\n\t}\r\n\r\n\tcreatePropertyDatasetContext(host: UmbControllerHost): UmbPropertyDatasetContext {\r\n\t\treturn new UmbInvariantWorkspacePropertyDatasetContext(host, this);\r\n\t}\r\n\r\n\tasync load(unique: string) {\r\n\t\tthis.resetState();\r\n\t\tawait this.#gotPropertyContext;\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis.#propertyContext?.value,\r\n\t\t\t(value) => {\r\n\t\t\t\tif (value) {\r\n\t\t\t\t\tconst blockTypeData = value.find((x: UmbBlockTypeBaseModel) => x.contentElementTypeKey === unique);\r\n\t\t\t\t\tif (blockTypeData) {\r\n\t\t\t\t\t\tthis.#data.setValue(blockTypeData);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// Fallback to undefined:\r\n\t\t\t\tthis.#data.setValue(undefined);\r\n\t\t\t},\r\n\t\t\t'observePropertyValue',\r\n\t\t);\r\n\t}\r\n\r\n\tasync create(contentElementTypeId: string, groupKey?: string | null) {\r\n\t\tthis.resetState();\r\n\r\n\t\tlet data: BlockTypeData = {\r\n\t\t\tcontentElementTypeKey: contentElementTypeId,\r\n\t\t} as BlockTypeData;\r\n\r\n\t\t// If we have a modal context, we blend in the modal preset data: [NL]\r\n\t\tif (this.modalContext) {\r\n\t\t\tdata = { ...data, ...this.modalContext.data.preset };\r\n\t\t}\r\n\r\n\t\t// Only set groupKey property if it has been parsed to this method\r\n\t\tif (groupKey) {\r\n\t\t\tdata.groupKey = groupKey;\r\n\t\t}\r\n\r\n\t\tthis.setIsNew(true);\r\n\t\tthis.#data.setValue(data);\r\n\t}\r\n\r\n\tgetData() {\r\n\t\treturn this.#data.getValue();\r\n\t}\r\n\r\n\tgetUnique() {\r\n\t\treturn this.getData()!.contentElementTypeKey;\r\n\t}\r\n\r\n\tgetEntityType() {\r\n\t\treturn this.#entityType;\r\n\t}\r\n\r\n\tgetName() {\r\n\t\treturn 'block name content element type here...';\r\n\t}\r\n\r\n\t// TODO: [v15] ignoring unused name parameter to avoid breaking changes\r\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\tsetName(name: string | undefined) {\r\n\t\tconsole.warn('You cannot set a name of a block type.');\r\n\t}\r\n\r\n\t/**\r\n\t * @function propertyValueByAlias\r\n\t * @param {string} propertyAlias\r\n\t * @returns {Promise<Observable<ReturnType | undefined> | undefined>}\r\n\t * @description Get an Observable for the value of this property.\r\n\t */\r\n\tasync propertyValueByAlias<ReturnType = unknown>(propertyAlias: string) {\r\n\t\treturn this.#data.asObservablePart((data) => data?.[propertyAlias as keyof BlockTypeData] as ReturnType);\r\n\t}\r\n\r\n\tgetPropertyValue<ReturnType = unknown>(propertyAlias: string) {\r\n\t\treturn this.#data.getValue()?.[propertyAlias as keyof BlockTypeData] as ReturnType;\r\n\t}\r\n\r\n\t/**\r\n\t * @function setPropertyValue\r\n\t * @param {string} alias\r\n\t * @param {unknown} value - value can be a promise resolving into the actual value or the raw value it self.\r\n\t * @returns {Promise<void>}\r\n\t * @description Set the value of this property.\r\n\t */\r\n\tasync setPropertyValue(alias: string, value: unknown) {\r\n\t\tconst currentData = this.#data.value;\r\n\t\tif (currentData) {\r\n\t\t\tthis.#data.update({ ...currentData, [alias]: value });\r\n\t\t}\r\n\t}\r\n\r\n\tasync submit() {\r\n\t\tif (!this.#data.value) {\r\n\t\t\tthrow new Error('No data to submit.');\r\n\t\t}\r\n\r\n\t\tawait this.#gotPropertyContext;\r\n\t\tif (!this.#propertyContext) {\r\n\t\t\tthrow new Error('Property context is not available.');\r\n\t\t}\r\n\t\tthis.#propertyContext.setValue(\r\n\t\t\tappendToFrozenArray(\r\n\t\t\t\tthis.#propertyContext.getValue() ?? [],\r\n\t\t\t\tthis.#data.getValue(),\r\n\t\t\t\t(x) => x?.contentElementTypeKey,\r\n\t\t\t),\r\n\t\t);\r\n\r\n\t\tthis.setIsNew(false);\r\n\t}\r\n\r\n\tpublic override destroy(): void {\r\n\t\tthis.#data.destroy();\r\n\t\tsuper.destroy();\r\n\t}\r\n}\r\n\r\nexport { UmbBlockTypeWorkspaceContext as api };\r\n"],"names":["_itemManager","_workspaceContext","UmbBlockTypeWorkspaceEditorElement","UmbLitElement","__privateAdd","UmbRepositoryItemsManager","UMB_DOCUMENT_TYPE_ITEM_REPOSITORY_ALIAS","UMB_BLOCK_TYPE_WORKSPACE_CONTEXT","instance","__privateSet","__privateGet","unique","items","item","html","UmbTextStyles","css","__decorateClass","state","customElement","UmbBlockTypeWorkspaceContext","UmbSubmittableWorkspaceContextBase","host","args","#data","UmbObjectState","data","umbObjectToPropertyValueArray","manifest","#entityType","#gotPropertyContext","UMB_PROPERTY_CONTEXT","context","#propertyContext","component","info","elementTypeKey","groupKey","UmbWorkspaceIsNewRedirectController","id","firstValueFrom","UmbWorkspaceIsNewRedirectControllerAlias","UmbInvariantWorkspacePropertyDatasetContext","value","blockTypeData","x","contentElementTypeId","name","propertyAlias","alias","currentData","appendToFrozenArray"],"mappings":"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"}