{"version":3,"file":"content-type-property-structure-helper.class-jQi1Hj18.js","sources":["../../../src/packages/content/content-type/workspace/views/design/content-type-design-editor-property.context-token.ts","../../../src/packages/content/content-type/structure/content-type-property-structure-helper.class.ts"],"sourcesContent":["import type { UmbPropertyTypeContext } from './content-type-design-editor-property.context.js';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\n\r\nexport const UMB_PROPERTY_TYPE_CONTEXT = new UmbContextToken<UmbPropertyTypeContext>('UmbPropertyTypeContext');\r\n","import type { UmbContentTypeModel, UmbPropertyTypeModel } from '../types.js';\r\nimport type { UmbContentTypeStructureManager } from './content-type-structure-manager.class.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbArrayState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\ntype UmbPropertyTypeUnique = UmbPropertyTypeModel['unique'];\r\n\r\n/**\r\n * This class is a helper class for managing the structure of containers in a content type.\r\n * This requires a structure manager {@link UmbContentTypeStructureManager} to manage the structure.\r\n */\r\nexport class UmbContentTypePropertyStructureHelper<T extends UmbContentTypeModel> extends UmbControllerBase {\r\n\t#init;\r\n\t#initResolver?: (value: unknown) => void;\r\n\r\n\t#structure?: UmbContentTypeStructureManager<T>;\r\n\r\n\t#containerId?: string | null;\r\n\r\n\t// State which holds all the properties of the current container, this is a composition of all properties from the containers that matches our target [NL]\r\n\t#propertyStructure = new UmbArrayState<UmbPropertyTypeModel>([], (x) => x.unique);\r\n\treadonly propertyStructure = this.#propertyStructure.asObservable();\r\n\treadonly propertyAliases = this.#propertyStructure.asObservablePart((x) => x.map((e) => e.alias));\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\t\tthis.#init = new Promise((resolve) => {\r\n\t\t\tthis.#initResolver = resolve;\r\n\t\t});\r\n\t\tthis.#propertyStructure.sortBy((a, b) => a.sortOrder - b.sortOrder);\r\n\t}\r\n\r\n\tasync contentTypes() {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#structure) return;\r\n\t\treturn this.#structure.contentTypes;\r\n\t}\r\n\r\n\tpublic setStructureManager(structure: UmbContentTypeStructureManager<T>) {\r\n\t\tif (this.#structure === structure || !structure) return;\r\n\t\tif (this.#structure && !structure) {\r\n\t\t\tthrow new Error(\r\n\t\t\t\t'Structure manager is already set, the helpers are not designed to be re-setup with new managers',\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.#structure = structure;\r\n\t\tthis.#initResolver?.(undefined);\r\n\t\tthis.#initResolver = undefined;\r\n\t\tthis.#observeContainer();\r\n\t}\r\n\r\n\tpublic getStructureManager() {\r\n\t\treturn this.#structure;\r\n\t}\r\n\r\n\tpublic setContainerId(value?: string | null) {\r\n\t\tif (this.#containerId === value) return;\r\n\t\tthis.#containerId = value;\r\n\t\tthis.#observeContainer();\r\n\t}\r\n\tpublic getContainerId() {\r\n\t\treturn this.#containerId;\r\n\t}\r\n\r\n\t#observeContainer() {\r\n\t\tthis.observe(\r\n\t\t\tthis.#containerId ? this.#structure?.mergedContainersOfId(this.#containerId) : undefined,\r\n\t\t\t(container) => {\r\n\t\t\t\tthis.observe(\r\n\t\t\t\t\tcontainer ? this.#structure?.propertyStructuresOfGroupIds(container.ids ?? []) : undefined,\r\n\t\t\t\t\t(properties) => {\r\n\t\t\t\t\t\tthis.#propertyStructure.setValue(properties ?? []);\r\n\t\t\t\t\t},\r\n\t\t\t\t\t'observeProperties',\r\n\t\t\t\t);\r\n\t\t\t},\r\n\t\t\t'observeContainer',\r\n\t\t);\r\n\t}\r\n\r\n\tasync isOwnerProperty(propertyUnique: UmbPropertyTypeUnique) {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#structure) return;\r\n\r\n\t\treturn this.#structure.ownerContentTypeObservablePart((x) =>\r\n\t\t\tx?.properties.some((y) => y.unique === propertyUnique),\r\n\t\t);\r\n\t}\r\n\r\n\tasync contentTypeOfProperty(propertyUnique: UmbPropertyTypeUnique) {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#structure) return;\r\n\r\n\t\treturn this.#structure.contentTypeOfProperty(propertyUnique);\r\n\t}\r\n\r\n\t// TODO: consider moving this to another class, to separate 'viewer' from 'manipulator':\r\n\t/** Manipulate methods: */\r\n\r\n\tasync insertProperty(property: UmbPropertyTypeModel, sortOrder?: number) {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#structure) return false;\r\n\r\n\t\tconst newProperty = { ...property };\r\n\t\tif (sortOrder) {\r\n\t\t\tnewProperty.sortOrder = sortOrder;\r\n\t\t}\r\n\r\n\t\tawait this.#structure.insertProperty(null, newProperty);\r\n\t\treturn true;\r\n\t}\r\n\r\n\tasync removeProperty(propertyUnique: UmbPropertyTypeUnique) {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#structure) return false;\r\n\r\n\t\tawait this.#structure.removeProperty(null, propertyUnique);\r\n\t\treturn true;\r\n\t}\r\n\r\n\t// Takes optional arguments as this is easier for the implementation in the view:\r\n\tasync partialUpdateProperty(propertyKey?: string, partialUpdate?: Partial<UmbPropertyTypeModel>) {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#structure || !propertyKey || !partialUpdate) return;\r\n\t\treturn await this.#structure.updateProperty(null, propertyKey, partialUpdate);\r\n\t}\r\n}\r\n"],"names":["UMB_PROPERTY_TYPE_CONTEXT","UmbContextToken","UmbContentTypePropertyStructureHelper","UmbControllerBase","host","#propertyStructure","UmbArrayState","x","#init","resolve","#initResolver","a","b","#structure","#containerId","structure","#observeContainer","value","container","properties","propertyUnique","y","property","sortOrder","newProperty","propertyKey","partialUpdate"],"mappings":"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"}