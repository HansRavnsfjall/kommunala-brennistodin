{"version":3,"file":"index.js","sources":["../../../../src/packages/content/content-type/conditions/constants.ts","../../../../src/packages/content/content-type/global-components/content-type-workspace-editor-header.element.ts","../../../../src/packages/content/content-type/global-components/input-content-type-collection-configuration/input-content-type-collection-configuration.element.ts","../../../../src/packages/content/content-type/repository/structure/content-type-structure-repository-base.ts","../../../../src/packages/content/content-type/repository/structure/content-type-structure-server-data-source-base.ts","../../../../src/packages/content/content-type/structure/content-type-structure-manager.class.ts","../../../../src/packages/content/content-type/workspace/content-type-workspace-context-base.ts"],"sourcesContent":["/**\r\n * Workspace Content Type Alias condition alias\r\n */\r\nexport const UMB_WORKSPACE_CONTENT_TYPE_ALIAS_CONDITION_ALIAS = 'Umb.Condition.WorkspaceContentTypeAlias';\r\n","import { UMB_CONTENT_TYPE_WORKSPACE_CONTEXT } from '../workspace/content-type-workspace.context-token.js';\r\nimport type { UmbInputWithAliasElement } from '@umbraco-cms/backoffice/components';\r\nimport { umbFocus, UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { css, html, customElement, state, ifDefined } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from '@umbraco-cms/backoffice/modal';\r\nimport { UMB_ICON_PICKER_MODAL } from '@umbraco-cms/backoffice/icon';\r\nimport type { UUITextareaElement } from '@umbraco-cms/backoffice/external/uui';\r\nimport { umbBindToValidation } from '@umbraco-cms/backoffice/validation';\r\n\r\n@customElement('umb-content-type-workspace-editor-header')\r\nexport class UmbContentTypeWorkspaceEditorHeaderElement extends UmbLitElement {\r\n\t@state()\r\n\tprivate _name?: string;\r\n\r\n\t@state()\r\n\tprivate _alias?: string;\r\n\r\n\t@state()\r\n\tprivate _description?: string;\r\n\r\n\t@state()\r\n\tprivate _icon?: string;\r\n\r\n\t@state()\r\n\tprivate _isNew?: boolean;\r\n\r\n\t#workspaceContext?: typeof UMB_CONTENT_TYPE_WORKSPACE_CONTEXT.TYPE;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(UMB_CONTENT_TYPE_WORKSPACE_CONTEXT, (instance) => {\r\n\t\t\tthis.#workspaceContext = instance;\r\n\t\t\tthis.#observeContentType();\r\n\t\t});\r\n\t}\r\n\r\n\t#observeContentType() {\r\n\t\tif (!this.#workspaceContext) return;\r\n\t\tthis.observe(this.#workspaceContext.name, (name) => (this._name = name), '_observeName');\r\n\t\tthis.observe(this.#workspaceContext.alias, (alias) => (this._alias = alias), '_observeAlias');\r\n\t\tthis.observe(\r\n\t\t\tthis.#workspaceContext.description,\r\n\t\t\t(description) => (this._description = description),\r\n\t\t\t'_observeDescription',\r\n\t\t);\r\n\t\tthis.observe(this.#workspaceContext.icon, (icon) => (this._icon = icon), '_observeIcon');\r\n\t\tthis.observe(this.#workspaceContext.isNew, (isNew) => (this._isNew = isNew), '_observeIsNew');\r\n\t}\r\n\r\n\tprivate async _handleIconClick() {\r\n\t\tconst [alias, color] = this._icon?.replace('color-', '')?.split(' ') ?? [];\r\n\t\tconst modalManager = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n\t\tif (!modalManager) {\r\n\t\t\tthrow new Error('Modal manager not found.');\r\n\t\t}\r\n\t\tconst modalContext = modalManager.open(this, UMB_ICON_PICKER_MODAL, {\r\n\t\t\tvalue: {\r\n\t\t\t\ticon: alias,\r\n\t\t\t\tcolor: color,\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tmodalContext?.onSubmit().then((saved) => {\r\n\t\t\tif (saved.icon && saved.color) {\r\n\t\t\t\tthis.#workspaceContext?.setIcon(`${saved.icon} color-${saved.color}`);\r\n\t\t\t} else if (saved.icon) {\r\n\t\t\t\tthis.#workspaceContext?.setIcon(saved.icon);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t#onNameAndAliasChange(event: InputEvent & { target: UmbInputWithAliasElement }) {\r\n\t\tthis.#workspaceContext?.setName(event.target.value ?? '');\r\n\t\tthis.#workspaceContext?.setAlias(event.target.alias ?? '');\r\n\t}\r\n\r\n\t#onDescriptionChange(event: InputEvent & { target: UUITextareaElement }) {\r\n\t\tthis.#workspaceContext?.setDescription(event.target.value.toString() ?? '');\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn html`\r\n\t\t\t<div id=\"header\">\r\n\t\t\t\t<uui-button id=\"icon\" compact label=\"icon\" look=\"outline\" @click=${this._handleIconClick}>\r\n\t\t\t\t\t<umb-icon name=${ifDefined(this._icon)}></umb-icon>\r\n\t\t\t\t</uui-button>\r\n\r\n\t\t\t\t<div id=\"editors\">\r\n\t\t\t\t\t<umb-input-with-alias\r\n\t\t\t\t\t\tid=\"name\"\r\n\t\t\t\t\t\tlabel=${this.localize.term('placeholders_entername')}\r\n\t\t\t\t\t\t.value=${this._name}\r\n\t\t\t\t\t\t.alias=${this._alias}\r\n\t\t\t\t\t\t?auto-generate-alias=${this._isNew}\r\n\t\t\t\t\t\t@change=${this.#onNameAndAliasChange}\r\n\t\t\t\t\t\trequired\r\n\t\t\t\t\t\t${umbBindToValidation(this, '$.name', this._name)}\r\n\t\t\t\t\t\t${umbFocus()}>\r\n\t\t\t\t\t</umb-input-with-alias>\r\n\r\n\t\t\t\t\t<uui-input\r\n\t\t\t\t\t\tid=\"description\"\r\n\t\t\t\t\t\t.label=${this.localize.term('placeholders_enterDescription')}\r\n\t\t\t\t\t\t.value=${this._description}\r\n\t\t\t\t\t\t.placeholder=${this.localize.term('placeholders_enterDescription')}\r\n\t\t\t\t\t\t@input=${this.#onDescriptionChange}></uui-input>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: contents;\r\n\t\t\t}\r\n\r\n\t\t\t#header {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex: 1 1 auto;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t}\r\n\r\n\t\t\t#editors {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex: 1 1 auto;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: 1px;\r\n\t\t\t}\r\n\r\n\t\t\t#name {\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\tz-index: 1;\r\n\t\t\t}\r\n\r\n\t\t\t#description {\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\t--uui-input-height: var(--uui-size-8);\r\n\t\t\t\t--uui-input-border-color: transparent;\r\n\t\t\t}\r\n\r\n\t\t\t#description:hover {\r\n\t\t\t\t--uui-input-border-color: var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t#icon {\r\n\t\t\t\tfont-size: var(--uui-size-8);\r\n\t\t\t\theight: 60px;\r\n\t\t\t\twidth: 60px;\r\n\t\t\t\t--uui-button-border-color: transparent;\r\n\t\t\t\t--uui-button-border-color-hover: var(--uui-color-border);\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-content-type-workspace-editor-header': UmbContentTypeWorkspaceEditorHeaderElement;\r\n\t}\r\n}\r\n","import { html, customElement, property, css, state, nothing } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbChangeEvent } from '@umbraco-cms/backoffice/event';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport {\r\n\tUMB_DATATYPE_WORKSPACE_MODAL,\r\n\tUMB_DATA_TYPE_ENTITY_TYPE,\r\n\tUMB_DATA_TYPE_PICKER_FLOW_DATA_TYPE_PICKER_MODAL,\r\n} from '@umbraco-cms/backoffice/data-type';\r\nimport { UmbModalRouteRegistrationController } from '@umbraco-cms/backoffice/router';\r\nimport { UmbFormControlMixin } from '@umbraco-cms/backoffice/validation';\r\n\r\n@customElement('umb-input-content-type-collection-configuration')\r\nexport class UmbInputContentTypeCollectionConfigurationElement extends UmbFormControlMixin<\r\n\tstring,\r\n\ttypeof UmbLitElement\r\n>(UmbLitElement) {\r\n\tprotected override getFormElement() {\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\t#dataTypeModal;\r\n\r\n\t#propertyEditorUiAlias = 'Umb.PropertyEditorUi.Collection';\r\n\r\n\t@state()\r\n\tprivate _dataTypePickerModalPath?: string;\r\n\r\n\t@property({ attribute: 'default-value' })\r\n\tdefaultValue?: string;\r\n\r\n\t#setValue(value: string | undefined) {\r\n\t\tthis.value = value;\r\n\t\tthis.dispatchEvent(new UmbChangeEvent());\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tnew UmbModalRouteRegistrationController(this, UMB_DATA_TYPE_PICKER_FLOW_DATA_TYPE_PICKER_MODAL)\r\n\t\t\t.addAdditionalPath(':uiAlias')\r\n\t\t\t.onSetup((routingInfo) => {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tpropertyEditorUiAlias: routingInfo.uiAlias,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tvalue: undefined,\r\n\t\t\t\t};\r\n\t\t\t})\r\n\t\t\t.onSubmit((submitData) => {\r\n\t\t\t\tif (submitData?.createNewWithPropertyEditorUiAlias) {\r\n\t\t\t\t\tthis.#createDataType();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.#setValue(submitData?.dataTypeId ?? this.defaultValue ?? '');\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.observeRouteBuilder((routeBuilder) => {\r\n\t\t\t\tthis._dataTypePickerModalPath = routeBuilder({ uiAlias: this.#propertyEditorUiAlias });\r\n\t\t\t});\r\n\r\n\t\tthis.#dataTypeModal = new UmbModalRouteRegistrationController(this, UMB_DATATYPE_WORKSPACE_MODAL)\r\n\t\t\t.addAdditionalPath(':uiAlias')\r\n\t\t\t.onSetup((params) => {\r\n\t\t\t\treturn { data: { entityType: UMB_DATA_TYPE_ENTITY_TYPE, preset: { editorUiAlias: params.uiAlias } } };\r\n\t\t\t})\r\n\t\t\t.onSubmit((value) => {\r\n\t\t\t\tthis.#setValue(value?.unique ?? this.defaultValue ?? '');\r\n\t\t\t});\r\n\t}\r\n\r\n\t#clearDataType() {\r\n\t\tthis.#setValue(undefined);\r\n\t}\r\n\r\n\t#createDataType() {\r\n\t\tthis.#dataTypeModal.open(\r\n\t\t\t{ uiAlias: this.#propertyEditorUiAlias },\r\n\t\t\t`create/parent/${UMB_DATA_TYPE_ENTITY_TYPE}/null`,\r\n\t\t);\r\n\t}\r\n\r\n\t#editDataType() {\r\n\t\tthis.#dataTypeModal?.open({}, `edit/${this.value}`);\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn !this.value ? this.#renderCreate() : this.#renderConfigured();\r\n\t}\r\n\r\n\t#renderCreate() {\r\n\t\tif (!this._dataTypePickerModalPath) return nothing;\r\n\t\treturn html`\r\n\t\t\t<uui-button\r\n\t\t\t\tid=\"create-button\"\r\n\t\t\t\tcolor=\"default\"\r\n\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\tlabel=${this.localize.term('collection_addCollectionConfiguration')}\r\n\t\t\t\thref=${this._dataTypePickerModalPath}></uui-button>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderConfigured() {\r\n\t\tif (!this.value || !this._dataTypePickerModalPath) return nothing;\r\n\t\treturn html`\r\n\t\t\t<uui-ref-list>\r\n\t\t\t\t<umb-ref-data-type standalone data-type-id=${this.value} @open=${this.#editDataType}>\r\n\t\t\t\t\t<uui-action-bar slot=\"actions\">\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tlabel=${this.localize.term('general_choose')}\r\n\t\t\t\t\t\t\thref=${this._dataTypePickerModalPath}></uui-button>\r\n\t\t\t\t\t\t<uui-button @click=${this.#clearDataType} label=${this.localize.term('general_remove')}></uui-button>\r\n\t\t\t\t\t</uui-action-bar>\r\n\t\t\t\t</umb-ref-data-type>\r\n\t\t\t</uui-ref-list>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tcss`\r\n\t\t\t#create-button {\r\n\t\t\t\twidth: 100%;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-input-content-type-collection-configuration': UmbInputContentTypeCollectionConfigurationElement;\r\n\t}\r\n}\r\n","import type { UmbContentTypeStructureRepository } from './content-type-structure-repository.interface.js';\r\nimport type {\r\n\tUmbContentTypeStructureDataSource,\r\n\tUmbContentTypeStructureDataSourceConstructor,\r\n} from './content-type-structure-data-source.interface.js';\r\nimport { UmbRepositoryBase } from '@umbraco-cms/backoffice/repository';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\n\r\nexport abstract class UmbContentTypeStructureRepositoryBase<ItemType>\r\n\textends UmbRepositoryBase\r\n\timplements UmbContentTypeStructureRepository<ItemType>\r\n{\r\n\t#structureSource: UmbContentTypeStructureDataSource<ItemType>;\r\n\r\n\tconstructor(host: UmbControllerHost, structureSource: UmbContentTypeStructureDataSourceConstructor<ItemType>) {\r\n\t\tsuper(host);\r\n\t\tthis.#structureSource = new structureSource(host);\r\n\t}\r\n\r\n\t/**\r\n\t * Returns a promise with the allowed children of a content type\r\n\t * @param {string} unique\r\n\t * @param parentContentUnique\r\n\t * @returns {*}\r\n\t * @memberof UmbContentTypeStructureRepositoryBase\r\n\t */\r\n\trequestAllowedChildrenOf(unique: string | null, parentContentUnique: string | null) {\r\n\t\treturn this.#structureSource.getAllowedChildrenOf(unique, parentContentUnique);\r\n\t}\r\n}\r\n","import type { UmbContentTypeStructureDataSource } from './content-type-structure-data-source.interface.js';\r\nimport type { UmbEntityModel } from '@umbraco-cms/backoffice/entity';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { tryExecute } from '@umbraco-cms/backoffice/resources';\r\nimport type { UmbPagedModel, UmbDataSourceResponse } from '@umbraco-cms/backoffice/repository';\r\n\r\n// Keep this type internal\r\ntype AllowedContentTypeBaseModel = {\r\n\tid: string;\r\n\tname: string;\r\n\tdescription?: string | null;\r\n\ticon?: string | null;\r\n};\r\n\r\nexport interface UmbContentTypeStructureServerDataSourceBaseArgs<\r\n\tServerItemType extends AllowedContentTypeBaseModel,\r\n\tClientItemType extends UmbEntityModel,\r\n> {\r\n\tgetAllowedChildrenOf: (\r\n\t\tunique: string | null,\r\n\t\tparentContentUnique: string | null,\r\n\t) => Promise<UmbDataSourceResponse<UmbPagedModel<ServerItemType>>>;\r\n\tmapper: (item: ServerItemType) => ClientItemType;\r\n}\r\n\r\nexport abstract class UmbContentTypeStructureServerDataSourceBase<\r\n\tServerItemType extends AllowedContentTypeBaseModel,\r\n\tClientItemType extends UmbEntityModel,\r\n> implements UmbContentTypeStructureDataSource<ClientItemType>\r\n{\r\n\t#host;\r\n\t#getAllowedChildrenOf;\r\n\t#mapper;\r\n\r\n\t/**\r\n\t * Creates an instance of UmbContentTypeStructureServerDataSourceBase.\r\n\t * @param {UmbControllerHost} host - The controller host for this controller to be appended to\r\n\t * @param args\r\n\t * @memberof UmbItemServerDataSourceBase\r\n\t */\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\targs: UmbContentTypeStructureServerDataSourceBaseArgs<ServerItemType, ClientItemType>,\r\n\t) {\r\n\t\tthis.#host = host;\r\n\t\tthis.#getAllowedChildrenOf = args.getAllowedChildrenOf;\r\n\t\tthis.#mapper = args.mapper;\r\n\t}\r\n\r\n\t/**\r\n\t * Returns a promise with the allowed content types for the given unique\r\n\t * @param {string} unique\r\n\t * @param parentContentUnique\r\n\t * @returns {*}\r\n\t * @memberof UmbContentTypeStructureServerDataSourceBase\r\n\t */\r\n\tasync getAllowedChildrenOf(unique: string | null, parentContentUnique: string | null) {\r\n\t\tconst { data, error } = await tryExecute(this.#host, this.#getAllowedChildrenOf(unique, parentContentUnique));\r\n\r\n\t\tif (data) {\r\n\t\t\tconst items = data.items.map((item) => this.#mapper(item));\r\n\t\t\treturn { data: { items, total: data.total } };\r\n\t\t}\r\n\r\n\t\treturn { error };\r\n\t}\r\n}\r\n","import type {\r\n\tUmbContentTypeModel,\r\n\tUmbPropertyContainerTypes,\r\n\tUmbPropertyTypeContainerMergedModel,\r\n\tUmbPropertyTypeContainerModel,\r\n\tUmbPropertyTypeModel,\r\n} from '../types.js';\r\nimport {\r\n\tUmbRepositoryDetailsManager,\r\n\ttype UmbDetailRepository,\r\n\ttype UmbRepositoryResponse,\r\n\ttype UmbRepositoryResponseWithAsObservable,\r\n} from '@umbraco-cms/backoffice/repository';\r\nimport { UmbId } from '@umbraco-cms/backoffice/id';\r\nimport type { UmbControllerHost, UmbController } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { MappingFunction, Observable } from '@umbraco-cms/backoffice/observable-api';\r\nimport {\r\n\tUmbArrayState,\r\n\tpartialUpdateFrozenArray,\r\n\tappendToFrozenArray,\r\n\tfilterFrozenArray,\r\n\tcreateObservablePart,\r\n\tobservationAsPromise,\r\n\tmergeObservables,\r\n} from '@umbraco-cms/backoffice/observable-api';\r\nimport { incrementString } from '@umbraco-cms/backoffice/utils';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { UmbExtensionApiInitializer } from '@umbraco-cms/backoffice/extension-api';\r\nimport { umbExtensionsRegistry, type ManifestRepository } from '@umbraco-cms/backoffice/extension-registry';\r\nimport { firstValueFrom } from '@umbraco-cms/backoffice/external/rxjs';\r\nimport { UmbError } from '@umbraco-cms/backoffice/resources';\r\nimport { encodeFolderName } from '@umbraco-cms/backoffice/router';\r\n\r\ntype UmbPropertyTypeUnique = UmbPropertyTypeModel['unique'];\r\n\r\nconst UmbFilterDuplicateStrings = (value: string, index: number, array: Array<string>) =>\r\n\tarray.indexOf(value) === index;\r\n\r\n/**\r\n * Manages a structure of a Content Type and its properties and containers.\r\n * This loads and merges the structures of the Content Type and its inherited and composed Content Types.\r\n * To help manage the data, there is two helper classes:\r\n * - {@link UmbContentTypePropertyStructureHelper} for managing the structure of properties, optional of another container or root.\r\n * - {@link UmbContentTypeContainerStructureHelper} for managing the structure of containers, optional of another container or root.\r\n */\r\nexport class UmbContentTypeStructureManager<\r\n\tT extends UmbContentTypeModel = UmbContentTypeModel,\r\n> extends UmbControllerBase {\r\n\t#initResolver?: (result: T) => void;\r\n\t#initRejection?: (reason: any) => void;\r\n\t#init = new Promise<T>((resolve, reject) => {\r\n\t\tthis.#initResolver = resolve;\r\n\t\tthis.#initRejection = reject;\r\n\t});\r\n\r\n\t#editedTypes = new UmbArrayState<string, string>([], (x) => x);\r\n\r\n\t#repository?: UmbDetailRepository<T>;\r\n\t#initRepositoryResolver?: (repo: UmbDetailRepository<T>) => void;\r\n\r\n\t#initRepository = new Promise<UmbDetailRepository<T>>((resolve) => {\r\n\t\tif (this.#repository) {\r\n\t\t\tresolve(this.#repository);\r\n\t\t} else {\r\n\t\t\tthis.#initRepositoryResolver = resolve;\r\n\t\t}\r\n\t});\r\n\r\n\t#repoManager?: UmbRepositoryDetailsManager<T>;\r\n\r\n\tasync whenLoaded() {\r\n\t\tawait this.#init;\r\n\t\treturn true;\r\n\t}\r\n\r\n\t#ownerContentTypeUnique?: string;\r\n\t#contentTypeObservers = new Array<UmbController>();\r\n\r\n\t#contentTypes = new UmbArrayState<T>([], (x) => x.unique);\r\n\treadonly contentTypes = this.#contentTypes.asObservable();\r\n\treadonly ownerContentType = this.#contentTypes.asObservablePart((x) =>\r\n\t\tx.find((y) => y.unique === this.#ownerContentTypeUnique),\r\n\t);\r\n\treadonly ownerContentTypeAlias = createObservablePart(this.ownerContentType, (x) => x?.alias);\r\n\treadonly ownerContentTypeName = createObservablePart(this.ownerContentType, (x) => x?.name);\r\n\treadonly ownerContentTypeCompositions = createObservablePart(this.ownerContentType, (x) => x?.compositions);\r\n\r\n\treadonly contentTypeCompositions = this.#contentTypes.asObservablePart((contentTypes) => {\r\n\t\treturn contentTypes.flatMap((x) => x.compositions ?? []);\r\n\t});\r\n\tasync getContentTypeCompositions() {\r\n\t\treturn await this.observe(this.contentTypeCompositions).asPromise();\r\n\t}\r\n\tasync getOwnerContentTypeCompositions() {\r\n\t\treturn await this.observe(this.ownerContentTypeCompositions).asPromise();\r\n\t}\r\n\treadonly #contentTypeContainers = this.#contentTypes.asObservablePart((contentTypes) => {\r\n\t\treturn contentTypes.flatMap((x) => x.containers ?? []);\r\n\t});\r\n\treadonly contentTypeProperties = this.#contentTypes.asObservablePart((contentTypes) => {\r\n\t\treturn contentTypes.flatMap((x) => x.properties ?? []);\r\n\t});\r\n\tasync getContentTypeProperties() {\r\n\t\treturn await this.observe(this.contentTypeProperties).asPromise();\r\n\t}\r\n\treadonly contentTypeDataTypeUniques = this.#contentTypes.asObservablePart((contentTypes) => {\r\n\t\treturn contentTypes\r\n\t\t\t.flatMap((x) => x.properties?.map((p) => p.dataType.unique) ?? [])\r\n\t\t\t.filter(UmbFilterDuplicateStrings);\r\n\t});\r\n\treadonly contentTypeHasProperties = this.#contentTypes.asObservablePart((contentTypes) => {\r\n\t\treturn contentTypes.some((x) => x.properties.length > 0);\r\n\t});\r\n\treadonly contentTypePropertyAliases = createObservablePart(this.contentTypeProperties, (properties) =>\r\n\t\tproperties.map((x) => x.alias),\r\n\t);\r\n\treadonly contentTypeUniques = this.#contentTypes.asObservablePart((x) => x.map((y) => y.unique));\r\n\treadonly contentTypeAliases = this.#contentTypes.asObservablePart((x) => x.map((y) => y.alias));\r\n\r\n\treadonly contentTypeLoaded = mergeObservables(\r\n\t\t[this.contentTypeCompositions, this.contentTypeUniques],\r\n\t\t([comps, uniques]) => {\r\n\t\t\treturn comps.every((x) => uniques.includes(x.contentType.unique));\r\n\t\t},\r\n\t);\r\n\r\n\treadonly variesByCulture = createObservablePart(this.ownerContentType, (x) => x?.variesByCulture);\r\n\treadonly variesBySegment = createObservablePart(this.ownerContentType, (x) => x?.variesBySegment);\r\n\r\n\tcontainerById(id: string) {\r\n\t\treturn createObservablePart(this.#contentTypeContainers, (x) => x.find((y) => y.id === id));\r\n\t}\r\n\r\n\tconstructor(host: UmbControllerHost, typeRepository: UmbDetailRepository<T> | string) {\r\n\t\tsuper(host);\r\n\r\n\t\tif (typeof typeRepository === 'string') {\r\n\t\t\tthis.#observeRepository(typeRepository);\r\n\t\t} else {\r\n\t\t\tthis.#repository = typeRepository;\r\n\t\t\tthis.#initRepositoryResolver?.(typeRepository);\r\n\t\t}\r\n\r\n\t\tthis.#initRepository.then(() => {\r\n\t\t\tif (!this.#repository) {\r\n\t\t\t\tthrow new Error(\r\n\t\t\t\t\t'Content Type Structure Manager failed cause it could not initialize or receive the Content Type Detail Repository.',\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tthis.#repoManager = new UmbRepositoryDetailsManager(this, typeRepository);\r\n\t\t\tthis.observe(\r\n\t\t\t\tthis.#repoManager.entries,\r\n\t\t\t\t(entries) => {\r\n\t\t\t\t\t// Prevent updating once that are have edited here.\r\n\t\t\t\t\tconst entriesToBeUpdated = entries.filter(\r\n\t\t\t\t\t\t(x) => !(this.#editedTypes.getHasOne(x.unique) && this.#contentTypes.getHasOne(x.unique)),\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\t// Remove entries based on no-longer existing uniques:\r\n\t\t\t\t\tconst entriesToBeRemoved = this.#contentTypes\r\n\t\t\t\t\t\t.getValue()\r\n\t\t\t\t\t\t.filter((entry) => !entries.some((x) => x.unique === entry.unique))\r\n\t\t\t\t\t\t.map((x) => x.unique);\r\n\r\n\t\t\t\t\tthis.#contentTypes.mute();\r\n\t\t\t\t\tthis.#contentTypes.remove(entriesToBeRemoved);\r\n\t\t\t\t\tthis.#contentTypes.append(entriesToBeUpdated);\r\n\t\t\t\t\tthis.#contentTypes.unmute();\r\n\t\t\t\t},\r\n\t\t\t\tnull,\r\n\t\t\t);\r\n\t\t});\r\n\r\n\t\t// Observe all Content Types compositions: [NL]\r\n\t\tthis.observe(\r\n\t\t\tthis.contentTypeCompositions,\r\n\t\t\t(contentTypeCompositions) => {\r\n\t\t\t\tthis.#loadContentTypeCompositions(contentTypeCompositions);\r\n\t\t\t},\r\n\t\t\tnull,\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * loadType will load the ContentType and all inherited and composed ContentTypes.\r\n\t * This will give us all the structure for properties and containers.\r\n\t * @param {string} unique - The unique of the ContentType to load.\r\n\t * @returns {Promise} - Promise resolved\r\n\t */\r\n\tpublic async loadType(unique: string): Promise<UmbRepositoryResponseWithAsObservable<T | undefined>> {\r\n\t\tif (this.#ownerContentTypeUnique === unique) {\r\n\t\t\t// Its the same, but we do not know if its done loading jet, so we will wait for the load promise to finish. [NL]\r\n\t\t\tawait this.#init;\r\n\t\t\treturn { data: this.getOwnerContentType(), asObservable: () => this.ownerContentType };\r\n\t\t}\r\n\t\tawait this.#initRepository;\r\n\t\tthis.clear();\r\n\t\tthis.#ownerContentTypeUnique = unique;\r\n\t\tif (!unique) {\r\n\t\t\tthis.#initRejection?.(`Content Type structure manager could not load: ${unique}`);\r\n\t\t\tthis.#initResolver = undefined;\r\n\t\t\tthis.#initRejection = undefined;\r\n\t\t\treturn Promise.reject(\r\n\t\t\t\tnew Error('The unique identifier is missing. A valid unique identifier is required to load the content type.'),\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.#repoManager!.setUniques([unique]);\r\n\t\tconst observable = this.#repoManager!.entryByUnique(unique);\r\n\t\tconst result = await this.observe(observable).asPromise();\r\n\t\tif (!result) {\r\n\t\t\tthis.#initRejection?.(`Content Type structure manager could not load: ${unique}`);\r\n\t\t\tthis.#initResolver = undefined;\r\n\t\t\tthis.#initRejection = undefined;\r\n\t\t\treturn {\r\n\t\t\t\terror: new UmbError(`Content Type structure manager could not load: ${unique}`),\r\n\t\t\t\tasObservable: () => observable,\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\t// Awaits that everything is loaded:\r\n\t\tawait observationAsPromise(this.contentTypeLoaded, async (loaded) => {\r\n\t\t\treturn loaded === true;\r\n\t\t}).catch(() => {\r\n\t\t\tconst msg = `Content Type structure manager could not load: ${unique}. Not all Content Types loaded successfully.`;\r\n\t\t\tthis.#initRejection?.(msg);\r\n\t\t\tthis.#initResolver = undefined;\r\n\t\t\tthis.#initRejection = undefined;\r\n\t\t\treturn Promise.reject(new UmbError(msg));\r\n\t\t});\r\n\r\n\t\tthis.#initResolver?.(result);\r\n\t\tthis.#initResolver = undefined;\r\n\t\tthis.#initRejection = undefined;\r\n\t\treturn { data: result, asObservable: () => this.ownerContentType };\r\n\t}\r\n\r\n\tpublic async createScaffold(preset?: Partial<T>): Promise<UmbRepositoryResponse<T>> {\r\n\t\tawait this.#initRepository;\r\n\t\tthis.clear();\r\n\r\n\t\tconst repsonse = await this.#repository!.createScaffold(preset);\r\n\t\tconst { data } = repsonse;\r\n\t\tif (!data) {\r\n\t\t\tthis.#initRejection?.(`Content Type structure manager could not create scaffold`);\r\n\t\t\tthis.#initResolver = undefined;\r\n\t\t\tthis.#initRejection = undefined;\r\n\t\t\treturn { error: repsonse.error };\r\n\t\t}\r\n\r\n\t\tthis.#ownerContentTypeUnique = data.unique;\r\n\r\n\t\t// Add the new content type to the list of content types, this holds our draft state of this scaffold.\r\n\t\tthis.#contentTypes.appendOne(data);\r\n\t\t// Make a entry in the repo manager:\r\n\t\tthis.#repoManager!.addEntry(data);\r\n\t\tthis.#initResolver?.(data);\r\n\t\tthis.#initResolver = undefined;\r\n\t\tthis.#initRejection = undefined;\r\n\t\treturn repsonse;\r\n\t}\r\n\r\n\t/**\r\n\t * Save the owner content type. Notice this is for a Content Type that is already stored on the server.\r\n\t * @returns {Promise} - A promise that will be resolved when the content type is saved.\r\n\t */\r\n\tpublic async save(): Promise<T> {\r\n\t\tawait this.#initRepository;\r\n\t\tconst contentType = this.getOwnerContentType();\r\n\t\tif (!contentType || !contentType.unique) throw new Error('Could not find the Content Type to save');\r\n\r\n\t\tconst { error, data } = await this.#repository!.save(contentType);\r\n\t\tif (error || !data) {\r\n\t\t\tthrow error?.message ?? 'Repository did not return data after save.';\r\n\t\t}\r\n\r\n\t\t// Update state with latest version:\r\n\t\tthis.#contentTypes.updateOne(contentType.unique, data);\r\n\r\n\t\t// Update entry in the repo manager:\r\n\t\tthis.#repoManager!.addEntry(data);\r\n\t\treturn data;\r\n\t}\r\n\r\n\t/**\r\n\t * Create the owner content type. Notice this is for a Content Type that is NOT already stored on the server.\r\n\t * @param {string | null} parentUnique - The unique of the parent content type\r\n\t * @returns {Promise} - a promise that is resolved when the content type has been created.\r\n\t */\r\n\tpublic async create(parentUnique: string | null): Promise<T> {\r\n\t\tawait this.#initRepository;\r\n\t\tconst contentType = this.getOwnerContentType();\r\n\t\tif (!contentType || !contentType.unique) {\r\n\t\t\tthrow new Error('Could not find the Content Type to create');\r\n\t\t}\r\n\t\tconst { error, data } = await this.#repository!.create(contentType, parentUnique);\r\n\t\tif (error || !data) {\r\n\t\t\tthrow error?.message ?? 'Repository did not return data after create.';\r\n\t\t}\r\n\r\n\t\t// Update state with latest version:\r\n\t\tthis.#contentTypes.updateOne(contentType.unique, data);\r\n\r\n\t\t// Let the repo manager know about this new unique, so it can be loaded:\r\n\t\tthis.#repoManager!.addEntry(data);\r\n\t\treturn data;\r\n\t}\r\n\r\n\tasync #loadContentTypeCompositions(contentTypeCompositions: T['compositions'] | undefined) {\r\n\t\t// Important to wait a JS-cycle, cause this is called by an observation of a state and this results in setting the value for the state(potentially in the same JS-cycle) then we need to make sure we don't trigger a new update before the old subscription chain is completed. [NL]\r\n\t\tawait Promise.resolve();\r\n\t\tconst ownerUnique = this.getOwnerContentTypeUnique();\r\n\t\tif (!ownerUnique) return;\r\n\t\tconst compositionUniques = contentTypeCompositions?.map((x) => x.contentType.unique) ?? [];\r\n\t\tconst newUniques = [ownerUnique, ...compositionUniques];\r\n\t\tthis.#contentTypes.filter((x) => newUniques.includes(x.unique));\r\n\t\tthis.#repoManager!.setUniques(newUniques);\r\n\t}\r\n\r\n\t/** Public methods for consuming structure: */\r\n\r\n\townerContentTypeObservablePart<R>(mappingFunction: MappingFunction<T | undefined, R>) {\r\n\t\treturn createObservablePart(this.ownerContentType, mappingFunction);\r\n\t}\r\n\r\n\tgetOwnerContentType() {\r\n\t\treturn this.#contentTypes.getValue().find((y) => y.unique === this.#ownerContentTypeUnique);\r\n\t}\r\n\r\n\tgetOwnerContentTypeName() {\r\n\t\treturn this.getOwnerContentType()?.name;\r\n\t}\r\n\r\n\tgetOwnerContentTypeUnique() {\r\n\t\treturn this.#ownerContentTypeUnique;\r\n\t}\r\n\r\n\tgetVariesByCulture() {\r\n\t\tconst ownerContentType = this.getOwnerContentType();\r\n\t\treturn ownerContentType?.variesByCulture;\r\n\t}\r\n\tgetVariesBySegment() {\r\n\t\tconst ownerContentType = this.getOwnerContentType();\r\n\t\treturn ownerContentType?.variesBySegment;\r\n\t}\r\n\r\n\t/**\r\n\t * Figure out if any of the Content Types has a Property.\r\n\t * @returns {boolean} - true if any of the Content Type in this composition has a Property.\r\n\t */\r\n\tgetHasProperties() {\r\n\t\treturn this.#contentTypes.getValue().some((y) => y.properties.length > 0);\r\n\t}\r\n\r\n\tupdateOwnerContentType(entry: Partial<T>) {\r\n\t\tthis.#editedTypes.appendOne(this.#ownerContentTypeUnique!);\r\n\t\tthis.#contentTypes.updateOne(this.#ownerContentTypeUnique, entry);\r\n\t}\r\n\r\n\tgetContentTypes() {\r\n\t\treturn this.#contentTypes.getValue();\r\n\t}\r\n\tgetContentTypeUniques() {\r\n\t\treturn this.#contentTypes.getValue().map((x) => x.unique);\r\n\t}\r\n\tgetContentTypeAliases() {\r\n\t\treturn this.#contentTypes.getValue().map((x) => x.alias);\r\n\t}\r\n\r\n\t// TODO: We could move the actions to another class?\r\n\r\n\t/**\r\n\t * Ensure a container exists for a specific Content Type. Otherwise clone it.\r\n\t * @param {string} containerId - The container to ensure exists on the given ContentType.\r\n\t * @param {string} contentTypeUnique - The content type to ensure the container for.\r\n\t * @returns {Promise<UmbPropertyTypeContainerModel | undefined>} - The container found or created for the owner ContentType.\r\n\t */\r\n\tasync ensureContainerOf(\r\n\t\tcontainerId: string,\r\n\t\tcontentTypeUnique: string,\r\n\t): Promise<UmbPropertyTypeContainerModel | undefined> {\r\n\t\tawait this.#init;\r\n\t\tconst contentType = this.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique);\r\n\t\tif (!contentType) {\r\n\t\t\tthrow new Error('Could not find the Content Type to ensure containers for');\r\n\t\t}\r\n\t\tconst container = contentType?.containers?.find((x) => x.id === containerId);\r\n\t\tif (!container) {\r\n\t\t\treturn this.cloneContainerTo(containerId, contentTypeUnique);\r\n\t\t}\r\n\t\treturn container;\r\n\t}\r\n\r\n\t/**\r\n\t * Clone a container to a specific Content Type.\r\n\t * @param {string} containerId - The container to clone, assuming it does not already exist on the given Content Type.\r\n\t * @param {string} toContentTypeUnique - The content type to clone to.\r\n\t * @returns {Promise<UmbPropertyTypeContainerModel | undefined>} - The container cloned or found for the owner ContentType.\r\n\t */\r\n\tasync cloneContainerTo(\r\n\t\tcontainerId: string,\r\n\t\ttoContentTypeUnique?: string,\r\n\t): Promise<UmbPropertyTypeContainerModel | undefined> {\r\n\t\tawait this.#init;\r\n\t\ttoContentTypeUnique = toContentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(toContentTypeUnique);\r\n\r\n\t\t// Find container.\r\n\t\tconst container = (await firstValueFrom(this.#contentTypeContainers)).find((x) => x.id === containerId);\r\n\t\tif (!container) throw new Error('Container to clone was not found');\r\n\r\n\t\tconst clonedContainer: UmbPropertyTypeContainerModel = {\r\n\t\t\t...container,\r\n\t\t\tid: UmbId.new(),\r\n\t\t};\r\n\r\n\t\tif (container.parent) {\r\n\t\t\t// Investigate parent container. (See if we have one that matches if not, then clone it.)\r\n\t\t\tconst parentContainer = await this.ensureContainerOf(container.parent.id, toContentTypeUnique);\r\n\t\t\tif (!parentContainer) {\r\n\t\t\t\tthrow new Error('Parent container for cloning could not be found or created');\r\n\t\t\t}\r\n\t\t\t// Clone container.\r\n\t\t\tclonedContainer.parent = { id: parentContainer.id };\r\n\t\t}\r\n\t\t// Spread containers, so we can append to it, and then update the specific content-type with the new set of containers: [NL]\r\n\t\t// Correction the spread is removed now, cause we do a filter: [NL]\r\n\t\t// And then we remove the existing one, to have the more local one replacing it. [NL]\r\n\t\tconst containers = [\r\n\t\t\t...(this.#contentTypes.getValue().find((x) => x.unique === toContentTypeUnique)?.containers ?? []),\r\n\t\t];\r\n\r\n\t\tcontainers.push(clonedContainer);\r\n\r\n\t\tthis.#contentTypes.updateOne(toContentTypeUnique, { containers } as Partial<T>);\r\n\r\n\t\treturn clonedContainer;\r\n\t}\r\n\r\n\tensureContainerNames(\r\n\t\tcontentTypeUnique: string | null,\r\n\t\ttype: UmbPropertyContainerTypes,\r\n\t\tparentId: string | null = null,\r\n\t) {\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.getOwnerContainers(type, parentId)?.forEach((container) => {\r\n\t\t\tif (container.name === '') {\r\n\t\t\t\tconst newName = 'Unnamed';\r\n\t\t\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\t\t\t\tthis.updateContainer(null, container.id, {\r\n\t\t\t\t\tname: this.makeContainerNameUniqueForOwnerContentType(container.id, newName, type, parentId) ?? newName,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tasync createContainer(\r\n\t\tcontentTypeUnique: string | null,\r\n\t\tparentId: string | null = null,\r\n\t\ttype: UmbPropertyContainerTypes = 'Group',\r\n\t\tsortOrder?: number,\r\n\t): Promise<UmbPropertyTypeContainerModel> {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\r\n\t\tif (parentId) {\r\n\t\t\tconst duplicatedParentContainer = await this.ensureContainerOf(parentId, contentTypeUnique);\r\n\t\t\tif (!duplicatedParentContainer) {\r\n\t\t\t\tthrow new Error('Parent container for creating a new container could not be found or created');\r\n\t\t\t}\r\n\t\t\tparentId = duplicatedParentContainer.id;\r\n\t\t}\r\n\r\n\t\tconst container: UmbPropertyTypeContainerModel = {\r\n\t\t\tid: UmbId.new(),\r\n\t\t\tparent: parentId ? { id: parentId } : null,\r\n\t\t\tname: '',\r\n\t\t\ttype: type,\r\n\t\t\tsortOrder: sortOrder ?? 0,\r\n\t\t};\r\n\r\n\t\treturn this.insertContainer(contentTypeUnique, container);\r\n\t}\r\n\r\n\tasync insertContainer(contentTypeUnique: string | null, container: UmbPropertyTypeContainerModel) {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tconst newContainer = { ...container };\r\n\t\tconst type = newContainer.type;\r\n\t\tconst parentId = newContainer.parent?.id ?? null;\r\n\r\n\t\t// If we have a parent, we need to ensure it exists, and then update the parent property with the new container id.\r\n\t\tif (newContainer.parent) {\r\n\t\t\tconst parentContainer = await this.ensureContainerOf(newContainer.parent.id, contentTypeUnique);\r\n\t\t\tif (!parentContainer) {\r\n\t\t\t\tthrow new Error('Container for inserting property could not be found or created');\r\n\t\t\t}\r\n\t\t\tnewContainer.parent.id = parentContainer.id;\r\n\t\t}\r\n\r\n\t\t// Ensure\r\n\t\tthis.ensureContainerNames(contentTypeUnique, type, parentId);\r\n\r\n\t\tconst frozenContainers =\r\n\t\t\tthis.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique)?.containers ?? [];\r\n\r\n\t\tconst containers = appendToFrozenArray(frozenContainers, newContainer, (x) => x.id === newContainer.id);\r\n\r\n\t\tthis.#contentTypes.updateOne(contentTypeUnique, { containers } as Partial<T>);\r\n\r\n\t\treturn newContainer;\r\n\t}\r\n\r\n\tmakeEmptyContainerName(\r\n\t\tcontainerId: string,\r\n\t\tlegacyContainerType?: UmbPropertyContainerTypes,\r\n\t\tlegacyParentId?: string | null,\r\n\t): string {\r\n\t\treturn (\r\n\t\t\tthis.makeContainerNameUniqueForOwnerContentType(containerId, 'Unnamed', legacyContainerType, legacyParentId) ??\r\n\t\t\t'Unnamed'\r\n\t\t);\r\n\t}\r\n\t/**\r\n\t *\r\n\t * @param {string} containerId - The id of the container to make unique\r\n\t * @param {string} newName - The new name to make unique\r\n\t * @param {never} _legacyContainerType - do not use, has no effect. Is deprecated and will be removed in v.17\r\n\t * @param {never} _legacyParentId - do not use, has no effect. Is deprecated and will be removed in v.17\r\n\t * @returns\r\n\t */\r\n\tmakeContainerNameUniqueForOwnerContentType(\r\n\t\tcontainerId: string,\r\n\t\tnewName: string,\r\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\t\t_legacyContainerType?: UmbPropertyContainerTypes,\r\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\t\t_legacyParentId?: string | null,\r\n\t) {\r\n\t\tconst container = this.getOwnerContainerById(containerId);\r\n\t\tif (!container) {\r\n\t\t\tconsole.warn(`Container with id ${containerId} not found in owner content type.`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tconst containerType = container.type;\r\n\t\tconst parentId = container.parent?.id ?? null;\r\n\r\n\t\tconst ownerRootContainers = this.getOwnerContainers(containerType, parentId); //getRootContainers() can't differentiates between compositions and locals\r\n\t\tif (!ownerRootContainers) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tlet changedName = newName;\r\n\t\twhile (ownerRootContainers.find((con) => con.name === changedName && con.id !== containerId)) {\r\n\t\t\tchangedName = incrementString(changedName);\r\n\t\t}\r\n\r\n\t\treturn changedName === newName ? null : changedName;\r\n\t}\r\n\r\n\tasync updateContainer(\r\n\t\tcontentTypeUnique: string | null,\r\n\t\tcontainerId: string,\r\n\t\tpartialUpdate: Partial<UmbPropertyTypeContainerModel>,\r\n\t) {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\r\n\t\t/*\r\n\t\t// If we have a container, we need to ensure it exists, and then update the container with the new parent id.\r\n\t\tif (containerId) {\r\n\t\t\tconst container = await this.ensureContainerOf(containerId, contentTypeUnique);\r\n\t\t\tif (!container) {\r\n\t\t\t\tthrow new Error('Container for inserting property could not be found or created');\r\n\t\t\t}\r\n\t\t\t// Correct containerId to the local one: [NL]\r\n\t\t\tcontainerId = container.id;\r\n\t\t}\r\n\t\t*/\r\n\r\n\t\tconst frozenContainers =\r\n\t\t\tthis.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique)?.containers ?? [];\r\n\r\n\t\tconst ownerContainer = frozenContainers.find((x) => x.id === containerId);\r\n\t\tif (!ownerContainer) {\r\n\t\t\tconsole.error(\r\n\t\t\t\t'We do not have this container on the requested id, we should clone the container and append the change to it. [NL]',\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst containers: UmbPropertyTypeContainerModel[] = partialUpdateFrozenArray(\r\n\t\t\tfrozenContainers,\r\n\t\t\tpartialUpdate,\r\n\t\t\t(x) => x.id === containerId,\r\n\t\t);\r\n\r\n\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n\t\t// @ts-ignore\r\n\t\t// TODO: fix TS partial complaint\r\n\t\tthis.#contentTypes.updateOne(contentTypeUnique, { containers });\r\n\t}\r\n\r\n\tasync removeContainer(\r\n\t\tcontentTypeUnique: string | null,\r\n\t\tcontainerId: string | null = null,\r\n\t\targs?: { preventRemovingProperties?: boolean },\r\n\t): Promise<void> {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\r\n\t\tconst contentType = this.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique);\r\n\t\tif (!contentType) {\r\n\t\t\tthrow new Error('Could not find the Content Type to remove container from');\r\n\t\t}\r\n\t\tconst frozenContainers = contentType.containers ?? [];\r\n\t\tconst removedContainerIds = frozenContainers\r\n\t\t\t.filter((x) => x.id === containerId || x.parent?.id === containerId)\r\n\t\t\t.map((x) => x.id);\r\n\t\tconst containers = frozenContainers.filter((x) => x.id !== containerId && x.parent?.id !== containerId);\r\n\r\n\t\tconst updates: Partial<T> = { containers } as Partial<T>;\r\n\r\n\t\tif (args?.preventRemovingProperties !== true) {\r\n\t\t\tupdates.properties = contentType.properties.filter((x) =>\r\n\t\t\t\tx.container ? !removedContainerIds.some((ids) => ids === x.container?.id) : true,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tthis.#contentTypes.updateOne(contentTypeUnique, updates);\r\n\t}\r\n\r\n\tasync insertProperty(contentTypeUnique: string | null, property: UmbPropertyTypeModel) {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\r\n\t\t// If we have a container, we need to ensure it exists, and then update the container with the new parent id. [NL]\r\n\t\tif (property.container) {\r\n\t\t\tthis.#contentTypes.mute();\r\n\t\t\tconst container = await this.ensureContainerOf(property.container.id, contentTypeUnique);\r\n\t\t\tthis.#contentTypes.unmute();\r\n\t\t\tif (!container) {\r\n\t\t\t\tthrow new Error('Container for inserting property could not be found or created');\r\n\t\t\t}\r\n\t\t\t// Unfreeze object, while settings container.id\r\n\t\t\tproperty = { ...property, container: { id: container.id } };\r\n\t\t}\r\n\r\n\t\tif (property.sortOrder === undefined) {\r\n\t\t\tproperty.sortOrder = 0;\r\n\t\t}\r\n\r\n\t\tconst frozenProperties =\r\n\t\t\tthis.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique)?.properties ?? [];\r\n\r\n\t\tconst properties = appendToFrozenArray(frozenProperties, property, (x) => x.unique === property.unique);\r\n\r\n\t\tthis.#contentTypes.updateOne(contentTypeUnique, { properties } as Partial<T>);\r\n\t}\r\n\r\n\tasync removeProperty(contentTypeUnique: string | null, propertyUnique: string) {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\r\n\t\tconst frozenProperties =\r\n\t\t\tthis.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique)?.properties ?? [];\r\n\r\n\t\tconst properties = filterFrozenArray(frozenProperties, (x) => x.unique !== propertyUnique);\r\n\r\n\t\tthis.#contentTypes.updateOne(contentTypeUnique, { properties } as Partial<T>);\r\n\t}\r\n\r\n\tasync updateProperty(\r\n\t\tcontentTypeUnique: string | null,\r\n\t\tpropertyUnique: string,\r\n\t\tpartialUpdate: Partial<UmbPropertyTypeModel>,\r\n\t) {\r\n\t\tawait this.#init;\r\n\t\tcontentTypeUnique = contentTypeUnique ?? this.#ownerContentTypeUnique!;\r\n\t\tthis.#editedTypes.appendOne(contentTypeUnique);\r\n\r\n\t\tconst frozenProperties =\r\n\t\t\tthis.#contentTypes.getValue().find((x) => x.unique === contentTypeUnique)?.properties ?? [];\r\n\t\tconst properties = partialUpdateFrozenArray(frozenProperties, partialUpdate, (x) => x.unique === propertyUnique);\r\n\r\n\t\tthis.#contentTypes.updateOne(contentTypeUnique, { properties } as Partial<T>);\r\n\t}\r\n\r\n\t// TODO: Refactor: These property methods, should maybe be named without structure in their name.\r\n\tasync propertyStructureById(propertyUnique: string) {\r\n\t\tawait this.#init;\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\tfor (const docType of docTypes) {\r\n\t\t\t\tconst foundProp = docType.properties?.find((property) => property.unique === propertyUnique);\r\n\t\t\t\tif (foundProp) {\r\n\t\t\t\t\treturn foundProp;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn undefined;\r\n\t\t});\r\n\t}\r\n\tasync propertyStructureByAlias(propertyAlias: string) {\r\n\t\tawait this.#init;\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\tfor (const docType of docTypes) {\r\n\t\t\t\tconst foundProp = docType.properties?.find((property) => property.alias === propertyAlias);\r\n\t\t\t\tif (foundProp) {\r\n\t\t\t\t\treturn foundProp;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn undefined;\r\n\t\t});\r\n\t}\r\n\r\n\tasync getPropertyStructureById(propertyUnique: string) {\r\n\t\tawait this.#init;\r\n\t\tfor (const docType of this.#contentTypes.getValue()) {\r\n\t\t\tconst foundProp = docType.properties?.find((property) => property.unique === propertyUnique);\r\n\t\t\tif (foundProp) {\r\n\t\t\t\treturn foundProp;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\tasync getOwnerPropertyById(propertyUnique: string | null): Promise<UmbPropertyTypeModel | undefined> {\r\n\t\tawait this.#init;\r\n\t\treturn this.getOwnerContentType()?.properties?.find((property) => property.unique === propertyUnique);\r\n\t}\r\n\r\n\tasync getPropertyStructureByAlias(propertyAlias: string) {\r\n\t\tawait this.#init;\r\n\t\tfor (const docType of this.#contentTypes.getValue()) {\r\n\t\t\tconst foundProp = docType.properties?.find((property) => property.alias === propertyAlias);\r\n\t\t\tif (foundProp) {\r\n\t\t\t\treturn foundProp;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\thasPropertyStructuresOf(containerId: string | null) {\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\treturn (\r\n\t\t\t\tdocTypes.find((docType) => {\r\n\t\t\t\t\treturn docType.properties?.find((property) => property.container?.id === containerId);\r\n\t\t\t\t}) !== undefined\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\trootPropertyStructures() {\r\n\t\treturn this.propertyStructuresOf(null);\r\n\t}\r\n\r\n\tpropertyStructuresOf(containerId: string | null) {\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\tconst props: UmbPropertyTypeModel[] = [];\r\n\t\t\tdocTypes.forEach((docType) => {\r\n\t\t\t\tdocType.properties?.forEach((property) => {\r\n\t\t\t\t\tif (property.container?.id === containerId) {\r\n\t\t\t\t\t\tprops.push(property);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\treturn props;\r\n\t\t});\r\n\t}\r\n\r\n\tpropertyStructuresOfGroupIds(groupIds: Array<string>) {\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\tconst props: UmbPropertyTypeModel[] = [];\r\n\t\t\tdocTypes.forEach((docType) => {\r\n\t\t\t\tdocType.properties?.forEach((property) => {\r\n\t\t\t\t\tif (property.container?.id && groupIds.includes(property.container.id)) {\r\n\t\t\t\t\t\tprops.push(property);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\treturn props;\r\n\t\t});\r\n\t}\r\n\r\n\thasPropertyStructuresOfGroupIds(groupIds: Array<string>) {\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\treturn docTypes.some((docType) => {\r\n\t\t\t\treturn docType.properties?.some((property) => {\r\n\t\t\t\t\treturn property.container?.id && groupIds.includes(property.container.id);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\thasPropertyStructuresOfRoot() {\r\n\t\treturn this.#contentTypes.asObservablePart((docTypes) => {\r\n\t\t\treturn docTypes.some((docType) => {\r\n\t\t\t\treturn docType.properties?.some((property) => {\r\n\t\t\t\t\treturn !property.container;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\trootContainers(containerType: UmbPropertyContainerTypes) {\r\n\t\treturn createObservablePart(this.#contentTypeContainers, (data) => {\r\n\t\t\treturn data.filter((x) => x.parent === null && x.type === containerType);\r\n\t\t});\r\n\t}\r\n\r\n\tasync getRootContainers(containerType: UmbPropertyContainerTypes) {\r\n\t\treturn (await firstValueFrom(this.#contentTypeContainers)).filter(\r\n\t\t\t(x) => x.parent === null && x.type === containerType,\r\n\t\t);\r\n\t}\r\n\r\n\tasync hasRootContainers(containerType: UmbPropertyContainerTypes) {\r\n\t\treturn createObservablePart(this.#contentTypeContainers, (data) => {\r\n\t\t\treturn data.filter((x) => x.parent === null && x.type === containerType).length > 0;\r\n\t\t});\r\n\t}\r\n\r\n\townerContainersOf(containerType: UmbPropertyContainerTypes, parentId: string | null) {\r\n\t\treturn this.ownerContentTypeObservablePart(\r\n\t\t\t(x) =>\r\n\t\t\t\tx?.containers?.filter(\r\n\t\t\t\t\t(x) => (parentId ? x.parent?.id === parentId : x.parent === null) && x.type === containerType,\r\n\t\t\t\t) ?? [],\r\n\t\t);\r\n\t}\r\n\r\n\tgetOwnerContainerById(id: string | null): UmbPropertyTypeContainerModel | undefined {\r\n\t\treturn this.getOwnerContentType()?.containers?.find((x) => x.id === id);\r\n\t}\r\n\r\n\tgetOwnerContainers(\r\n\t\tcontainerType: UmbPropertyContainerTypes,\r\n\t\tparentId: string | null,\r\n\t): Array<UmbPropertyTypeContainerModel> | undefined {\r\n\t\treturn this.getOwnerContentType()?.containers?.filter(\r\n\t\t\t(x) => (parentId ? x.parent?.id === parentId : x.parent === null) && x.type === containerType,\r\n\t\t);\r\n\t}\r\n\r\n\tisOwnerContainer(containerId: string): boolean | undefined {\r\n\t\treturn this.getOwnerContentType()?.containers?.some((x) => x.id === containerId);\r\n\t}\r\n\r\n\tcontainersOfParentId(parentId: string, containerType: UmbPropertyContainerTypes) {\r\n\t\treturn createObservablePart(this.#contentTypeContainers, (data) => {\r\n\t\t\treturn data.filter((x) => x.parent?.id === parentId && x.type === containerType);\r\n\t\t});\r\n\t}\r\n\r\n\t// In future this might need to take parentName(parentId lookup) into account as well? otherwise containers that share same name and type will always be merged, but their position might be different and they should not be merged. [NL]\r\n\tcontainersByNameAndType(name: string, containerType: UmbPropertyContainerTypes) {\r\n\t\treturn createObservablePart(this.#contentTypeContainers, (data) => {\r\n\t\t\treturn data.filter((x) => x.name === name && x.type === containerType);\r\n\t\t});\r\n\t}\r\n\r\n\tcontainersByNameAndTypeAndParent(\r\n\t\tname: string,\r\n\t\tcontainerType: UmbPropertyContainerTypes,\r\n\t\tparentName: string | null,\r\n\t\tparentType?: UmbPropertyContainerTypes,\r\n\t) {\r\n\t\treturn createObservablePart(this.#contentTypeContainers, (data) => {\r\n\t\t\treturn data.filter(\r\n\t\t\t\t(x) =>\r\n\t\t\t\t\t// Match name and type:\r\n\t\t\t\t\tx.name === name &&\r\n\t\t\t\t\tx.type === containerType &&\r\n\t\t\t\t\t// If we look for a parent name, then we need to match that as well:\r\n\t\t\t\t\t(parentName !== null\r\n\t\t\t\t\t\t? // And we have a parent on this container, then we need to match the parent name and type as well\r\n\t\t\t\t\t\t\tx.parent\r\n\t\t\t\t\t\t\t? data.some((y) => x.parent!.id === y.id && y.name === parentName && y.type === parentType)\r\n\t\t\t\t\t\t\t: false\r\n\t\t\t\t\t\t: // if we do not have a parent then its not a match\r\n\t\t\t\t\t\t\tx.parent === null), // it parentName === null then we expect the container parent to be null.\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\tgetContentTypeOfContainer(containerId: string) {\r\n\t\treturn this.#contentTypes\r\n\t\t\t.getValue()\r\n\t\t\t.find((contentType) => contentType.containers.some((c) => c.id === containerId));\r\n\t}\r\n\r\n\tcontentTypeOfProperty(propertyId: UmbPropertyTypeUnique) {\r\n\t\treturn this.#contentTypes.asObservablePart((contentTypes) =>\r\n\t\t\tcontentTypes.find((contentType) => contentType.properties.some((p) => p.unique === propertyId)),\r\n\t\t);\r\n\t}\r\n\r\n\t#observeRepository(repositoryAlias: string) {\r\n\t\tif (!repositoryAlias) throw new Error('Content Type structure manager must have a repository alias.');\r\n\r\n\t\tnew UmbExtensionApiInitializer<ManifestRepository<UmbDetailRepository<T>>>(\r\n\t\t\tthis,\r\n\t\t\tumbExtensionsRegistry,\r\n\t\t\trepositoryAlias,\r\n\t\t\t[this._host],\r\n\t\t\t(permitted, ctrl) => {\r\n\t\t\t\tthis.#repository = permitted ? ctrl.api : undefined;\r\n\t\t\t\tif (this.#repository) {\r\n\t\t\t\t\tthis.#initRepositoryResolver?.(this.#repository);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * Get all property aliases for the content type including inherited and composed content types.\r\n\t * @returns {Promise<Array<string>>} - A promise that will be resolved with the list of all content type property aliases.\r\n\t */\r\n\tasync getContentTypePropertyAliases() {\r\n\t\treturn this.#contentTypes\r\n\t\t\t.getValue()\r\n\t\t\t.flatMap((x) => x.properties?.map((y) => y.alias) ?? [])\r\n\t\t\t.filter(UmbFilterDuplicateStrings);\r\n\t}\r\n\r\n\tpublic clear() {\r\n\t\tthis.#contentTypeObservers.forEach((observer) => observer.destroy());\r\n\t\tthis.#contentTypeObservers = [];\r\n\t\tthis.#repoManager?.clear();\r\n\t\tthis.#contentTypes.setValue([]);\r\n\t\tthis.#ownerContentTypeUnique = undefined;\r\n\t}\r\n\r\n\tpublic override destroy() {\r\n\t\tthis.#contentTypes.destroy();\r\n\t\tsuper.destroy();\r\n\t}\r\n\r\n\t#mergedContainers: UmbPropertyTypeContainerMergedModel[] = [];\r\n\tpublic readonly contentTypeMergedContainers = createObservablePart(\r\n\t\tthis.#contentTypeContainers,\r\n\t\t(containers: UmbPropertyTypeContainerModel[]): UmbPropertyTypeContainerMergedModel[] => {\r\n\t\t\t// Lookup map for containers\r\n\t\t\tconst containerByIdCache = new Map<string, UmbPropertyTypeContainerModel>();\r\n\t\t\tfor (const c of containers) {\r\n\t\t\t\tcontainerByIdCache.set(c.id, c);\r\n\t\t\t}\r\n\r\n\t\t\t// Cache to avoid recomputing parent chains\r\n\t\t\tconst chainCache = new Map<string, Array<string>>();\r\n\r\n\t\t\t// Map to merge duplicates\r\n\t\t\tconst mergedMap = new Map<string, UmbPropertyTypeContainerMergedModel>();\r\n\r\n\t\t\tfor (const container of containers) {\r\n\t\t\t\tconst path = getContainerChainKey(container, containerByIdCache, chainCache);\r\n\t\t\t\tconst key = path?.join('|') ?? null;\r\n\t\t\t\tconst isOwner = this.isOwnerContainer(container.id);\r\n\t\t\t\tif (!mergedMap.has(key)) {\r\n\t\t\t\t\t// Store the first occurrence\r\n\t\t\t\t\tmergedMap.set(key, {\r\n\t\t\t\t\t\tkey: key,\r\n\t\t\t\t\t\tids: [container.id],\r\n\t\t\t\t\t\townerId: isOwner ? container.id : undefined,\r\n\t\t\t\t\t\tparentIds: new Set([container.parent?.id ?? null]),\r\n\t\t\t\t\t\tpath: path,\r\n\t\t\t\t\t\ttype: container.type,\r\n\t\t\t\t\t\tname: container.name,\r\n\t\t\t\t\t\tsortOrder: container.sortOrder, // Heavily assuming the first is the owner content type container, this could maybe turn out not always to be the case?\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// existing already then just add the id:\r\n\t\t\t\t\tconst existing = mergedMap.get(key)!;\r\n\t\t\t\t\texisting.ids.push(container.id);\r\n\t\t\t\t\texisting.parentIds.add(container.parent?.id ?? null);\r\n\t\t\t\t\texisting.ownerId ??= isOwner ? container.id : undefined;\r\n\t\t\t\t\tif (isOwner) {\r\n\t\t\t\t\t\t// If this is the owner container, then we should update the sort order to ensure it is the one from the owner instance: [NL]\r\n\t\t\t\t\t\texisting.sortOrder = container.sortOrder;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn (this.#mergedContainers = Array.from(mergedMap.values()));\r\n\t\t},\r\n\t);\r\n\r\n\tpublic mergedContainersOfId(id: string): Observable<UmbPropertyTypeContainerMergedModel | undefined> {\r\n\t\treturn createObservablePart(this.contentTypeMergedContainers, (mergedContainers) => {\r\n\t\t\treturn mergedContainers.find((x) => x.ids.includes(id));\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t *\r\n\t * Find merged containers that match the provided container ids.\r\n\t * Notice if you can provide one or more ids matching the same container and it will still only return return the matching container once.\r\n\t * @param containerIds - An array of container ids to find merged containers for.\r\n\t * @returns {Observable} - An observable that emits the merged containers that match the provided container ids.\r\n\t */\r\n\t/*\r\n\tpublic mergedContainersOfIds(searchIds: Array<string>): Observable<Array<UmbPropertyTypeContainerMergedModel>> {\r\n\t\treturn createObservablePart(this.contentTypeMergedContainers, (mergedContainers) => {\r\n\t\t\treturn mergedContainers.filter((x) => searchIds.some((id) => x.ids.includes(id)));\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\t/**\r\n\t * Find a merged container that match the provided container id.\r\n\t * @param {string} id - The id to find the merged container of.\r\n\t * @returns {UmbPropertyTypeContainerMergedModel | undefined} - The merged containers that match the provided container ids.\r\n\t */\r\n\tgetMergedContainerById(id: string): UmbPropertyTypeContainerMergedModel | undefined {\r\n\t\treturn this.#mergedContainers.find((x) => x.ids.includes(id));\r\n\t}\r\n\t/**\r\n\t * Find a merged container that match the provided merged-container key.\r\n\t * @param {string} key - The key to find the merged container of.\r\n\t * @returns {UmbPropertyTypeContainerMergedModel | undefined} - The merged containers that match the provided merged-container key.\r\n\t */\r\n\tgetMergedContainerByKey(key: string): UmbPropertyTypeContainerMergedModel | undefined {\r\n\t\treturn this.#mergedContainers.find((x) => x.key === key);\r\n\t}\r\n\r\n\t/**\r\n\t *\r\n\t * Find merged child containers that are children of the provided parent container ids.\r\n\t * Notice this will find matching containers and include their child containers in this.\r\n\t * @param containerIds - An array of container ids to find merged child containers for.\r\n\t * @param searchId\r\n\t * @param type - The type of the containers to find.\r\n\t * @returns {Observable} - An observable that emits the merged child containers that match the provided container ids.\r\n\t */\r\n\tpublic mergedContainersOfParentIdAndType(\r\n\t\tsearchId: string | null,\r\n\t\ttype: UmbPropertyContainerTypes,\r\n\t): Observable<Array<UmbPropertyTypeContainerMergedModel>> {\r\n\t\treturn createObservablePart(this.contentTypeMergedContainers, (mergedContainers) => {\r\n\t\t\t// First find the path for the parentId, and then find matching children:\r\n\t\t\tconst parentIds = searchId ? (mergedContainers.find((x) => x.ids.includes(searchId))?.ids ?? []) : [null];\r\n\t\t\treturn mergedContainers.filter((x) => x.type === type && parentIds.some((id) => x.parentIds.has(id)));\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t *\r\n\t * Find merged child containers that are children of one of the provided parent container ids.\r\n\t * Notice if you can provide one or more ids matching the same parent and it will still only return return the matching child container once.\r\n\t * @param containerIds - An array of container ids to find merged child containers for.\r\n\t * @param type - The type of the containers to find.\r\n\t * @returns {Observable} - An observable that emits the merged child containers that match the provided container ids.\r\n\t */\r\n\t/*\r\n\tpublic mergedContainersOfParentIds(\r\n\t\tsearchIds: Array<string | null>,\r\n\t\ttype: UmbPropertyContainerTypes,\r\n\t): Observable<Array<UmbPropertyTypeContainerMergedModel>> {\r\n\t\treturn createObservablePart(this.contentTypeMergedContainers, (mergedContainers) => {\r\n\t\t\treturn mergedContainers.filter((x) => x.type === type && searchIds.some((id) => x.parentIds.has(id)));\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\n// Get a unique key for a container including all parent type/name pairs\r\n/**\r\n *\r\n * @param container\r\n * @param containerById\r\n * @param chainCache\r\n */\r\nfunction getContainerChainKey(\r\n\tcontainer: UmbPropertyTypeContainerModel,\r\n\tcontainerById: Map<string, UmbPropertyTypeContainerModel>,\r\n\tchainCache: Map<string, Array<string>>,\r\n): Array<string> {\r\n\tif (chainCache.has(container.id)) {\r\n\t\treturn chainCache.get(container.id)!;\r\n\t}\r\n\r\n\t// Notice this is made compatible with the path for the URL of the tab, making the match simpler in the other end. [NL]\r\n\tlet path = [`${container.type.toLowerCase()}/${encodeFolderName(container.name)}`];\r\n\tif (container.parent && containerById.has(container.parent.id)) {\r\n\t\tconst parent = containerById.get(container.parent.id)!;\r\n\t\tpath = [...getContainerChainKey(parent, containerById, chainCache), ...path];\r\n\t} else if (!container.parent && container.type === 'Group') {\r\n\t\t// Append root to the containers with no parent.\r\n\t\t//path.unshift(`root`);\r\n\t\t// No that is not part of the responsibility of this one. [NL]\r\n\t}\r\n\r\n\tchainCache.set(container.id, [...path]);\r\n\treturn path;\r\n}\r\n","import { UmbContentTypeStructureManager } from '../structure/index.js';\r\nimport type { UmbContentTypeCompositionModel, UmbContentTypeDetailModel, UmbContentTypeSortModel } from '../types.js';\r\nimport type { UmbContentTypeWorkspaceContext } from './content-type-workspace-context.interface.js';\r\nimport { UmbEntityDetailWorkspaceContextBase } from '@umbraco-cms/backoffice/workspace';\r\nimport {\r\n\tUmbEntityUpdatedEvent,\r\n\tUmbRequestReloadChildrenOfEntityEvent,\r\n\tUmbRequestReloadStructureForEntityEvent,\r\n} from '@umbraco-cms/backoffice/entity-action';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport type { Observable } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbEntityModel } from '@umbraco-cms/backoffice/entity';\r\nimport type {\r\n\tUmbDetailRepository,\r\n\tUmbRepositoryResponse,\r\n\tUmbRepositoryResponseWithAsObservable,\r\n} from '@umbraco-cms/backoffice/repository';\r\nimport type {\r\n\tUmbEntityDetailWorkspaceContextArgs,\r\n\tUmbEntityDetailWorkspaceContextCreateArgs,\r\n\tUmbRoutableWorkspaceContext,\r\n} from '@umbraco-cms/backoffice/workspace';\r\nimport type { UmbReferenceByUnique } from '@umbraco-cms/backoffice/models';\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\r\nexport interface UmbContentTypeWorkspaceContextArgs extends UmbEntityDetailWorkspaceContextArgs {}\r\n\r\nconst LOADING_STATE_UNIQUE = 'umbLoadingContentTypeDetail';\r\n\r\nexport abstract class UmbContentTypeWorkspaceContextBase<\r\n\t\tDetailModelType extends UmbContentTypeDetailModel = UmbContentTypeDetailModel,\r\n\t\tDetailRepositoryType extends UmbDetailRepository<DetailModelType> = UmbDetailRepository<DetailModelType>,\r\n\t>\r\n\textends UmbEntityDetailWorkspaceContextBase<DetailModelType, DetailRepositoryType>\r\n\timplements UmbContentTypeWorkspaceContext<DetailModelType>, UmbRoutableWorkspaceContext\r\n{\r\n\tpublic readonly IS_CONTENT_TYPE_WORKSPACE_CONTEXT = true;\r\n\r\n\tpublic readonly name: Observable<string | undefined>;\r\n\tpublic readonly alias: Observable<string | undefined>;\r\n\tpublic readonly description: Observable<string | undefined>;\r\n\tpublic readonly icon: Observable<string | undefined>;\r\n\r\n\tpublic readonly allowedAtRoot: Observable<boolean | undefined>;\r\n\tpublic readonly variesByCulture: Observable<boolean | undefined>;\r\n\tpublic readonly variesBySegment: Observable<boolean | undefined>;\r\n\tpublic readonly isElement: Observable<boolean | undefined>;\r\n\tpublic readonly allowedContentTypes: Observable<Array<UmbContentTypeSortModel> | undefined>;\r\n\tpublic readonly compositions: Observable<Array<UmbContentTypeCompositionModel> | undefined>;\r\n\tpublic readonly collection: Observable<UmbReferenceByUnique | null | undefined>;\r\n\r\n\tpublic readonly structure: UmbContentTypeStructureManager<DetailModelType>;\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbContentTypeWorkspaceContextArgs) {\r\n\t\tsuper(host, args);\r\n\r\n\t\tthis.structure = new UmbContentTypeStructureManager<DetailModelType>(this, args.detailRepositoryAlias);\r\n\r\n\t\tthis.name = this.structure.ownerContentTypeObservablePart((data) => data?.name);\r\n\t\tthis.alias = this.structure.ownerContentTypeObservablePart((data) => data?.alias);\r\n\t\tthis.description = this.structure.ownerContentTypeObservablePart((data) => data?.description);\r\n\t\tthis.icon = this.structure.ownerContentTypeObservablePart((data) => data?.icon);\r\n\t\tthis.allowedAtRoot = this.structure.ownerContentTypeObservablePart((data) => data?.allowedAtRoot);\r\n\t\tthis.variesByCulture = this.structure.ownerContentTypeObservablePart((data) => data?.variesByCulture);\r\n\t\tthis.variesBySegment = this.structure.ownerContentTypeObservablePart((data) => data?.variesBySegment);\r\n\t\tthis.isElement = this.structure.ownerContentTypeObservablePart((data) => data?.isElement);\r\n\t\tthis.allowedContentTypes = this.structure.ownerContentTypeObservablePart((data) => data?.allowedContentTypes);\r\n\t\tthis.compositions = this.structure.ownerContentTypeObservablePart((data) => data?.compositions);\r\n\t\tthis.collection = this.structure.ownerContentTypeObservablePart((data) => data?.collection);\r\n\r\n\t\t// Keep current data in sync with the owner content type - This is used for the discard changes feature\r\n\t\tthis.observe(this.structure.ownerContentType, (data) => this._data.setCurrent(data), null);\r\n\t\tthis.observe(this.name, (name) => this.view.setTitle(name), null);\r\n\t\t// TODO: sometimes the browserTitle for a parent view is set later than the child is updating. We need to fix this as well enable a parent browser title to be updating on the go. [NL]\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a new scaffold\r\n\t * @param { UmbEntityDetailWorkspaceContextCreateArgs<DetailModelType> } args The arguments for creating a new scaffold\r\n\t * @returns { Promise<DetailModelType | undefined> } The new scaffold\r\n\t */\r\n\tpublic override async createScaffold(\r\n\t\targs: UmbEntityDetailWorkspaceContextCreateArgs<DetailModelType>,\r\n\t): Promise<DetailModelType | undefined> {\r\n\t\tthis.resetState();\r\n\t\tthis.loading.addState({ unique: LOADING_STATE_UNIQUE, message: `Creating ${this.getEntityType()} scaffold` });\r\n\t\tthis._internal_setCreateUnderParent(args.parent);\r\n\r\n\t\tconst request = this.structure.createScaffold(args.preset);\r\n\t\tthis._getDataPromise = request;\r\n\t\tlet { data } = await request;\r\n\r\n\t\tif (data) {\r\n\t\t\tdata = await this._processIncomingData(data);\r\n\t\t\tdata = await this._scaffoldProcessData(data);\r\n\r\n\t\t\tif (this.modalContext) {\r\n\t\t\t\t// Notice if the preset comes with values, they will overwrite the scaffolded values... [NL]\r\n\t\t\t\tdata = { ...data, ...this.modalContext.data.preset };\r\n\t\t\t}\r\n\r\n\t\t\tthis.setUnique(data.unique);\r\n\t\t\tthis.setIsNew(true);\r\n\t\t\tthis._data.setPersisted(data);\r\n\t\t}\r\n\r\n\t\tthis.loading.removeState(LOADING_STATE_UNIQUE);\r\n\r\n\t\treturn data;\r\n\t}\r\n\r\n\t/**\r\n\t * Loads the data for the workspace\r\n\t * @param { string } unique The unique identifier of the data to load\r\n\t * @returns { Promise<UmbRepositoryResponse<DetailModelType> | UmbRepositoryResponseWithAsObservable<DetailModelType>> } The loaded data\r\n\t */\r\n\toverride async load(\r\n\t\tunique: string,\r\n\t): Promise<UmbRepositoryResponse<DetailModelType> | UmbRepositoryResponseWithAsObservable<DetailModelType>> {\r\n\t\tif (unique === this.getUnique() && this._getDataPromise) {\r\n\t\t\treturn await this._getDataPromise;\r\n\t\t}\r\n\r\n\t\tthis.resetState();\r\n\t\tthis.setUnique(unique);\r\n\t\tthis.loading.addState({ unique: LOADING_STATE_UNIQUE, message: `Loading ${this.getEntityType()} Details` });\r\n\t\tthis._getDataPromise = this.structure.loadType(unique);\r\n\t\tconst response = await this._getDataPromise;\r\n\t\tconst data = response.data;\r\n\t\tif (data) {\r\n\t\t\tthis._data.setPersisted(data);\r\n\t\t\tthis.setIsNew(false);\r\n\r\n\t\t\tthis.observe(\r\n\t\t\t\tthis.structure.ownerContentType,\r\n\t\t\t\t(entity: any) => this.#onDetailStoreChange(entity),\r\n\t\t\t\t'umbContentTypeDetailStoreObserver',\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tthis.loading.removeState(LOADING_STATE_UNIQUE);\r\n\t\treturn response;\r\n\t}\r\n\r\n\t#onDetailStoreChange(entity: DetailModelType | undefined) {\r\n\t\tif (!entity) {\r\n\t\t\tthis._data.clear();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Creates the Content Type\r\n\t * @param { DetailModelType } currentData The current data\r\n\t * @param { UmbEntityModel } parent The parent entity\r\n\t * @memberof UmbContentTypeWorkspaceContextBase\r\n\t */\r\n\tprotected override async _create(currentData: DetailModelType, parent: UmbEntityModel) {\r\n\t\ttry {\r\n\t\t\tawait this.structure.create(parent?.unique);\r\n\r\n\t\t\tthis._data.setPersisted(this.structure.getOwnerContentType());\r\n\r\n\t\t\tconst eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\t\tif (!eventContext) {\r\n\t\t\t\tthrow new Error('Could not get the action event context');\r\n\t\t\t}\r\n\t\t\tconst event = new UmbRequestReloadChildrenOfEntityEvent({\r\n\t\t\t\tentityType: parent.entityType,\r\n\t\t\t\tunique: parent.unique,\r\n\t\t\t});\r\n\t\t\teventContext.dispatchEvent(event);\r\n\r\n\t\t\tthis.setIsNew(false);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(error);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Updates the content type for the workspace\r\n\t * @memberof UmbContentTypeWorkspaceContextBase\r\n\t */\r\n\tprotected override async _update() {\r\n\t\ttry {\r\n\t\t\tawait this.structure.save();\r\n\r\n\t\t\tthis._data.setPersisted(this.structure.getOwnerContentType());\r\n\r\n\t\t\tconst eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\t\tif (!eventContext) {\r\n\t\t\t\tthrow new Error('Could not get the action event context');\r\n\t\t\t}\r\n\r\n\t\t\tconst unique = this.getUnique()!;\r\n\t\t\tconst entityType = this.getEntityType();\r\n\r\n\t\t\tconst reloadStructureEvent = new UmbRequestReloadStructureForEntityEvent({\r\n\t\t\t\tunique,\r\n\t\t\t\tentityType,\r\n\t\t\t});\r\n\r\n\t\t\teventContext.dispatchEvent(reloadStructureEvent);\r\n\r\n\t\t\tconst updatedEvent = new UmbEntityUpdatedEvent({\r\n\t\t\t\tunique,\r\n\t\t\t\tentityType,\r\n\t\t\t\teventUnique: this._workspaceEventUnique,\r\n\t\t\t});\r\n\r\n\t\t\teventContext.dispatchEvent(updatedEvent);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(error);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the name of the content type\r\n\t * @returns { string | undefined } The name of the content type\r\n\t */\r\n\tpublic getName(): string | undefined {\r\n\t\treturn this.structure.getOwnerContentType()?.name;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the name of the content type\r\n\t * @param { string } name The name of the content type\r\n\t */\r\n\tpublic setName(name: string) {\r\n\t\tthis.structure.updateOwnerContentType({ name } as Partial<DetailModelType>);\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the alias of the content type\r\n\t * @returns { string | undefined } The alias of the content type\r\n\t */\r\n\tpublic getAlias(): string | undefined {\r\n\t\treturn this.structure.getOwnerContentType()?.alias;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the alias of the content type\r\n\t * @param { string } alias The alias of the content type\r\n\t */\r\n\tpublic setAlias(alias: string) {\r\n\t\tthis.structure.updateOwnerContentType({ alias } as Partial<DetailModelType>);\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the description of the content type\r\n\t * @returns { string | undefined } The description of the content type\r\n\t */\r\n\tpublic getDescription(): string | undefined {\r\n\t\treturn this.structure.getOwnerContentType()?.description;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the description of the content type\r\n\t * @param { string } description The description of the content type\r\n\t */\r\n\tpublic setDescription(description: string) {\r\n\t\tthis.structure.updateOwnerContentType({ description } as Partial<DetailModelType>);\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the compositions of the content type\r\n\t * @returns { string | undefined } The icon of the content type\r\n\t */\r\n\tpublic getCompositions(): Array<UmbContentTypeCompositionModel> | undefined {\r\n\t\treturn this.structure.getOwnerContentType()?.compositions;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the compositions of the content type\r\n\t * @param { string } compositions The compositions of the content type\r\n\t * @returns { void }\r\n\t */\r\n\tpublic setCompositions(compositions: Array<UmbContentTypeCompositionModel>) {\r\n\t\tthis.structure.updateOwnerContentType({ compositions } as Partial<DetailModelType>);\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the icon of the content type\r\n\t * @returns { string | undefined } The icon of the content type\r\n\t */\r\n\tpublic getIcon(): string | undefined {\r\n\t\treturn this.structure.getOwnerContentType()?.icon;\r\n\t}\r\n\r\n\t// TODO: manage setting icon color alias?\r\n\tpublic setIcon(icon: string) {\r\n\t\tthis.structure.updateOwnerContentType({ icon } as Partial<DetailModelType>);\r\n\t}\r\n\r\n\tpublic override getData() {\r\n\t\treturn this.structure.getOwnerContentType();\r\n\t}\r\n\r\n\tpublic override destroy(): void {\r\n\t\tthis.structure.destroy();\r\n\t\tsuper.destroy();\r\n\t}\r\n}\r\n"],"names":["UMB_WORKSPACE_CONTENT_TYPE_ALIAS_CONDITION_ALIAS","_workspaceContext","_UmbContentTypeWorkspaceEditorHeaderElement_instances","observeContentType_fn","onNameAndAliasChange_fn","onDescriptionChange_fn","UmbContentTypeWorkspaceEditorHeaderElement","UmbLitElement","__privateAdd","UMB_CONTENT_TYPE_WORKSPACE_CONTEXT","instance","__privateSet","__privateMethod","alias","color","modalManager","UMB_MODAL_MANAGER_CONTEXT","UMB_ICON_PICKER_MODAL","saved","__privateGet","html","ifDefined","umbBindToValidation","umbFocus","name","description","icon","isNew","event","css","__decorateClass","state","customElement","_dataTypeModal","_propertyEditorUiAlias","_UmbInputContentTypeCollectionConfigurationElement_instances","setValue_fn","clearDataType_fn","createDataType_fn","editDataType_fn","renderCreate_fn","renderConfigured_fn","UmbInputContentTypeCollectionConfigurationElement","UmbFormControlMixin","UmbModalRouteRegistrationController","UMB_DATA_TYPE_PICKER_FLOW_DATA_TYPE_PICKER_MODAL","routingInfo","submitData","routeBuilder","UMB_DATATYPE_WORKSPACE_MODAL","params","UMB_DATA_TYPE_ENTITY_TYPE","value","UmbChangeEvent","nothing","property","UmbContentTypeStructureRepositoryBase","UmbRepositoryBase","#structureSource","host","structureSource","unique","parentContentUnique","UmbContentTypeStructureServerDataSourceBase","#host","#getAllowedChildrenOf","#mapper","args","data","error","tryExecute","item","UmbFilterDuplicateStrings","index","array","UmbContentTypeStructureManager","UmbControllerBase","typeRepository","#init","resolve","reject","#initResolver","#initRejection","#editedTypes","UmbArrayState","x","#initRepository","#repository","#initRepositoryResolver","#contentTypeObservers","#contentTypes","y","#ownerContentTypeUnique","createObservablePart","contentTypes","#contentTypeContainers","p","properties","mergeObservables","comps","uniques","#mergedContainers","containers","containerByIdCache","c","chainCache","mergedMap","container","path","getContainerChainKey","key","isOwner","existing","#observeRepository","#repoManager","UmbRepositoryDetailsManager","entries","entriesToBeUpdated","entriesToBeRemoved","entry","contentTypeCompositions","#loadContentTypeCompositions","id","observable","result","observationAsPromise","loaded","msg","UmbError","preset","repsonse","contentType","parentUnique","ownerUnique","compositionUniques","newUniques","mappingFunction","containerId","contentTypeUnique","toContentTypeUnique","firstValueFrom","clonedContainer","UmbId","parentContainer","type","parentId","newName","sortOrder","duplicatedParentContainer","newContainer","frozenContainers","appendToFrozenArray","legacyContainerType","legacyParentId","_legacyContainerType","_legacyParentId","containerType","ownerRootContainers","changedName","con","incrementString","partialUpdate","partialUpdateFrozenArray","removedContainerIds","updates","ids","frozenProperties","propertyUnique","filterFrozenArray","docTypes","docType","foundProp","propertyAlias","props","groupIds","parentName","parentType","propertyId","repositoryAlias","UmbExtensionApiInitializer","umbExtensionsRegistry","permitted","ctrl","observer","mergedContainers","searchId","parentIds","containerById","encodeFolderName","parent","LOADING_STATE_UNIQUE","UmbContentTypeWorkspaceContextBase","UmbEntityDetailWorkspaceContextBase","request","response","entity","#onDetailStoreChange","currentData","eventContext","UMB_ACTION_EVENT_CONTEXT","UmbRequestReloadChildrenOfEntityEvent","entityType","reloadStructureEvent","UmbRequestReloadStructureForEntityEvent","updatedEvent","UmbEntityUpdatedEvent","compositions"],"mappings":"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"}