{"version":3,"file":"bulk-delete.action-CqsjOYvc.js","sources":["../../../src/packages/core/entity-bulk-action/common/bulk-delete/bulk-delete.action.ts"],"sourcesContent":["import { UmbEntityBulkActionBase } from '../../entity-bulk-action-base.js';\r\nimport type { MetaEntityBulkActionDeleteKind } from './types.js';\r\nimport { createExtensionApiByAlias } from '@umbraco-cms/backoffice/extension-registry';\r\nimport { umbConfirmModal } from '@umbraco-cms/backoffice/modal';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport {\r\n\tUmbEntityDeletedEvent,\r\n\tUmbRequestReloadChildrenOfEntityEvent,\r\n\tUmbRequestReloadStructureForEntityEvent,\r\n} from '@umbraco-cms/backoffice/entity-action';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\nimport { UMB_ENTITY_CONTEXT, type UmbEntityModel } from '@umbraco-cms/backoffice/entity';\r\nimport type { UmbDetailRepository, UmbItemRepository } from '@umbraco-cms/backoffice/repository';\r\n\r\nexport class UmbDeleteEntityBulkAction<\r\n\tMetaKindType extends MetaEntityBulkActionDeleteKind = MetaEntityBulkActionDeleteKind,\r\n> extends UmbEntityBulkActionBase<MetaKindType> {\r\n\t#localize = new UmbLocalizationController(this);\r\n\t#items: Array<any> = [];\r\n\t/**\r\n\t * @deprecated this has been turned into a private property and cannot be used from v.18. Will be removed in v.18\r\n\t */\r\n\tprotected get _items() {\r\n\t\treturn this.#items;\r\n\t}\r\n\t/**\r\n\t * @deprecated this has been turned into a private property and cannot be used from v.18. Will be removed in v.18\r\n\t */\r\n\tprotected set _items(value: Array<any>) {\r\n\t\tthis.#items = value;\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tif (this.selection?.length === 0) {\r\n\t\t\tthrow new Error('No items selected.');\r\n\t\t}\r\n\r\n\t\t// TODO: Move item look up to a future bulk action context\r\n\t\tawait this.#requestItems();\r\n\t\tawait this._confirmDelete(this.#items);\r\n\t\tawait this.#requestBulkDelete(this.selection);\r\n\t}\r\n\r\n\tprotected async _confirmDelete(items: Array<any>) {\r\n\t\tconst headline = '#actions_delete';\r\n\t\tconst message = '#defaultdialogs_confirmBulkDelete';\r\n\r\n\t\t// TODO: consider showing more details about the items being deleted\r\n\t\tawait umbConfirmModal(this._host, {\r\n\t\t\theadline,\r\n\t\t\tcontent: this.#localize.string(message, items.length),\r\n\t\t\tcolor: 'danger',\r\n\t\t\tconfirmLabel: '#actions_delete',\r\n\t\t});\r\n\t}\r\n\r\n\tasync #requestItems() {\r\n\t\tconst itemRepository = await createExtensionApiByAlias<UmbItemRepository<any>>(\r\n\t\t\tthis,\r\n\t\t\tthis.args.meta.itemRepositoryAlias,\r\n\t\t);\r\n\r\n\t\tconst { data } = await itemRepository.requestItems(this.selection);\r\n\r\n\t\tthis.#items = data ?? [];\r\n\t}\r\n\r\n\tasync #requestBulkDelete(uniques: Array<string>) {\r\n\t\tconst detailRepository = await createExtensionApiByAlias<UmbDetailRepository<UmbEntityModel>>(\r\n\t\t\tthis,\r\n\t\t\tthis.args.meta.detailRepositoryAlias,\r\n\t\t);\r\n\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\r\n\t\tconst succeeded: Array<string> = [];\r\n\r\n\t\tfor (const unique of uniques) {\r\n\t\t\tconst { error } = await detailRepository.delete(unique);\r\n\r\n\t\t\tif (error) {\r\n\t\t\t\tconst notification = { data: { message: error.message } };\r\n\t\t\t\tnotificationContext?.peek('danger', notification);\r\n\t\t\t} else {\r\n\t\t\t\tsucceeded.push(unique);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (succeeded.length > 0) {\r\n\t\t\tconst notification = {\r\n\t\t\t\tdata: { message: `Deleted ${succeeded.length} ${succeeded.length === 1 ? 'item' : 'items'}` },\r\n\t\t\t};\r\n\t\t\tnotificationContext?.peek('positive', notification);\r\n\t\t}\r\n\r\n\t\tawait this.#notify(succeeded);\r\n\t}\r\n\r\n\tasync #notify(succeeded: Array<string>) {\r\n\t\tconst entityContext = await this.getContext(UMB_ENTITY_CONTEXT);\r\n\t\tif (!entityContext) throw new Error('Entity Context is not available');\r\n\r\n\t\tconst eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\tif (!eventContext) throw new Error('Event Context is not available');\r\n\r\n\t\tconst entityType = entityContext.getEntityType();\r\n\t\tconst unique = entityContext.getUnique();\r\n\r\n\t\tif (entityType && unique !== undefined) {\r\n\t\t\tconst args = { entityType, unique };\r\n\r\n\t\t\tconst reloadChildren = new UmbRequestReloadChildrenOfEntityEvent(args);\r\n\t\t\teventContext.dispatchEvent(reloadChildren);\r\n\r\n\t\t\tconst reloadStructure = new UmbRequestReloadStructureForEntityEvent(args);\r\n\t\t\teventContext.dispatchEvent(reloadStructure);\r\n\t\t}\r\n\r\n\t\tconst succeededItems = this.#items.filter((item) => succeeded.includes(item.unique));\r\n\r\n\t\tsucceededItems.forEach((item) => {\r\n\t\t\tconst deletedEvent = new UmbEntityDeletedEvent({\r\n\t\t\t\tunique: item.unique,\r\n\t\t\t\tentityType: item.entityType,\r\n\t\t\t});\r\n\r\n\t\t\teventContext.dispatchEvent(deletedEvent);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport { UmbDeleteEntityBulkAction as api };\r\n"],"names":["UmbDeleteEntityBulkAction","UmbEntityBulkActionBase","#localize","UmbLocalizationController","#items","value","#requestItems","#requestBulkDelete","items","umbConfirmModal","itemRepository","createExtensionApiByAlias","data","uniques","detailRepository","notificationContext","UMB_NOTIFICATION_CONTEXT","succeeded","unique","error","notification","#notify","entityContext","UMB_ENTITY_CONTEXT","eventContext","UMB_ACTION_EVENT_CONTEXT","entityType","args","reloadChildren","UmbRequestReloadChildrenOfEntityEvent","reloadStructure","UmbRequestReloadStructureForEntityEvent","item","deletedEvent","UmbEntityDeletedEvent"],"mappings":"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"}