{"version":3,"file":"index.js","sources":["../../../../src/packages/core/property/components/unsupported-property/utils.ts","../../../../src/packages/core/property/property-dataset-property-validator/property-dataset-property-validator.controller.ts","../../../../src/packages/core/property/property-guard-manager/property-guard.manager.ts","../../../../src/packages/core/property/property-guard-manager/variant-property-guard.manager.ts","../../../../src/packages/core/property/property-value-cloner/property-value-clone.controller.ts","../../../../src/packages/core/property/property-value-preset/property-value-preset-builder.controller.ts","../../../../src/packages/core/property/property-value-preset/property-value-preset-variant-builder.controller.ts"],"sourcesContent":["import type { UmbUnsupportedEditorSchemaAliases } from '../../types/index.js';\r\n\r\nexport const UMB_UNSUPPORTED_EDITOR_SCHEMA_ALIASES: UmbUnsupportedEditorSchemaAliases = {\r\n\tblock: ['Umbraco.ImageCropper'],\r\n};\r\n","import { UMB_PROPERTY_DATASET_CONTEXT } from '../property-dataset/property-dataset-context.token.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbValueValidator, type UmbValueValidatorArgs } from '@umbraco-cms/backoffice/validation';\r\n\r\nexport interface UmbPropertyDatasetPropertyValidatorArgs<ValueType = unknown> extends UmbValueValidatorArgs<ValueType> {\r\n\tpropertyAlias: string;\r\n}\r\n\r\n// The Example Workspace Context Controller:\r\nexport class UmbPropertyDatasetPropertyValidator<ValueType = unknown> extends UmbValueValidator<ValueType> {\r\n\t//\r\n\t#propertyAlias: string;\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbPropertyDatasetPropertyValidatorArgs<ValueType>) {\r\n\t\tsuper(host, args);\r\n\t\tthis.#propertyAlias = args.propertyAlias;\r\n\r\n\t\tthis.consumeContext(UMB_PROPERTY_DATASET_CONTEXT, async (context) => {\r\n\t\t\tthis.observe(\r\n\t\t\t\tawait context?.propertyValueByAlias<ValueType>(this.#propertyAlias),\r\n\t\t\t\t(value) => {\r\n\t\t\t\t\tthis.value = value;\r\n\t\t\t\t},\r\n\t\t\t\t'observeDatasetValue',\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n}\r\n","import type { Observable } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbReferenceByUnique } from '@umbraco-cms/backoffice/models';\r\nimport { UmbGuardManagerBase, type UmbGuardRule } from '@umbraco-cms/backoffice/utils';\r\n\r\nexport interface UmbPropertyGuardRule extends UmbGuardRule {\r\n\tpropertyType?: UmbReferenceByUnique;\r\n}\r\n\r\n/**\r\n *\r\n * @param rule\r\n * @param propertyType\r\n */\r\nfunction findRule(rule: UmbPropertyGuardRule, propertyType: UmbReferenceByUnique) {\r\n\treturn rule.propertyType?.unique === propertyType.unique || rule.propertyType === undefined;\r\n}\r\n\r\n/**\r\n * @description - A Guard to manage property rules.\r\n * @export\r\n * @class UmbPropertyGuardManager\r\n * @augments {UmbGuardManagerBase<UmbPropertyGuardRule>}\r\n */\r\nexport class UmbPropertyGuardManager extends UmbGuardManagerBase<UmbPropertyGuardRule> {\r\n\t/**\r\n\t * Checks if the property is permitted for the given property type\r\n\t * @param {UmbReferenceByUnique} propertyType\r\n\t * @returns {Observable<boolean>} - Observable that emits true if the property is permitted\r\n\t * @memberof UmbPropertyGuardManager\r\n\t */\r\n\tisPermittedForProperty(propertyType: UmbReferenceByUnique): Observable<boolean> {\r\n\t\treturn this._rules.asObservablePart((rules) => this.#resolvePermission(rules, propertyType));\r\n\t}\r\n\r\n\t/**\r\n\t * Checks if the property is permitted for the given property type\r\n\t * @param {UmbReferenceByUnique} propertyType\r\n\t * @returns {boolean} - Returns true if the property is permitted\r\n\t * @memberof UmbPropertyGuardManager\r\n\t */\r\n\tgetIsPermittedForProperty(propertyType: UmbReferenceByUnique): boolean {\r\n\t\treturn this.#resolvePermission(this.getRules(), propertyType);\r\n\t}\r\n\r\n\t#resolvePermission(rules: UmbPropertyGuardRule[], propertyType: UmbReferenceByUnique) {\r\n\t\tif (rules.filter((x) => x.permitted === false).some((rule) => findRule(rule, propertyType))) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (rules.filter((x) => x.permitted === true).some((rule) => findRule(rule, propertyType))) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn this._fallback;\r\n\t}\r\n}\r\n","import type { UmbPropertyGuardRule } from './property-guard.manager.js';\r\nimport type { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport type { Observable } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbReferenceByUnique } from '@umbraco-cms/backoffice/models';\r\nimport { UmbGuardManagerBase } from '@umbraco-cms/backoffice/utils';\r\n\r\nexport interface UmbVariantPropertyGuardRule extends UmbPropertyGuardRule {\r\n\t/**\r\n\t * @description - The variant id of the property.\r\n\t * @type {UmbVariantId}\r\n\t * @memberof UmbVariantPropertyGuardRule\r\n\t */\r\n\tvariantId?: UmbVariantId;\r\n\r\n\t/**\r\n\t * @description - The variant id of the dataset. This is used to determine if the rule applies to the current dataset.\r\n\t * @type {UmbVariantId}\r\n\t * @memberof UmbVariantPropertyGuardRule\r\n\t */\r\n\tdatasetVariantId?: UmbVariantId;\r\n}\r\n\r\n/**\r\n *\r\n * @param {UmbVariantPropertyGuardRule} rule - The rule to check.\r\n * @param {UmbVariantId} variantId - The property variant id to check.\r\n * @param {UmbReferenceByUnique} propertyType - The property type to check.\r\n * @param {UmbVariantId} datasetVariantId - The variant id of the dataset. This is used to determine if the rule applies to the current dataset.\r\n * @returns {boolean} - Returns true if the rule applies to the given conditions.\r\n */\r\nfunction findRule(\r\n\trule: UmbVariantPropertyGuardRule,\r\n\tvariantId: UmbVariantId,\r\n\tpropertyType: UmbReferenceByUnique,\r\n\tdatasetVariantId: UmbVariantId,\r\n) {\r\n\treturn (\r\n\t\t(rule.variantId === undefined || rule.variantId.culture === variantId.culture) &&\r\n\t\t(rule.propertyType === undefined || rule.propertyType.unique === propertyType.unique) &&\r\n\t\t(rule.datasetVariantId === undefined || rule.datasetVariantId.culture === datasetVariantId.culture)\r\n\t);\r\n}\r\n\r\n/**\r\n * UmbVariantPropertyGuardManager is a class that manages the rules for variant properties.\r\n * @export\r\n * @class UmbVariantPropertyGuardManager\r\n * @augments {UmbGuardManagerBase<UmbVariantPropertyGuardRule>}\r\n */\r\nexport class UmbVariantPropertyGuardManager extends UmbGuardManagerBase<UmbVariantPropertyGuardRule> {\r\n\t/**\r\n\t * Checks if the variant and propertyType is permitted.\r\n\t * @param {UmbVariantId} variantId - The variant id to check.\r\n\t * @param {UmbReferenceByUnique} propertyType - The property type to check.\r\n\t * @param {UmbVariantId} datasetVariantId - The dataset variant id to check.\r\n\t * @returns {Observable<boolean>} - Returns an observable that emits true if the variant and propertyType is permitted, false otherwise.\r\n\t * @memberof UmbVariantPropertyGuardManager\r\n\t */\r\n\tisPermittedForVariantAndProperty(\r\n\t\tvariantId: UmbVariantId,\r\n\t\tpropertyType: UmbReferenceByUnique,\r\n\t\tdatasetVariantId: UmbVariantId,\r\n\t): Observable<boolean> {\r\n\t\treturn this._rules.asObservablePart((rules) =>\r\n\t\t\tthis.#resolvePermission(rules, variantId, propertyType, datasetVariantId),\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * Checks if the variant and propertyType is permitted.\r\n\t * @param {UmbVariantId} variantId - The variant id to check.\r\n\t * @param {UmbReferenceByUnique} propertyType - The property type to check.\r\n\t * @param {UmbVariantId} datasetVariantId - The dataset variant id to check.\r\n\t * @returns {boolean} - Returns true if the variant and propertyType is permitted, false otherwise.\r\n\t * @memberof UmbVariantPropertyGuardManager\r\n\t */\r\n\tgetIsPermittedForVariantAndProperty(\r\n\t\tvariantId: UmbVariantId,\r\n\t\tpropertyType: UmbReferenceByUnique,\r\n\t\tdatasetVariantId: UmbVariantId,\r\n\t): boolean {\r\n\t\treturn this.#resolvePermission(this._rules.getValue(), variantId, propertyType, datasetVariantId);\r\n\t}\r\n\r\n\t#resolvePermission(\r\n\t\trules: UmbVariantPropertyGuardRule[],\r\n\t\tvariantId: UmbVariantId,\r\n\t\tpropertyType: UmbReferenceByUnique,\r\n\t\tdatasetVariantId: UmbVariantId,\r\n\t) {\r\n\t\tif (\r\n\t\t\trules\r\n\t\t\t\t.filter((x) => x.permitted === false)\r\n\t\t\t\t.some((rule) => findRule(rule, variantId, propertyType, datasetVariantId))\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (\r\n\t\t\trules\r\n\t\t\t\t.filter((x) => x.permitted === true)\r\n\t\t\t\t.some((rule) => findRule(rule, variantId, propertyType, datasetVariantId))\r\n\t\t) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn this._fallback;\r\n\t}\r\n}\r\n","import type { UmbPropertyValueDataPotentiallyWithEditorAlias } from '../index.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { createExtensionApi } from '@umbraco-cms/backoffice/extension-api';\r\nimport { umbExtensionsRegistry } from '@umbraco-cms/backoffice/extension-registry';\r\n\r\nexport class UmbPropertyValueCloneController extends UmbControllerBase {\r\n\t/**\r\n\t * Clones the property data.\r\n\t * @param {UmbPropertyValueDataPotentiallyWithEditorAlias} property - The property data.\r\n\t * @returns {Promise<UmbPropertyValueDataPotentiallyWithEditorAlias>} - A promise that resolves to the cloned property data.\r\n\t */\r\n\tasync clone<ValueType = unknown>(\r\n\t\tproperty: UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>,\r\n\t): Promise<UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>> {\r\n\t\tconst result = await this.#cloneProperty<ValueType>(property);\r\n\r\n\t\tthis.destroy();\r\n\r\n\t\treturn result ?? property;\r\n\t}\r\n\r\n\tasync #cloneProperty<ValueType>(\r\n\t\tproperty: UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>,\r\n\t): Promise<UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>> {\r\n\t\tconst clonedProperty = await this.#cloneValue(property);\r\n\t\treturn await this.#cloneInnerValues<ValueType>(clonedProperty);\r\n\t}\r\n\r\n\tasync #cloneValue<ValueType>(\r\n\t\tincomingProperty: UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>,\r\n\t): Promise<UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>> {\r\n\t\tconst editorAlias = (incomingProperty as any).editorAlias as string | undefined;\r\n\t\tif (!editorAlias) {\r\n\t\t\tconsole.error(`Editor alias not found for ${incomingProperty.alias}`);\r\n\t\t\treturn incomingProperty;\r\n\t\t}\r\n\r\n\t\t// Find the cloner for this editor alias:\r\n\t\tconst manifest = umbExtensionsRegistry.getByTypeAndFilter(\r\n\t\t\t'propertyValueCloner',\r\n\t\t\t(x) => x.forEditorAlias === editorAlias,\r\n\t\t)[0];\r\n\r\n\t\tif (!manifest) {\r\n\t\t\treturn incomingProperty;\r\n\t\t}\r\n\r\n\t\tconst api = await createExtensionApi(this, manifest);\r\n\t\tif (!api) {\r\n\t\t\treturn incomingProperty;\r\n\t\t}\r\n\r\n\t\t(api as any).manifest = manifest;\r\n\r\n\t\tlet clonedProperty = incomingProperty;\r\n\r\n\t\tif (api.cloneValue) {\r\n\t\t\tconst clonedValue = await api.cloneValue(incomingProperty.value);\r\n\t\t\tif (clonedValue) {\r\n\t\t\t\tclonedProperty = { ...incomingProperty, value: clonedValue };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn clonedProperty;\r\n\t}\r\n\r\n\tasync #cloneInnerValues<ValueType>(\r\n\t\tincomingProperty: UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>,\r\n\t): Promise<UmbPropertyValueDataPotentiallyWithEditorAlias<ValueType>> {\r\n\t\tconst editorAlias = (incomingProperty as any).editorAlias as string | undefined;\r\n\t\tif (!editorAlias) {\r\n\t\t\treturn incomingProperty;\r\n\t\t}\r\n\r\n\t\t// Find the resolver for this editor alias:\r\n\t\tconst manifest = umbExtensionsRegistry.getByTypeAndFilter(\r\n\t\t\t'propertyValueResolver',\r\n\t\t\t// TODO: Remove depcrated filter option in v.17 [NL]\r\n\t\t\t(x) => x.forEditorAlias === editorAlias || x.meta?.editorAlias === editorAlias,\r\n\t\t)[0];\r\n\r\n\t\tif (!manifest) {\r\n\t\t\treturn incomingProperty;\r\n\t\t}\r\n\r\n\t\tconst api = await createExtensionApi(this, manifest);\r\n\t\tif (!api) {\r\n\t\t\treturn incomingProperty;\r\n\t\t}\r\n\r\n\t\t(api as any).manifest = manifest;\r\n\r\n\t\tif (api.processValues) {\r\n\t\t\treturn (\r\n\t\t\t\t(await api.processValues(incomingProperty, async (properties) => {\r\n\t\t\t\t\t// Transform the values:\r\n\t\t\t\t\tconst clonedValues = await Promise.all(\r\n\t\t\t\t\t\tproperties.map(async (value) => {\r\n\t\t\t\t\t\t\treturn (await this.#cloneProperty(value)) ?? value;\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\treturn clonedValues;\r\n\t\t\t\t})) ?? incomingProperty\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t// the api did not provide a value processor, so we will return the incoming property:\r\n\t\treturn incomingProperty;\r\n\t}\r\n}\r\n","import type { UmbPropertyValueData, UmbPropertyValueDataPotentiallyWithEditorAlias } from '../index.js';\r\nimport type {\r\n\tManifestPropertyValuePreset,\r\n\tUmbPropertyTypePresetModel,\r\n\tUmbPropertyTypePresetWithSchemaAliasModel,\r\n\tUmbPropertyValuePreset,\r\n\tUmbPropertyValuePresetApiCallArgs,\r\n\tUmbPropertyValuePresetApiCallArgsEntityBase,\r\n} from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { createExtensionApi } from '@umbraco-cms/backoffice/extension-api';\r\nimport { umbExtensionsRegistry } from '@umbraco-cms/backoffice/extension-registry';\r\n\r\nexport class UmbPropertyValuePresetBuilderController<\r\n\tReturnType extends UmbPropertyValueData = UmbPropertyValueData | UmbPropertyValueDataPotentiallyWithEditorAlias,\r\n> extends UmbControllerBase {\r\n\t#baseCreateArgs?: UmbPropertyValuePresetApiCallArgsEntityBase;\r\n\tprotected _existingValues?: Array<ReturnType>;\r\n\r\n\tsetValues(values: Array<ReturnType>): void {\r\n\t\tthis._existingValues = values;\r\n\t}\r\n\r\n\t/**\r\n\t * Clones the property data.\r\n\t * @param {UmbPropertyValueDataPotentiallyWithEditorAlias} propertyTypes - Data about the properties to make a preset for.\r\n\t * @param createArgs\r\n\t * @returns {Promise<UmbPropertyValueDataPotentiallyWithEditorAlias>} - A promise that resolves to the cloned property data.\r\n\t */\r\n\tasync create<GivenPropertyTypesType extends UmbPropertyTypePresetModel>(\r\n\t\tpropertyTypes: Array<GivenPropertyTypesType>,\r\n\t\t// TODO: Remove that the argument is Optional and as well remove Partial<> in v.17.0 [NL]\r\n\t\tcreateArgs?: Partial<UmbPropertyValuePresetApiCallArgsEntityBase>,\r\n\t): Promise<Array<ReturnType>> {\r\n\t\t//\r\n\t\t// TODO: Clean up warnings in v.17.0 [NL]\r\n\t\tthis.#baseCreateArgs = {\r\n\t\t\tentityType:\r\n\t\t\t\tcreateArgs?.entityType ??\r\n\t\t\t\t'needs to be parsed to the UmbPropertyValuePresetBuilderController, this is not present because of a custom legacy implementation',\r\n\t\t\tentityUnique:\r\n\t\t\t\tcreateArgs?.entityUnique ??\r\n\t\t\t\t'needs to be parsed to the UmbPropertyValuePresetBuilderController, this is not present because of a custom legacy implementation',\r\n\t\t\tentityTypeUnique: createArgs?.entityTypeUnique,\r\n\t\t};\r\n\r\n\t\tif (!createArgs?.entityUnique || !createArgs?.entityType) {\r\n\t\t\tconsole.warn(\r\n\t\t\t\t`entityUnique or entityType was not provided for UmbPropertyValuePresetBuilderController.create in the second argument. This will be required in v.17.0 and must be provided when calling create().`,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst result = await Promise.all(propertyTypes.map(this.#createPropertyPreset));\r\n\r\n\t\t//Merge all the values into a single array:\r\n\t\tconst values = result.flatMap((x) => x);\r\n\r\n\t\tthis.destroy();\r\n\r\n\t\treturn values;\r\n\t}\r\n\r\n\t#createPropertyPreset = async (\r\n\t\tpropertyType: UmbPropertyTypePresetModel | UmbPropertyTypePresetWithSchemaAliasModel,\r\n\t): Promise<Array<ReturnType>> => {\r\n\t\tconst editorAlias: string | undefined = (propertyType as UmbPropertyTypePresetWithSchemaAliasModel)\r\n\t\t\t.propertyEditorSchemaAlias;\r\n\r\n\t\tconst editorUiAlias = propertyType.propertyEditorUiAlias;\r\n\t\tif (!editorUiAlias) {\r\n\t\t\tthrow new Error(`propertyEditorUiAlias was not defined in ${propertyType}`);\r\n\t\t}\r\n\r\n\t\tlet filter: (x: ManifestPropertyValuePreset) => boolean;\r\n\t\tif (editorAlias && editorUiAlias) {\r\n\t\t\tfilter = (x) => x.forPropertyEditorSchemaAlias === editorAlias || x.forPropertyEditorUiAlias === editorUiAlias;\r\n\t\t} else {\r\n\t\t\tfilter = (x) => x.forPropertyEditorUiAlias === editorUiAlias;\r\n\t\t}\r\n\r\n\t\t// Find a preset for this editor alias:\r\n\t\tconst manifests = umbExtensionsRegistry.getByTypeAndFilter('propertyValuePreset', filter);\r\n\r\n\t\tconst apis = (\r\n\t\t\tawait Promise.all(\r\n\t\t\t\tmanifests.map((x) =>\r\n\t\t\t\t\tcreateExtensionApi(this, x).then((x) => {\r\n\t\t\t\t\t\tif (x) {\r\n\t\t\t\t\t\t\t(x as any).manifest = x;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn x;\r\n\t\t\t\t\t}),\r\n\t\t\t\t),\r\n\t\t\t)\r\n\t\t).filter((x) => x !== undefined) as Array<UmbPropertyValuePreset>;\r\n\r\n\t\tconst result = await this._generatePropertyValues(apis, propertyType);\r\n\r\n\t\tfor (const api of apis) {\r\n\t\t\tapi.destroy();\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t};\r\n\r\n\tprotected async _generatePropertyValues(\r\n\t\tapis: Array<UmbPropertyValuePreset>,\r\n\t\tpropertyType: UmbPropertyTypePresetModel | UmbPropertyTypePresetWithSchemaAliasModel,\r\n\t): Promise<Array<ReturnType>> {\r\n\t\tconst args: Partial<UmbPropertyValuePresetApiCallArgs> = {\r\n\t\t\tvalue: this._existingValues?.find((x) => x.alias === propertyType.alias)?.value,\r\n\t\t};\r\n\t\tconst property = await this._generatePropertyValue(apis, propertyType, args);\r\n\t\treturn property ? [property] : [];\r\n\t}\r\n\r\n\tprotected async _generatePropertyValue(\r\n\t\tapis: Array<UmbPropertyValuePreset>,\r\n\t\tpropertyType: UmbPropertyTypePresetModel | UmbPropertyTypePresetWithSchemaAliasModel,\r\n\t\tincomingCallArgs: Partial<UmbPropertyValuePresetApiCallArgs>,\r\n\t): Promise<ReturnType | undefined> {\r\n\t\tlet value: unknown = incomingCallArgs.value;\r\n\r\n\t\t// Only process value if it is `undefined`, if a property has a value we do not want to process it. [NL]\r\n\t\tif (value === undefined) {\r\n\t\t\tconst callArgs: UmbPropertyValuePresetApiCallArgs = {\r\n\t\t\t\t...this.#baseCreateArgs!,\r\n\t\t\t\talias: propertyType.alias,\r\n\t\t\t\tpropertyEditorUiAlias: propertyType.propertyEditorUiAlias,\r\n\t\t\t\tpropertyEditorSchemaAlias: (propertyType as UmbPropertyTypePresetWithSchemaAliasModel)\r\n\t\t\t\t\t.propertyEditorSchemaAlias,\r\n\t\t\t\t...incomingCallArgs,\r\n\t\t\t};\r\n\t\t\t// Important to use a inline for loop, to secure that each entry is processed(asynchronously) in order\r\n\t\t\tfor (const api of apis) {\r\n\t\t\t\tif (!api.processValue) {\r\n\t\t\t\t\tthrow new Error(`'processValue()' method is not defined in the api: ${api.constructor.name}`);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvalue = await api.processValue(value, propertyType.config, propertyType.typeArgs, callArgs);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (value === undefined) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ((propertyType as UmbPropertyTypePresetWithSchemaAliasModel).propertyEditorSchemaAlias) {\r\n\t\t\treturn {\r\n\t\t\t\teditorAlias: (propertyType as UmbPropertyTypePresetWithSchemaAliasModel).propertyEditorSchemaAlias,\r\n\t\t\t\talias: propertyType.alias,\r\n\t\t\t\tvalue,\r\n\t\t\t} satisfies UmbPropertyValueDataPotentiallyWithEditorAlias as UmbPropertyValueDataPotentiallyWithEditorAlias as ReturnType;\r\n\t\t} else {\r\n\t\t\treturn {\r\n\t\t\t\talias: propertyType.alias,\r\n\t\t\t\tvalue,\r\n\t\t\t} satisfies UmbPropertyValueData as ReturnType;\r\n\t\t}\r\n\t}\r\n}\r\n","import { UmbVariantId } from '../../variant/variant-id.class.js';\r\nimport { UmbPropertyValuePresetBuilderController } from './property-value-preset-builder.controller.js';\r\nimport type {\r\n\tUmbPropertyTypePresetModel,\r\n\tUmbPropertyTypePresetWithSchemaAliasModel,\r\n\tUmbPropertyValuePreset,\r\n\tUmbPropertyValuePresetApiCallArgs,\r\n} from './types.js';\r\nimport type { UmbElementValueModel } from '@umbraco-cms/backoffice/content';\r\n\r\ntype ReturnType = UmbElementValueModel;\r\n\r\nexport class UmbPropertyValuePresetVariantBuilderController extends UmbPropertyValuePresetBuilderController<ReturnType> {\r\n\t#cultures: Array<null | string> = [];\r\n\t// Always declare the default segment (null)\r\n\t#segments: Array<null | string> = [null];\r\n\r\n\t// TODO: We properly need to break this, as Engage needs to control which Segments are available for each culture, maybe investigate the option to go about a new option to just parse options.? Break in v.17.0 [NL]\r\n\r\n\tsetCultures(cultures: Array<string>): void {\r\n\t\tthis.#cultures = cultures;\r\n\t}\r\n\tsetSegments(segments: Array<string>): void {\r\n\t\t// No matter how many segments are present, always include the default segment (null)\r\n\t\tthis.#segments = [null, ...segments];\r\n\t}\r\n\r\n\tprotected override async _generatePropertyValues(\r\n\t\tapis: Array<UmbPropertyValuePreset>,\r\n\t\tpropertyType: UmbPropertyTypePresetModel | UmbPropertyTypePresetWithSchemaAliasModel,\r\n\t): Promise<Array<ReturnType>> {\r\n\t\tconst values: Array<ReturnType> = [];\r\n\r\n\t\tif (propertyType.typeArgs.variesBySegment && propertyType.typeArgs.variesByCulture) {\r\n\t\t\tif (this.#cultures.length === 0) {\r\n\t\t\t\tthrow new Error('Cultures must be set when varying by culture.');\r\n\t\t\t}\r\n\r\n\t\t\tfor (const culture of this.#cultures) {\r\n\t\t\t\tfor (const segment of this.#segments) {\r\n\t\t\t\t\tconst value = await this._generatePropertyValue(\r\n\t\t\t\t\t\tapis,\r\n\t\t\t\t\t\tpropertyType,\r\n\t\t\t\t\t\tthis.#makeArgsFor(propertyType.alias, culture, segment),\r\n\t\t\t\t\t);\r\n\t\t\t\t\tif (value) {\r\n\t\t\t\t\t\tvalue.culture = culture;\r\n\t\t\t\t\t\tvalue.segment = segment;\r\n\t\t\t\t\t\tvalues.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (propertyType.typeArgs.variesByCulture) {\r\n\t\t\tif (this.#cultures.length === 0) {\r\n\t\t\t\tthrow new Error('Cultures must be set when varying by culture.');\r\n\t\t\t}\r\n\r\n\t\t\tfor (const culture of this.#cultures) {\r\n\t\t\t\tconst value = await this._generatePropertyValue(\r\n\t\t\t\t\tapis,\r\n\t\t\t\t\tpropertyType,\r\n\t\t\t\t\tthis.#makeArgsFor(propertyType.alias, culture, null),\r\n\t\t\t\t);\r\n\t\t\t\tif (value) {\r\n\t\t\t\t\tvalue.culture = culture;\r\n\t\t\t\t\tvalue.segment = null;\r\n\t\t\t\t\tvalues.push(value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (propertyType.typeArgs.variesBySegment) {\r\n\t\t\tfor (const segment of this.#segments) {\r\n\t\t\t\tconst value = await this._generatePropertyValue(\r\n\t\t\t\t\tapis,\r\n\t\t\t\t\tpropertyType,\r\n\t\t\t\t\tthis.#makeArgsFor(propertyType.alias, null, segment),\r\n\t\t\t\t);\r\n\t\t\t\tif (value) {\r\n\t\t\t\t\t// Be aware this maybe should have been the default culture?\r\n\t\t\t\t\tvalue.culture = null;\r\n\t\t\t\t\tvalue.segment = segment;\r\n\t\t\t\t\tvalues.push(value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst value = await this._generatePropertyValue(\r\n\t\t\t\tapis,\r\n\t\t\t\tpropertyType,\r\n\t\t\t\tthis.#makeArgsFor(propertyType.alias, null, null),\r\n\t\t\t);\r\n\t\t\tif (value) {\r\n\t\t\t\t// Be aware this maybe should have been the default culture?\r\n\t\t\t\tvalue.culture = null;\r\n\t\t\t\tvalue.segment = null;\r\n\t\t\t\tvalues.push(value);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn values;\r\n\t}\r\n\r\n\t#makeArgsFor(alias: string, culture: null | string, segment: null | string) {\r\n\t\tconst variantId = new UmbVariantId(culture, segment);\r\n\t\tconst args: Partial<UmbPropertyValuePresetApiCallArgs> = {\r\n\t\t\tvariantId,\r\n\t\t\tvalue: this._existingValues?.find((x) => x.alias === alias && variantId.compare(x))?.value,\r\n\t\t};\r\n\t\treturn args;\r\n\t}\r\n}\r\n"],"names":["UMB_UNSUPPORTED_EDITOR_SCHEMA_ALIASES","UmbPropertyDatasetPropertyValidator","UmbValueValidator","#propertyAlias","host","args","UMB_PROPERTY_DATASET_CONTEXT","context","value","findRule","rule","propertyType","UmbPropertyGuardManager","UmbGuardManagerBase","rules","#resolvePermission","x","variantId","datasetVariantId","UmbVariantPropertyGuardManager","UmbPropertyValueCloneController","UmbControllerBase","property","result","#cloneProperty","clonedProperty","#cloneValue","#cloneInnerValues","incomingProperty","editorAlias","manifest","umbExtensionsRegistry","api","createExtensionApi","clonedValue","properties","UmbPropertyValuePresetBuilderController","#baseCreateArgs","values","propertyTypes","createArgs","#createPropertyPreset","editorUiAlias","filter","manifests","apis","incomingCallArgs","callArgs","UmbPropertyValuePresetVariantBuilderController","#cultures","#segments","cultures","segments","culture","segment","#makeArgsFor","alias","UmbVariantId"],"mappings":"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"}