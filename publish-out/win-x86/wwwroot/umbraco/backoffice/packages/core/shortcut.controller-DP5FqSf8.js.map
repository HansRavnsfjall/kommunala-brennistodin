{"version":3,"file":"shortcut.controller-DP5FqSf8.js","sources":["../../../src/packages/core/shortcut/context/shortcut.context-token.ts","../../../src/packages/core/shortcut/context/shortcut.controller.ts"],"sourcesContent":["import type { UmbShortcutController } from './shortcut.controller.js';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\n\r\nexport const UMB_SHORTCUT_CONTEXT = new UmbContextToken<UmbShortcutController>('UmbShortcutContext');\r\n","import type { UmbShortcut } from '../types.js';\r\nimport { UMB_SHORTCUT_CONTEXT } from './shortcut.context-token.js';\r\nimport { UmbArrayState } from '@umbraco-cms/backoffice/observable-api';\r\nimport { UmbControllerBase, type UmbClassInterface } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbContextProviderController } from '@umbraco-cms/backoffice/context-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbPartialSome } from '@umbraco-cms/backoffice/utils';\r\n\r\ntype IncomingShortcutType = UmbPartialSome<UmbShortcut, 'unique' | 'weight' | 'modifier' | 'shift' | 'alt'>;\r\n\r\nconst IsMac = navigator.userAgent ? /Mac/i.test(navigator.userAgent) : navigator.platform.toUpperCase().includes('MAC');\r\n\r\nexport class UmbShortcutController extends UmbControllerBase {\r\n\t//\r\n\t#inUnprovidingState = false;\r\n\r\n\t#parent?: UmbShortcutController;\r\n\r\n\treadonly #shortcuts = new UmbArrayState<UmbShortcut>([], (x) => x.unique);\r\n\tpublic readonly all = this.#shortcuts.asObservable();\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.#shortcuts.sortBy((a, b) => (b.weight || 0) - (a.weight || 0));\r\n\t}\r\n\r\n\t#providerCtrl?: UmbContextProviderController;\r\n\t#currentProvideHost?: UmbClassInterface;\r\n\t/**\r\n\t * Provide this validation context to a specific controller host.\r\n\t * This can be used to Host a validation context in a Workspace, but provide it on a certain scope, like a specific Workspace View.\r\n\t * @param {UmbClassInterface} controllerHost - The controller host to provide this validation context to.\r\n\t */\r\n\tprovideAt(controllerHost: UmbClassInterface): void {\r\n\t\tif (this.#currentProvideHost === controllerHost) return;\r\n\r\n\t\tthis.unprovide();\r\n\r\n\t\tthis.#currentProvideHost = controllerHost;\r\n\t\tthis.#providerCtrl = controllerHost.provideContext(UMB_SHORTCUT_CONTEXT, this as any);\r\n\t}\r\n\r\n\tunprovide(): void {\r\n\t\tif (this.#providerCtrl) {\r\n\t\t\t// We need to set this in Unprovide state, so this context can be provided again later.\r\n\t\t\tthis.#inUnprovidingState = true;\r\n\t\t\tthis.#providerCtrl.destroy();\r\n\t\t\tthis.#providerCtrl = undefined;\r\n\t\t\tthis.#inUnprovidingState = false;\r\n\t\t\tthis.#currentProvideHost = undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tinherit(): void {\r\n\t\tthis.consumeContext(UMB_SHORTCUT_CONTEXT, (parent) => {\r\n\t\t\tthis.inheritFrom(parent);\r\n\t\t}).skipHost();\r\n\t\t// Notice skipHost ^^, this is because we do not want it to consume it self, as this would be a match for this consumption, instead we will look at the parent and above. [NL]\r\n\t}\r\n\r\n\tinheritFrom(parent: UmbShortcutController | undefined): void {\r\n\t\tif (this.#parent === parent) return;\r\n\t\tthis.#parent = parent;\r\n\t}\r\n\r\n\tinitiateChange() {\r\n\t\tthis.#shortcuts.mute();\r\n\t}\r\n\tfinishChange() {\r\n\t\tthis.#shortcuts.unmute();\r\n\t}\r\n\r\n\t/**\r\n\t * Add a new hint\r\n\t * @param {IncomingShortcutType} shortcut - The hint to add\r\n\t * @returns {UmbShortcut['unique']} Unique value of the hint\r\n\t */\r\n\taddOne(shortcut: IncomingShortcutType): string | symbol {\r\n\t\tconst newShortcut = { ...shortcut } as unknown as UmbShortcut;\r\n\t\tnewShortcut.unique ??= Symbol();\r\n\t\tnewShortcut.weight ??= 0;\r\n\t\tnewShortcut.modifier ??= false;\r\n\t\tnewShortcut.shift ??= false;\r\n\t\tnewShortcut.alt ??= false;\r\n\t\tthis.#shortcuts.appendOne(newShortcut);\r\n\t\treturn shortcut.unique!;\r\n\t}\r\n\r\n\t/**\r\n\t * Add multiple rules\r\n\t * @param {IncomingShortcutType[]} shortcuts - Array of hints to add\r\n\t */\r\n\tadd(shortcuts: IncomingShortcutType[]) {\r\n\t\tthis.#shortcuts.mute();\r\n\t\tshortcuts.forEach((hint) => this.addOne(hint));\r\n\t\tthis.#shortcuts.unmute();\r\n\t}\r\n\r\n\t/**\r\n\t * Remove a hint\r\n\t * @param {UmbShortcut['unique']} unique Unique value of the hint to remove\r\n\t */\r\n\tremoveOne(unique: UmbShortcut['unique']) {\r\n\t\tthis.#shortcuts.removeOne(unique);\r\n\t}\r\n\r\n\t/**\r\n\t * Remove multiple hints\r\n\t * @param {UmbShortcut['unique'][]} uniques Array of unique values to remove\r\n\t */\r\n\tremove(uniques: UmbShortcut['unique'][]) {\r\n\t\tthis.#shortcuts.remove(uniques);\r\n\t}\r\n\r\n\t/**\r\n\t * Check if a hint exists\r\n\t * @param {UmbShortcut['unique']} unique Unique value of the hint to check\r\n\t * @returns {boolean} True if the hint exists, false otherwise\r\n\t */\r\n\thas(unique: UmbShortcut['unique']): boolean {\r\n\t\treturn this.#shortcuts.getHasOne(unique);\r\n\t}\r\n\r\n\t/**\r\n\t * Get all hints\r\n\t * @returns {UmbShortcut[]} Array of hints\r\n\t */\r\n\tgetAll(): UmbShortcut[] {\r\n\t\treturn this.#shortcuts.getValue();\r\n\t}\r\n\r\n\t/**\r\n\t * Get all hints\r\n\t * @param key\r\n\t * @param modifier\r\n\t * @param shift\r\n\t * @param alt\r\n\t * @returns {UmbShortcut[]} Array of hints\r\n\t */\r\n\tfindShortcut(key: string, modifier: boolean, shift: boolean = false, alt: boolean = false): UmbShortcut | undefined {\r\n\t\tconst shortcuts = this.#shortcuts.getValue();\r\n\t\tfor (const s of shortcuts) {\r\n\t\t\tif (s.key.toLowerCase() === key.toLowerCase() && s.modifier === modifier && s.shift === shift && s.alt === alt) {\r\n\t\t\t\treturn s;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\t/**\r\n\t * Clear all hints\r\n\t */\r\n\tclear(): void {\r\n\t\tthis.#shortcuts.setValue([]);\r\n\t}\r\n\r\n\tactivate() {\r\n\t\twindow.addEventListener('keydown', this.#onKeyDown);\r\n\t}\r\n\r\n\tdeactivate() {\r\n\t\twindow.removeEventListener('keydown', this.#onKeyDown);\r\n\t}\r\n\r\n\t#onKeyDown = (e: KeyboardEvent) => {\r\n\t\tconst keyDown = e.key.toLowerCase();\r\n\t\tconst modifierDown = IsMac ? e.metaKey : e.ctrlKey;\r\n\r\n\t\tconst shortcut = this.findShortcut(keyDown, modifierDown, e.shiftKey, e.altKey);\r\n\t\tif (shortcut) {\r\n\t\t\te.preventDefault();\r\n\t\t\tshortcut.action();\r\n\t\t}\r\n\t};\r\n\r\n\toverride destroy(): void {\r\n\t\tsuper.destroy();\r\n\t\tif (this.#inUnprovidingState === true) {\r\n\t\t\t// TODO: What is it i'm doing here, check if it actually makes sense, if so add a comment on why [NL]\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.unprovide();\r\n\t\tthis.#parent = undefined;\r\n\r\n\t\tthis.#shortcuts.destroy();\r\n\t}\r\n}\r\n"],"names":["UMB_SHORTCUT_CONTEXT","UmbContextToken","IsMac","UmbShortcutController","UmbControllerBase","host","#inUnprovidingState","#shortcuts","UmbArrayState","x","#onKeyDown","keyDown","modifierDown","shortcut","a","b","#parent","#providerCtrl","#currentProvideHost","controllerHost","parent","newShortcut","shortcuts","hint","unique","uniques","key","modifier","shift","alt"],"mappings":"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"}