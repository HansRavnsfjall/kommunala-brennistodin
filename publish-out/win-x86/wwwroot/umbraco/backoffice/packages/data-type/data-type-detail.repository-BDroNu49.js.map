{"version":3,"file":"data-type-detail.repository-BDroNu49.js","sources":["../../../src/packages/data-type/repository/detail/server-data-source/data-type-detail.server.request-manager.ts","../../../src/packages/data-type/repository/detail/server-data-source/data-type-detail.server.data-source.ts","../../../src/packages/data-type/repository/detail/data-type-detail.repository.ts"],"sourcesContent":["/* eslint-disable local-rules/no-direct-api-import */\r\nimport { dataTypeDetailCache } from './data-type-detail.server.cache.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport {\r\n\tDataTypeService,\r\n\ttype CreateDataTypeRequestModel,\r\n\ttype DataTypeResponseModel,\r\n\ttype UpdateDataTypeRequestModel,\r\n} from '@umbraco-cms/backoffice/external/backend-api';\r\nimport {\r\n\tUmbManagementApiDetailDataRequestManager,\r\n\tUmbManagementApiInFlightRequestCache,\r\n} from '@umbraco-cms/backoffice/management-api';\r\n\r\nexport class UmbManagementApiDataTypeDetailDataRequestManager extends UmbManagementApiDetailDataRequestManager<\r\n\tDataTypeResponseModel,\r\n\tUpdateDataTypeRequestModel,\r\n\tCreateDataTypeRequestModel\r\n> {\r\n\tstatic #inflightRequestCache = new UmbManagementApiInFlightRequestCache<DataTypeResponseModel>();\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, {\r\n\t\t\tcreate: (body: CreateDataTypeRequestModel) => DataTypeService.postDataType({ body }),\r\n\t\t\tread: (id: string) => DataTypeService.getDataTypeById({ path: { id } }),\r\n\t\t\tupdate: (id: string, body: UpdateDataTypeRequestModel) => DataTypeService.putDataTypeById({ path: { id }, body }),\r\n\t\t\tdelete: (id: string) => DataTypeService.deleteDataTypeById({ path: { id } }),\r\n\t\t\tdataCache: dataTypeDetailCache,\r\n\t\t\tinflightRequestCache: UmbManagementApiDataTypeDetailDataRequestManager.#inflightRequestCache,\r\n\t\t});\r\n\t}\r\n}\r\n","import type { UmbDataTypeDetailModel, UmbDataTypePropertyValueModel } from '../../../types.js';\r\nimport { UMB_DATA_TYPE_ENTITY_TYPE } from '../../../entity.js';\r\nimport { UmbManagementApiDataTypeDetailDataRequestManager } from './data-type-detail.server.request-manager.js';\r\nimport { UmbId } from '@umbraco-cms/backoffice/id';\r\nimport type { UmbDetailDataSource } from '@umbraco-cms/backoffice/repository';\r\nimport type {\r\n\tCreateDataTypeRequestModel,\r\n\tDataTypeResponseModel,\r\n\tUpdateDataTypeRequestModel,\r\n} from '@umbraco-cms/backoffice/external/backend-api';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\n\r\n/**\r\n * A data source for the Data Type that fetches data from the server\r\n * @class UmbDataTypeServerDataSource\r\n * @implements {RepositoryDetailDataSource}\r\n */\r\nexport class UmbDataTypeServerDataSource\r\n\textends UmbControllerBase\r\n\timplements UmbDetailDataSource<UmbDataTypeDetailModel>\r\n{\r\n\t#detailRequestManager = new UmbManagementApiDataTypeDetailDataRequestManager(this);\r\n\r\n\t/**\r\n\t * Creates a new Data Type scaffold\r\n\t * @param {(string | null)} parentUnique\r\n\t * @param preset\r\n\t * @returns { CreateDataTypeRequestModel }\r\n\t * @memberof UmbDataTypeServerDataSource\r\n\t */\r\n\tasync createScaffold(preset: Partial<UmbDataTypeDetailModel> = {}) {\r\n\t\tconst data: UmbDataTypeDetailModel = {\r\n\t\t\tentityType: UMB_DATA_TYPE_ENTITY_TYPE,\r\n\t\t\tunique: UmbId.new(),\r\n\t\t\tname: '',\r\n\t\t\teditorAlias: undefined,\r\n\t\t\teditorUiAlias: null,\r\n\t\t\tvalues: [],\r\n\t\t\t...preset,\r\n\t\t};\r\n\r\n\t\treturn { data };\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches a Data Type with the given id from the server\r\n\t * @param {string} unique\r\n\t * @returns {*}\r\n\t * @memberof UmbDataTypeServerDataSource\r\n\t */\r\n\tasync read(unique: string) {\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\tconst { data, error } = await this.#detailRequestManager.read(unique);\r\n\r\n\t\treturn { data: data ? this.#mapServerResponseModelToEntityDetailModel(data) : undefined, error };\r\n\t}\r\n\r\n\t/**\r\n\t * Inserts a new Data Type on the server\r\n\t * @param {UmbDataTypeDetailModel} model\r\n\t * @param parentUnique\r\n\t * @returns {*}\r\n\t * @memberof UmbDataTypeServerDataSource\r\n\t */\r\n\tasync create(model: UmbDataTypeDetailModel, parentUnique: string | null = null) {\r\n\t\tif (!model) throw new Error('Data Type is missing');\r\n\t\tif (!model.unique) throw new Error('Data Type unique is missing');\r\n\t\tif (!model.editorAlias) throw new Error('Property Editor Alias is missing');\r\n\t\tif (!model.editorUiAlias) throw new Error('Property Editor UI Alias is missing');\r\n\r\n\t\t// TODO: make data mapper to prevent errors\r\n\t\tconst body: CreateDataTypeRequestModel = {\r\n\t\t\tid: model.unique,\r\n\t\t\tparent: parentUnique ? { id: parentUnique } : null,\r\n\t\t\tname: model.name,\r\n\t\t\teditorAlias: model.editorAlias,\r\n\t\t\teditorUiAlias: model.editorUiAlias,\r\n\t\t\tvalues: model.values,\r\n\t\t};\r\n\r\n\t\tconst { data, error } = await this.#detailRequestManager.create(body);\r\n\r\n\t\treturn { data: data ? this.#mapServerResponseModelToEntityDetailModel(data) : undefined, error };\r\n\t}\r\n\r\n\t/**\r\n\t * Updates a DataType on the server\r\n\t * @param {UmbDataTypeDetailModel} DataType\r\n\t * @param model\r\n\t * @returns {*}\r\n\t * @memberof UmbDataTypeServerDataSource\r\n\t */\r\n\tasync update(model: UmbDataTypeDetailModel) {\r\n\t\tif (!model.unique) throw new Error('Unique is missing');\r\n\t\tif (!model.editorAlias) throw new Error('Property Editor Alias is missing');\r\n\t\tif (!model.editorUiAlias) throw new Error('Property Editor UI Alias is missing');\r\n\r\n\t\t// TODO: make data mapper to prevent errors\r\n\t\tconst body: UpdateDataTypeRequestModel = {\r\n\t\t\tname: model.name,\r\n\t\t\teditorAlias: model.editorAlias,\r\n\t\t\teditorUiAlias: model.editorUiAlias,\r\n\t\t\tvalues: model.values,\r\n\t\t};\r\n\r\n\t\tconst { data, error } = await this.#detailRequestManager.update(model.unique, body);\r\n\r\n\t\treturn { data: data ? this.#mapServerResponseModelToEntityDetailModel(data) : undefined, error };\r\n\t}\r\n\r\n\t/**\r\n\t * Deletes a Data Type on the server\r\n\t * @param {string} unique\r\n\t * @returns {*}\r\n\t * @memberof UmbDataTypeServerDataSource\r\n\t */\r\n\tasync delete(unique: string) {\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\t\treturn this.#detailRequestManager.delete(unique);\r\n\t}\r\n\r\n\t// TODO: change this to a mapper extension when the endpoints returns a $type for DataTypeResponseModel\r\n\t#mapServerResponseModelToEntityDetailModel(data: DataTypeResponseModel): UmbDataTypeDetailModel {\r\n\t\treturn {\r\n\t\t\tentityType: UMB_DATA_TYPE_ENTITY_TYPE,\r\n\t\t\tunique: data.id,\r\n\t\t\tname: data.name,\r\n\t\t\teditorAlias: data.editorAlias,\r\n\t\t\teditorUiAlias: data.editorUiAlias || null,\r\n\t\t\tvalues: data.values as Array<UmbDataTypePropertyValueModel>,\r\n\t\t};\r\n\t}\r\n}\r\n","import type { UmbDataTypeDetailModel } from '../../types.js';\r\nimport { UmbDataTypeServerDataSource } from './server-data-source/data-type-detail.server.data-source.js';\r\nimport type { UmbDataTypeDetailStore } from './data-type-detail.store.js';\r\nimport { UMB_DATA_TYPE_DETAIL_STORE_CONTEXT } from './data-type-detail.store.context-token.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbDetailRepositoryBase } from '@umbraco-cms/backoffice/repository';\r\nexport class UmbDataTypeDetailRepository extends UmbDetailRepositoryBase<UmbDataTypeDetailModel> {\r\n\t#init: Promise<unknown>;\r\n\t#detailStore?: UmbDataTypeDetailStore;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UmbDataTypeServerDataSource, UMB_DATA_TYPE_DETAIL_STORE_CONTEXT);\r\n\r\n\t\tthis.#init = this.consumeContext(UMB_DATA_TYPE_DETAIL_STORE_CONTEXT, (instance) => {\r\n\t\t\tthis.#detailStore = instance;\r\n\t\t})\r\n\t\t\t.asPromise({ preventTimeout: true })\r\n\t\t\t.catch(() => {\r\n\t\t\t\t// If the context is not available, we can assume that the store is not available.\r\n\t\t\t\tthis.#detailStore = undefined;\r\n\t\t\t});\r\n\t}\r\n\r\n\tasync byPropertyEditorUiAlias(propertyEditorUiAlias: string) {\r\n\t\tif (!propertyEditorUiAlias) throw new Error('propertyEditorUiAlias is missing');\r\n\t\tawait this.#init;\r\n\t\treturn this.#detailStore!.withPropertyEditorUiAlias(propertyEditorUiAlias);\r\n\t}\r\n}\r\n\r\nexport { UmbDataTypeDetailRepository as api };\r\n"],"names":["UmbManagementApiDataTypeDetailDataRequestManager","UmbManagementApiDetailDataRequestManager","#inflightRequestCache","UmbManagementApiInFlightRequestCache","host","body","DataTypeService","id","dataTypeDetailCache","UmbDataTypeServerDataSource","UmbControllerBase","#detailRequestManager","preset","UMB_DATA_TYPE_ENTITY_TYPE","UmbId","unique","data","error","#mapServerResponseModelToEntityDetailModel","model","parentUnique","UmbDataTypeDetailRepository","UmbDetailRepositoryBase","#init","#detailStore","UMB_DATA_TYPE_DETAIL_STORE_CONTEXT","instance","propertyEditorUiAlias"],"mappings":"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"}