{"version":3,"file":"document-block-property-value-user-permission.workspace-context-BcA2JyP0.js","sources":["../../../src/packages/documents/documents/user-permissions/document-property-value/workspace-context/document-block-property-value-user-permission.workspace-context.ts"],"sourcesContent":["import { UMB_DOCUMENT_ENTITY_TYPE } from '../../../entity.js';\r\nimport { UmbPropertyValueUserPermissionWorkspaceContextBase } from './property-value-user-permission-workspace-context-base.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_BLOCK_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/block';\r\nimport { UMB_CONTENT_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/content';\r\n\r\nexport class UmbDocumentBlockPropertyValueUserPermissionWorkspaceContext extends UmbPropertyValueUserPermissionWorkspaceContextBase {\r\n\t#blockWorkspaceContext?: typeof UMB_BLOCK_WORKSPACE_CONTEXT.TYPE;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.consumeContext(UMB_BLOCK_WORKSPACE_CONTEXT, async (context) => {\r\n\t\t\tthis.#blockWorkspaceContext = context;\r\n\r\n\t\t\t// We only want to apply the permission logic if the block is in a document\r\n\t\t\t// TODO: revisit this when getContext supports passContextAliasMatches\r\n\t\t\tconst contentWorkspaceContext = await this.consumeContext(UMB_CONTENT_WORKSPACE_CONTEXT, () => {})\r\n\t\t\t\t.passContextAliasMatches()\r\n\t\t\t\t.asPromise()\r\n\t\t\t\t.catch(() => undefined);\r\n\r\n\t\t\tif (contentWorkspaceContext?.getEntityType() === UMB_DOCUMENT_ENTITY_TYPE) {\r\n\t\t\t\tthis.#observeDocumentBlockProperties();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tasync #observeDocumentBlockProperties() {\r\n\t\tif (!this.#blockWorkspaceContext) return;\r\n\r\n\t\tconst ownerContent = this.#blockWorkspaceContext.content;\r\n\r\n\t\tthis.observe(ownerContent.structure.contentTypeProperties, (properties) => {\r\n\t\t\t// TODO: If zero properties I guess we should then clear the state? [NL]\r\n\t\t\tif (properties.length === 0) return;\r\n\r\n\t\t\townerContent.propertyViewGuard.fallbackToNotPermitted();\r\n\t\t\townerContent.propertyWriteGuard.fallbackToNotPermitted();\r\n\t\t\tthis._setPermissions(properties, ownerContent.propertyViewGuard, ownerContent.propertyWriteGuard);\r\n\t\t});\r\n\r\n\t\tconst ownerSettings = this.#blockWorkspaceContext.settings;\r\n\r\n\t\tthis.observe(ownerSettings.structure.contentTypeProperties, (properties) => {\r\n\t\t\t// TODO: If zero properties I guess we should then clear the state? [NL]\r\n\t\t\tif (properties.length === 0) return;\r\n\r\n\t\t\townerSettings.propertyViewGuard.fallbackToNotPermitted();\r\n\t\t\townerSettings.propertyWriteGuard.fallbackToNotPermitted();\r\n\t\t\tthis._setPermissions(properties, ownerSettings.propertyViewGuard, ownerSettings.propertyWriteGuard);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport { UmbDocumentBlockPropertyValueUserPermissionWorkspaceContext as api };\r\n"],"names":["UmbDocumentBlockPropertyValueUserPermissionWorkspaceContext","UmbPropertyValueUserPermissionWorkspaceContextBase","#blockWorkspaceContext","host","UMB_BLOCK_WORKSPACE_CONTEXT","context","UMB_CONTENT_WORKSPACE_CONTEXT","UMB_DOCUMENT_ENTITY_TYPE","#observeDocumentBlockProperties","ownerContent","properties","ownerSettings"],"mappings":";;;;AAMO,MAAMA,UAAoEC,EAAmD;AAAA,EACnIC;AAAA,EAEA,YAAYC,GAAyB;AACpC,UAAMA,CAAI,GAEV,KAAK,eAAeC,GAA6B,OAAOC,MAAY;AACnE,WAAKH,KAAyBG,IAIE,MAAM,KAAK,eAAeC,GAA+B,MAAM;AAAA,MAAC,CAAC,EAC/F,wBAAA,EACA,YACA,MAAM,MAAA;AAAA,OAAe,IAEM,cAAA,MAAoBC,KAChD,KAAKC,GAAA;AAAA,IAEP,CAAC;AAAA,EACF;AAAA,EAEA,MAAMA,KAAkC;AACvC,QAAI,CAAC,KAAKN,GAAwB;AAElC,UAAMO,IAAe,KAAKP,GAAuB;AAEjD,SAAK,QAAQO,EAAa,UAAU,uBAAuB,CAACC,MAAe;AAE1E,MAAIA,EAAW,WAAW,MAE1BD,EAAa,kBAAkB,uBAAA,GAC/BA,EAAa,mBAAmB,uBAAA,GAChC,KAAK,gBAAgBC,GAAYD,EAAa,mBAAmBA,EAAa,kBAAkB;AAAA,IACjG,CAAC;AAED,UAAME,IAAgB,KAAKT,GAAuB;AAElD,SAAK,QAAQS,EAAc,UAAU,uBAAuB,CAACD,MAAe;AAE3E,MAAIA,EAAW,WAAW,MAE1BC,EAAc,kBAAkB,uBAAA,GAChCA,EAAc,mBAAmB,uBAAA,GACjC,KAAK,gBAAgBD,GAAYC,EAAc,mBAAmBA,EAAc,kBAAkB;AAAA,IACnG,CAAC;AAAA,EACF;AACD;"}