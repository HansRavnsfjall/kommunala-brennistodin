{"version":3,"file":"document-collection.repository-iiYObbaE.js","sources":["../../../src/packages/documents/documents/collection/repository/document-collection.server.data-source.ts","../../../src/packages/documents/documents/collection/repository/document-collection.repository.ts"],"sourcesContent":["import type { UmbDocumentCollectionFilterModel, UmbDocumentCollectionItemModel } from '../types.js';\r\nimport { UMB_DOCUMENT_ENTITY_TYPE } from '../../entity.js';\r\nimport { DirectionModel, DocumentService } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport { tryExecute } from '@umbraco-cms/backoffice/resources';\r\nimport type { DocumentCollectionResponseModel } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport type { UmbCollectionDataSource } from '@umbraco-cms/backoffice/collection';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\n\r\nexport class UmbDocumentCollectionServerDataSource implements UmbCollectionDataSource<UmbDocumentCollectionItemModel> {\r\n\t#host: UmbControllerHost;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tthis.#host = host;\r\n\t}\r\n\r\n\tasync getCollection(filter: UmbDocumentCollectionFilterModel) {\r\n\t\tif (!filter.unique) {\r\n\t\t\tthrow new Error('Unique ID is required to fetch a collection.');\r\n\t\t}\r\n\r\n\t\tconst query = {\r\n\t\t\tdataTypeId: filter.dataTypeId ?? '',\r\n\t\t\torderBy: filter.orderBy ?? 'updateDate',\r\n\t\t\torderCulture: filter.orderCulture ?? 'en-US',\r\n\t\t\torderDirection: filter.orderDirection === 'asc' ? DirectionModel.ASCENDING : DirectionModel.DESCENDING,\r\n\t\t\tfilter: filter.filter,\r\n\t\t\tskip: filter.skip || 0,\r\n\t\t\ttake: filter.take || 100,\r\n\t\t};\r\n\r\n\t\tconst { data, error } = await tryExecute(\r\n\t\t\tthis.#host,\r\n\t\t\tDocumentService.getCollectionDocumentById({ path: { id: filter.unique }, query }),\r\n\t\t);\r\n\r\n\t\tif (data) {\r\n\t\t\tconst items = data.items.map((item: DocumentCollectionResponseModel) => {\r\n\t\t\t\t// TODO: remove in v17.0.0\r\n\t\t\t\tconst variant = item.variants[0];\r\n\r\n\t\t\t\tconst model: UmbDocumentCollectionItemModel = {\r\n\t\t\t\t\tancestors: item.ancestors.map((ancestor) => {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tunique: ancestor.id,\r\n\t\t\t\t\t\t\tentityType: UMB_DOCUMENT_ENTITY_TYPE,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tunique: item.id,\r\n\t\t\t\t\tentityType: UMB_DOCUMENT_ENTITY_TYPE,\r\n\t\t\t\t\tcontentTypeAlias: item.documentType.alias,\r\n\t\t\t\t\tcreateDate: item.variants\r\n\t\t\t\t\t\t.map((v) => new Date(v.createDate))\r\n\t\t\t\t\t\t.reduce((earliest, current) => (current < earliest ? current : earliest)),\r\n\t\t\t\t\tcreator: item.creator,\r\n\t\t\t\t\ticon: item.documentType.icon,\r\n\t\t\t\t\tisProtected: item.isProtected,\r\n\t\t\t\t\tisTrashed: item.isTrashed,\r\n\t\t\t\t\tname: variant.name,\r\n\t\t\t\t\tsortOrder: item.sortOrder,\r\n\t\t\t\t\tstate: variant.state,\r\n\t\t\t\t\tflags: variant.flags,\r\n\t\t\t\t\tupdateDate: item.variants\r\n\t\t\t\t\t\t.map((v) => new Date(v.updateDate))\r\n\t\t\t\t\t\t.reduce((latest, current) => (current > latest ? current : latest)),\r\n\t\t\t\t\tupdater: item.updater,\r\n\t\t\t\t\tvalues: item.values.map((item) => {\r\n\t\t\t\t\t\treturn { alias: item.alias, value: item.value as string };\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tdocumentType: {\r\n\t\t\t\t\t\tunique: item.documentType.id,\r\n\t\t\t\t\t\ticon: item.documentType.icon,\r\n\t\t\t\t\t\talias: item.documentType.alias,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tvariants: item.variants.map((item) => {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: item.name,\r\n\t\t\t\t\t\t\tculture: item.culture ?? null,\r\n\t\t\t\t\t\t\tstate: item.state,\r\n\t\t\t\t\t\t\tflags: item.flags,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}),\r\n\t\t\t\t};\r\n\t\t\t\treturn model;\r\n\t\t\t});\r\n\r\n\t\t\treturn { data: { items, total: data.total } };\r\n\t\t}\r\n\r\n\t\treturn { error };\r\n\t}\r\n}\r\n","import type { UmbDocumentCollectionFilterModel } from '../types.js';\r\nimport { UmbDocumentCollectionServerDataSource } from './document-collection.server.data-source.js';\r\nimport { UmbRepositoryBase } from '@umbraco-cms/backoffice/repository';\r\nimport type { UmbCollectionRepository } from '@umbraco-cms/backoffice/collection';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\n\r\nexport class UmbDocumentCollectionRepository extends UmbRepositoryBase implements UmbCollectionRepository {\r\n\t#collectionSource: UmbDocumentCollectionServerDataSource;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.#collectionSource = new UmbDocumentCollectionServerDataSource(host);\r\n\t}\r\n\r\n\tasync requestCollection(query: UmbDocumentCollectionFilterModel) {\r\n\t\treturn this.#collectionSource.getCollection(query);\r\n\t}\r\n}\r\n\r\nexport default UmbDocumentCollectionRepository;\r\n"],"names":["UmbDocumentCollectionServerDataSource","#host","host","filter","query","DirectionModel","data","error","tryExecute","DocumentService","item","variant","ancestor","UMB_DOCUMENT_ENTITY_TYPE","v","earliest","current","latest","UmbDocumentCollectionRepository","UmbRepositoryBase","#collectionSource"],"mappings":";;;;AAQO,MAAMA,EAAyG;AAAA,EACrHC;AAAA,EAEA,YAAYC,GAAyB;AACpC,SAAKD,KAAQC;AAAA,EACd;AAAA,EAEA,MAAM,cAAcC,GAA0C;AAC7D,QAAI,CAACA,EAAO;AACX,YAAM,IAAI,MAAM,8CAA8C;AAG/D,UAAMC,IAAQ;AAAA,MACb,YAAYD,EAAO,cAAc;AAAA,MACjC,SAASA,EAAO,WAAW;AAAA,MAC3B,cAAcA,EAAO,gBAAgB;AAAA,MACrC,gBAAgBA,EAAO,mBAAmB,QAAQE,EAAe,YAAYA,EAAe;AAAA,MAC5F,QAAQF,EAAO;AAAA,MACf,MAAMA,EAAO,QAAQ;AAAA,MACrB,MAAMA,EAAO,QAAQ;AAAA,IAAA,GAGhB,EAAE,MAAAG,GAAM,OAAAC,EAAA,IAAU,MAAMC;AAAA,MAC7B,KAAKP;AAAA,MACLQ,EAAgB,0BAA0B,EAAE,MAAM,EAAE,IAAIN,EAAO,OAAA,GAAU,OAAAC,EAAA,CAAO;AAAA,IAAA;AAGjF,WAAIE,IAkDI,EAAE,MAAM,EAAE,OAjDHA,EAAK,MAAM,IAAI,CAACI,MAA0C;AAEvE,YAAMC,IAAUD,EAAK,SAAS,CAAC;AA4C/B,aA1C8C;AAAA,QAC7C,WAAWA,EAAK,UAAU,IAAI,CAACE,OACvB;AAAA,UACN,QAAQA,EAAS;AAAA,UACjB,YAAYC;AAAA,QAAA,EAEb;AAAA,QACD,QAAQH,EAAK;AAAA,QACb,YAAYG;AAAA,QACZ,kBAAkBH,EAAK,aAAa;AAAA,QACpC,YAAYA,EAAK,SACf,IAAI,CAACI,MAAM,IAAI,KAAKA,EAAE,UAAU,CAAC,EACjC,OAAO,CAACC,GAAUC,MAAaA,IAAUD,IAAWC,IAAUD,CAAS;AAAA,QACzE,SAASL,EAAK;AAAA,QACd,MAAMA,EAAK,aAAa;AAAA,QACxB,aAAaA,EAAK;AAAA,QAClB,WAAWA,EAAK;AAAA,QAChB,MAAMC,EAAQ;AAAA,QACd,WAAWD,EAAK;AAAA,QAChB,OAAOC,EAAQ;AAAA,QACf,OAAOA,EAAQ;AAAA,QACf,YAAYD,EAAK,SACf,IAAI,CAACI,MAAM,IAAI,KAAKA,EAAE,UAAU,CAAC,EACjC,OAAO,CAACG,GAAQD,MAAaA,IAAUC,IAASD,IAAUC,CAAO;AAAA,QACnE,SAASP,EAAK;AAAA,QACd,QAAQA,EAAK,OAAO,IAAI,CAACA,OACjB,EAAE,OAAOA,EAAK,OAAO,OAAOA,EAAK,MAAA,EACxC;AAAA,QACD,cAAc;AAAA,UACb,QAAQA,EAAK,aAAa;AAAA,UAC1B,MAAMA,EAAK,aAAa;AAAA,UACxB,OAAOA,EAAK,aAAa;AAAA,QAAA;AAAA,QAE1B,UAAUA,EAAK,SAAS,IAAI,CAACA,OACrB;AAAA,UACN,MAAMA,EAAK;AAAA,UACX,SAASA,EAAK,WAAW;AAAA,UACzB,OAAOA,EAAK;AAAA,UACZ,OAAOA,EAAK;AAAA,QAAA,EAEb;AAAA,MAAA;AAAA,IAGH,CAAC,GAEuB,OAAOJ,EAAK,QAAM,IAGpC,EAAE,OAAAC,EAAA;AAAA,EACV;AACD;ACpFO,MAAMW,UAAwCC,EAAqD;AAAA,EACzGC;AAAA,EAEA,YAAYlB,GAAyB;AACpC,UAAMA,CAAI,GAEV,KAAKkB,KAAoB,IAAIpB,EAAsCE,CAAI;AAAA,EACxE;AAAA,EAEA,MAAM,kBAAkBE,GAAyC;AAChE,WAAO,KAAKgB,GAAkB,cAAchB,CAAK;AAAA,EAClD;AACD;"}