{"version":3,"file":"document-item-data-resolver-D2-3CuIM.js","sources":["../../../src/packages/documents/documents/item/document-item-data-resolver.ts"],"sourcesContent":["import { UmbDocumentVariantState } from '../types.js';\r\nimport type { UmbDocumentItemModel } from './types.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbEntityFlag } from '@umbraco-cms/backoffice/entity-flag';\r\nimport type { DocumentVariantStateModel } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport {\r\n\ttype Observable,\r\n\tUmbArrayState,\r\n\tUmbBooleanState,\r\n\tUmbObjectState,\r\n\tUmbStringState,\r\n} from '@umbraco-cms/backoffice/observable-api';\r\nimport { type UmbVariantContext, UMB_VARIANT_CONTEXT } from '@umbraco-cms/backoffice/variant';\r\n\r\ntype UmbDocumentItemDataResolverModel = Omit<UmbDocumentItemModel, 'parent' | 'hasChildren'>;\r\n\r\nfunction isVariantsInvariant(variants: Array<{ culture: string | null }>): boolean {\r\n\treturn variants?.[0]?.culture === null;\r\n}\r\nfunction findVariant<T extends { culture: string | null }>(variants: Array<T>, culture: string): T | undefined {\r\n\treturn variants.find((x) => x.culture === culture);\r\n}\r\n\r\n/**\r\n * A controller for resolving data for a document item\r\n * @exports\r\n * @class UmbDocumentItemDataResolver\r\n * @augments {UmbControllerBase}\r\n */\r\nexport class UmbDocumentItemDataResolver<DataType extends UmbDocumentItemDataResolverModel> extends UmbControllerBase {\r\n\t#data = new UmbObjectState<DataType | undefined>(undefined);\r\n\r\n\tpublic readonly unique = this.#data.asObservablePart((x) => x?.unique);\r\n\tpublic readonly icon = this.#data.asObservablePart((x) => x?.documentType.icon);\r\n\tpublic readonly isTrashed = this.#data.asObservablePart((x) => x?.isTrashed);\r\n\r\n\t#name = new UmbStringState(undefined);\r\n\tpublic readonly name = this.#name.asObservable();\r\n\r\n\t#state = new UmbStringState<DocumentVariantStateModel | null | undefined>(undefined);\r\n\tpublic readonly state = this.#state.asObservable() as Observable<DocumentVariantStateModel | null | undefined>;\r\n\r\n\t#isDraft = new UmbBooleanState(undefined);\r\n\tpublic readonly isDraft = this.#isDraft.asObservable();\r\n\r\n\t#flags = new UmbArrayState<UmbEntityFlag>([], (data) => data.alias);\r\n\tpublic readonly flags = this.#flags.asObservable();\r\n\r\n\t#variantContext?: UmbVariantContext;\r\n\t#fallbackCulture?: string | null;\r\n\t#displayCulture?: string | null;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.consumeContext(UMB_VARIANT_CONTEXT, (context) => {\r\n\t\t\tthis.#variantContext = context;\r\n\t\t\tthis.#observeVariantContext();\r\n\t\t});\r\n\t}\r\n\r\n\t#observeVariantContext() {\r\n\t\tthis.observe(\r\n\t\t\tthis.#variantContext?.displayCulture,\r\n\t\t\t(displayCulture) => {\r\n\t\t\t\tif (displayCulture === undefined) return;\r\n\t\t\t\tthis.#displayCulture = displayCulture;\r\n\t\t\t\tthis.#setVariantAwareValues();\r\n\t\t\t},\r\n\t\t\t'umbObserveVariantId',\r\n\t\t);\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis.#variantContext?.fallbackCulture,\r\n\t\t\t(fallbackCulture) => {\r\n\t\t\t\tif (fallbackCulture === undefined) return;\r\n\t\t\t\tthis.#fallbackCulture = fallbackCulture;\r\n\t\t\t\tthis.#setVariantAwareValues();\r\n\t\t\t},\r\n\t\t\t'umbObserveFallbackCulture',\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * Get the current item\r\n\t * @returns {DataType | undefined} The current item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tgetData(): DataType | undefined {\r\n\t\treturn this.#data.getValue();\r\n\t}\r\n\r\n\t/**\r\n\t * Set the current item\r\n\t * @param {DataType | undefined} data The current item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tsetData(data: DataType | undefined) {\r\n\t\tthis.#data.setValue(data);\r\n\t\tthis.#setVariantAwareValues();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the unique of the item\r\n\t * @returns {Promise<string | undefined>} The unique of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getUnique(): Promise<string | undefined> {\r\n\t\treturn await this.observe(this.unique).asPromise();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the name of the item\r\n\t * @returns {Promise<string>} The name of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getName(): Promise<string> {\r\n\t\treturn (await this.observe(this.name).asPromise()) || '';\r\n\t}\r\n\r\n\t/**\r\n\t * Get the icon of the item\r\n\t * @returns {Promise<string | undefined>} The icon of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getIcon(): Promise<string | undefined> {\r\n\t\treturn await this.observe(this.icon).asPromise();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the state of the item\r\n\t * @returns {Promise<string | undefined>} The state of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getState(): Promise<DocumentVariantStateModel | null | undefined> {\r\n\t\treturn await this.observe(this.state).asPromise();\r\n\t}\r\n\r\n\t/**\r\n\t * Get the isDraft of the item\r\n\t * @returns {Promise<boolean>} The isDraft of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getIsDraft(): Promise<boolean> {\r\n\t\treturn (await this.observe(this.isDraft).asPromise()) ?? false;\r\n\t}\r\n\r\n\t/**\r\n\t * Get the isTrashed of the item\r\n\t * @returns {Promise<boolean | undefined>} The isTrashed of the item\r\n\t * @memberof UmbDocumentItemDataResolver\r\n\t */\r\n\tasync getIsTrashed(): Promise<boolean> {\r\n\t\treturn (await this.observe(this.isTrashed).asPromise()) ?? false;\r\n\t}\r\n\r\n\t#setVariantAwareValues() {\r\n\t\tif (!this.#variantContext) return;\r\n\t\tif (!this.#displayCulture) return;\r\n\t\tif (!this.#fallbackCulture) return;\r\n\t\tif (!this.#data) return;\r\n\t\tthis.#setName();\r\n\t\tthis.#setIsDraft();\r\n\t\tthis.#setState();\r\n\t\tthis.#setFlags();\r\n\t}\r\n\r\n\t#setName() {\r\n\t\tconst variant = this.#getCurrentVariant();\r\n\t\tif (variant) {\r\n\t\t\tthis.#name.setValue(variant.name);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst variants = this.getData()?.variants;\r\n\t\tif (variants) {\r\n\t\t\tconst fallbackName = findVariant(variants, this.#fallbackCulture!)?.name;\r\n\t\t\tthis.#name.setValue(`(${fallbackName})`);\r\n\t\t} else {\r\n\t\t\tthis.#name.setValue(undefined);\r\n\t\t}\r\n\t}\r\n\r\n\t#setIsDraft() {\r\n\t\tconst variant = this.#getCurrentVariant();\r\n\t\tconst isDraft = variant?.state === UmbDocumentVariantState.DRAFT || false;\r\n\t\tthis.#isDraft.setValue(isDraft);\r\n\t}\r\n\r\n\t#setState() {\r\n\t\tconst variant = this.#getCurrentVariant();\r\n\t\tconst state = variant?.state || UmbDocumentVariantState.NOT_CREATED;\r\n\t\tthis.#state.setValue(state);\r\n\t}\r\n\r\n\t#setFlags() {\r\n\t\tconst data = this.getData();\r\n\t\tif (!data) {\r\n\t\t\tthis.#flags.setValue([]);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst flags = data.flags ?? [];\r\n\t\tconst variantFlags = this.#getCurrentVariant()?.flags ?? [];\r\n\t\tthis.#flags.setValue([...flags, ...variantFlags]);\r\n\t}\r\n\r\n\t#getCurrentVariant() {\r\n\t\tconst variants = this.getData()?.variants;\r\n\t\tif (!variants) return undefined;\r\n\r\n\t\tif (isVariantsInvariant(variants)) {\r\n\t\t\treturn variants[0];\r\n\t\t}\r\n\r\n\t\treturn findVariant(variants, this.#displayCulture!);\r\n\t}\r\n}\r\n"],"names":["isVariantsInvariant","variants","findVariant","culture","x","UmbDocumentItemDataResolver","UmbControllerBase","host","#data","UmbObjectState","#name","UmbStringState","#state","#isDraft","UmbBooleanState","#flags","UmbArrayState","data","UMB_VARIANT_CONTEXT","context","#variantContext","#observeVariantContext","#fallbackCulture","#displayCulture","displayCulture","#setVariantAwareValues","fallbackCulture","#setName","#setIsDraft","#setState","#setFlags","variant","#getCurrentVariant","fallbackName","isDraft","UmbDocumentVariantState","state","flags","variantFlags"],"mappings":"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"}