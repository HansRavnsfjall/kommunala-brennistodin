{"version":3,"file":"document-publishing.workspace-context-De5j-yxD.js","sources":["../../../src/packages/documents/documents/publishing/pending-changes/document-published-pending-changes.manager.ts","../../../src/packages/documents/documents/publishing/workspace-context/document-publishing.workspace-context.ts"],"sourcesContent":["import type { UmbDocumentVariantModel } from '../../types.js';\r\nimport type {\r\n\tUmbDocumentPublishedPendingChangesManagerProcessArgs,\r\n\tUmbPublishedVariantWithPendingChanges,\r\n} from './types.js';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { UmbMergeContentVariantDataController } from '@umbraco-cms/backoffice/content';\r\nimport { jsonStringComparison, UmbArrayState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\n/**\r\n * Manages the pending changes for a published document.\r\n * @exports\r\n * @class UmbDocumentPublishedPendingChangesManager\r\n * @augments {UmbControllerBase}\r\n */\r\nexport class UmbDocumentPublishedPendingChangesManager extends UmbControllerBase {\r\n\t#variantsWithChanges = new UmbArrayState<UmbPublishedVariantWithPendingChanges>([], (x) => x.variantId.toString());\r\n\tpublic readonly variantsWithChanges = this.#variantsWithChanges.asObservable();\r\n\r\n\t/**\r\n\t * Checks each variant if there are any pending changes to publish.\r\n\t * @param {UmbDocumentPublishedPendingChangesManagerProcessArgs} args - The arguments for the process.\r\n\t * @param {UmbDocumentDetailModel} args.persistedData - The persisted document data.\r\n\t * @param {UmbDocumentDetailModel} args.publishedData - The published document data.\r\n\t * @returns {Promise<void>}\r\n\t * @memberof UmbDocumentPublishedPendingChangesManager\r\n\t */\r\n\tasync process(args: UmbDocumentPublishedPendingChangesManagerProcessArgs): Promise<void> {\r\n\t\tif (!args.persistedData) throw new Error('Persisted data is missing');\r\n\t\tif (!args.publishedData) throw new Error('Published data is missing');\r\n\t\tif (args.persistedData.unique !== args.publishedData.unique)\r\n\t\t\tthrow new Error('Persisted and published data does not have the same unique');\r\n\r\n\t\tconst variantIds = args.persistedData.variants?.map((x) => UmbVariantId.Create(x)) ?? [];\r\n\r\n\t\tconst pendingChangesPromises = variantIds.map(async (variantId) => {\r\n\t\t\tconst mergedData = await new UmbMergeContentVariantDataController(this).process(\r\n\t\t\t\targs.publishedData,\r\n\t\t\t\targs.persistedData,\r\n\t\t\t\t[variantId],\r\n\t\t\t\t[variantId],\r\n\t\t\t);\r\n\r\n\t\t\tconst mergedDataClone = structuredClone(mergedData);\r\n\t\t\tconst publishedDataClone = structuredClone(args.publishedData);\r\n\r\n\t\t\t// remove dates from the comparison\r\n\t\t\tmergedDataClone.variants.forEach((variant) => this.#cleanVariantForComparison(variant));\r\n\t\t\tpublishedDataClone.variants.forEach((variant) => this.#cleanVariantForComparison(variant));\r\n\r\n\t\t\t// remove template from the comparison (doesn't affect publishable changes, and the published version is coming through as null)\r\n\t\t\tmergedDataClone.template = null;\r\n\t\t\tpublishedDataClone.template = null;\r\n\t\t\tconst hasChanges = jsonStringComparison(mergedDataClone, publishedDataClone) === false;\r\n\r\n\t\t\tif (hasChanges) {\r\n\t\t\t\treturn { variantId };\r\n\t\t\t} else {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst variantsWithPendingChanges = (await Promise.all(pendingChangesPromises)).filter((x) => x !== null);\r\n\r\n\t\tthis.#variantsWithChanges.setValue(variantsWithPendingChanges);\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the variants with changes.\r\n\t * @returns {Array<UmbPublishedVariantWithPendingChanges>}  {Array<UmbVariantWithChanges>}\r\n\t * @memberof UmbDocumentPublishedPendingChangesManager\r\n\t */\r\n\tgetVariantsWithChanges(): Array<UmbPublishedVariantWithPendingChanges> {\r\n\t\treturn this.#variantsWithChanges.getValue();\r\n\t}\r\n\r\n\t#cleanVariantForComparison = (variant: UmbDocumentVariantModel) => {\r\n\t\t// The server seems to have some date mismatches when quickly\r\n\t\t// fetching a document after a save and comparing it to the published version.\r\n\t\t// This is a temporary workaround to not include these dates in the comparison.\r\n\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n\t\t// @ts-expect-error\r\n\t\tdelete variant.updateDate;\r\n\t};\r\n\r\n\t/**\r\n\t * Clear all states/values,\r\n\t */\r\n\tclear() {\r\n\t\tthis.#variantsWithChanges.setValue([]);\r\n\t}\r\n}\r\n","import { UMB_DOCUMENT_WORKSPACE_CONTEXT } from '../../workspace/document-workspace.context-token.js';\r\nimport type {\r\n\tUmbDocumentDetailModel,\r\n\tUmbDocumentVariantOptionModel,\r\n\tUmbDocumentVariantPublishModel,\r\n} from '../../types.js';\r\nimport { UmbDocumentPublishingRepository } from '../repository/index.js';\r\nimport { UmbDocumentPublishedPendingChangesManager } from '../pending-changes/index.js';\r\nimport { UMB_DOCUMENT_SCHEDULE_MODAL } from '../schedule-publish/constants.js';\r\nimport { UMB_DOCUMENT_PUBLISH_WITH_DESCENDANTS_MODAL } from '../publish-with-descendants/constants.js';\r\nimport { UMB_DOCUMENT_PUBLISH_MODAL } from '../publish/constants.js';\r\nimport { UmbUnpublishDocumentEntityAction } from '../unpublish/index.js';\r\nimport { UMB_DOCUMENT_PUBLISHING_WORKSPACE_CONTEXT } from './document-publishing.workspace-context.token.js';\r\nimport { UMB_DOCUMENT_PUBLISHING_SHORTCUT_UNIQUE } from './constants.js';\r\nimport { firstValueFrom } from '@umbraco-cms/backoffice/external/rxjs';\r\nimport { observeMultiple } from '@umbraco-cms/backoffice/observable-api';\r\nimport { umbOpenModal } from '@umbraco-cms/backoffice/modal';\r\nimport { DocumentVariantStateModel } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\nimport {\r\n\tUmbRequestReloadChildrenOfEntityEvent,\r\n\tUmbRequestReloadStructureForEntityEvent,\r\n} from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbVariantId } from '@umbraco-cms/backoffice/variant';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbEntityUnique } from '@umbraco-cms/backoffice/entity';\r\n\r\nexport class UmbDocumentPublishingWorkspaceContext extends UmbContextBase {\r\n\t/**\r\n\t * Manages the pending changes for the published document.\r\n\t * @memberof UmbDocumentPublishingWorkspaceContext\r\n\t */\r\n\tpublic readonly publishedPendingChanges = new UmbDocumentPublishedPendingChangesManager(this);\r\n\r\n\t#init: Promise<unknown>;\r\n\t#documentWorkspaceContext?: typeof UMB_DOCUMENT_WORKSPACE_CONTEXT.TYPE;\r\n\t#eventContext?: typeof UMB_ACTION_EVENT_CONTEXT.TYPE;\r\n\t#publishingRepository = new UmbDocumentPublishingRepository(this);\r\n\t#publishedDocumentData?: UmbDocumentDetailModel;\r\n\t#currentUnique?: UmbEntityUnique;\r\n\t#notificationContext?: typeof UMB_NOTIFICATION_CONTEXT.TYPE;\r\n\treadonly #localize = new UmbLocalizationController(this);\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_DOCUMENT_PUBLISHING_WORKSPACE_CONTEXT);\r\n\r\n\t\tthis.#init = Promise.all([\r\n\t\t\tthis.consumeContext(UMB_DOCUMENT_WORKSPACE_CONTEXT, async (context) => {\r\n\t\t\t\tif (this.#documentWorkspaceContext) {\r\n\t\t\t\t\t// remove shortcut:\r\n\t\t\t\t\tthis.#documentWorkspaceContext.view.shortcuts.removeOne(UMB_DOCUMENT_PUBLISHING_SHORTCUT_UNIQUE);\r\n\t\t\t\t}\r\n\t\t\t\tthis.#documentWorkspaceContext = context;\r\n\t\t\t\tthis.#documentWorkspaceContext?.view.shortcuts.addOne({\r\n\t\t\t\t\tunique: UMB_DOCUMENT_PUBLISHING_SHORTCUT_UNIQUE,\r\n\t\t\t\t\tlabel: this.#localize.term('content_saveAndPublishShortcut'),\r\n\t\t\t\t\tkey: 'p',\r\n\t\t\t\t\tmodifier: true,\r\n\t\t\t\t\taction: () => this.saveAndPublish(),\r\n\t\t\t\t});\r\n\t\t\t\tthis.#initPendingChanges();\r\n\t\t\t})\r\n\t\t\t\t.asPromise({ preventTimeout: true })\r\n\t\t\t\t.catch(() => {\r\n\t\t\t\t\t// If the context is not available, we can assume that the context is not available.\r\n\t\t\t\t\tthis.#documentWorkspaceContext = undefined;\r\n\t\t\t\t}),\r\n\r\n\t\t\tthis.consumeContext(UMB_ACTION_EVENT_CONTEXT, async (context) => {\r\n\t\t\t\tthis.#eventContext = context;\r\n\t\t\t})\r\n\t\t\t\t.asPromise({ preventTimeout: true })\r\n\t\t\t\t.catch(() => {\r\n\t\t\t\t\t// If the context is not available, we can assume that the context is not available.\r\n\t\t\t\t\tthis.#eventContext = undefined;\r\n\t\t\t\t}),\r\n\t\t]);\r\n\r\n\t\tthis.consumeContext(UMB_NOTIFICATION_CONTEXT, (context) => {\r\n\t\t\tthis.#notificationContext = context;\r\n\t\t});\r\n\t}\r\n\r\n\tpublic async publish() {\r\n\t\tthrow new Error('Method not implemented.');\r\n\t}\r\n\r\n\t/**\r\n\t * Save and publish the document\r\n\t * @returns {Promise<void>}\r\n\t * @memberof UmbDocumentPublishingWorkspaceContext\r\n\t */\r\n\tpublic async saveAndPublish(): Promise<void> {\r\n\t\tconst elementStyle = (this.getHostElement() as HTMLElement).style;\r\n\t\telementStyle.removeProperty('--uui-color-invalid');\r\n\t\telementStyle.removeProperty('--uui-color-invalid-emphasis');\r\n\t\telementStyle.removeProperty('--uui-color-invalid-standalone');\r\n\t\telementStyle.removeProperty('--uui-color-invalid-contrast');\r\n\t\treturn this.#handleSaveAndPublish();\r\n\t}\r\n\r\n\t/**\r\n\t * Schedule the document for publishing\r\n\t * @returns {Promise<void>}\r\n\t * @memberof UmbDocumentPublishingWorkspaceContext\r\n\t */\r\n\tpublic async schedule(): Promise<void> {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst unique = this.#documentWorkspaceContext.getUnique();\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\tconst entityType = this.#documentWorkspaceContext.getEntityType();\r\n\t\tif (!entityType) throw new Error('Entity type is missing');\r\n\r\n\t\tconst { options, selected } = await this.#determineVariantOptions();\r\n\r\n\t\tconst result = await umbOpenModal(this, UMB_DOCUMENT_SCHEDULE_MODAL, {\r\n\t\t\tdata: {\r\n\t\t\t\toptions,\r\n\t\t\t\tactiveVariants: selected,\r\n\t\t\t\tpickableFilter: this.#publishableVariantsFilter,\r\n\t\t\t\tprevalues: options.map((option) => ({\r\n\t\t\t\t\tunique: option.unique,\r\n\t\t\t\t\tschedule: {\r\n\t\t\t\t\t\tpublishTime: option.variant?.scheduledPublishDate,\r\n\t\t\t\t\t\tunpublishTime: option.variant?.scheduledUnpublishDate,\r\n\t\t\t\t\t},\r\n\t\t\t\t})),\r\n\t\t\t},\r\n\t\t}).catch(() => undefined);\r\n\r\n\t\tif (!result?.selection.length) return;\r\n\r\n\t\t// Map to the correct format for the API (UmbDocumentVariantPublishModel)\r\n\t\tconst variants =\r\n\t\t\tresult?.selection.map<UmbDocumentVariantPublishModel>((x) => ({\r\n\t\t\t\tvariantId: UmbVariantId.FromString(x.unique),\r\n\t\t\t\tschedule: {\r\n\t\t\t\t\tpublishTime: this.#convertToDateTimeOffset(x.schedule?.publishTime),\r\n\t\t\t\t\tunpublishTime: this.#convertToDateTimeOffset(x.schedule?.unpublishTime),\r\n\t\t\t\t},\r\n\t\t\t})) ?? [];\r\n\r\n\t\tif (!variants.length) return;\r\n\r\n\t\tconst variantIds = variants.map((x) => x.variantId);\r\n\t\tconst saveData = await this.#documentWorkspaceContext.constructSaveData(variantIds);\r\n\t\tawait this.#documentWorkspaceContext.runMandatoryValidationForSaveData(saveData);\r\n\t\tawait this.#documentWorkspaceContext.askServerToValidate(saveData, variantIds);\r\n\r\n\t\t// TODO: Only validate the specified selection.. [NL]\r\n\t\treturn this.#documentWorkspaceContext.validateAndSubmit(\r\n\t\t\tasync () => {\r\n\t\t\t\tif (!this.#documentWorkspaceContext) {\r\n\t\t\t\t\tthrow new Error('Document workspace context is missing');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Save the document before scheduling\r\n\t\t\t\tawait this.#documentWorkspaceContext.performCreateOrUpdate(variantIds, saveData);\r\n\r\n\t\t\t\t// Schedule the document\r\n\t\t\t\tconst { error } = await this.#publishingRepository.publish(unique, variants);\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\treturn Promise.reject(error);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst notification = { data: { message: this.#localize.term('speechBubbles_editContentScheduledSavedText') } };\r\n\t\t\t\tthis.#notificationContext?.peek('positive', notification);\r\n\r\n\t\t\t\t// reload the document so all states are updated after the publish operation\r\n\t\t\t\tawait this.#documentWorkspaceContext.reload();\r\n\t\t\t\tthis.#loadAndProcessLastPublished();\r\n\r\n\t\t\t\t// request reload of this entity\r\n\t\t\t\tconst structureEvent = new UmbRequestReloadStructureForEntityEvent({ entityType, unique });\r\n\t\t\t\tthis.#eventContext?.dispatchEvent(structureEvent);\r\n\t\t\t},\r\n\t\t\tasync (reason?: any) => {\r\n\t\t\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\t\t\tif (!notificationContext) {\r\n\t\t\t\t\tthrow new Error('Notification context is missing');\r\n\t\t\t\t}\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: this.#localize.term('speechBubbles_editContentScheduledNotSavedText') },\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn Promise.reject(reason);\r\n\t\t\t},\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * Convert a date string to a server time string in ISO format, example: 2021-01-01T12:00:00.000+00:00.\r\n\t * The input must be a valid date string, otherwise it will return null.\r\n\t * The output matches the DateTimeOffset format in C#.\r\n\t * @param dateString\r\n\t */\r\n\t#convertToDateTimeOffset(dateString: string | null | undefined) {\r\n\t\tif (!dateString || dateString.length === 0) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tconst date = new Date(dateString);\r\n\r\n\t\tif (isNaN(date.getTime())) {\r\n\t\t\tconsole.warn(`[Schedule]: Invalid date: ${dateString}`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\t// Convert the date to UTC time in ISO format before sending it to the server\r\n\t\treturn date.toISOString();\r\n\t}\r\n\r\n\t/**\r\n\t * Publish the document with descendants\r\n\t * @returns {Promise<void>}\r\n\t * @memberof UmbDocumentPublishingWorkspaceContext\r\n\t */\r\n\tpublic async publishWithDescendants(): Promise<void> {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst unique = this.#documentWorkspaceContext.getUnique();\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\tconst entityType = this.#documentWorkspaceContext.getEntityType();\r\n\t\tif (!entityType) throw new Error('Entity type is missing');\r\n\r\n\t\tconst { options, selected } = await this.#determineVariantOptions();\r\n\r\n\t\tconst result = await umbOpenModal(this, UMB_DOCUMENT_PUBLISH_WITH_DESCENDANTS_MODAL, {\r\n\t\t\tdata: {\r\n\t\t\t\toptions,\r\n\t\t\t\tpickableFilter: this.#publishableVariantsFilter,\r\n\t\t\t},\r\n\t\t\tvalue: { selection: selected },\r\n\t\t}).catch(() => undefined);\r\n\r\n\t\tif (!result?.selection.length) return;\r\n\r\n\t\t// Map to variantIds\r\n\t\tconst variantIds = result?.selection.map((x) => UmbVariantId.FromString(x)) ?? [];\r\n\r\n\t\tif (!variantIds.length) return;\r\n\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst localize = new UmbLocalizationController(this);\r\n\r\n\t\tconst primaryVariantName = await this.observe(this.#documentWorkspaceContext.name(variantIds[0])).asPromise();\r\n\r\n\t\tconst waitNotice = notificationContext?.peek('warning', {\r\n\t\t\tdata: {\r\n\t\t\t\theadline: localize.term('publish_publishAll', primaryVariantName),\r\n\t\t\t\tmessage: localize.term('publish_inProgress'),\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tconst { error } = await this.#publishingRepository.publishWithDescendants(\r\n\t\t\tunique,\r\n\t\t\tvariantIds,\r\n\t\t\tresult.includeUnpublishedDescendants ?? false,\r\n\t\t);\r\n\r\n\t\twaitNotice?.close();\r\n\r\n\t\tif (!error) {\r\n\t\t\tnotificationContext?.peek('positive', {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tmessage: localize.term('publish_nodePublishAll', primaryVariantName),\r\n\t\t\t\t},\r\n\t\t\t});\r\n\r\n\t\t\t// reload the document so all states are updated after the publish operation\r\n\t\t\tawait this.#documentWorkspaceContext.reload();\r\n\t\t\tthis.#loadAndProcessLastPublished();\r\n\r\n\t\t\t// request reload of this entity\r\n\t\t\tconst structureEvent = new UmbRequestReloadStructureForEntityEvent({ entityType, unique });\r\n\t\t\tthis.#eventContext?.dispatchEvent(structureEvent);\r\n\r\n\t\t\t// request reload of the children\r\n\t\t\tconst childrenEvent = new UmbRequestReloadChildrenOfEntityEvent({ entityType, unique });\r\n\t\t\tthis.#eventContext?.dispatchEvent(childrenEvent);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Unpublish the document\r\n\t * @returns {Promise<void>}\r\n\t * @memberof UmbDocumentPublishingWorkspaceContext\r\n\t */\r\n\tpublic async unpublish(): Promise<void> {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst unique = this.#documentWorkspaceContext.getUnique();\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\tconst entityType = this.#documentWorkspaceContext.getEntityType();\r\n\t\tif (!entityType) throw new Error('Entity type is missing');\r\n\r\n\t\t// TODO: remove meta\r\n\t\tawait new UmbUnpublishDocumentEntityAction(this, { unique, entityType, meta: {} as never }).execute();\r\n\t}\r\n\r\n\tasync #handleSaveAndPublish() {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst unique = this.#documentWorkspaceContext.getUnique();\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\tlet variantIds: Array<UmbVariantId> = [];\r\n\r\n\t\tconst { options, selected } = await this.#determineVariantOptions();\r\n\r\n\t\t// If there is only one variant, we don't need to open the modal.\r\n\t\tif (options.length === 0) {\r\n\t\t\tthrow new Error('No variants are available');\r\n\t\t} else if (options.length === 1) {\r\n\t\t\t// If only one option we will skip ahead and save the document with the only variant available:\r\n\t\t\tvariantIds.push(UmbVariantId.Create(options[0]));\r\n\t\t} else {\r\n\t\t\t// If there are multiple variants, we will open the modal to let the user pick which variants to publish.\r\n\t\t\tconst result = await umbOpenModal(this, UMB_DOCUMENT_PUBLISH_MODAL, {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\theadline: this.#localize.term('content_saveAndPublishModalTitle'),\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tpickableFilter: this.#publishableVariantsFilter,\r\n\t\t\t\t},\r\n\t\t\t\tvalue: { selection: selected },\r\n\t\t\t}).catch(() => undefined);\r\n\r\n\t\t\tif (!result?.selection.length || !unique) return;\r\n\r\n\t\t\tvariantIds = result?.selection.map((x) => UmbVariantId.FromString(x)) ?? [];\r\n\t\t}\r\n\r\n\t\tconst saveData = await this.#documentWorkspaceContext.constructSaveData(variantIds);\r\n\t\tawait this.#documentWorkspaceContext.runMandatoryValidationForSaveData(saveData, variantIds);\r\n\t\tawait this.#documentWorkspaceContext.askServerToValidate(saveData, variantIds);\r\n\r\n\t\t// TODO: Only validate the specified selection.. [NL]\r\n\t\treturn this.#documentWorkspaceContext.validateAndSubmit(\r\n\t\t\tasync () => {\r\n\t\t\t\treturn this.#performSaveAndPublish(variantIds, saveData);\r\n\t\t\t},\r\n\t\t\tasync (reason?: any) => {\r\n\t\t\t\t// If data of the selection is not valid Then just save:\r\n\t\t\t\tawait this.#documentWorkspaceContext!.performCreateOrUpdate(variantIds, saveData);\r\n\t\t\t\t// Notifying that the save was successful, but we did not publish, which is what we want to symbolize here. [NL]\r\n\t\t\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\t\t\tif (!notificationContext) {\r\n\t\t\t\t\tthrow new Error('Notification context is missing');\r\n\t\t\t\t}\r\n\t\t\t\t// TODO: Get rid of the save notification.\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: this.#localize.term('speechBubbles_editContentPublishedFailedByValidation') },\r\n\t\t\t\t});\r\n\t\t\t\t// Reject even thought the save was successful, but we did not publish, which is what we want to symbolize here. [NL]\r\n\t\t\t\treturn await Promise.reject(reason);\r\n\t\t\t},\r\n\t\t);\r\n\t}\r\n\r\n\tasync #performSaveAndPublish(variantIds: Array<UmbVariantId>, saveData: UmbDocumentDetailModel): Promise<void> {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst unique = this.#documentWorkspaceContext.getUnique();\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\tconst entityType = this.#documentWorkspaceContext.getEntityType();\r\n\t\tif (!entityType) throw new Error('Entity type is missing');\r\n\r\n\t\tawait this.#documentWorkspaceContext.performCreateOrUpdate(variantIds, saveData);\r\n\r\n\t\tconst { error } = await this.#publishingRepository.publish(\r\n\t\t\tunique,\r\n\t\t\tvariantIds.map((variantId) => ({ variantId })),\r\n\t\t);\r\n\r\n\t\tif (!error) {\r\n\t\t\tthis.#notificationContext?.peek('positive', {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tmessage: this.#localize.term('speechBubbles_editContentPublishedHeader'),\r\n\t\t\t\t},\r\n\t\t\t});\r\n\r\n\t\t\t// reload the document so all states are updated after the publish operation\r\n\t\t\tawait this.#documentWorkspaceContext.reload();\r\n\t\t\tthis.#loadAndProcessLastPublished();\r\n\r\n\t\t\tconst event = new UmbRequestReloadStructureForEntityEvent({ unique, entityType });\r\n\t\t\tthis.#eventContext?.dispatchEvent(event);\r\n\t\t}\r\n\t}\r\n\r\n\t#publishableVariantsFilter = (option: UmbDocumentVariantOptionModel) => {\r\n\t\tconst variantId = UmbVariantId.Create(option);\r\n\t\t// If the read only guard is permitted it means the variant is read only\r\n\t\tconst isReadOnly = this.#documentWorkspaceContext!.readOnlyGuard.getIsPermittedForVariant(variantId);\r\n\t\t// If the variant is read only, we can't publish it\r\n\t\tconst isPublishable = !isReadOnly;\r\n\t\treturn isPublishable;\r\n\t};\r\n\r\n\tasync #determineVariantOptions(): Promise<{\r\n\t\toptions: UmbDocumentVariantOptionModel[];\r\n\t\tselected: string[];\r\n\t}> {\r\n\t\tawait this.#init;\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst allOptions = await firstValueFrom(this.#documentWorkspaceContext.variantOptions);\r\n\t\tconst options = allOptions.filter((option) => option.segment === null);\r\n\r\n\t\t// TODO: this is a temporary copy of the content-detail workspace context method.\r\n\t\t// we need to implement custom selection that makes sense for each the publishing modal.\r\n\t\tlet selected = this.#getPublishVariantsSelection();\r\n\r\n\t\t// Selected can contain entries that are not part of the options, therefor the modal filters selection based on options.\r\n\t\tselected = selected.filter((x) => options.some((o) => o.unique === x));\r\n\r\n\t\t// Filter out read-only variants\r\n\t\t// TODO: This would not work with segments, as the 'selected'-array is an array of strings, not UmbVariantId's. [NL]\r\n\t\t// Please have a look at the implementation in the content-detail workspace context, as that one compares variantIds. [NL]\r\n\t\tselected = selected.filter(\r\n\t\t\t(x) => this.#documentWorkspaceContext!.readOnlyGuard.getIsPermittedForVariant(new UmbVariantId(x)) === false,\r\n\t\t);\r\n\r\n\t\treturn {\r\n\t\t\toptions,\r\n\t\t\tselected,\r\n\t\t};\r\n\t}\r\n\r\n\t#getPublishVariantsSelection() {\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\t\tconst activeVariants = this.#documentWorkspaceContext.splitView.getActiveVariants();\r\n\t\tconst activeVariantIds = activeVariants.map((x) => UmbVariantId.Create(x));\r\n\t\tconst changedVariantIds = this.#documentWorkspaceContext.getChangedVariants();\r\n\t\tconst activeAndChangedVariantIds = [...activeVariantIds, ...changedVariantIds];\r\n\r\n\t\t// if a segment has been changed, we select the \"parent\" culture variant as it is currently only possible to select between cultures in the dialogs\r\n\t\tconst changedParentCultureVariantIds = activeAndChangedVariantIds\r\n\t\t\t.filter((x) => x.segment !== null)\r\n\t\t\t.map((x) => x.toSegmentInvariant());\r\n\r\n\t\tconst selected = [...activeAndChangedVariantIds, ...changedParentCultureVariantIds].map((variantId) =>\r\n\t\t\tvariantId.toString(),\r\n\t\t);\r\n\r\n\t\tconst uniqueSelected = [...new Set(selected)];\r\n\r\n\t\treturn uniqueSelected;\r\n\t}\r\n\r\n\tasync #initPendingChanges() {\r\n\t\tif (!this.#documentWorkspaceContext) {\r\n\t\t\t// Do not complain in this case.\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.observe(\r\n\t\t\tobserveMultiple([this.#documentWorkspaceContext.unique, this.#documentWorkspaceContext.isNew]),\r\n\t\t\t([unique, isNew]) => {\r\n\t\t\t\t// We have loaded in a new document, so we need to clear the states\r\n\t\t\t\tif (unique !== this.#currentUnique) {\r\n\t\t\t\t\tthis.#clear();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.#currentUnique = unique;\r\n\r\n\t\t\t\tif (isNew === false && unique) {\r\n\t\t\t\t\tthis.#loadAndProcessLastPublished();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t'uniqueObserver',\r\n\t\t);\r\n\r\n\t\tthis.observe(\r\n\t\t\tthis.#documentWorkspaceContext.persistedData,\r\n\t\t\t() => this.#processPendingChanges(),\r\n\t\t\t'umbPersistedDataObserver',\r\n\t\t);\r\n\t}\r\n\r\n\t#hasPublishedVariant() {\r\n\t\tconst variants = this.#documentWorkspaceContext?.getVariants();\r\n\t\treturn (\r\n\t\t\tvariants?.some(\r\n\t\t\t\t(variant) =>\r\n\t\t\t\t\tvariant.state === DocumentVariantStateModel.PUBLISHED ||\r\n\t\t\t\t\tvariant.state === DocumentVariantStateModel.PUBLISHED_PENDING_CHANGES,\r\n\t\t\t) ?? false\r\n\t\t);\r\n\t}\r\n\r\n\tasync #loadAndProcessLastPublished() {\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\t// No need to check pending changes for new documents\r\n\t\tif (this.#documentWorkspaceContext.getIsNew()) return;\r\n\r\n\t\tconst unique = this.#documentWorkspaceContext.getUnique();\r\n\t\tif (!unique) throw new Error('Unique is missing');\r\n\r\n\t\t// Only load the published data if the document is already published or has been published before\r\n\t\tconst hasPublishedVariant = this.#hasPublishedVariant();\r\n\t\tif (!hasPublishedVariant) return;\r\n\r\n\t\tconst { data } = await this.#publishingRepository.published(unique);\r\n\t\tthis.#publishedDocumentData = data;\r\n\t\tthis.#processPendingChanges();\r\n\t}\r\n\r\n\t#processPendingChanges() {\r\n\t\tif (!this.#documentWorkspaceContext) throw new Error('Document workspace context is missing');\r\n\r\n\t\tconst persistedData = this.#documentWorkspaceContext.getPersistedData();\r\n\t\tconst publishedData = this.#publishedDocumentData;\r\n\t\tif (!persistedData || !publishedData) return;\r\n\r\n\t\tthis.publishedPendingChanges.process({ persistedData, publishedData });\r\n\t}\r\n\r\n\t#clear() {\r\n\t\tthis.#publishedDocumentData = undefined;\r\n\t\tthis.publishedPendingChanges.clear();\r\n\t}\r\n}\r\n\r\nexport { UmbDocumentPublishingWorkspaceContext as api };\r\n"],"names":["UmbDocumentPublishedPendingChangesManager","UmbControllerBase","#variantsWithChanges","UmbArrayState","x","#cleanVariantForComparison","variant","args","pendingChangesPromises","UmbVariantId","variantId","mergedData","UmbMergeContentVariantDataController","mergedDataClone","publishedDataClone","jsonStringComparison","variantsWithPendingChanges","UmbDocumentPublishingWorkspaceContext","UmbContextBase","host","UMB_DOCUMENT_PUBLISHING_WORKSPACE_CONTEXT","#publishingRepository","UmbDocumentPublishingRepository","#localize","UmbLocalizationController","#publishableVariantsFilter","option","#documentWorkspaceContext","#init","UMB_DOCUMENT_WORKSPACE_CONTEXT","context","UMB_DOCUMENT_PUBLISHING_SHORTCUT_UNIQUE","#initPendingChanges","UMB_ACTION_EVENT_CONTEXT","#eventContext","UMB_NOTIFICATION_CONTEXT","#notificationContext","#publishedDocumentData","#currentUnique","elementStyle","#handleSaveAndPublish","unique","entityType","options","selected","#determineVariantOptions","result","umbOpenModal","UMB_DOCUMENT_SCHEDULE_MODAL","variants","#convertToDateTimeOffset","variantIds","saveData","error","notification","#loadAndProcessLastPublished","structureEvent","UmbRequestReloadStructureForEntityEvent","reason","notificationContext","dateString","date","UMB_DOCUMENT_PUBLISH_WITH_DESCENDANTS_MODAL","localize","primaryVariantName","waitNotice","childrenEvent","UmbRequestReloadChildrenOfEntityEvent","UmbUnpublishDocumentEntityAction","UMB_DOCUMENT_PUBLISH_MODAL","#performSaveAndPublish","event","firstValueFrom","#getPublishVariantsSelection","o","activeVariantIds","changedVariantIds","activeAndChangedVariantIds","changedParentCultureVariantIds","observeMultiple","isNew","#clear","#processPendingChanges","#hasPublishedVariant","DocumentVariantStateModel","data","persistedData","publishedData"],"mappings":"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"}