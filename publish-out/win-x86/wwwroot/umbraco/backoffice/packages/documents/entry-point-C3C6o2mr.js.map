{"version":3,"file":"entry-point-C3C6o2mr.js","sources":["../../../src/packages/documents/documents/item/repository/document-item.server.cache-invalidation.manager.ts","../../../src/packages/documents/documents/entry-point.ts"],"sourcesContent":["import { documentItemCache } from './document-item.server.cache.js';\r\nimport {\r\n\tUmbManagementApiItemDataCacheInvalidationManager,\r\n\ttype UmbManagementApiServerEventModel,\r\n} from '@umbraco-cms/backoffice/management-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { DocumentItemResponseModel } from '@umbraco-cms/backoffice/external/backend-api';\r\n\r\nexport class UmbManagementApiDocumentItemDataCacheInvalidationManager extends UmbManagementApiItemDataCacheInvalidationManager<DocumentItemResponseModel> {\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, {\r\n\t\t\tdataCache: documentItemCache,\r\n\t\t\t/* The Document item model includes info about the Document Type.\r\n\t\t\tWe need to invalidate the cache for both Document and DocumentType events. */\r\n\t\t\teventSources: ['Umbraco:CMS:Document', 'Umbraco:CMS:DocumentType'],\r\n\t\t\teventTypes: ['Updated', 'Deleted', 'Trashed'],\r\n\t\t});\r\n\t}\r\n\r\n\tprotected override _onServerEvent(event: UmbManagementApiServerEventModel) {\r\n\t\tif (event.eventSource === 'Umbraco:CMS:DocumentType') {\r\n\t\t\tthis.#onDocumentTypeChange(event);\r\n\t\t} else {\r\n\t\t\tthis.#onDocumentChange(event);\r\n\t\t}\r\n\t}\r\n\r\n\t#onDocumentChange(event: UmbManagementApiServerEventModel) {\r\n\t\t// Invalidate the specific document\r\n\t\tconst documentId = event.key;\r\n\t\tthis._dataCache.delete(documentId);\r\n\t}\r\n\r\n\t#onDocumentTypeChange(event: UmbManagementApiServerEventModel) {\r\n\t\t// Invalidate all documents of the specified Document Type\r\n\t\tconst documentTypeId = event.key;\r\n\t\tconst documentIds = this._dataCache\r\n\t\t\t.getAll()\r\n\t\t\t.filter((cachedItem) => cachedItem.documentType.id === documentTypeId)\r\n\t\t\t.map((item) => item.id);\r\n\r\n\t\tdocumentIds.forEach((id) => this._dataCache.delete(id));\r\n\t}\r\n}\r\n","import { UmbManagementApiDocumentItemDataCacheInvalidationManager } from './item/repository/document-item.server.cache-invalidation.manager.js';\r\nimport type { UmbEntryPointOnInit, UmbEntryPointOnUnload } from '@umbraco-cms/backoffice/extension-api';\r\n\r\nlet itemDataCacheInvalidationManager: UmbManagementApiDocumentItemDataCacheInvalidationManager | undefined;\r\n\r\nexport const onInit: UmbEntryPointOnInit = (host) => {\r\n\titemDataCacheInvalidationManager = new UmbManagementApiDocumentItemDataCacheInvalidationManager(host);\r\n};\r\n\r\nexport const onUnload: UmbEntryPointOnUnload = () => {\r\n\titemDataCacheInvalidationManager?.destroy();\r\n};\r\n"],"names":["UmbManagementApiDocumentItemDataCacheInvalidationManager","UmbManagementApiItemDataCacheInvalidationManager","host","documentItemCache","event","#onDocumentTypeChange","#onDocumentChange","documentId","documentTypeId","cachedItem","item","id","itemDataCacheInvalidationManager","onInit","onUnload"],"mappings":";;AAQO,MAAMA,UAAiEC,EAA4E;AAAA,EACzJ,YAAYC,GAAyB;AACpC,UAAMA,GAAM;AAAA,MACX,WAAWC;AAAA;AAAA;AAAA,MAGX,cAAc,CAAC,wBAAwB,0BAA0B;AAAA,MACjE,YAAY,CAAC,WAAW,WAAW,SAAS;AAAA,IAAA,CAC5C;AAAA,EACF;AAAA,EAEmB,eAAeC,GAAyC;AAC1E,IAAIA,EAAM,gBAAgB,6BACzB,KAAKC,GAAsBD,CAAK,IAEhC,KAAKE,GAAkBF,CAAK;AAAA,EAE9B;AAAA,EAEAE,GAAkBF,GAAyC;AAE1D,UAAMG,IAAaH,EAAM;AACzB,SAAK,WAAW,OAAOG,CAAU;AAAA,EAClC;AAAA,EAEAF,GAAsBD,GAAyC;AAE9D,UAAMI,IAAiBJ,EAAM;AAM7B,IALoB,KAAK,WACvB,OAAA,EACA,OAAO,CAACK,MAAeA,EAAW,aAAa,OAAOD,CAAc,EACpE,IAAI,CAACE,MAASA,EAAK,EAAE,EAEX,QAAQ,CAACC,MAAO,KAAK,WAAW,OAAOA,CAAE,CAAC;AAAA,EACvD;AACD;ACxCA,IAAIC;AAEG,MAAMC,IAA8B,CAACX,MAAS;AACpD,EAAAU,IAAmC,IAAIZ,EAAyDE,CAAI;AACrG,GAEaY,IAAkC,MAAM;AACpD,EAAAF,GAAkC,QAAA;AACnC;"}