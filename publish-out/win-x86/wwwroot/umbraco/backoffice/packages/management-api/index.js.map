{"version":3,"file":"index.js","sources":["../../../src/packages/management-api/detail/cache-invalidation.manager.ts","../../../src/packages/management-api/detail/cache.ts","../../../src/packages/management-api/detail/detail-data.request-manager.ts","../../../src/packages/management-api/item/item-data.request-manager.ts","../../../src/packages/management-api/item/cache-invalidation.manager.ts","../../../src/packages/management-api/item/cache.ts","../../../src/packages/management-api/inflight-request/cache.ts"],"sourcesContent":["import { UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT } from '../server-event/constants.js';\r\nimport type { UmbManagementApiServerEventModel } from '../server-event/types.js';\r\nimport type { UmbManagementApiDetailDataCache } from './cache.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\n\r\nexport interface UmbManagementApiDetailDataInvalidationManagerArgs<DetailResponseModelType> {\r\n\tdataCache: UmbManagementApiDetailDataCache<DetailResponseModelType>;\r\n\teventSources: Array<string>;\r\n\teventTypes?: Array<string>;\r\n}\r\n\r\nexport class UmbManagementApiDetailDataCacheInvalidationManager<DetailResponseModelType> extends UmbControllerBase {\r\n\tprotected _dataCache: UmbManagementApiDetailDataCache<DetailResponseModelType>;\r\n\t#eventSources: Array<string>;\r\n\t#eventTypes: Array<string>;\r\n\t#serverEventContext?: typeof UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT.TYPE;\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\targs: UmbManagementApiDetailDataInvalidationManagerArgs<DetailResponseModelType>,\r\n\t) {\r\n\t\tsuper(host);\r\n\t\t{\r\n\t\t\tthis._dataCache = args.dataCache;\r\n\t\t\tthis.#eventSources = args.eventSources;\r\n\t\t\tthis.#eventTypes = args.eventTypes ?? ['Updated', 'Deleted'];\r\n\r\n\t\t\tthis.consumeContext(UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT, (context) => {\r\n\t\t\t\tthis.#serverEventContext = context;\r\n\t\t\t\tthis.#observeServerEvents();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Handles server events\r\n\t * @protected\r\n\t * @param {UmbManagementApiServerEventModel} event - The server event to handle\r\n\t * @memberof UmbManagementApiDetailDataCacheInvalidationManager\r\n\t */\r\n\tprotected _onServerEvent(event: UmbManagementApiServerEventModel) {\r\n\t\tthis._dataCache.delete(event.key);\r\n\t}\r\n\r\n\t#observeServerEvents() {\r\n\t\tthis.observe(\r\n\t\t\tthis.#serverEventContext?.byEventSourcesAndEventTypes(this.#eventSources, this.#eventTypes),\r\n\t\t\t(event) => {\r\n\t\t\t\tif (!event) return;\r\n\t\t\t\tthis._onServerEvent(event);\r\n\t\t\t},\r\n\t\t\t'umbObserveServerEvents',\r\n\t\t);\r\n\t}\r\n\r\n\toverride destroy(): void {\r\n\t\tthis._dataCache.clear();\r\n\t}\r\n}\r\n","// Keep internal\r\ninterface UmbDetailCacheEntryModel<DetailDataModelType> {\r\n\tid: string;\r\n\tdata: DetailDataModelType;\r\n\ttimestamp: string;\r\n}\r\n\r\n/**\r\n * A runtime cache for storing entity detail data from the Management Api\r\n * @class UmbManagementApiDetailDataCache\r\n * @template DetailDataModelType\r\n */\r\nexport class UmbManagementApiDetailDataCache<DetailDataModelType> {\r\n\t#entries: Map<string, UmbDetailCacheEntryModel<DetailDataModelType>> = new Map();\r\n\r\n\t/**\r\n\t * Checks if an entry exists in the cache\r\n\t * @param {string} id - The ID of the entry to check\r\n\t * @returns {boolean} - True if the entry exists, false otherwise\r\n\t * @memberof UmbManagementApiDetailDataCache\r\n\t */\r\n\thas(id: string): boolean {\r\n\t\treturn this.#entries.has(id);\r\n\t}\r\n\r\n\t/**\r\n\t * Adds an entry to the cache\r\n\t * @param {string} id - The ID of the entry to add\r\n\t * @param {DetailDataModelType} data - The data to cache\r\n\t * @memberof UmbManagementApiDetailDataCache\r\n\t */\r\n\tset(id: string, data: DetailDataModelType): void {\r\n\t\tconst cacheEntry: UmbDetailCacheEntryModel<DetailDataModelType> = {\r\n\t\t\tid: id,\r\n\t\t\tdata,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t};\r\n\r\n\t\tthis.#entries.set(id, cacheEntry);\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves an entry from the cache\r\n\t * @param {string} id - The ID of the entry to retrieve\r\n\t * @returns {DetailDataModelType | undefined} - The cached entry or undefined if not found\r\n\t * @memberof UmbManagementApiDetailDataCache\r\n\t */\r\n\tget(id: string): DetailDataModelType | undefined {\r\n\t\tconst entry = this.#entries.get(id);\r\n\t\treturn entry ? entry.data : undefined;\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves all entries from the cache\r\n\t * @returns {Array<DetailDataModelType>} - An array of all cached entries\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\tgetAll(): Array<DetailDataModelType> {\r\n\t\treturn Array.from(this.#entries.values()).map((entry) => entry.data);\r\n\t}\r\n\r\n\t/**\r\n\t * Deletes an entry from the cache\r\n\t * @param {string} id - The ID of the entry to delete\r\n\t * @memberof UmbManagementApiDetailDataCache\r\n\t */\r\n\tdelete(id: string): void {\r\n\t\tthis.#entries.delete(id);\r\n\t}\r\n\r\n\t/**\r\n\t * Clears all entries from the cache\r\n\t * @memberof UmbManagementApiDetailDataCache\r\n\t */\r\n\tclear(): void {\r\n\t\tthis.#entries.clear();\r\n\t}\r\n}\r\n","import { UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT } from '../server-event/constants.js';\r\nimport type { UmbManagementApiInFlightRequestCache } from '../inflight-request/cache.js';\r\nimport type { UmbManagementApiDetailDataCache } from './cache.js';\r\nimport {\r\n\ttryExecute,\r\n\ttype UmbApiError,\r\n\ttype UmbCancelError,\r\n\ttype UmbApiResponse,\r\n\ttype UmbApiWithErrorResponse,\r\n} from '@umbraco-cms/backoffice/resources';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\n\r\nexport interface UmbManagementApiDetailDataRequestManagerArgs<\r\n\tDetailResponseModelType,\r\n\tCreateRequestModelType,\r\n\tUpdateRequestModelType,\r\n> {\r\n\tcreate: (data: CreateRequestModelType) => Promise<UmbApiResponse<{ data: unknown }>>;\r\n\tread: (id: string) => Promise<UmbApiResponse<{ data: DetailResponseModelType }>>;\r\n\tupdate: (id: string, data: UpdateRequestModelType) => Promise<UmbApiResponse<{ data: unknown }>>;\r\n\tdelete: (id: string) => Promise<UmbApiResponse<{ data: unknown }>>;\r\n\tdataCache: UmbManagementApiDetailDataCache<DetailResponseModelType>;\r\n\tinflightRequestCache: UmbManagementApiInFlightRequestCache<DetailResponseModelType>;\r\n}\r\n\r\nexport class UmbManagementApiDetailDataRequestManager<\r\n\tDetailResponseModelType,\r\n\tCreateRequestModelType,\r\n\tUpdateRequestModelType,\r\n> extends UmbControllerBase {\r\n\t#dataCache: UmbManagementApiDetailDataCache<DetailResponseModelType>;\r\n\t#inflightRequestCache: UmbManagementApiInFlightRequestCache<DetailResponseModelType>;\r\n\r\n\t#create;\r\n\t#read;\r\n\t#update;\r\n\t#delete;\r\n\t#serverEventContext?: typeof UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT.TYPE;\r\n\t#isConnectedToServerEvents = false;\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\targs: UmbManagementApiDetailDataRequestManagerArgs<\r\n\t\t\tDetailResponseModelType,\r\n\t\t\tCreateRequestModelType,\r\n\t\t\tUpdateRequestModelType\r\n\t\t>,\r\n\t) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.#create = args.create;\r\n\t\tthis.#read = args.read;\r\n\t\tthis.#update = args.update;\r\n\t\tthis.#delete = args.delete;\r\n\r\n\t\tthis.#dataCache = args.dataCache;\r\n\t\tthis.#inflightRequestCache = args.inflightRequestCache;\r\n\r\n\t\tthis.consumeContext(UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT, (context) => {\r\n\t\t\tthis.#serverEventContext = context;\r\n\t\t\tthis.#observeServerEvents();\r\n\t\t});\r\n\t}\r\n\r\n\tasync create(data: CreateRequestModelType): Promise<UmbApiResponse<{ data?: DetailResponseModelType }>> {\r\n\t\tconst { data: createdId, error } = await tryExecute(this, this.#create(data));\r\n\r\n\t\tif (!error) {\r\n\t\t\treturn this.read(createdId as string);\r\n\t\t}\r\n\r\n\t\treturn { error };\r\n\t}\r\n\r\n\tasync read(id: string): Promise<UmbApiResponse<{ data?: DetailResponseModelType }>> {\r\n\t\tlet data: DetailResponseModelType | undefined;\r\n\t\tlet error: UmbApiError | UmbCancelError | undefined;\r\n\r\n\t\tconst inflightCacheKey = `read:${id}`;\r\n\r\n\t\t// Only read from the cache when we are connected to the server events\r\n\t\tif (this.#isConnectedToServerEvents && this.#dataCache.has(id)) {\r\n\t\t\tdata = this.#dataCache.get(id);\r\n\t\t} else {\r\n\t\t\tconst hasInflightRequest = this.#inflightRequestCache.has(inflightCacheKey);\r\n\r\n\t\t\tconst request = hasInflightRequest\r\n\t\t\t\t? this.#inflightRequestCache.get(inflightCacheKey)?.requestPromise\r\n\t\t\t\t: tryExecute(this, this.#read(id));\r\n\r\n\t\t\tif (!request) {\r\n\t\t\t\tthrow new Error(\r\n\t\t\t\t\t`Failed to create or retrieve 'read' request for ID: ${id} (cache key: ${inflightCacheKey}). Aborting read.`,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tthis.#inflightRequestCache.set(inflightCacheKey, request);\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst { data: serverData, error: serverError } = await request;\r\n\r\n\t\t\t\tif (this.#isConnectedToServerEvents && serverData) {\r\n\t\t\t\t\tthis.#dataCache.set(id, serverData);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdata = serverData;\r\n\t\t\t\terror = serverError;\r\n\t\t\t} finally {\r\n\t\t\t\tthis.#inflightRequestCache.delete(inflightCacheKey);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn { data, error };\r\n\t}\r\n\r\n\tasync update(id: string, data: UpdateRequestModelType): Promise<UmbApiResponse<{ data?: DetailResponseModelType }>> {\r\n\t\tconst { error } = await tryExecute(this, this.#update(id, data));\r\n\r\n\t\tif (!error) {\r\n\t\t\treturn this.read(id);\r\n\t\t}\r\n\r\n\t\treturn { error };\r\n\t}\r\n\r\n\tasync delete(id: string): Promise<UmbApiWithErrorResponse> {\r\n\t\tconst { error } = await tryExecute(this, this.#delete(id));\r\n\r\n\t\t// Only update the cache when we are connected to the server events\r\n\t\tif (this.#isConnectedToServerEvents && !error) {\r\n\t\t\tthis.#dataCache.delete(id);\r\n\t\t}\r\n\r\n\t\treturn { error };\r\n\t}\r\n\r\n\t#observeServerEvents() {\r\n\t\tthis.observe(\r\n\t\t\tthis.#serverEventContext?.isConnected,\r\n\t\t\t(isConnected) => {\r\n\t\t\t\t/* We purposefully ignore the initial value of isConnected.\r\n\t\t\t\tWe only care about whether the connection is established or not (true/false) */\r\n\t\t\t\tif (isConnected === undefined) return;\r\n\t\t\t\tthis.#isConnectedToServerEvents = isConnected;\r\n\r\n\t\t\t\t// Clear the cache if we lose connection to the server events\r\n\t\t\t\tif (this.#isConnectedToServerEvents === false) {\r\n\t\t\t\t\tthis.#dataCache.clear();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t'umbObserveServerEventsConnection',\r\n\t\t);\r\n\t}\r\n}\r\n","import { UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT } from '../server-event/constants.js';\r\nimport type { UmbManagementApiItemDataCache } from './cache.js';\r\nimport type { UmbApiError, UmbCancelError, UmbApiResponse } from '@umbraco-cms/backoffice/resources';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbItemDataApiGetRequestController } from '@umbraco-cms/backoffice/entity-item';\r\n\r\nexport interface UmbManagementApiItemDataRequestManagerArgs<ItemResponseModelType> {\r\n\tgetItems: (unique: Array<string>) => Promise<UmbApiResponse<{ data: Array<ItemResponseModelType> }>>;\r\n\tdataCache: UmbManagementApiItemDataCache<ItemResponseModelType>;\r\n\tgetUniqueMethod: (item: ItemResponseModelType) => string;\r\n}\r\n\r\nexport class UmbManagementApiItemDataRequestManager<ItemResponseModelType> extends UmbControllerBase {\r\n\t#dataCache: UmbManagementApiItemDataCache<ItemResponseModelType>;\r\n\t#serverEventContext?: typeof UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT.TYPE;\r\n\tgetUniqueMethod: (item: ItemResponseModelType) => string;\r\n\r\n\t#getItems;\r\n\t#isConnectedToServerEvents = false;\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbManagementApiItemDataRequestManagerArgs<ItemResponseModelType>) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.#getItems = args.getItems;\r\n\t\tthis.#dataCache = args.dataCache;\r\n\t\tthis.getUniqueMethod = args.getUniqueMethod;\r\n\r\n\t\tthis.consumeContext(UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT, (context) => {\r\n\t\t\tthis.#serverEventContext = context;\r\n\t\t\tthis.#observeServerEventsConnection();\r\n\t\t});\r\n\t}\r\n\r\n\tasync getItems(ids: Array<string>): Promise<UmbApiResponse<{ data?: Array<ItemResponseModelType> }>> {\r\n\t\tlet error: UmbApiError | UmbCancelError | undefined;\r\n\t\tlet idsToRequest: Array<string> = [...ids];\r\n\t\tlet cacheItems: Array<ItemResponseModelType> = [];\r\n\t\tlet serverItems: Array<ItemResponseModelType> | undefined;\r\n\r\n\t\t// Only read from the cache when we are connected to the server events\r\n\t\tif (this.#isConnectedToServerEvents) {\r\n\t\t\tconst cachedIds = ids.filter((id) => this.#dataCache.has(id));\r\n\t\t\tcacheItems = cachedIds\r\n\t\t\t\t.map((id) => this.#dataCache.get(id))\r\n\t\t\t\t.filter((x) => x !== undefined) as Array<ItemResponseModelType>;\r\n\t\t\tidsToRequest = ids.filter((id) => !this.#dataCache.has(id));\r\n\t\t}\r\n\r\n\t\tif (idsToRequest.length > 0) {\r\n\t\t\tconst getItemsController = new UmbItemDataApiGetRequestController(this, {\r\n\t\t\t\tapi: (args) => this.#getItems(args.uniques),\r\n\t\t\t\tuniques: idsToRequest,\r\n\t\t\t});\r\n\r\n\t\t\tconst { data: serverData, error: serverError } = await getItemsController.request();\r\n\r\n\t\t\tserverItems = serverData ?? [];\r\n\t\t\terror = serverError;\r\n\r\n\t\t\tif (this.#isConnectedToServerEvents) {\r\n\t\t\t\t// If we are connected to server events, we can cache the server data\r\n\t\t\t\tserverItems?.forEach((item) => this.#dataCache.set(this.getUniqueMethod(item), item));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst data: Array<ItemResponseModelType> = [...cacheItems, ...(serverItems ?? [])];\r\n\r\n\t\treturn { data, error };\r\n\t}\r\n\r\n\t#observeServerEventsConnection() {\r\n\t\tthis.observe(\r\n\t\t\tthis.#serverEventContext?.isConnected,\r\n\t\t\t(isConnected) => {\r\n\t\t\t\t/* We purposefully ignore the initial value of isConnected.\r\n\t\t\t\tWe only care about whether the connection is established or not (true/false) */\r\n\t\t\t\tif (isConnected === undefined) return;\r\n\t\t\t\tthis.#isConnectedToServerEvents = isConnected;\r\n\r\n\t\t\t\t// Clear the cache if we lose connection to the server events\r\n\t\t\t\tif (this.#isConnectedToServerEvents === false) {\r\n\t\t\t\t\tthis.#dataCache.clear();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t'umbObserveServerEventsConnection',\r\n\t\t);\r\n\t}\r\n}\r\n","import { UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT } from '../server-event/constants.js';\r\nimport type { UmbManagementApiServerEventModel } from '../server-event/types.js';\r\nimport type { UmbManagementApiItemDataCache } from './cache.js';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\n\r\nexport interface UmbManagementApiItemDataInvalidationManagerArgs<ItemResponseModelType> {\r\n\tdataCache: UmbManagementApiItemDataCache<ItemResponseModelType>;\r\n\teventSources: Array<string>;\r\n\teventTypes?: Array<string>;\r\n}\r\n\r\nexport class UmbManagementApiItemDataCacheInvalidationManager<ItemResponseModelType> extends UmbControllerBase {\r\n\tprotected _dataCache: UmbManagementApiItemDataCache<ItemResponseModelType>;\r\n\t#eventSources: Array<string>;\r\n\t#eventTypes: Array<string>;\r\n\t#serverEventContext?: typeof UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT.TYPE;\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbManagementApiItemDataInvalidationManagerArgs<ItemResponseModelType>) {\r\n\t\tsuper(host);\r\n\t\t{\r\n\t\t\tthis._dataCache = args.dataCache;\r\n\t\t\tthis.#eventSources = args.eventSources;\r\n\t\t\tthis.#eventTypes = args.eventTypes ?? ['Updated', 'Deleted'];\r\n\r\n\t\t\tthis.consumeContext(UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT, (context) => {\r\n\t\t\t\tthis.#serverEventContext = context;\r\n\t\t\t\tthis.#observeServerEvents();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Handles server events\r\n\t * @protected\r\n\t * @param {UmbManagementApiServerEventModel} event - The server event to handle\r\n\t * @memberof UmbManagementApiItemDataCacheInvalidationManager\r\n\t */\r\n\tprotected _onServerEvent(event: UmbManagementApiServerEventModel) {\r\n\t\tthis._dataCache.delete(event.key);\r\n\t}\r\n\r\n\t#observeServerEvents() {\r\n\t\t// Invalidate cache entries when entities are updated or deleted\r\n\t\tthis.observe(\r\n\t\t\tthis.#serverEventContext?.byEventSourcesAndEventTypes(this.#eventSources, this.#eventTypes),\r\n\t\t\t(event) => {\r\n\t\t\t\tif (!event) return;\r\n\t\t\t\tthis._onServerEvent(event);\r\n\t\t\t},\r\n\t\t\t'umbObserveServerEvents',\r\n\t\t);\r\n\t}\r\n\r\n\toverride destroy(): void {\r\n\t\tthis._dataCache.clear();\r\n\t}\r\n}\r\n","// Keep internal\r\ninterface UmbItemCacheEntryModel<ItemDataModelType> {\r\n\tid: string;\r\n\tdata: ItemDataModelType;\r\n\ttimestamp: string;\r\n}\r\n\r\n/**\r\n * A runtime cache for storing entity item data from the Management Api\r\n * @class UmbManagementApiItemDataCache\r\n * @template ItemDataModelType\r\n */\r\nexport class UmbManagementApiItemDataCache<ItemDataModelType> {\r\n\t#entries: Map<string, UmbItemCacheEntryModel<ItemDataModelType>> = new Map();\r\n\r\n\t/**\r\n\t * Checks if an entry exists in the cache\r\n\t * @param {string} id - The ID of the entry to check\r\n\t * @returns {boolean} - True if the entry exists, false otherwise\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\thas(id: string): boolean {\r\n\t\treturn this.#entries.has(id);\r\n\t}\r\n\r\n\t/**\r\n\t * Adds an entry to the cache\r\n\t * @param {string} id - The ID of the entry to add\r\n\t * @param {ItemDataModelType} data - The data to cache\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\tset(id: string, data: ItemDataModelType): void {\r\n\t\tconst cacheEntry: UmbItemCacheEntryModel<ItemDataModelType> = {\r\n\t\t\tid: id,\r\n\t\t\tdata,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t};\r\n\r\n\t\tthis.#entries.set(id, cacheEntry);\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves an entry from the cache\r\n\t * @param {string} id - The ID of the entry to retrieve\r\n\t * @returns {ItemDataModelType | undefined} - The cached entry or undefined if not found\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\tget(id: string): ItemDataModelType | undefined {\r\n\t\tconst entry = this.#entries.get(id);\r\n\t\treturn entry ? entry.data : undefined;\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves all entries from the cache\r\n\t * @returns {Array<ItemDataModelType>} - An array of all cached entries\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\tgetAll(): Array<ItemDataModelType> {\r\n\t\treturn Array.from(this.#entries.values()).map((entry) => entry.data);\r\n\t}\r\n\r\n\t/**\r\n\t * Deletes an entry from the cache\r\n\t * @param {string} id - The ID of the entry to delete\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\tdelete(id: string): void {\r\n\t\tthis.#entries.delete(id);\r\n\t}\r\n\r\n\t/**\r\n\t * Clears all entries from the cache\r\n\t * @memberof UmbManagementApiItemDataCache\r\n\t */\r\n\tclear(): void {\r\n\t\tthis.#entries.clear();\r\n\t}\r\n}\r\n","import type { UmbApiResponse } from '@umbraco-cms/backoffice/resources';\r\n\r\ninterface UmbInFlightRequestCacheEntryModel<ResponseModelType> {\r\n\tkey: string;\r\n\trequestPromise: Promise<RequestResolvedType<ResponseModelType>>;\r\n\ttimestamp: string;\r\n}\r\n\r\n// Keep internal\r\ntype RequestResolvedType<ResponseModelType> = UmbApiResponse<{ data?: ResponseModelType }>;\r\n\r\n/**\r\n * A cache for inflight requests to the Management Api. Use this class to cache requests and avoid duplicate calls.\r\n * @class UmbManagementApiInflightRequestCache\r\n * @template ResponseModelType\r\n */\r\nexport class UmbManagementApiInFlightRequestCache<ResponseModelType> {\r\n\t#entries = new Map<string, UmbInFlightRequestCacheEntryModel<ResponseModelType>>();\r\n\r\n\t/**\r\n\t * Checks if an entry exists in the cache\r\n\t * @param {string} key - The ID of the entry to check\r\n\t * @returns {boolean} - True if the entry exists, false otherwise\r\n\t * @memberof UmbManagementApiInflightRequestCache\r\n\t */\r\n\thas(key: string): boolean {\r\n\t\treturn this.#entries.has(key);\r\n\t}\r\n\r\n\t/**\r\n\t * Adds an entry to the cache\r\n\t * @param {string} key - A unique key representing the promise\r\n\t * @param {Promise<UmbApiResponse<RequestResolvedType<ResponseModelType>>>} promise - The promise to cache\r\n\t * @memberof UmbManagementApiInflightRequestCache\r\n\t */\r\n\tset(key: string, promise: Promise<RequestResolvedType<ResponseModelType>>): void {\r\n\t\tthis.#entries.set(key, {\r\n\t\t\tkey,\r\n\t\t\trequestPromise: promise,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves an entry from the cache\r\n\t * @param {string} key - The ID of the entry to retrieve\r\n\t * @returns {Promise<RequestResolvedType<ResponseModelType>> | undefined} - The cached promise or undefined if not found\r\n\t * @memberof UmbManagementApiInflightRequestCache\r\n\t */\r\n\tget(key: string): UmbInFlightRequestCacheEntryModel<ResponseModelType> | undefined {\r\n\t\treturn this.#entries.get(key);\r\n\t}\r\n\r\n\t/**\r\n\t * Deletes an entry from the cache\r\n\t * @param {string} key - The ID of the entry to delete\r\n\t * @memberof UmbManagementApiInflightRequestCache\r\n\t */\r\n\tdelete(key: string): void {\r\n\t\tthis.#entries.delete(key);\r\n\t}\r\n\r\n\t/**\r\n\t * Clears all entries from the cache\r\n\t * @memberof UmbManagementApiInflightRequestCache\r\n\t */\r\n\tclear(): void {\r\n\t\tthis.#entries.clear();\r\n\t}\r\n}\r\n"],"names":["UmbManagementApiDetailDataCacheInvalidationManager","UmbControllerBase","#eventSources","#eventTypes","#serverEventContext","host","args","UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT","context","#observeServerEvents","event","UmbManagementApiDetailDataCache","#entries","id","data","cacheEntry","entry","UmbManagementApiDetailDataRequestManager","#dataCache","#inflightRequestCache","#create","#read","#update","#delete","#isConnectedToServerEvents","createdId","error","tryExecute","inflightCacheKey","request","serverData","serverError","isConnected","UmbManagementApiItemDataRequestManager","#getItems","#observeServerEventsConnection","ids","idsToRequest","cacheItems","serverItems","x","getItemsController","UmbItemDataApiGetRequestController","item","UmbManagementApiItemDataCacheInvalidationManager","UmbManagementApiItemDataCache","UmbManagementApiInFlightRequestCache","key","promise"],"mappings":"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"}