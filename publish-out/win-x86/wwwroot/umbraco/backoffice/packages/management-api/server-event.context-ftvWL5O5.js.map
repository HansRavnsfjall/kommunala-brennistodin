{"version":3,"file":"server-event.context-ftvWL5O5.js","sources":["../../../src/packages/management-api/server-event/global-context/server-event.context.ts"],"sourcesContent":["import { UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT } from './server-event.context-token.js';\r\nimport type { UmbManagementApiServerEventModel } from './types.js';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { HubConnectionBuilder, type HubConnection } from '@umbraco-cms/backoffice/external/signalr';\r\nimport { UMB_SERVER_CONTEXT } from '@umbraco-cms/backoffice/server';\r\nimport type { Observable } from '@umbraco-cms/backoffice/external/rxjs';\r\nimport { filter, Subject } from '@umbraco-cms/backoffice/external/rxjs';\r\nimport { UmbBooleanState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\nexport class UmbManagementApiServerEventContext extends UmbContextBase {\r\n\t#connection?: HubConnection;\r\n\t#authContext?: typeof UMB_AUTH_CONTEXT.TYPE;\r\n\t#serverContext?: typeof UMB_SERVER_CONTEXT.TYPE;\r\n\r\n\t#events = new Subject<UmbManagementApiServerEventModel>();\r\n\tpublic readonly events = this.#events.asObservable();\r\n\r\n\t#isConnected = new UmbBooleanState(undefined);\r\n\tpublic readonly isConnected = this.#isConnected.asObservable();\r\n\r\n\t/**\r\n\t * Filters events by the given event types\r\n\t * @param {string} eventTypes - The event types to filter by\r\n\t * @returns {Observable<UmbManagementApiServerEventModel>} - The filtered events\r\n\t * @memberof UmbManagementApiServerEventContext\r\n\t */\r\n\tbyEventSource(eventTypes: string): Observable<UmbManagementApiServerEventModel> {\r\n\t\treturn this.#events.asObservable().pipe(filter((event) => event.eventType === eventTypes));\r\n\t}\r\n\r\n\t/**\r\n\t * Filters events by the given event sources and event types\r\n\t * @param {Array<string>} eventSources - The event sources to filter by\r\n\t * @param {Array<string>} eventTypes - The event types to filter by\r\n\t * @returns {Observable<UmbManagementApiServerEventModel>} - The filtered events\r\n\t * @memberof UmbManagementApiServerEventContext\r\n\t */\r\n\tbyEventSourcesAndEventTypes(\r\n\t\teventSources: Array<string>,\r\n\t\teventTypes: Array<string>,\r\n\t): Observable<UmbManagementApiServerEventModel> {\r\n\t\treturn this.#events\r\n\t\t\t.asObservable()\r\n\t\t\t.pipe(filter((event) => eventSources.includes(event.eventSource) && eventTypes.includes(event.eventType)));\r\n\t}\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT);\r\n\r\n\t\tthis.consumeContext(UMB_AUTH_CONTEXT, (context) => {\r\n\t\t\tthis.#authContext = context;\r\n\t\t\tthis.#observeIsAuthorized();\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_SERVER_CONTEXT, (context) => {\r\n\t\t\tthis.#serverContext = context;\r\n\t\t});\r\n\t}\r\n\r\n\t#observeIsAuthorized() {\r\n\t\tthis.observe(this.#authContext?.isAuthorized, async (isAuthorized) => {\r\n\t\t\tif (isAuthorized === undefined) return;\r\n\r\n\t\t\tif (isAuthorized) {\r\n\t\t\t\tconst token = await this.#authContext?.getLatestToken();\r\n\t\t\t\tif (token) {\r\n\t\t\t\t\tthis.#initHubConnection(token);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error('No auth token found');\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.#isConnected.setValue(false);\r\n\t\t\t\tthis.#connection?.stop();\r\n\t\t\t\tthis.#connection = undefined;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t#initHubConnection(token: string) {\r\n\t\tconst serverURL = this.#serverContext?.getServerUrl();\r\n\r\n\t\tif (!serverURL) {\r\n\t\t\tthrow new Error('Server URL is not defined in the server context');\r\n\t\t}\r\n\r\n\t\t// TODO: get the url from a server config?\r\n\t\tconst serverEventHubUrl = `${serverURL}/umbraco/serverEventHub`;\r\n\r\n\t\tthis.#connection = new HubConnectionBuilder()\r\n\t\t\t.withUrl(serverEventHubUrl, {\r\n\t\t\t\taccessTokenFactory: () => token,\r\n\t\t\t})\r\n\t\t\t.build();\r\n\r\n\t\tthis.#connection.on('notify', (payload) => {\r\n\t\t\tconst event: UmbManagementApiServerEventModel = {\r\n\t\t\t\t...payload,\r\n\t\t\t\tclientTimestamp: new Date().toISOString(),\r\n\t\t\t};\r\n\r\n\t\t\tthis.#events.next(event);\r\n\t\t});\r\n\r\n\t\tthis.#connection\r\n\t\t\t.start()\r\n\t\t\t.then(() => this.#isConnected.setValue(true))\r\n\t\t\t.catch(() => this.#isConnected.setValue(false));\r\n\r\n\t\tthis.#connection.onclose(() => this.#isConnected.setValue(false));\r\n\t}\r\n}\r\n\r\nexport { UmbManagementApiServerEventContext as api };\r\n"],"names":["UmbManagementApiServerEventContext","UmbContextBase","host","UMB_MANAGEMENT_API_SERVER_EVENT_CONTEXT","#events","Subject","#isConnected","UmbBooleanState","UMB_AUTH_CONTEXT","context","#authContext","#observeIsAuthorized","UMB_SERVER_CONTEXT","#serverContext","#connection","eventTypes","filter","event","eventSources","isAuthorized","token","#initHubConnection","serverURL","serverEventHubUrl","HubConnectionBuilder","payload"],"mappings":";;;;;;;AAWO,MAAMA,UAA2CC,EAAe;AAAA,EAqCtE,YAAYC,GAAyB;AACpC,UAAMA,GAAMC,CAAuC,GAjCpD,KAAAC,KAAU,IAAIC,EAAA,GACd,KAAgB,SAAS,KAAKD,GAAQ,aAAA,GAEtC,KAAAE,KAAe,IAAIC,EAAgB,MAAS,GAC5C,KAAgB,cAAc,KAAKD,GAAa,aAAA,GA+B/C,KAAK,eAAeE,GAAkB,CAACC,MAAY;AAClD,WAAKC,KAAeD,GACpB,KAAKE,GAAA;AAAA,IACN,CAAC,GAED,KAAK,eAAeC,GAAoB,CAACH,MAAY;AACpD,WAAKI,KAAiBJ;AAAA,IACvB,CAAC;AAAA,EACF;AAAA,EA/CAK;AAAA,EACAJ;AAAA,EACAG;AAAA,EAEAT;AAAA,EAGAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,cAAcS,GAAkE;AAC/E,WAAO,KAAKX,GAAQ,aAAA,EAAe,KAAKY,EAAO,CAACC,MAAUA,EAAM,cAAcF,CAAU,CAAC;AAAA,EAC1F;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,4BACCG,GACAH,GAC+C;AAC/C,WAAO,KAAKX,GACV,aAAA,EACA,KAAKY,EAAO,CAACC,MAAUC,EAAa,SAASD,EAAM,WAAW,KAAKF,EAAW,SAASE,EAAM,SAAS,CAAC,CAAC;AAAA,EAC3G;AAAA,EAeAN,KAAuB;AACtB,SAAK,QAAQ,KAAKD,IAAc,cAAc,OAAOS,MAAiB;AACrE,UAAIA,MAAiB;AAErB,YAAIA,GAAc;AACjB,gBAAMC,IAAQ,MAAM,KAAKV,IAAc,eAAA;AACvC,cAAIU;AACH,iBAAKC,GAAmBD,CAAK;AAAA;AAE7B,kBAAM,IAAI,MAAM,qBAAqB;AAAA,QAEvC;AACC,eAAKd,GAAa,SAAS,EAAK,GAChC,KAAKQ,IAAa,KAAA,GAClB,KAAKA,KAAc;AAAA,IAErB,CAAC;AAAA,EACF;AAAA,EAEAO,GAAmBD,GAAe;AACjC,UAAME,IAAY,KAAKT,IAAgB,aAAA;AAEvC,QAAI,CAACS;AACJ,YAAM,IAAI,MAAM,iDAAiD;AAIlE,UAAMC,IAAoB,GAAGD,CAAS;AAEtC,SAAKR,KAAc,IAAIU,EAAA,EACrB,QAAQD,GAAmB;AAAA,MAC3B,oBAAoB,MAAMH;AAAA,IAAA,CAC1B,EACA,MAAA,GAEF,KAAKN,GAAY,GAAG,UAAU,CAACW,MAAY;AAC1C,YAAMR,IAA0C;AAAA,QAC/C,GAAGQ;AAAA,QACH,kBAAiB,oBAAI,KAAA,GAAO,YAAA;AAAA,MAAY;AAGzC,WAAKrB,GAAQ,KAAKa,CAAK;AAAA,IACxB,CAAC,GAED,KAAKH,GACH,MAAA,EACA,KAAK,MAAM,KAAKR,GAAa,SAAS,EAAI,CAAC,EAC3C,MAAM,MAAM,KAAKA,GAAa,SAAS,EAAK,CAAC,GAE/C,KAAKQ,GAAY,QAAQ,MAAM,KAAKR,GAAa,SAAS,EAAK,CAAC;AAAA,EACjE;AACD;"}