{"version":3,"file":"entry-point-DH0FlQVv.js","sources":["../../../src/packages/media/media/repository/item/media-item.server.cache-invalidation.manager.ts","../../../src/packages/media/media/entry-point.ts"],"sourcesContent":["import { mediaItemCache } from './media-item.server.cache.js';\r\nimport {\r\n\tUmbManagementApiItemDataCacheInvalidationManager,\r\n\ttype UmbManagementApiServerEventModel,\r\n} from '@umbraco-cms/backoffice/management-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { MediaItemResponseModel } from '@umbraco-cms/backoffice/external/backend-api';\r\n\r\nexport class UmbManagementApiMediaItemDataCacheInvalidationManager extends UmbManagementApiItemDataCacheInvalidationManager<MediaItemResponseModel> {\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, {\r\n\t\t\tdataCache: mediaItemCache,\r\n\t\t\t/* The Media item model includes info about the Media Type.\r\n\t\t\tWe need to invalidate the cache for both Media and MediaType events. */\r\n\t\t\teventSources: ['Umbraco:CMS:Media', 'Umbraco:CMS:MediaType'],\r\n\t\t\teventTypes: ['Updated', 'Deleted', 'Trashed'],\r\n\t\t});\r\n\t}\r\n\r\n\tprotected override _onServerEvent(event: UmbManagementApiServerEventModel) {\r\n\t\tif (event.eventSource === 'Umbraco:CMS:MediaType') {\r\n\t\t\tthis.#onMediaTypeChange(event);\r\n\t\t} else {\r\n\t\t\tthis.#onMediaChange(event);\r\n\t\t}\r\n\t}\r\n\r\n\t#onMediaChange(event: UmbManagementApiServerEventModel) {\r\n\t\t// Invalidate the specific media item\r\n\t\tconst mediaId = event.key;\r\n\t\tthis._dataCache.delete(mediaId);\r\n\t}\r\n\r\n\t#onMediaTypeChange(event: UmbManagementApiServerEventModel) {\r\n\t\t// Invalidate all media items of the specified Media Type\r\n\t\tconst mediaTypeId = event.key;\r\n\t\tconst mediaIds = this._dataCache\r\n\t\t\t.getAll()\r\n\t\t\t.filter((cachedItem) => cachedItem.mediaType.id === mediaTypeId)\r\n\t\t\t.map((item) => item.id);\r\n\r\n\t\tmediaIds.forEach((id) => this._dataCache.delete(id));\r\n\t}\r\n}\r\n","import { UmbManagementApiMediaItemDataCacheInvalidationManager } from './repository/item/media-item.server.cache-invalidation.manager.js';\r\nimport type { UmbEntryPointOnInit, UmbEntryPointOnUnload } from '@umbraco-cms/backoffice/extension-api';\r\n\r\nlet itemDataCacheInvalidationManager: UmbManagementApiMediaItemDataCacheInvalidationManager | undefined;\r\n\r\nexport const onInit: UmbEntryPointOnInit = (host) => {\r\n\titemDataCacheInvalidationManager = new UmbManagementApiMediaItemDataCacheInvalidationManager(host);\r\n};\r\n\r\nexport const onUnload: UmbEntryPointOnUnload = () => {\r\n\titemDataCacheInvalidationManager?.destroy();\r\n};\r\n"],"names":["UmbManagementApiMediaItemDataCacheInvalidationManager","UmbManagementApiItemDataCacheInvalidationManager","host","mediaItemCache","event","#onMediaTypeChange","#onMediaChange","mediaId","mediaTypeId","cachedItem","item","id","itemDataCacheInvalidationManager","onInit","onUnload"],"mappings":";;AAQO,MAAMA,UAA8DC,EAAyE;AAAA,EACnJ,YAAYC,GAAyB;AACpC,UAAMA,GAAM;AAAA,MACX,WAAWC;AAAA;AAAA;AAAA,MAGX,cAAc,CAAC,qBAAqB,uBAAuB;AAAA,MAC3D,YAAY,CAAC,WAAW,WAAW,SAAS;AAAA,IAAA,CAC5C;AAAA,EACF;AAAA,EAEmB,eAAeC,GAAyC;AAC1E,IAAIA,EAAM,gBAAgB,0BACzB,KAAKC,GAAmBD,CAAK,IAE7B,KAAKE,GAAeF,CAAK;AAAA,EAE3B;AAAA,EAEAE,GAAeF,GAAyC;AAEvD,UAAMG,IAAUH,EAAM;AACtB,SAAK,WAAW,OAAOG,CAAO;AAAA,EAC/B;AAAA,EAEAF,GAAmBD,GAAyC;AAE3D,UAAMI,IAAcJ,EAAM;AAM1B,IALiB,KAAK,WACpB,OAAA,EACA,OAAO,CAACK,MAAeA,EAAW,UAAU,OAAOD,CAAW,EAC9D,IAAI,CAACE,MAASA,EAAK,EAAE,EAEd,QAAQ,CAACC,MAAO,KAAK,WAAW,OAAOA,CAAE,CAAC;AAAA,EACpD;AACD;ACxCA,IAAIC;AAEG,MAAMC,IAA8B,CAACX,MAAS;AACpD,EAAAU,IAAmC,IAAIZ,EAAsDE,CAAI;AAClG,GAEaY,IAAkC,MAAM;AACpD,EAAAF,GAAkC,QAAA;AACnC;"}