{"version":3,"file":"imaging.repository-oDvp8QYt.js","sources":["../../../src/packages/media/imaging/imaging.server.data.ts","../../../src/packages/media/imaging/imaging.repository.ts"],"sourcesContent":["import type { UmbImagingResizeModel } from './types.js';\r\nimport { ImagingService, type MediaUrlInfoResponseModel } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport type { UmbMediaUrlModel } from '@umbraco-cms/backoffice/media';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { tryExecute } from '@umbraco-cms/backoffice/resources';\r\n\r\n/**\r\n * A data source for the Imaging Service that resizes a media item from the server\r\n * @class UmbImagingServerDataSource\r\n * @implements {RepositoryDetailDataSource}\r\n */\r\nexport class UmbImagingServerDataSource {\r\n\t#host: UmbControllerHost;\r\n\r\n\t/**\r\n\t * Creates an instance of UmbImagingServerDataSource.\r\n\t * @param {UmbControllerHost} host - The controller host for this controller to be appended to\r\n\t * @memberof UmbImagingServerDataSource\r\n\t */\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tthis.#host = host;\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches the URL for the given media items as resized images\r\n\t * @param {string} unique\r\n\t * @param uniques\r\n\t * @param imagingModel\r\n\t * @memberof UmbImagingServerDataSource\r\n\t */\r\n\tasync getItems(uniques: Array<string>, imagingModel?: UmbImagingResizeModel) {\r\n\t\tif (!uniques.length) throw new Error('Uniques are missing');\r\n\r\n\t\tconst { data, error } = await tryExecute(\r\n\t\t\tthis.#host,\r\n\t\t\tImagingService.getImagingResizeUrls({ query: { id: uniques, ...imagingModel } }),\r\n\t\t);\r\n\r\n\t\tif (data) {\r\n\t\t\tconst items = data.map((item) => this.#mapper(item));\r\n\t\t\treturn { data: items };\r\n\t\t}\r\n\r\n\t\treturn { error };\r\n\t}\r\n\r\n\t#mapper(item: MediaUrlInfoResponseModel): UmbMediaUrlModel {\r\n\t\tconst url = item.urlInfos[0]?.url;\r\n\t\treturn {\r\n\t\t\tunique: item.id,\r\n\t\t\turl: url,\r\n\t\t};\r\n\t}\r\n}\r\n","import { UmbImagingCropMode, type UmbImagingResizeModel } from './types.js';\r\nimport { UmbImagingServerDataSource } from './imaging.server.data.js';\r\nimport { UMB_IMAGING_STORE_CONTEXT } from './imaging.store.token.js';\r\nimport { UmbRepositoryBase } from '@umbraco-cms/backoffice/repository';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbApi } from '@umbraco-cms/backoffice/extension-api';\r\nimport type { UmbMediaUrlModel } from '@umbraco-cms/backoffice/media';\r\n\r\n/**\r\n * Repository for managing imaging-related data.\r\n * You can use it to request (cached) thumbnail URLs or new resized images.\r\n */\r\nexport class UmbImagingRepository extends UmbRepositoryBase implements UmbApi {\r\n\t#init;\r\n\t#itemSource = new UmbImagingServerDataSource(this);\r\n\t#dataStore?: typeof UMB_IMAGING_STORE_CONTEXT.TYPE;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\r\n\t\tthis.#init = this.consumeContext(UMB_IMAGING_STORE_CONTEXT, (instance) => {\r\n\t\t\tif (instance) {\r\n\t\t\t\tthis.#dataStore = instance;\r\n\t\t\t}\r\n\t\t}).asPromise({ preventTimeout: true });\r\n\t}\r\n\r\n\t/**\r\n\t * Requests the items for the given uniques\r\n\t * @param {Array<string>} uniques - The uniques\r\n\t * @param {UmbImagingResizeModel} imagingModel - The imaging model\r\n\t * @returns {Promise<{ data: UmbMediaUrlModel[] }>} - The resized absolute media URLs\r\n\t * @memberof UmbImagingRepository\r\n\t */\r\n\tasync requestResizedItems(\r\n\t\tuniques: Array<string>,\r\n\t\timagingModel?: UmbImagingResizeModel,\r\n\t): Promise<{ data: UmbMediaUrlModel[] }> {\r\n\t\tif (!uniques.length) throw new Error('Uniques are missing');\r\n\r\n\t\tawait this.#init;\r\n\r\n\t\tif (!this.#dataStore) {\r\n\t\t\tconsole.warn('[UmbImagingRepository] No data store available. All thumbnails are uncached.');\r\n\t\t}\r\n\r\n\t\tconst urls = new Map<string, string>();\r\n\r\n\t\tfor (const unique of uniques) {\r\n\t\t\tconst existingCrop = this.#dataStore?.getCrop(unique, imagingModel);\r\n\t\t\tif (existingCrop !== undefined) {\r\n\t\t\t\turls.set(unique, existingCrop);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tconst { data: urlModels, error } = await this.#itemSource.getItems([unique], imagingModel);\r\n\r\n\t\t\tif (error) {\r\n\t\t\t\tconsole.error('[UmbImagingRepository] Error fetching items', error);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tconst url = urlModels?.[0]?.url;\r\n\r\n\t\t\tthis.#dataStore?.addCrop(unique, url ?? '', imagingModel);\r\n\r\n\t\t\tif (url) {\r\n\t\t\t\turls.set(unique, url);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn { data: Array.from(urls).map(([unique, url]) => ({ unique, url })) };\r\n\t}\r\n\r\n\t/**\r\n\t * Internal method to clear the cache for a specific image.\r\n\t * @param {string} unique The unique identifier for the media item\r\n\t * @internal\r\n\t */\r\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\r\n\tasync _internal_clearCropByUnique(unique: string) {\r\n\t\tawait this.#init;\r\n\t\tthis.#dataStore?.clearCropByUnique(unique);\r\n\t}\r\n\r\n\t/**\r\n\t * Requests the thumbnail URLs for the given uniques\r\n\t * @param {Array<string>} uniques - The unique identifiers for the media items\r\n\t * @param {number} height - The desired height in pixels of the thumbnail\r\n\t * @param {number} width - The desired width in pixels of the thumbnail\r\n\t * @param {UmbImagingCropMode} mode - The crop mode\r\n\t * @returns {Promise<{ data: UmbMediaUrlModel[] }>} - The resized absolute media URLs\r\n\t * @memberof UmbImagingRepository\r\n\t * @deprecated Use {@link UmbImagingRepository#requestResizedItems} instead for more flexibility and control over the imaging model. This will be removed in Umbraco 18.\r\n\t */\r\n\tasync requestThumbnailUrls(\r\n\t\tuniques: Array<string>,\r\n\t\theight: number,\r\n\t\twidth: number,\r\n\t\tmode: UmbImagingCropMode = UmbImagingCropMode.MIN,\r\n\t): Promise<{ data: UmbMediaUrlModel[] }> {\r\n\t\tconst imagingModel: UmbImagingResizeModel = { height, width, mode };\r\n\t\treturn this.requestResizedItems(uniques, imagingModel);\r\n\t}\r\n}\r\n\r\nexport { UmbImagingRepository as api };\r\n"],"names":["UmbImagingServerDataSource","#host","host","uniques","imagingModel","data","error","tryExecute","ImagingService","item","#mapper","url","UmbImagingRepository","UmbRepositoryBase","#init","#itemSource","#dataStore","UMB_IMAGING_STORE_CONTEXT","instance","urls","unique","existingCrop","urlModels","height","width","mode","UmbImagingCropMode"],"mappings":";;;;AAWO,MAAMA,EAA2B;AAAA,EACvCC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,YAAYC,GAAyB;AACpC,SAAKD,KAAQC;AAAA,EACd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,MAAM,SAASC,GAAwBC,GAAsC;AAC5E,QAAI,CAACD,EAAQ,OAAQ,OAAM,IAAI,MAAM,qBAAqB;AAE1D,UAAM,EAAE,MAAAE,GAAM,OAAAC,EAAA,IAAU,MAAMC;AAAA,MAC7B,KAAKN;AAAA,MACLO,EAAe,qBAAqB,EAAE,OAAO,EAAE,IAAIL,GAAS,GAAGC,IAAa,CAAG;AAAA,IAAA;AAGhF,WAAIC,IAEI,EAAE,MADKA,EAAK,IAAI,CAACI,MAAS,KAAKC,GAAQD,CAAI,CAAC,EACpC,IAGT,EAAE,OAAAH,EAAA;AAAA,EACV;AAAA,EAEAI,GAAQD,GAAmD;AAC1D,UAAME,IAAMF,EAAK,SAAS,CAAC,GAAG;AAC9B,WAAO;AAAA,MACN,QAAQA,EAAK;AAAA,MACb,KAAAE;AAAA,IAAA;AAAA,EAEF;AACD;ACzCO,MAAMC,UAA6BC,EAAoC;AAAA,EAC7EC;AAAA,EACAC,KAAc,IAAIf,EAA2B,IAAI;AAAA,EACjDgB;AAAA,EAEA,YAAYd,GAAyB;AACpC,UAAMA,CAAI,GAEV,KAAKY,KAAQ,KAAK,eAAeG,GAA2B,CAACC,MAAa;AACzE,MAAIA,MACH,KAAKF,KAAaE;AAAA,IAEpB,CAAC,EAAE,UAAU,EAAE,gBAAgB,IAAM;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,MAAM,oBACLf,GACAC,GACwC;AACxC,QAAI,CAACD,EAAQ,OAAQ,OAAM,IAAI,MAAM,qBAAqB;AAE1D,UAAM,KAAKW,IAEN,KAAKE,MACT,QAAQ,KAAK,8EAA8E;AAG5F,UAAMG,wBAAW,IAAA;AAEjB,eAAWC,KAAUjB,GAAS;AAC7B,YAAMkB,IAAe,KAAKL,IAAY,QAAQI,GAAQhB,CAAY;AAClE,UAAIiB,MAAiB,QAAW;AAC/B,QAAAF,EAAK,IAAIC,GAAQC,CAAY;AAC7B;AAAA,MACD;AAEA,YAAM,EAAE,MAAMC,GAAW,OAAAhB,MAAU,MAAM,KAAKS,GAAY,SAAS,CAACK,CAAM,GAAGhB,CAAY;AAEzF,UAAIE,GAAO;AACV,gBAAQ,MAAM,+CAA+CA,CAAK;AAClE;AAAA,MACD;AAEA,YAAMK,IAAMW,IAAY,CAAC,GAAG;AAE5B,WAAKN,IAAY,QAAQI,GAAQT,KAAO,IAAIP,CAAY,GAEpDO,KACHQ,EAAK,IAAIC,GAAQT,CAAG;AAAA,IAEtB;AAEA,WAAO,EAAE,MAAM,MAAM,KAAKQ,CAAI,EAAE,IAAI,CAAC,CAACC,GAAQT,CAAG,OAAO,EAAE,QAAAS,GAAQ,KAAAT,EAAA,EAAM,EAAA;AAAA,EACzE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAM,4BAA4BS,GAAgB;AACjD,UAAM,KAAKN,IACX,KAAKE,IAAY,kBAAkBI,CAAM;AAAA,EAC1C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYA,MAAM,qBACLjB,GACAoB,GACAC,GACAC,IAA2BC,EAAmB,KACN;AACxC,UAAMtB,IAAsC,EAAE,QAAAmB,GAAQ,OAAAC,GAAO,MAAAC,EAAA;AAC7D,WAAO,KAAK,oBAAoBtB,GAASC,CAAY;AAAA,EACtD;AACD;"}