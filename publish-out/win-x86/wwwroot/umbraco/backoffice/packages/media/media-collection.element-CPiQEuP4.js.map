{"version":3,"file":"media-collection.element-CPiQEuP4.js","sources":["../../../src/packages/media/media/collection/media-collection.element.ts"],"sourcesContent":["import { UMB_MEDIA_ENTITY_TYPE, UMB_MEDIA_ROOT_ENTITY_TYPE } from '../entity.js';\r\nimport { UMB_MEDIA_WORKSPACE_CONTEXT } from '../workspace/media-workspace.context-token.js';\r\nimport type { UmbDropzoneMediaElement } from '../dropzone/index.js';\r\nimport { UMB_MEDIA_COLLECTION_CONTEXT } from './media-collection.context-token.js';\r\nimport { customElement, html, ref, state, when } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbCollectionDefaultElement } from '@umbraco-cms/backoffice/collection';\r\nimport { UmbRequestReloadChildrenOfEntityEvent } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport type { UmbDropzoneSubmittedEvent } from '@umbraco-cms/backoffice/dropzone';\r\n\r\n@customElement('umb-media-collection')\r\nexport class UmbMediaCollectionElement extends UmbCollectionDefaultElement {\r\n\t#collectionContext?: typeof UMB_MEDIA_COLLECTION_CONTEXT.TYPE;\r\n\r\n\t@state()\r\n\tprivate _progress = -1;\r\n\r\n\t@state()\r\n\tprivate _unique: string | null = null;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(UMB_MEDIA_COLLECTION_CONTEXT, (context) => {\r\n\t\t\t// TODO: stop consuming the context both in the default element and here. Instead make the default able to inform when the context is consumed. Or come up with a better system for the controllers to talk together. [NL]\r\n\t\t\tthis.#collectionContext = context;\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_MEDIA_WORKSPACE_CONTEXT, (instance) => {\r\n\t\t\tthis.observe(instance?.unique, (unique) => {\r\n\t\t\t\tthis._unique = unique ?? null;\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t#observeProgressItems(dropzone?: Element) {\r\n\t\tif (!dropzone) return;\r\n\t\tthis.observe(\r\n\t\t\t(dropzone as UmbDropzoneMediaElement).progressItems(),\r\n\t\t\t(progressItems) => {\r\n\t\t\t\tprogressItems.forEach((item) => {\r\n\t\t\t\t\t// We do not update folders as it may have children still being uploaded.\r\n\t\t\t\t\tif (item.folder?.name) return;\r\n\r\n\t\t\t\t\tthis.#collectionContext?.updatePlaceholderStatus(item.unique, item.status);\r\n\t\t\t\t\tthis.#collectionContext?.updatePlaceholderProgress(item.unique, item.progress);\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\t'_observeProgressItems',\r\n\t\t);\r\n\t}\r\n\r\n\tasync #setupPlaceholders(event: UmbDropzoneSubmittedEvent) {\r\n\t\tevent.preventDefault();\r\n\t\tconst placeholders = event.items\r\n\t\t\t.filter((p) => p.parentUnique === this._unique)\r\n\t\t\t.map((p) => ({ unique: p.unique, status: p.status, name: p.temporaryFile?.file.name ?? p.folder?.name }));\r\n\r\n\t\tthis.#collectionContext?.setPlaceholders(placeholders);\r\n\t}\r\n\r\n\tasync #onComplete(event: Event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis._progress = -1;\r\n\t\tthis.#collectionContext?.requestCollection();\r\n\r\n\t\tconst eventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\tif (!eventContext) {\r\n\t\t\tthrow new Error('Could not get event context');\r\n\t\t}\r\n\t\tconst reloadEvent = new UmbRequestReloadChildrenOfEntityEvent({\r\n\t\t\tentityType: this._unique ? UMB_MEDIA_ENTITY_TYPE : UMB_MEDIA_ROOT_ENTITY_TYPE,\r\n\t\t\tunique: this._unique,\r\n\t\t});\r\n\t\teventContext.dispatchEvent(reloadEvent);\r\n\t}\r\n\r\n\t#onProgress(event: ProgressEvent) {\r\n\t\tevent.preventDefault();\r\n\t\tthis._progress = (event.loaded / event.total) * 100;\r\n\t\tif (this._progress >= 100) {\r\n\t\t\tthis._progress = -1;\r\n\t\t}\r\n\t}\r\n\r\n\tprotected override renderToolbar() {\r\n\t\treturn html`\r\n\t\t\t<umb-collection-toolbar slot=\"header\">\r\n\t\t\t\t<umb-collection-filter-field></umb-collection-filter-field>\r\n\t\t\t</umb-collection-toolbar>\r\n\t\t\t${when(this._progress >= 0, () => html`<uui-loader-bar progress=${this._progress}></uui-loader-bar>`)}\r\n\t\t\t<umb-dropzone-media\r\n\t\t\t\tid=\"dropzone\"\r\n\t\t\t\t${ref(this.#observeProgressItems)}\r\n\t\t\t\tmultiple\r\n\t\t\t\t.parentUnique=${this._unique}\r\n\t\t\t\t@submitted=${this.#setupPlaceholders}\r\n\t\t\t\t@complete=${this.#onComplete}\r\n\t\t\t\t@progress=${this.#onProgress}></umb-dropzone-media>\r\n\t\t`;\r\n\t}\r\n}\r\n\r\n/** @deprecated Should be exported as `element` only; to be removed in Umbraco 17. */\r\nexport default UmbMediaCollectionElement;\r\n\r\nexport { UmbMediaCollectionElement as element };\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-media-collection': UmbMediaCollectionElement;\r\n\t}\r\n}\r\n"],"names":["_collectionContext","_UmbMediaCollectionElement_instances","observeProgressItems_fn","setupPlaceholders_fn","onComplete_fn","onProgress_fn","UmbMediaCollectionElement","UmbCollectionDefaultElement","__privateAdd","UMB_MEDIA_COLLECTION_CONTEXT","context","__privateSet","UMB_MEDIA_WORKSPACE_CONTEXT","instance","unique","html","when","ref","__privateMethod","dropzone","progressItems","item","__privateGet","event","placeholders","p","eventContext","UMB_ACTION_EVENT_CONTEXT","reloadEvent","UmbRequestReloadChildrenOfEntityEvent","UMB_MEDIA_ENTITY_TYPE","UMB_MEDIA_ROOT_ENTITY_TYPE","__decorateClass","state","customElement","UmbMediaCollectionElement$1"],"mappings":";;;;;;;;;;;wXAAAA,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC;AAWO,IAAMC,IAAN,cAAwCC,EAA4B;AAAA,EAS1E,cAAc;AACb,UAAA,GAVKC,EAAA,MAAAP,CAAA,GACNO,EAAA,MAAAR,CAAA,GAGA,KAAQ,YAAY,IAGpB,KAAQ,UAAyB,MAKhC,KAAK,eAAeS,GAA8B,CAACC,MAAY;AAE9D,MAAAC,EAAA,MAAKX,GAAqBU,CAAA;AAAA,IAC3B,CAAC,GAED,KAAK,eAAeE,GAA6B,CAACC,MAAa;AAC9D,WAAK,QAAQA,GAAU,QAAQ,CAACC,MAAW;AAC1C,aAAK,UAAUA,KAAU;AAAA,MAC1B,CAAC;AAAA,IACF,CAAC;AAAA,EACF;AAAA,EAoDmB,gBAAgB;AAClC,WAAOC;AAAA;AAAA;AAAA;AAAA,KAIJC,EAAK,KAAK,aAAa,GAAG,MAAMD,6BAAgC,KAAK,SAAS,oBAAoB,CAAC;AAAA;AAAA;AAAA,MAGlGE,EAAIC,EAAA,MAAKjB,GAAAC,CAAA,CAAqB,CAAC;AAAA;AAAA,oBAEjB,KAAK,OAAO;AAAA,iBACfgB,QAAKjB,GAAAE,CAAA,CAAkB;AAAA,gBACxBe,QAAKjB,GAAAG,CAAA,CAAW;AAAA,gBAChBc,QAAKjB,GAAAI,CAAA,CAAW;AAAA;AAAA,EAE/B;AACD;AAzFCL,IAAA,oBAAA,QAAA;AADMC,IAAA,oBAAA,QAAA;AAwBNC,IAAqB,SAACiB,GAAoB;AACzC,EAAKA,KACL,KAAK;AAAA,IACHA,EAAqC,cAAA;AAAA,IACtC,CAACC,MAAkB;AAClB,MAAAA,EAAc,QAAQ,CAACC,MAAS;AAE/B,QAAIA,EAAK,QAAQ,SAEjBC,EAAA,MAAKtB,CAAA,GAAoB,wBAAwBqB,EAAK,QAAQA,EAAK,MAAM,GACzEC,EAAA,MAAKtB,CAAA,GAAoB,0BAA0BqB,EAAK,QAAQA,EAAK,QAAQ;AAAA,MAC9E,CAAC;AAAA,IACF;AAAA,IACA;AAAA,EAAA;AAEF;AAEMlB,IAAkB,eAACoB,GAAkC;AAC1D,EAAAA,EAAM,eAAA;AACN,QAAMC,IAAeD,EAAM,MACzB,OAAO,CAACE,MAAMA,EAAE,iBAAiB,KAAK,OAAO,EAC7C,IAAI,CAACA,OAAO,EAAE,QAAQA,EAAE,QAAQ,QAAQA,EAAE,QAAQ,MAAMA,EAAE,eAAe,KAAK,QAAQA,EAAE,QAAQ,OAAO;AAEzG,EAAAH,EAAA,MAAKtB,CAAA,GAAoB,gBAAgBwB,CAAY;AACtD;AAEMpB,IAAW,eAACmB,GAAc;AAC/B,EAAAA,EAAM,eAAA,GACN,KAAK,YAAY,IACjBD,EAAA,MAAKtB,IAAoB,kBAAA;AAEzB,QAAM0B,IAAe,MAAM,KAAK,WAAWC,CAAwB;AACnE,MAAI,CAACD;AACJ,UAAM,IAAI,MAAM,6BAA6B;AAE9C,QAAME,IAAc,IAAIC,EAAsC;AAAA,IAC7D,YAAY,KAAK,UAAUC,IAAwBC;AAAA,IACnD,QAAQ,KAAK;AAAA,EAAA,CACb;AACD,EAAAL,EAAa,cAAcE,CAAW;AACvC;AAEAvB,IAAW,SAACkB,GAAsB;AACjC,EAAAA,EAAM,eAAA,GACN,KAAK,YAAaA,EAAM,SAASA,EAAM,QAAS,KAC5C,KAAK,aAAa,QACrB,KAAK,YAAY;AAEnB;AApEQS,EAAA;AAAA,EADPC,EAAA;AAAM,GAHK3B,EAIJ,WAAA,aAAA,CAAA;AAGA0B,EAAA;AAAA,EADPC,EAAA;AAAM,GANK3B,EAOJ,WAAA,WAAA,CAAA;AAPIA,IAAN0B,EAAA;AAAA,EADNE,EAAc,sBAAsB;AAAA,GACxB5B,CAAA;AA6Fb,MAAA6B,IAAe7B;"}