{"version":3,"file":"package.repository-Cg-nPSQY.js","sources":["../../../src/packages/packages/package/repository/sources/package.server.data.ts","../../../src/packages/packages/package/repository/package.repository.ts"],"sourcesContent":["import { tryExecute } from '@umbraco-cms/backoffice/resources';\r\nimport { ManifestService, PackageService } from '@umbraco-cms/backoffice/external/backend-api';\r\nimport type {\r\n\tCreatePackageRequestModel,\r\n\tUpdatePackageRequestModel,\r\n} from '@umbraco-cms/backoffice/external/backend-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\n\r\n/**\r\n * Data source for packages from the server\r\n \r\n */\r\nexport class UmbPackageServerDataSource {\r\n\tconstructor(private readonly _host: UmbControllerHost) {}\r\n\r\n\tasync deleteCreatedPackage(unique: string) {\r\n\t\treturn await tryExecute(this._host, PackageService.deletePackageCreatedById({ path: { id: unique } }));\r\n\t}\r\n\r\n\tgetCreatedPackage(unique: string) {\r\n\t\treturn tryExecute(this._host, PackageService.getPackageCreatedById({ path: { id: unique } }));\r\n\t}\r\n\r\n\tgetCreatedPackages({ skip, take }: { skip: number; take: number }) {\r\n\t\treturn tryExecute(this._host, PackageService.getPackageCreated({ query: { skip, take } }));\r\n\t}\r\n\r\n\tgetCreatePackageDownload(unique: string) {\r\n\t\treturn tryExecute(this._host, PackageService.getPackageCreatedByIdDownload({ path: { id: unique } }));\r\n\t}\r\n\r\n\t/**\r\n\t * Get the root items from the server\r\n\t * @memberof UmbPackageServerDataSource\r\n\t */\r\n\tgetRootItems() {\r\n\t\treturn tryExecute(this._host, ManifestService.getManifestManifest());\r\n\t}\r\n\r\n\t/**\r\n\t * Get the package configuration from the server\r\n\t * @memberof UmbPackageServerDataSource\r\n\t */\r\n\tgetPackageConfiguration() {\r\n\t\treturn tryExecute(this._host, PackageService.getPackageConfiguration());\r\n\t}\r\n\r\n\t/**\r\n\t * Get the package migrations from the server\r\n\t * @memberof UmbPackageServerDataSource\r\n\t */\r\n\tgetPackageMigrations() {\r\n\t\treturn tryExecute(this._host, PackageService.getPackageMigrationStatus({ query: { skip: 0, take: 9999 } }));\r\n\t}\r\n\r\n\tasync saveCreatedPackage(body: CreatePackageRequestModel) {\r\n\t\treturn await tryExecute(this._host, PackageService.postPackageCreated({ body }));\r\n\t}\r\n\r\n\tasync updateCreatedPackage(id: string, body: UpdatePackageRequestModel) {\r\n\t\treturn await tryExecute(this._host, PackageService.putPackageCreatedById({ path: { id }, body }));\r\n\t}\r\n}\r\n","import type { UmbCreatedPackageDefinition, UmbCreatedPackages } from '../../types.js';\r\nimport { UMB_PACKAGE_STORE_TOKEN } from './package.store.context-token.js';\r\nimport { UmbPackageServerDataSource } from './sources/package.server.data.js';\r\nimport type { UmbPackageStore } from './package.store.js';\r\nimport { isManifestBaseType } from '@umbraco-cms/backoffice/extension-api';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbApi, ManifestBase } from '@umbraco-cms/backoffice/extension-api';\r\nimport { UMB_SERVER_CONTEXT } from '@umbraco-cms/backoffice/server';\r\n\r\n/**\r\n * A repository for Packages which mimics a tree store.\r\n \r\n */\r\nexport class UmbPackageRepository extends UmbControllerBase implements UmbApi {\r\n\t#init!: Promise<void>;\r\n\t#packageStore?: UmbPackageStore;\r\n\t#packageSource: UmbPackageServerDataSource;\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host);\r\n\t\tthis.#packageSource = new UmbPackageServerDataSource(this);\r\n\t\tthis.#init = new Promise((resolve) => {\r\n\t\t\tthis.consumeContext(UMB_PACKAGE_STORE_TOKEN, (instance) => {\r\n\t\t\t\tthis.#packageStore = instance;\r\n\t\t\t\tif (instance) {\r\n\t\t\t\t\tthis.requestConfiguration(instance);\r\n\t\t\t\t\tthis.requestRootItems(instance);\r\n\t\t\t\t\tthis.requestPackageMigrations(instance);\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tasync getCreatedPackage(unique: string | undefined): Promise<UmbCreatedPackageDefinition> {\r\n\t\tif (!unique) {\r\n\t\t\treturn this.#getEmptyCreatedPackage();\r\n\t\t}\r\n\r\n\t\tconst { data } = await this.#packageSource.getCreatedPackage(unique);\r\n\r\n\t\tif (!data) {\r\n\t\t\treturn this.#getEmptyCreatedPackage();\r\n\t\t}\r\n\r\n\t\tconst { id, ...model } = data;\r\n\t\treturn { unique: id, ...model };\r\n\t}\r\n\r\n\tasync getCreatedPackages({ skip, take }: { skip: number; take: number }): Promise<UmbCreatedPackages | undefined> {\r\n\t\tconst { data } = await this.#packageSource.getCreatedPackages({ skip, take });\r\n\t\tif (!data) return undefined;\r\n\t\treturn {\r\n\t\t\titems: data.items?.map((item) => ({ unique: item.id, name: item.name })),\r\n\t\t\ttotal: data.total,\r\n\t\t};\r\n\t}\r\n\r\n\tasync getCreatePackageDownload(unique: string): Promise<Blob | undefined> {\r\n\t\tconst { data } = await this.#packageSource.getCreatePackageDownload(unique);\r\n\t\treturn data;\r\n\t}\r\n\r\n\t#getEmptyCreatedPackage(): UmbCreatedPackageDefinition {\r\n\t\treturn {\r\n\t\t\tunique: '',\r\n\t\t\tname: '',\r\n\t\t\tpackagePath: '',\r\n\t\t\tcontentNodeId: undefined,\r\n\t\t\tcontentLoadChildNodes: false,\r\n\t\t\tmediaIds: [],\r\n\t\t\tmediaLoadChildNodes: false,\r\n\t\t\tdocumentTypes: [],\r\n\t\t\tmediaTypes: [],\r\n\t\t\tdataTypes: [],\r\n\t\t\ttemplates: [],\r\n\t\t\tpartialViews: [],\r\n\t\t\tstylesheets: [],\r\n\t\t\tscripts: [],\r\n\t\t\tlanguages: [],\r\n\t\t\tdictionaryItems: [],\r\n\t\t};\r\n\t}\r\n\r\n\tasync deleteCreatedPackage(unique: string) {\r\n\t\tconst { error } = await this.#packageSource.deleteCreatedPackage(unique);\r\n\t\treturn !error;\r\n\t}\r\n\r\n\tasync requestConfiguration(store: UmbPackageStore) {\r\n\t\tconst { data } = await this.#packageSource.getPackageConfiguration();\r\n\t\tif (data) {\r\n\t\t\tstore.setConfiguration(data);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Request the root items from the Data Source\r\n\t * @param store\r\n\t * @memberOf UmbPackageRepository\r\n\t */\r\n\tasync requestRootItems(store: UmbPackageStore) {\r\n\t\tif (store.isPackagesLoaded) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst { data: packages } = await this.#packageSource.getRootItems();\r\n\r\n\t\tif (packages) {\r\n\t\t\t// Append packages to the store but only if they have a name\r\n\t\t\tstore.appendItems(packages.filter((p) => p.name?.length));\r\n\t\t\tconst extensions: ManifestBase[] = [];\r\n\r\n\t\t\tconst serverContext = await this.getContext(UMB_SERVER_CONTEXT);\r\n\r\n\t\t\tif (!serverContext) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst serverUrl = serverContext.getServerUrl();\r\n\r\n\t\t\tpackages.forEach((p) => {\r\n\t\t\t\tp.extensions?.forEach((e) => {\r\n\t\t\t\t\t// Crudely validate that the extension at least follows a basic manifest structure\r\n\t\t\t\t\t// Idea: Use `Zod` to validate the manifest\r\n\t\t\t\t\tif (isManifestBaseType(e)) {\r\n\t\t\t\t\t\t/**\r\n\t\t\t\t\t\t * Crude check to see if extension is of type \"js\" since it is safe to assume we do not\r\n\t\t\t\t\t\t * need to load any other types of extensions in the backoffice (we need a js file to load)\r\n\t\t\t\t\t\t */\r\n\t\t\t\t\t\t// Add base url if the js path is relative\r\n\t\t\t\t\t\tif ('js' in e && typeof e.js === 'string' && !e.js.startsWith('http')) {\r\n\t\t\t\t\t\t\te.js = `${serverUrl}${e.js}`;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Add base url if the element path is relative\r\n\t\t\t\t\t\tif ('element' in e && typeof e.element === 'string' && !e.element.startsWith('http')) {\r\n\t\t\t\t\t\t\te.element = `${serverUrl}${e.element}`;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Add base url if the element path api relative\r\n\t\t\t\t\t\tif ('api' in e && typeof e.api === 'string' && !e.api.startsWith('http')) {\r\n\t\t\t\t\t\t\te.api = `${serverUrl}${e.api}`;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\textensions.push(e);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\tstore.appendExtensions(extensions);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Request the package migrations from the Data Source\r\n\t * @param store\r\n\t * @memberOf UmbPackageRepository\r\n\t */\r\n\tasync requestPackageMigrations(store: UmbPackageStore) {\r\n\t\tconst { data: migrations } = await this.#packageSource.getPackageMigrations();\r\n\r\n\t\tif (migrations) {\r\n\t\t\tstore.appendMigrations(migrations.items);\r\n\t\t}\r\n\t}\r\n\r\n\tasync saveCreatedPackage(pkg: UmbCreatedPackageDefinition) {\r\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\t\tconst { unique: _, ...model } = pkg;\r\n\t\tconst { data } = await this.#packageSource.saveCreatedPackage(model);\r\n\t\treturn data;\r\n\t}\r\n\r\n\tasync updateCreatedPackage(pkg: UmbCreatedPackageDefinition): Promise<boolean> {\r\n\t\tconst { unique, ...model } = pkg;\r\n\t\tconst { error } = await this.#packageSource.updateCreatedPackage(unique, model);\r\n\t\treturn !error;\r\n\t}\r\n\r\n\tasync configuration() {\r\n\t\tawait this.#init;\r\n\t\treturn this.#packageStore!.configuration;\r\n\t}\r\n\r\n\t/**\r\n\t * Observable of root items\r\n\t * @memberOf UmbPackageRepository\r\n\t */\r\n\tasync rootItems() {\r\n\t\tawait this.#init;\r\n\t\treturn this.#packageStore!.rootItems;\r\n\t}\r\n\r\n\t/**\r\n\t * Observable of extensions\r\n\t * @memberOf UmbPackageRepository\r\n\t */\r\n\tasync extensions() {\r\n\t\tawait this.#init;\r\n\t\treturn this.#packageStore!.extensions;\r\n\t}\r\n\r\n\t/**\r\n\t * Observable of migrations\r\n\t * @memberOf UmbPackageRepository\r\n\t */\r\n\tasync migrations() {\r\n\t\tawait this.#init;\r\n\t\treturn this.#packageStore!.migrations;\r\n\t}\r\n}\r\n\r\nexport default UmbPackageRepository;\r\n"],"names":["UmbPackageServerDataSource","_host","unique","tryExecute","PackageService","skip","take","ManifestService","body","id","UmbPackageRepository","UmbControllerBase","#init","#packageStore","#packageSource","host","resolve","UMB_PACKAGE_STORE_TOKEN","instance","#getEmptyCreatedPackage","data","model","item","error","store","packages","p","extensions","serverContext","UMB_SERVER_CONTEXT","serverUrl","e","isManifestBaseType","migrations","pkg","_"],"mappings":"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"}