{"version":3,"file":"index.js","sources":["../../../src/packages/ufm/components/ufm-render/ufm-render.element.ts","../../../src/packages/ufm/components/ufm-js-expression.element.ts","../../../src/packages/ufm/controllers/ufm-virtual-render.controller.ts"],"sourcesContent":["import { UMB_UFM_CONTEXT } from '../../contexts/ufm.context.js';\r\nimport { UmbUfmRenderContext } from './ufm-render.context.js';\r\nimport { css, customElement, nothing, property, unsafeHTML, until } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\n\r\n@customElement('umb-ufm-render')\r\nexport class UmbUfmRenderElement extends UmbLitElement {\r\n\t#context = new UmbUfmRenderContext(this);\r\n\r\n\t@property({ type: Boolean })\r\n\tinline = false;\r\n\r\n\t@property()\r\n\tmarkdown?: string;\r\n\r\n\t// No reactive property declaration because it's causing a re-render that is not needed.\r\n\t// This just works as a shortcut to set the values on the context. [NL]\r\n\tpublic set value(value: string | unknown | undefined) {\r\n\t\tthis.#context.setValue(value);\r\n\t}\r\n\tpublic get value(): string | unknown | undefined {\r\n\t\treturn this.#context.getValue();\r\n\t}\r\n\r\n\t#ufmContext?: typeof UMB_UFM_CONTEXT.TYPE;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(UMB_UFM_CONTEXT, (ufmContext) => {\r\n\t\t\tthis.#ufmContext = ufmContext;\r\n\t\t});\r\n\t}\r\n\r\n\toverride toString(): string {\r\n\t\treturn this.shadowRoot?.textContent ?? '';\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn until(this.#renderMarkdown());\r\n\t}\r\n\r\n\tasync #renderMarkdown() {\r\n\t\tif (!this.#ufmContext || !this.markdown) return null;\r\n\t\tconst markup = await this.#ufmContext.parse(this.markdown, this.inline);\r\n\t\treturn markup ? unsafeHTML(markup) : nothing;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tposition: relative;\r\n\t\t\t}\r\n\r\n\t\t\t* {\r\n\t\t\t\tmax-width: 100%;\r\n\t\t\t\tword-wrap: break-word;\r\n\t\t\t}\r\n\r\n\t\t\tpre {\r\n\t\t\t\toverflow: auto;\r\n\t\t\t}\r\n\r\n\t\t\tcode {\r\n\t\t\t\tfont-family: var(--uui-font-monospace, monospace);\r\n\t\t\t\twhite-space: pre-wrap;\r\n\t\t\t\tbackground-color: var(--uui-color-background);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tpadding: 0.2em 0.4em;\r\n\t\t\t}\r\n\r\n\t\t\t:host > :first-child {\r\n\t\t\t\tmargin-block-start: 0;\r\n\t\t\t}\r\n\r\n\t\t\t:host > :last-child {\r\n\t\t\t\tmargin-block-end: 0;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport { UmbUfmRenderElement as element };\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-ufm-render': UmbUfmRenderElement;\r\n\t}\r\n}\r\n","import { UMB_UFM_CONTEXT } from '../contexts/ufm.context.js';\r\nimport { UMB_UFM_RENDER_CONTEXT } from './ufm-render/ufm-render.context.js';\r\nimport { customElement, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { EvalAstFactory, Parser } from '@umbraco-cms/backoffice/external/heximal-expressions';\r\nimport { UmbLruCache } from '@umbraco-cms/backoffice/cache';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport type { Expression, Scope } from '@umbraco-cms/backoffice/external/heximal-expressions';\r\n\r\nconst astFactory = new EvalAstFactory();\r\nconst expressionCache = new UmbLruCache<string, Expression | undefined>(1000);\r\n\r\n@customElement('umb-ufm-js-expression')\r\nexport class UmbUfmJsExpressionElement extends UmbLitElement {\r\n\t#ufmContext?: typeof UMB_UFM_CONTEXT.TYPE;\r\n\r\n\t@state()\r\n\tvalue?: unknown;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(UMB_UFM_CONTEXT, (ufmContext) => {\r\n\t\t\tthis.#ufmContext = ufmContext;\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_UFM_RENDER_CONTEXT, (context) => {\r\n\t\t\tthis.observe(\r\n\t\t\t\tcontext?.value,\r\n\t\t\t\t(value) => {\r\n\t\t\t\t\tthis.value = this.#labelTemplate(this.textContent ?? '', value);\r\n\t\t\t\t},\r\n\t\t\t\t'observeValue',\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n\r\n\t#labelTemplate(expression: string, model?: any): string {\r\n\t\tconst filters = this.#ufmContext?.getFilters() ?? [];\r\n\t\tconst functions = Object.fromEntries(filters.map((x) => [x.alias, x.filter]));\r\n\t\tconst scope: Scope = { ...model, ...functions };\r\n\r\n\t\tlet ast = expressionCache.get(expression);\r\n\r\n\t\tif (ast === undefined && !expressionCache.has(expression)) {\r\n\t\t\ttry {\r\n\t\t\t\tast = new Parser(expression, astFactory).parse();\r\n\t\t\t} catch {\r\n\t\t\t\tconsole.error(`Error parsing expression: \\`${expression}\\``);\r\n\t\t\t}\r\n\t\t\texpressionCache.set(expression, ast);\r\n\t\t}\r\n\r\n\t\treturn ast?.evaluate(scope) ?? '';\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn (Array.isArray(this.value) ? this.value : [this.value]).join(', ');\r\n\t}\r\n}\r\n\r\nexport default UmbUfmJsExpressionElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'umb-ufm-js-expression': UmbUfmJsExpressionElement;\r\n\t}\r\n}\r\n","import { UmbUfmRenderElement } from '../components/index.js';\r\nimport { UmbControllerBase } from '@umbraco-cms/backoffice/class-api';\r\n\r\n/**\r\n * Renders a UFM\r\n */\r\nexport class UmbUfmVirtualRenderController extends UmbControllerBase {\r\n\t#element?: UmbUfmRenderElement;\r\n\r\n\t#getTextFromDescendants(element?: Element | null): string {\r\n\t\tif (!element) return '';\r\n\r\n\t\tconst items: Array<string> = [];\r\n\r\n\t\t// Try get the text content from the shadow root first, otherwise get it from the light DOM. [LK]\r\n\t\tif (element.shadowRoot) {\r\n\t\t\tfor (const node of element.shadowRoot.childNodes) {\r\n\t\t\t\tif (node.nodeType === Node.ELEMENT_NODE) {\r\n\t\t\t\t\titems.push(this.#getTextFromDescendants(node as Element));\r\n\t\t\t\t} else if (node.nodeType === Node.TEXT_NODE) {\r\n\t\t\t\t\titems.push(node.textContent ?? '');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tfor (const node of element.childNodes) {\r\n\t\t\t\tif (node.nodeType === Node.ELEMENT_NODE) {\r\n\t\t\t\t\titems.push(this.#getTextFromDescendants(node as Element));\r\n\t\t\t\t} else if (node.nodeType === Node.TEXT_NODE) {\r\n\t\t\t\t\titems.push(node.textContent ?? '');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn items.filter((x) => x).join('');\r\n\t}\r\n\r\n\tset markdown(markdown: string | undefined) {\r\n\t\tthis.#markdown = markdown;\r\n\t\tif (this.#element) {\r\n\t\t\tthis.#element.markdown = markdown;\r\n\t\t}\r\n\t}\r\n\tget markdown(): string | undefined {\r\n\t\treturn this.#markdown;\r\n\t}\r\n\t#markdown: string | undefined;\r\n\r\n\tset value(value: unknown | undefined) {\r\n\t\tthis.#value = value;\r\n\t\tif (this.#element) {\r\n\t\t\tthis.#element.value = value;\r\n\t\t}\r\n\t}\r\n\tget value(): unknown | undefined {\r\n\t\treturn this.#value;\r\n\t}\r\n\t#value: unknown | undefined;\r\n\r\n\toverride hostConnected(): void {\r\n\t\tconst element = new UmbUfmRenderElement();\r\n\t\telement.inline = true;\r\n\t\telement.style.visibility = 'hidden';\r\n\r\n\t\telement.markdown = this.#markdown;\r\n\t\telement.value = this.#value;\r\n\r\n\t\tthis.getHostElement().appendChild(element);\r\n\t\tthis.#element = element;\r\n\t}\r\n\r\n\toverride hostDisconnected(): void {\r\n\t\tthis.#element?.remove();\r\n\t}\r\n\r\n\toverride toString(): string {\r\n\t\treturn this.#getTextFromDescendants(this.#element);\r\n\t}\r\n\r\n\toverride destroy(): void {\r\n\t\tsuper.destroy();\r\n\t\tthis.#element?.destroy();\r\n\t\t(this.#element as any) = undefined;\r\n\t}\r\n}\r\n"],"names":["_context","_ufmContext","_UmbUfmRenderElement_instances","renderMarkdown_fn","UmbUfmRenderElement","UmbLitElement","__privateAdd","UmbUfmRenderContext","UMB_UFM_CONTEXT","ufmContext","__privateSet","value","__privateGet","until","__privateMethod","markup","unsafeHTML","nothing","UmbTextStyles","css","__decorateClass","property","customElement","_UmbUfmJsExpressionElement_instances","labelTemplate_fn","astFactory","EvalAstFactory","expressionCache","UmbLruCache","UmbUfmJsExpressionElement","UMB_UFM_RENDER_CONTEXT","context","expression","model","filters","functions","x","scope","ast","Parser","state","UmbUfmVirtualRenderController","UmbControllerBase","#element","#getTextFromDescendants","element","items","node","markdown","#markdown","#value"],"mappings":"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"}