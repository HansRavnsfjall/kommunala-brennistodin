{"version":3,"file":"ufm.context-CodmBAew.js","sources":["../../../src/packages/ufm/contexts/ufm.context.ts"],"sourcesContent":["import type { ManifestUfmFilter } from '../extensions/ufm-filter.extension.js';\r\nimport { DOMPurify } from '@umbraco-cms/backoffice/external/dompurify';\r\nimport { Marked } from '@umbraco-cms/backoffice/external/marked';\r\nimport { UmbArrayState } from '@umbraco-cms/backoffice/observable-api';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { UmbContextToken } from '@umbraco-cms/backoffice/context-api';\r\nimport { UmbExtensionsApiInitializer } from '@umbraco-cms/backoffice/extension-api';\r\nimport { umbExtensionsRegistry } from '@umbraco-cms/backoffice/extension-registry';\r\nimport type { Config as DOMPurifyConfig } from '@umbraco-cms/backoffice/external/dompurify';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbExtensionApiInitializer } from '@umbraco-cms/backoffice/extension-api';\r\n\r\nconst UmbDomPurify = DOMPurify(window);\r\nconst UmbDomPurifyConfig: DOMPurifyConfig = {\r\n\tUSE_PROFILES: { html: true },\r\n\tCUSTOM_ELEMENT_HANDLING: {\r\n\t\ttagNameCheck: /^(?:ufm|umb|uui)-.*$/,\r\n\t\tattributeNameCheck: /.+/,\r\n\t\tallowCustomizedBuiltInElements: false,\r\n\t},\r\n};\r\n\r\nUmbDomPurify.addHook('afterSanitizeAttributes', function (node) {\r\n\t// set all elements owning target to target=_blank\r\n\tif ('target' in node && node instanceof HTMLElement) {\r\n\t\tnode.setAttribute('target', '_blank');\r\n\t}\r\n});\r\n\r\nexport const UmbMarked = new Marked({\r\n\tasync: true,\r\n\tgfm: true,\r\n\tbreaks: true,\r\n\thooks: {\r\n\t\tpostprocess: (markup) => UmbDomPurify.sanitize(markup, UmbDomPurifyConfig),\r\n\t},\r\n});\r\n\r\nexport type UmbUfmFilterFunction = ((...args: Array<unknown>) => string | undefined | null) | undefined;\r\n\r\nexport type UmbUfmFilterType = {\r\n\talias: string;\r\n\tfilter: UmbUfmFilterFunction;\r\n};\r\n\r\nexport class UmbUfmContext extends UmbContextBase {\r\n\t#filters = new UmbArrayState<UmbUfmFilterType>([], (x) => x.alias);\r\n\tpublic readonly filters = this.#filters.asObservable();\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_UFM_CONTEXT);\r\n\r\n\t\tnew UmbExtensionsApiInitializer(this, umbExtensionsRegistry, 'markedExtension', [UmbMarked]);\r\n\r\n\t\tnew UmbExtensionsApiInitializer(this, umbExtensionsRegistry, 'ufmFilter', [], undefined, (controllers) => {\r\n\t\t\tconst filters = controllers\r\n\t\t\t\t.map((controller) => {\r\n\t\t\t\t\tconst ctrl = controller as unknown as UmbExtensionApiInitializer<ManifestUfmFilter>;\r\n\t\t\t\t\tif (!ctrl.manifest || !ctrl.api) return null;\r\n\t\t\t\t\treturn { alias: ctrl.manifest.meta.alias, filter: ctrl.api.filter };\r\n\t\t\t\t})\r\n\t\t\t\t.filter((x) => x) as Array<UmbUfmFilterType>;\r\n\r\n\t\t\tthis.#filters.setValue(filters);\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Get the filters registered in the UFM context.\r\n\t * @returns {Array<UmbUfmFilterType>} An array of filters with their aliases and filter functions.\r\n\t */\r\n\tpublic getFilters(): Array<UmbUfmFilterType> {\r\n\t\treturn this.#filters.getValue();\r\n\t}\r\n\r\n\t/**\r\n\t * Get a filter by its alias.\r\n\t * @param alias The alias of the filter to retrieve.\r\n\t * @returns {UmbUfmFilterFunction} The filter function associated with the alias, or undefined if not found.\r\n\t */\r\n\tpublic getFilterByAlias(alias: string): UmbUfmFilterFunction {\r\n\t\treturn this.#filters.getValue().find((x) => x.alias === alias)?.filter;\r\n\t}\r\n\r\n\t/**\r\n\t * Parse markdown content, optionally inline.\r\n\t * @param markdown The markdown string to parse.\r\n\t * @param inline If true, parse inline markdown; otherwise, parse block markdown.\r\n\t * @returns {Promise<string>} A promise that resolves to the parsed HTML string.\r\n\t */\r\n\tpublic async parse(markdown: string, inline: boolean): Promise<string> {\r\n\t\treturn !inline ? await UmbMarked.parse(markdown) : await UmbMarked.parseInline(markdown);\r\n\t}\r\n}\r\n\r\nexport const UMB_UFM_CONTEXT = new UmbContextToken<UmbUfmContext>('UmbUfmContext');\r\n\r\nexport { UmbUfmContext as api };\r\n"],"names":["UmbDomPurify","DOMPurify","UmbDomPurifyConfig","node","UmbMarked","Marked","markup","UmbUfmContext","UmbContextBase","host","UMB_UFM_CONTEXT","#filters","UmbArrayState","x","UmbExtensionsApiInitializer","umbExtensionsRegistry","controllers","filters","controller","ctrl","alias","markdown","inline","UmbContextToken"],"mappings":";;;;;;;AAYA,MAAMA,IAAeC,EAAU,MAAM,GAC/BC,IAAsC;AAAA,EAC3C,cAAc,EAAE,MAAM,GAAA;AAAA,EACtB,yBAAyB;AAAA,IACxB,cAAc;AAAA,IACd,oBAAoB;AAAA,IACpB,gCAAgC;AAAA,EAAA;AAElC;AAEAF,EAAa,QAAQ,2BAA2B,SAAUG,GAAM;AAE/D,EAAI,YAAYA,KAAQA,aAAgB,eACvCA,EAAK,aAAa,UAAU,QAAQ;AAEtC,CAAC;AAEM,MAAMC,IAAY,IAAIC,EAAO;AAAA,EACnC,OAAO;AAAA,EACP,KAAK;AAAA,EACL,QAAQ;AAAA,EACR,OAAO;AAAA,IACN,aAAa,CAACC,MAAWN,EAAa,SAASM,GAAQJ,CAAkB;AAAA,EAAA;AAE3E,CAAC;AASM,MAAMK,UAAsBC,EAAe;AAAA,EAIjD,YAAYC,GAAyB;AACpC,UAAMA,GAAMC,CAAe,GAJ5B,KAAAC,KAAW,IAAIC,EAAgC,CAAA,GAAI,CAACC,MAAMA,EAAE,KAAK,GACjE,KAAgB,UAAU,KAAKF,GAAS,aAAA,GAKvC,IAAIG,EAA4B,MAAMC,GAAuB,mBAAmB,CAACX,CAAS,CAAC,GAE3F,IAAIU,EAA4B,MAAMC,GAAuB,aAAa,IAAI,QAAW,CAACC,MAAgB;AACzG,YAAMC,IAAUD,EACd,IAAI,CAACE,MAAe;AACpB,cAAMC,IAAOD;AACb,eAAI,CAACC,EAAK,YAAY,CAACA,EAAK,MAAY,OACjC,EAAE,OAAOA,EAAK,SAAS,KAAK,OAAO,QAAQA,EAAK,IAAI,OAAA;AAAA,MAC5D,CAAC,EACA,OAAO,CAACN,MAAMA,CAAC;AAEjB,WAAKF,GAAS,SAASM,CAAO;AAAA,IAC/B,CAAC;AAAA,EACF;AAAA,EAnBAN;AAAA;AAAA;AAAA;AAAA;AAAA,EAyBO,aAAsC;AAC5C,WAAO,KAAKA,GAAS,SAAA;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOO,iBAAiBS,GAAqC;AAC5D,WAAO,KAAKT,GAAS,SAAA,EAAW,KAAK,CAACE,MAAMA,EAAE,UAAUO,CAAK,GAAG;AAAA,EACjE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAa,MAAMC,GAAkBC,GAAkC;AACtE,WAAQA,IAA2C,MAAMlB,EAAU,YAAYiB,CAAQ,IAAtE,MAAMjB,EAAU,MAAMiB,CAAQ;AAAA,EAChD;AACD;AAEO,MAAMX,IAAkB,IAAIa,EAA+B,eAAe;"}