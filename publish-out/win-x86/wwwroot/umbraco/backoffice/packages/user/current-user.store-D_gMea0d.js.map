{"version":3,"file":"current-user.store-D_gMea0d.js","sources":["../../../src/packages/user/current-user/repository/current-user.store.ts"],"sourcesContent":["import type {\r\n\tUmbCurrentUserExternalLoginProviderModel,\r\n\tUmbCurrentUserMfaProviderModel,\r\n\tUmbCurrentUserModel,\r\n} from '../types.js';\r\nimport { UMB_CURRENT_USER_STORE_CONTEXT } from './current-user.store.token.js';\r\nimport type { UmbUserDetailModel } from '@umbraco-cms/backoffice/user';\r\nimport { UMB_USER_DETAIL_STORE_CONTEXT } from '@umbraco-cms/backoffice/user';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbArrayState, UmbObjectState } from '@umbraco-cms/backoffice/observable-api';\r\n\r\nexport class UmbCurrentUserStore extends UmbContextBase {\r\n\t#data = new UmbObjectState<UmbCurrentUserModel | undefined>(undefined);\r\n\treadonly data = this.#data.asObservable();\r\n\r\n\t#mfaProviders = new UmbArrayState<UmbCurrentUserMfaProviderModel>([], (e) => e.providerName);\r\n\treadonly mfaProviders = this.#mfaProviders.asObservable();\r\n\r\n\t#externalLoginProviders = new UmbArrayState<UmbCurrentUserExternalLoginProviderModel>(\r\n\t\t[],\r\n\t\t(e) => e.providerSchemeName,\r\n\t);\r\n\treadonly externalLoginProviders = this.#externalLoginProviders.asObservable();\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_CURRENT_USER_STORE_CONTEXT);\r\n\r\n\t\tthis.consumeContext(UMB_USER_DETAIL_STORE_CONTEXT, (instance) => {\r\n\t\t\tthis.observe(instance?.all(), (users) => this.#onUserDetailStoreUpdate(users ?? []));\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Get the current user\r\n\t * @readonly\r\n\t * @type {UmbCurrentUserModel}\r\n\t * @memberof UmbCurrentUserStore\r\n\t */\r\n\tget() {\r\n\t\treturn this.#data.getValue();\r\n\t}\r\n\r\n\t/**\r\n\t * Set the current user\r\n\t * @param {UmbCurrentUserModel} data\r\n\t * @memberof UmbCurrentUserStore\r\n\t */\r\n\tset(data: UmbCurrentUserModel) {\r\n\t\tthis.#data.setValue(data);\r\n\t}\r\n\r\n\t/**\r\n\t * Update the current user\r\n\t * @param {Partial<UmbCurrentUserModel>} data\r\n\t * @memberof UmbCurrentUserStore\r\n\t */\r\n\tupdate(data: Partial<UmbCurrentUserModel>) {\r\n\t\tthis.#data.update(data);\r\n\t}\r\n\r\n\t/**\r\n\t * Clear the current user\r\n\t * @memberof UmbCurrentUserStore\r\n\t */\r\n\tclear() {\r\n\t\tthis.#data.setValue(undefined);\r\n\t}\r\n\r\n\t#onUserDetailStoreUpdate = (users: Array<UmbUserDetailModel>) => {\r\n\t\tconst currentUser = this.get();\r\n\t\tif (!currentUser) return;\r\n\r\n\t\tconst updatedCurrentUser = users.find((user) => user.unique === currentUser.unique);\r\n\t\tif (!updatedCurrentUser) return;\r\n\r\n\t\tconst mappedCurrentUser: Partial<UmbCurrentUserModel> = {\r\n\t\t\temail: updatedCurrentUser.email,\r\n\t\t\tuserName: updatedCurrentUser.userName,\r\n\t\t\tname: updatedCurrentUser.name,\r\n\t\t\tlanguageIsoCode: updatedCurrentUser.languageIsoCode || '', // TODO: default value?\r\n\t\t\tdocumentStartNodeUniques: updatedCurrentUser.documentStartNodeUniques,\r\n\t\t\tmediaStartNodeUniques: updatedCurrentUser.mediaStartNodeUniques,\r\n\t\t\tavatarUrls: updatedCurrentUser.avatarUrls,\r\n\t\t\tisAdmin: updatedCurrentUser.isAdmin,\r\n\t\t};\r\n\r\n\t\tthis.update(mappedCurrentUser);\r\n\t};\r\n\r\n\tsetMfaProviders(data: Array<UmbCurrentUserMfaProviderModel>) {\r\n\t\tthis.#mfaProviders.setValue(data);\r\n\t}\r\n\r\n\tupdateMfaProvider(data: Partial<UmbCurrentUserMfaProviderModel>) {\r\n\t\tthis.#mfaProviders.updateOne(data.providerName, data);\r\n\t}\r\n\r\n\tsetExternalLoginProviders(data: Array<UmbCurrentUserExternalLoginProviderModel>) {\r\n\t\tthis.#externalLoginProviders.setValue(data);\r\n\t}\r\n\r\n\tupdateExternalLoginProvider(data: Partial<UmbCurrentUserExternalLoginProviderModel>) {\r\n\t\tthis.#externalLoginProviders.updateOne(data.providerSchemeName, data);\r\n\t}\r\n}\r\n\r\nexport default UmbCurrentUserStore;\r\n"],"names":["UmbCurrentUserStore","UmbContextBase","host","UMB_CURRENT_USER_STORE_CONTEXT","#data","UmbObjectState","#mfaProviders","UmbArrayState","e","#externalLoginProviders","#onUserDetailStoreUpdate","users","currentUser","updatedCurrentUser","user","mappedCurrentUser","UMB_USER_DETAIL_STORE_CONTEXT","instance","data"],"mappings":";;;;AAYO,MAAMA,UAA4BC,EAAe;AAAA,EAavD,YAAYC,GAAyB;AACpC,UAAMA,GAAMC,CAA8B,GAb3C,KAAAC,KAAQ,IAAIC,EAAgD,MAAS,GACrE,KAAS,OAAO,KAAKD,GAAM,aAAA,GAE3B,KAAAE,KAAgB,IAAIC,EAA8C,CAAA,GAAI,CAACC,MAAMA,EAAE,YAAY,GAC3F,KAAS,eAAe,KAAKF,GAAc,aAAA,GAE3C,KAAAG,KAA0B,IAAIF;AAAA,MAC7B,CAAA;AAAA,MACA,CAACC,MAAMA,EAAE;AAAA,IAAA,GAEV,KAAS,yBAAyB,KAAKC,GAAwB,aAAA,GA8C/D,KAAAC,KAA2B,CAACC,MAAqC;AAChE,YAAMC,IAAc,KAAK,IAAA;AACzB,UAAI,CAACA,EAAa;AAElB,YAAMC,IAAqBF,EAAM,KAAK,CAACG,MAASA,EAAK,WAAWF,EAAY,MAAM;AAClF,UAAI,CAACC,EAAoB;AAEzB,YAAME,IAAkD;AAAA,QACvD,OAAOF,EAAmB;AAAA,QAC1B,UAAUA,EAAmB;AAAA,QAC7B,MAAMA,EAAmB;AAAA,QACzB,iBAAiBA,EAAmB,mBAAmB;AAAA;AAAA,QACvD,0BAA0BA,EAAmB;AAAA,QAC7C,uBAAuBA,EAAmB;AAAA,QAC1C,YAAYA,EAAmB;AAAA,QAC/B,SAASA,EAAmB;AAAA,MAAA;AAG7B,WAAK,OAAOE,CAAiB;AAAA,IAC9B,GA5DC,KAAK,eAAeC,GAA+B,CAACC,MAAa;AAChE,WAAK,QAAQA,GAAU,OAAO,CAACN,MAAU,KAAKD,GAAyBC,KAAS,CAAA,CAAE,CAAC;AAAA,IACpF,CAAC;AAAA,EACF;AAAA,EAlBAP;AAAA,EAGAE;AAAA,EAGAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAoBA,MAAM;AACL,WAAO,KAAKL,GAAM,SAAA;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,IAAIc,GAA2B;AAC9B,SAAKd,GAAM,SAASc,CAAI;AAAA,EACzB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,OAAOA,GAAoC;AAC1C,SAAKd,GAAM,OAAOc,CAAI;AAAA,EACvB;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,QAAQ;AACP,SAAKd,GAAM,SAAS,MAAS;AAAA,EAC9B;AAAA,EAEAM;AAAA,EAqBA,gBAAgBQ,GAA6C;AAC5D,SAAKZ,GAAc,SAASY,CAAI;AAAA,EACjC;AAAA,EAEA,kBAAkBA,GAA+C;AAChE,SAAKZ,GAAc,UAAUY,EAAK,cAAcA,CAAI;AAAA,EACrD;AAAA,EAEA,0BAA0BA,GAAuD;AAChF,SAAKT,GAAwB,SAASS,CAAI;AAAA,EAC3C;AAAA,EAEA,4BAA4BA,GAAyD;AACpF,SAAKT,GAAwB,UAAUS,EAAK,oBAAoBA,CAAI;AAAA,EACrE;AACD;"}